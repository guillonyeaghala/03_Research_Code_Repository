*Macro Basics;
*https://support.sas.com/resources/papers/proceedings/proceedings/sugi29/243-29.pdf;

*As you construct macro programs, you will use two basic building blocks: macros and macro variables.
 You can tell them apart because the names of macro variables start with an ampersand (&), while the names of macros start with a percent sign (%).
 1 A macro variable is like a standard data variable except that it does not belong to a data set and has only a single value which is always character. The value of a macro variable could be a variable name, a numeral, or any text you want substituted in your program. 
 A macro, however, is a larger piece of a program that can contain complex logic including complete DATA and PROC steps, and macro statements such as %IF-%THEN/%ELSE and %DO-%END. Macros often —but not always—contain macro variables.;
 
*Macro variables come in two varieties: either local or global. 
A macro variable’s scope is local if it is defined inside a macro.
Its scope is global if it is defined in “open code” which is everything outside a macro. 
You can use a global macro variable anywhere in your program, but you can use a local macro variable only inside its own macro:

*%LET is a straightforward macro statement that simply assigns a value to a macro variable. 
Suppose you have a program that you run once a month. 
Every time you have to edit the program so it will select data for the correct month and print the correct title. This is time-consuming and prone to errors. 
You can use %LET to create a macro variable. Then you can change the value of the macro variable in the %LET statement, and SAS will repeat the new value throughout your program;

*The general form a %LET statement is

%LET macro-variable-name = value;

*where macro-variable-name is a name you make up following the standard rules for SAS names.
Value is the text to be substituted for the macro variable name
The following statement create a macro variable.

%LET winner = Lance Armstrong; 

*Notice that there are no quotation marks around value even when it contains characters. 
Blanks at the beginning and end will be trimmed, and everything else between the equal sign and semicolon will become part of the value for the macro variable;

*To use the macro variable, you simply add the ampersand prefix (&) and stick the macro variable name wherever you want its value to be substituted;

TITLE “First: &winner”;

*After being resolved by the macro processor, this statement would become;

TITLE “First: Lance Armstrong”;

*CREATING MODULAR CODE WITH MACROS
Anytime you find yourself repeating the same program statements over and over, you might want to consider creating a
macro instead. Macros are simply a group of SAS statements that have a name. And, anytime you want that group of
statements in your program, you use the name instead of the re-typing all the statements.
The general form of a macro is;

%MACRO macro-name;
 macro-text
%MEND macro-name;

*The %MACRO statement tells SAS that this is the beginning of the macro.
the %MEND statement signals the end of the macro. 
Macro-name is a name you make up for your macro. 
You don’t need to specify the macro-name in the %MEND statement, but it will make your programs easier to understand if you include it. 
Macro-text represents the SAS statements that you want in your macro;

*After you define your macro, you need to invoke it when you want to use it. 
Do this by adding a percent sign in front of the macro-name like this;

"%macro-name"

/*While you do not need to end this statement with a semicolon, it generally does no harm either*/

/* Example

Looking at the bicycle models data, the sales personnel like to have lists of models sorted both by model name and by price. 
The following program creates a macro named PRINTIT that has the PROC PRINT statements you need for the report. 
Then the program calls the macro twice; first without sorting the data (it is already sorted by model name), and then after executing a PROC SORT by Price.*/

%MACRO printit;

PROC PRINT DATA = models NOOBS;
 TITLE 'Current Models';
 VAR Model Class Frame Price;
 FORMAT Price DOLLAR6.;
RUN;
%MEND printit;

/*The first PROC PRINT is generated by the first call to the PRINTIT macro, the PROC SORT comes from the original program*/

%printit;

/*Here are the standard SAS statements that are generated by the macro processor.*/

PROC PRINT DATA = models NOOBS;
 TITLE 'Current Models';
 VAR Model Class Frame Price;
 FORMAT Price DOLLAR6.;
RUN;

/*The second PROC PRINT is generated by the second call to the PRINTIT macro*/

PROC SORT DATA = models;
 BY Price;

%printit;

/*Here are the standard SAS statements that are generated by the macro processor.*/

PROC SORT DATA = models;
 BY Price;

PROC PRINT DATA = models NOOBS;
 TITLE 'Current Models';
 VAR Model Class Frame Price;
 FORMAT Price DOLLAR6.;
RUN;

/*ADDING PARAMETERS TO MACROS*/

/*Macros allow you to execute a set of SAS statements with just one statement, and while this alone can be helpful, macros
are even more powerful when you add parameters to them. Parameters are macro variables whose values are set when
you invoke the macro. Parameters give your macros flexibility.*/

/*To add parameters to your macro, simply list the macro-variable names followed by an equal sign in parentheses after the macro name:*/

%MACRO macro-name (parameter-1=, parameter-2=, . . . parameter-n=);
 macro-text
%MEND macro-name;

/*For example, if you have a macro named %MONTHLYREPORT that has parameters for the month and region, it might start like this:*/

%MACRO monthlyreport (month=, region=);

/*Then when you invoke the macro, specify the values for the macro variables after the equal signs:*/
/*Because these macro variables are defined in the macro, they are, by default, local to the macro and you cannot use them in any SAS statements outside the macro*/

%monthlyreport (month=May, region=West);

/*Example*/

/*The PRINTIT macro from the previous example prints the desired reports, but you have to sort the data between calls to the
macro and the title does not reflect the sort order of the report. This new macro, SORTANDPRINT includes the PROC SORT
statements and adds parameters so that you can vary both the sort variable and the sort sequence (descending or not).
Then the macro variables are added to a TITLE statement, so the report states how it is sorted. There are two calls to the
macro, producing two reports.*/

/*For sortvar enter the variable for sorting the report. For sortseq use either Descending or do not enter a value for an ascending sequence;*/

%MACRO sortandprint(sortseq=, sortvar=);
PROC SORT DATA = models;
 BY &sortseq &sortvar;
PROC PRINT DATA = models NOOBS;
 TITLE 'Current Models';
 TITLE2 "Sorted by &sortseq &sortvar";
 VAR Model Class Frame Price;
 FORMAT Price DOLLAR6.;
RUN;
%MEND sortandprint;

/*The first call to the macro gives the &SORTSEQ macro variable the value DESCENDING and the &SORTVAR macro
variable the value Price. So the statements generated by this call will sort the data by descending values of the variable
Price.*/ 

%sortandprint(sortseq=Descending, sortvar=Price);

/*Here are the SAS statements that are generated by the macro processor:*/

PROC SORT DATA = models;
BY Descending Price;
PROC PRINT DATA = models NOOBS;
TITLE 'Current Models';
TITLE2 "Sorted by Descending Price";
VAR Model Class Frame Price;
FORMAT Price DOLLAR6.;
RUN;

/*The second call to the macro gives &SORTSEQ no value and &SORTVAR the value Class. So this call will produce
statements that sort the data by ascending (the default) Class.*/

%sortandprint(sortseq=, sortvar=Class);

/*Here are the SAS statements that are generated by the macro processor:*/

PROC SORT DATA = models;
BY Class;
PROC PRINT DATA = models NOOBS;
TITLE 'Current Models';
TITLE2 "Sorted by Class";
VAR Model Class Frame Price;
FORMAT Price DOLLAR6.;
RUN;

/*MPRINT system option*/

/*We have been showing you what SAS sees after the macro processor has resolved your program, but normally you won’t
see these statements. However if you specify the MPRINT sys tem option in your program, then SAS will print the resolved
statements from macros in the SAS log. This can be very useful for debugging purposes. To turn on the MPRINT option,
submit an OPTIONS statement like this:*/

OPTIONS MPRINT;

*************************************************************************************************************************************
*************************************************************************************************************************************
*************************************************************************************************************************************;

*libname mylib "\\CDRG-FS-P03\Projects\Dr. Israni Projects\DeKAF\MISSION study\Raw_data";
libname mylib "D:\ROOK_03_Professional\HHRI\16_Mission_Redcap_Prospective_Cross-sectional\Datasets\MISSION_Redcap_MAR2023";

*You will need to upload the files to the SAS studio server directly;
*Right click on the folder location and select properties to copy the path name;

libname mylib "/home/u63327094/analysis_MISSION_01_PS_data_reports";

*Import and save to sas database first time for faster loading;
proc import 
datafile= '\\CDRG-FS-P03\Projects\Dr. Israni Projects\DeKAF\MISSION study\Raw_data\2021.11.22 MISSION REDCap data CSV.csv'
out=mylib.mission
dbms=csv
replace;
getnames=yes;
guessingrows=9999;
run;

*This is the CSV file as downloaded from REDCAP;
proc import 
datafile= '/home/u63327094/analysis_MISSION_PS_data_reports/MicrobiomeAndImmunos_DATA_2023-07-11_0825.csv'
out=mylib.mission_prospective
dbms=csv
replace;
getnames=yes;
guessingrows=9999;
run;

*This is the CSV file as downloaded from REDCAP;
proc import 
datafile= '/home/u63327094/analysis_MISSION_PS_data_reports/MicrobiomeAndImmunos_DATA_2023-09-06_1109.csv'
out=mylib.mission_prospective
dbms=csv
replace;
getnames=yes;
guessingrows=9999;
run;

proc import 
datafile= '/home/u63327094/analysis_MISSION_PS_data_reports/MicrobiomeAndImmunos_DATA_2023-09-18_1426.csv'
out=mylib.mission_prospective
dbms=csv
replace;
getnames=yes;
guessingrows=9999;
run;

proc import 
datafile= '/home/u63327094/analysis_MISSION_PS_data_reports/MicrobiomeAndImmunos_DATA_2023-09-25_1515.csv'
out=mylib.mission_prospective
dbms=csv
replace;
getnames=yes;
guessingrows=9999;
run;

proc import 
datafile= '/home/u63327094/analysis_MISSION_PS_data_reports/MicrobiomeAndImmunos_DATA_2023-09-25_1552.csv'
out=mylib.mission_prospective
dbms=csv
replace;
getnames=yes;
guessingrows=9999;
run;

proc import 
datafile= '/home/u63327094/analysis_MISSION_PS_data_reports/MicrobiomeAndImmunos_DATA_2023-10-17_1324.csv'
out=mylib.mission_prospective
dbms=csv
replace;
getnames=yes;
guessingrows=9999;
run;

proc import 
datafile= '/home/u63327094/analysis_MISSION_PS_data_reports/MicrobiomeAndImmunos_DATA_2023-10-24_0927.csv'
out=mylib.mission_prospective
dbms=csv
replace;
getnames=yes;
guessingrows=9999;
run;

proc import 
datafile= '/home/u63327094/analysis_MISSION_PS_data_reports/MicrobiomeAndImmunos_DATA_2024-01-03_0816.csv'
out=mylib.mission_prospective
dbms=csv
replace;
getnames=yes;
guessingrows=9999;
run;

proc import 
datafile= '/home/u63327094/analysis_MISSION_01_PS_data_reports/MicrobiomeAndImmunos_DATA_2024-02-02_1021.csv'
out=mylib.mission_prospective
dbms=csv
replace;
getnames=yes;
guessingrows=99999;
run;

*Load data; 
data mission; 
set mylib.mission;
run; 

data mission; 
set mylib.mission_prospective;
run; 

*Macro breakdown

*Check variable names before running the macro;
*Make sure to run the macros at the begining of the SAS code to enable them within the macro below;

proc contents data=mission order=varnum;
run;

*Here are the global macro variables (&clean and &wcnt) that will be referenced in the main macro;
*To use the macro variable, you simply add the ampersand prefix (&) and stick the macro variable name wherever you want its value to be substituted;
*%LET is a straightforward macro statement that simply assigns a value to a macro variable; 

%let clean = %STR(dm 'cle log; cle out';);

options MPRINT;

*word count macro that gets the number of words in a text string;
%macro wordcnt(string);
	%local string wcnt;
	%* The word count is stored in wcnt;
	%let wcnt=0; 
	%do %until(%qscan(&string,&wcnt+1,%str( ))=%str());
	   %let wcnt=%eval(&wcnt+1);
	%end;
	&wcnt
%mend wordcnt;

*Now the coding for the macro that splits the data by form begins;
%let redcaps = redcap_event_name redcap_repeat_instrument redcap_repeat_instance;

*To add parameters to your macro, simply list the macro-variable names followed by an equal sign in parentheses after the macro name;
%macro selectvars(outputdataset, vars);

	%let numvar = %wordcnt(&vars.);

	data mylib.&outputdataset.; 
		set mission (keep = record_id &redcaps.
			&vars.); *This statement makes sure we keep the Participant ID with each subset form;
		nummissing=cmiss(of &vars.);
		if nummissing=&numvar. then delete; *delete row if all variables are missing (so we don't report expected missingness if nothing was entered for someone);
		drop nummissing;
	run;

%mend selectvars; *This tells sas that is the end of the macro;

&clean.; *This runs the clean macro after we are done with the selectvars macro;

*********************************************************************************************************************************************************************************************************;
*********************************************************************************************************************************************************************************************************;
*********************************************************************************************************************************************************************************************************;

/*This proc contents is what we us to determine the variables to list when running the "&selectvars" macro;
*if you look at the proc contents table, then there is typically a variable name formatted as "form name followed by an underscore" at the end of all the variables in the form; 
*That means for form A1, I the last variable will be listed as a1_****, and i can include all the variables prior to it as part of form a1.*/
 
proc contents data=mission order=varnum; 
run;

*Outputting all variables as rtf code;

title1;

options orientation=portrait center number pageno=1 nodate;

ods rtf file="/home/u63327094/analysis_MISSION_data_reports/PS_REDCAP_allvariables.rtf";

proc contents data=mission order=varnum; 
run;

ods rtf close;

*Initial macro setup;

%let clean = %STR(dm 'cle log; cle out';);

options MPRINT;

*word count macro that gets the number of words in a text string;
%macro wordcnt(string);
	%local string wcnt;
	%* The word count is stored in wcnt;
	%let wcnt=0; 
	%do %until(%qscan(&string,&wcnt+1,%str( ))=%str());
	   %let wcnt=%eval(&wcnt+1);
	%end;
	&wcnt
%mend wordcnt;

*split new data into different datasets by form;

%let redcaps = redcap_event_name redcap_repeat_instrument redcap_repeat_instance;

%macro selectvars(outputdataset, vars);

	%let numvar = %wordcnt(&vars.);

	data mylib.&outputdataset.; *Participant ID;
		set mission (keep = record_id &redcaps.
			&vars.);
		nummissing=cmiss(of &vars.);
		if nummissing=&numvar. then delete; *delete row if all variables are missing;
		drop nummissing;
	run;

%mend selectvars;

&clean.;
proc contents data=mission order=varnum;
run;

*****************************************************************************************************************************;
*****************************************************************************************************************************;
*****************************************************************************************************************************;


*In order to determine the  type & number of forms, use the "redcap_repeat_instrument" variables;
*However, this does not cover all the variables form names (based on the data dictionary because forms A, B and C are not repeated);
*It is best to use the "Form name" in the data dictionary for guidance;

proc contents data=mission order=varnum; 
run;

proc freq data = mission;
tables redcap_repeat_instrument;
run;

*How to check if a participant has dropped out of the study;
*Based on the variables:

withdrew_consent (1. Did the participant withdraw consent?)	j1_consent_withdraw
study_termination (4. Did the participant terminate study participation early?)	j2_end_of_the_data_collection
reason_study_terminatn (4.a. Provide the reason for early study termination	1, Physician decision | 2, Study closure | 3, Participant voluntarily withdrew from this study | 4, Participant unable to provide samples | 5, Lost to follow-up | 6, Serious adverse event | 7, Non-fatal graft failure | 8, Patient not alive | 9, Patient cannot travel | 10, Other)	j2_end_of_the_data_collection;

*Checking participants who dropped out;
*3519 3522 3523 3525 3526 3529 3533 3540 4003 4008 4010 4023 4024 4028 4030;

proc freq data = mission;
tables record_id*withdrew_consent / nocol norow nopercent;
where withdrew_consent =1;
title "list of participants who withdrew consent";
run;

proc print data = mission;
var record_id redcap_event_name redcap_repeat_instrument redcap_repeat_instance withdrew_consent dt_withdrew death_event death_dt study_termination reason_study_terminatn mpd_occur mpd_dt;
where withdrew_consent =1 or death_event=1 or study_termination = 1 or mpd_occur = 1;
title "list of participants who could be missing data due to withdrawal (form J1), death (form I6), study termination (form J2) or major protocol deviation (form J3)";
run;

proc print data = mission;
var record_id redcap_event_name redcap_repeat_instrument redcap_repeat_instance withdrew_consent dt_withdrew death_event death_dt study_termination reason_study_terminatn;
where withdrew_consent =1 or death_event=1 or study_termination = 1;
title "list of participants who could be missing data due to withdrawal (form J1), death (form I6), study termination (form J2) or major protocol deviation (form J3)";
run;

*Checking participants who terminated the study early;
*4003 4008 4010;

proc freq data = mission;
tables record_id*study_termination / nocol norow nopercent;
run;

proc freq data = mission;
tables record_id*study_termination / nocol norow nopercent;
where study_termination =1;
title "list of participants who terminated the study early";
run;

*Cross checking the IDs that I excluded in previous MOSIO data cleanups;
*3502 3504 4006 4009 4003 4007 4010;

/*Generating descriptive statistics table for the poster
use Mission_MOSIO_REDCAP, clear

drop if participant == 3502
drop if participant == 3504
drop if participant == 4006
drop if participant == 4009
drop if participant == 4003
drop if participant == 4007
drop if participant == 4010*/

*Cross checking the participants who received myfortic from moataz "MISSION patient list 2222023.xlsx"
*3001 3003 3005;

*Cross checking the participants who received envarsus during PK;
*4017, 4019, 4036;

*Printing out the PIDs of participants who withdrew consent or terminated the study early for Tin to prep Blood DNA samples;

proc freq data = mission;
tables record_id*withdrew_consent / nocol norow nopercent;
where withdrew_consent =1;
title "list of participants who withdrew consent";
run;

proc freq data = mission;
tables record_id*study_termination / nocol norow nopercent;
where study_termination =1;
title "list of participants who terminated the study early";
run;

*Here are the PIDs who should be excluded due to withdrawal in the PS study;

proc print data = mission;
var record_id redcap_event_name redcap_repeat_instrument redcap_repeat_instance withdrew_consent dt_withdrew death_event death_dt study_termination reason_study_terminatn;
where withdrew_consent =1 or death_event=1 or study_termination = 1;
title "list of participants who were removed from the report due to withdrawal (form J1), death (form I6), study termination (form J2)";
run;

ods excel file="/home/u63327094/analysis_MISSION_PS_data_reports/ps_exclusion_blood.csv";

proc print data = mission;
var record_id redcap_event_name redcap_repeat_instrument redcap_repeat_instance withdrew_consent dt_withdrew death_event death_dt study_termination reason_study_terminatn;
where withdrew_consent =1 or death_event=1 or study_termination = 1;
title "list of participants who were removed from the report due to withdrawal (form J1), death (form I6), study termination (form J2)";
run;

ods excel close;

data btemp2;
set btemp;
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

*****************************************************************************************************************************;
*****************************************************************************************************************************;
*****************************************************************************************************************************;
 

*Based on the testing done above, I will simplify my macro to output the proc freqs, and then list out the missing values and package it all into a single rtf document;
*The last step would be to run the macro for each variable within an rtf procedure to get the output directly in a word file;
 
*here is the categorical variable macro with a barplot option for categorical variables;
*Also adding a format for the variables;

%let form = b1;

%macro categ(pred,i); 

proc freq data = &form;
tables &pred / plots=freqplot();
title "categorical report";
run;
 
proc print data = &form;
var record_id redcap_event_name redcap_repeat_instrument redcap_repeat_instance &pred; 
where &pred = . or " ";
title "missing observations for categorical report";
run;

%mend categ; 

*Here is the macro for continuous variables with a histogram option for the continuous variables;
*Changing from proc univariate to just the histogram to reduce the data generated;
*http://support.sas.com/kb/22/754.html; 
*Use ods select histogram before proc univariate;

%let form = b1;

%macro contin(pred,i); 

proc means data = &form n mean max min range std;
 where &pred ne . or " ";
 var &pred;
 title "continuous report";
 run; 
  
ods select histogram;
proc univariate data = &form;
 where &pred ne . or " ";
 histogram &pred/normal;
 title "figure for continuous report";
 run; 
 
proc print data = &form;
var record_id redcap_event_name redcap_repeat_instrument redcap_repeat_instance &pred; 
where &pred = . or " ";
title "missing observations for continuous report";
run;

%mend contin; 

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

*a1;
%selectvars(a1, 
site 
dt_first_text 
data_entered_bya1 
a1_participant_id_complete);
proc print data=mylib.a1;
run;

proc print data=mylib.a1; *No point changing the dataset name here as it was pulled from the macro selection;
run;

*a2;
%selectvars(a2, 
inclusn_criteria___1	
inclusn_criteria___2	
inclusn_criteria___3
inclusn_criteria___4	
inclusn_criteria___5	
inclusn_criteria___6
exclusion_criteria___1	
exclusion_criteria___2	
exclusion_criteria___3
exclusion_criteria___4	
exclusion_criteria___5	
exclusion_criteria___6
exclusion_criteria___7	
exclusion_criteria___8	
exclusion_criteria___9
exclusion_criteria___10	
exclusion_criteria___11
eligibility_confirm	
consent_form_signed	
future_studies
microbiome_samples
the_principal_investigator
leftover_samples
kidney_biopsy
nih
eval_sign	
a2_recipient_eligibilty_and_cons
		);
proc print data=mylib.a2;
run;


*a1;

data a1;
set mylib.a1;
run;

proc contents data = a1 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data a1;
set a1;
label 
site = "Participating Site"
dt_first_text = "Date of first diarrhea assessment text message"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value	site 4 = "HHRI" 3 = "UMN";
run;
					
data a1;
set a1;
format site site.;
run;	

proc sort data=a1;
by 
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc freq data=a1 noprint;
tables record_id / out=freqs;
proc freq data=freqs;
tables count;
run;

data mylib.a1clean;
set a1;
run;

*a2;

data a2;
set mylib.a2;
run;

proc contents data = a2 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data a2;
set a2;
label 
inclusn_criteria___1 = "1, Participant undergoing kidney transplant"
inclusn_criteria___2 = "2, Male or female at least 18 years of age at time of enrollment"
inclusn_criteria___3 = "3, Will or has received a living or deceased donor kidney transplant"
inclusn_criteria___4 = "4, Planned posttransplant immunosuppression regimen of mycophenolate mofetil dosed every 12 hours (Cellcept or generic) and immediate-release tacrolimus (dosed twice daily generic or brand formulation)."
inclusn_criteria___5 = "5, Able and willing to complete study-related procedures and events"
inclusn_criteria___6 = "6, Signs written informed consent and HIPAA form"
exclusion_criteria___1 = "1, Recipient of a previous non-kidney, non-pancreas transplant"
exclusion_criteria___2 = "2, Subject is a multi-organ transplant recipient; simultaneous pancreas and kidney (SPK) transplant is allowed and does not necessitate exclusion"
exclusion_criteria___3 = "3, Patient that takes medications that significantly impact (inhibit or induce) UGT enzymes 1A8, 1A9, and 1A10"
exclusion_criteria___4 = "4, Presence of active gastroparesis and documented in medical record"
exclusion_criteria___5 = "5, Liver dysfunction (total bilirubin >2x upper limit of normal) within 2 months of enrollment"
exclusion_criteria___6 = "6, Patients that take medications that significantly impact (inhibit or induce) the biliary transporters"
exclusion_criteria___7 = "7, Patient is known to be HIV positive"
exclusion_criteria___8 = "8, Pregnant or nursing (lactating) women"
exclusion_criteria___9 = "9, History of bariatric surgery"
exclusion_criteria___10 = "10, Non-English speaking"
exclusion_criteria___11 = "11, None of the above"
eligibility_confirm = "Based on the questions above is the participant eligible to participate in this study?"
consent_form_signed = "4. Did the participant sign an informed consent form?"
future_studies = "5. The study staff may contact me in the future to see whether I am interested in participating in other research studies conducted by the study staff"
microbiome_samples = "6. The principal investigator may retain any leftover blood or microbiome samples taken during the study. These samples may be used for other research not related to this study. These samples will be retained in non-identifiable form, meaning that there will be no information associated with the blood or samples that will allow anyone to readily ascertain my identity"
the_principal_investigator = "7. The principal investigator may retain any leftover blood DNA taken during the study. These samples may be used for other research not related to this study. These samples will be retained in a non-identifiable form, meaning that there will be no information associated with the blood or samples that will allow anyone to readily ascertain my identity"
leftover_samples = "8. The principal investigator may retain microbiome, genetic data, and clinical information related to the transplant for future research not related to this study."
kidney_biopsy = "9. If I have a clinically indicated kidney biopsy(ies) during my time of study participation (up to 12 years post-transplant), the principal investigator may utilize any leftover kidney biopsy tissue and pathology information about the biopsy for future research not related to this study."
nih = "10. The principal investigator may provide de-identified data collected in this study to National Institutes of Health repositories such as dbGap for other researchers to use."
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value	eligibility_confirm	1 = "yes" 0 = "no";
value	consent_form_signed	1 = "yes" 0	= "no";
value	future_studies	1 = "yes" 0 = "no" ;
value	microbiome_samples 1 = "yes" 0 = "no";
value	the_principal_investigator 1 = "yes" 0 = "no";
value	leftover_samples 1 = "yes" 0 = "no";
value	kidney_biopsy 1 = "yes" 0 = "no";
value	nih	1 = "yes" 0 = "no";
run;
					
data a2;
set a2;
format eligibility_confirm eligibility_confirm.;
format consent_form_signed consent_form_signed.;
format future_studies future_studies.;
format microbiome_samples microbiome_samples.;
format the_principal_investigator the_principal_investigator.;
format leftover_samples leftover_samples.;
format kidney_biopsy kidney_biopsy.;
format nih nih.;
run;					

proc sort data=a2;
by 
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc print data=a2;
run;

proc freq data=a2 noprint;
tables record_id / out=freqs;
proc freq data=freqs;
tables count;
run;

data mylib.a2clean;
set a2;
run;

** merge;

data mylib.aclean;
merge mylib.a1clean mylib.a2clean;
by record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;


proc freq data=mylib.aclean;
tables
inclusn_criteria___1
inclusn_criteria___2
inclusn_criteria___3
inclusn_criteria___4
inclusn_criteria___5
inclusn_criteria___6
exclusion_criteria___1
exclusion_criteria___2
exclusion_criteria___3
exclusion_criteria___4
exclusion_criteria___5
exclusion_criteria___6
exclusion_criteria___7
exclusion_criteria___8
exclusion_criteria___9
exclusion_criteria___10
exclusion_criteria___11
;
run;

proc print data=mylib.aclean (obs=10);
run;

proc contents data=mylib.aclean varnum;
run;

proc freq data=mylib.aclean noprint;
tables record_id / out=freqs;
proc freq data=freqs;
tables count;
run;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

***b;

*b1;
%selectvars(b1,
sex_2
sex
ethnicity	
race___1	
race___2	
race___3	
race___4	
race___5
race___6	
race___7
predom_race	
residence	
country_of_birth	
other_country	
donor_type	
birth_yr_ld	
sex_ld	
ethnicity_ld	
ancestry_ld___1	
ancestry_ld___2	
ancestry_ld___3	
ancestry_ld___4	
ancestry_ld___5	
ancestry_ld___6	
ancestry_ld___7		
race_ld	
birth_yr_dd	
sex_dd	
ethnicity_dd	
ancestry_dd___1	
ancestry_dd___2	
ancestry_dd___3	
ancestry_dd___4	
ancestry_dd___5	
ancestry_dd___6	
ancestry_dd___7	
race_dd	
data_entered_byb1	
b1_demographics_complete			
		);								
proc print data=mylib.b1;										
run;

*b2;
%selectvars(b2,
height_baseline	
weight_baseline_kg	
bmi_baseline	
smoking					
pets	
pets_count	
pets_type	
diabetes_pretx					
diabetes_treat_pretx___1	
diabetes_treat_pretx___2	
diabetes_treat_pretx___3	
diabetes_treat_pretx___4					
diabetes_treat_pretx___5	
diabetes_treat_pretx___6	
oral_hypogly_specific	
diabetes_treat_other					
age_at_diabetic_pretx	
past_diagnoses	
cor_artery_drug	
cor_artery_revascular					
cor_vas_drug	
cor_vas_revascular	
con_heart_fail	
highbp					
myocardialinf	
strok	
peri_vascular	
surg_peri_vascular					
hyperlipidemia_drug	malignancies	
past_malignancy___1	
past_malignancy___2					
past_malignancy___3	
past_malignancy___4	
past_malignancy___5	
past_malignancy___6					
past_malignancy___7	
past_malignancy___8	
other_malignacy	
height_donor_ld					
weight_donor_ld	
donor_scr_avail	
donor_scr_value	
dt_admissn_scr_ld					
donor_relationship	
donor_relation_type	
relation_type_other	
donor_bp					
cmv_donor_igg	
eb_donor	
hepb_donor	
hepc_donor					
height_donor_dd	
weight_donor_dd	
scr_donor_avail_dd	
donor_scr_value_dd					
dt_final_scr_dd	
donor_death_cause	
cause_death_other	
donor_bp_dd					
dcd	ecd	
dd_donor_diabetes	
kdpi					
cmv_dd_donor	
eb_dd_donor	
hepb_dd_donor	
hepc_dd_donor					
data_entered_byb2	
b2_recipient_baseline_medical_hi							
		);								
proc print data=mylib.b2;										
run;	

*b2a (added later on in the study;
%selectvars(b2a,
date_of_pk_visit	
height_at_pk	
weight_at_pk	
);								
proc print data=mylib.b2a;										
run;									
										
*b3;
%selectvars(b3,										
tx_dt
dt_hosp_discharge_posttx	
esrd_cause	
esrd_cause_glom_dis					
esrd_cause_glom_dis_other	
esrd_other	
cause_esrd_notes	
esrd_biopsy_confirm					
prev_tx	
donor_type_prevtx	
preemptive_tx	
initial_dialysis					
spk	plasmapheresis	
pre_im_biopsy	
int_fibr_per					
glom_scl	
tub_atr_per	
focl_inf_per	
art_hyl_per					
art_plaq_per	
atn	cyst	
calcificatn					
inst_fib	
tub_atr	
focl_inf	
art_hyl					
art_plaq	
mesangium	
cmv_recipient	
ebv_recipient					
hepb_recipient	
hepc_recipient	
data_entered_byb3	
b3_recipient_renal_disease_and_t					
		);								
proc print data=mylib.b3;										
run;										
										
*b4;
%selectvars(b4,										
med_dt_baseline	
htn_baseline	
htn_med_baseline___1	
htn_med_baseline___2					
htn_med_baseline___3	
htn_med_baseline___4	
htn_med_baseline___5	
htn_med_baseline___6					
htn_med_baseline___7	
htn_med_baseline___8	
htn_med_baseline___9	
htn_med_baseline___10					
htn_med_baseline___11	
htn_med_baseline___12	
other_htn_baseline	
lipid_baseline					
lipid_med_baseline___1	
lipid_med_baseline___2	
lipid_med_baseline___3	
lipid_med_baseline___4					
lipid_med_baseline___5	
lipid_med_baseline___6	
lipid_med_baseline___7	
other_lipid_med_baseline					
acidreducer_baseline	
acid_red_med_baseline___1	
acid_red_med_baseline___2	
acid_red_med_baseline___3					
acid_red_med_baseline___4	
other_acid_red_baseline	
antiviral_baseline	
antiviral_med_baseline___1					
antiviral_med_baseline___2	
antiviral_med_baseline___3	
antiviral_med_baseline___4	
antiviral_med_baseline___5					
antiviral_med_baseline___6	
other_antiviral_baseline	
antifungal_baseline	
antifungal_meds_baseline___1					
antifungal_meds_baseline___2	
antifungal_meds_baseline___3	
antifungal_meds_baseline___4	
antifungal_meds_baseline___5					
antifungal_meds_baseline___6	
antifungal_meds_baseline___7	
antifungal_meds_baseline___8	
antifungal_meds_baseline___9					
antifungal_meds_baseline___10	
antifungal_meds_baseline___11	
antifungal_meds_baseline___12	
antifungal_meds_baseline___13					
antifungal_meds_baseline___14	
other_antifungal_baseline	
antibiotics_baseline	
antibio_med_baseline___1					
antibio_med_baseline___2	
antibio_med_baseline___3	
antibio_med_baseline___4	
antibio_med_baseline___5					
antibio_med_baseline___6	
antibio_med_baseline___7	
antibio_med_baseline___8	
antibio_med_baseline___9					
antibio_med_baseline___10	
antibio_med_baseline___11	
antibio_med_baseline___12	
other_antibiotics_baseline					
probiotx_baseline	
immunospu_baseline	
immuno_baseline_list___1	
immuno_baseline_list___2					
immuno_baseline_list___3	
immuno_baseline_list___4	
immuno_baseline_list___5	
immuno_baseline_list___6					
other_immuno_baseline	
data_entered_byb4	
b4_baseline_pretransplant_concom						
		);								
proc print data=mylib.b4;										
run;										
										
*b5;
%selectvars(b5,										
cold_ischem_time	
pump_perfusn	
transfusion	
abx_preop					
abx_preop_med___1	
abx_preop_med___2	
abx_preop_med___3	
abx_preop_med___4					
abx_preop_med___5	
abx_preop_med___6	
abx_preop_med___7	
abx_preop_med___8					
abx_preop_med___9	
abx_preop_med___10	
abx_preop_med___11	
abx_preop_med___12					
other_abx_preop	
data_entered_byb5	
b5_operative_information_complet						
		);								
proc print data=mylib.b5;										
run;										
										
*b6;
%selectvars(b6,										
hlaa_status	
hlab_status	
hlac_status	
hladrb1_status					
hladpa1_status	
hladpb1_status	
hladqa1_status	
hladqb1_status					
hla_a_allele1	
hla_a_se1	
hla_a_allele2	
hla_a_se2					
hla_b_allele1	
hla_b_se1	
hla_b_allele2	
hla_b_se2					
hla_c_allele1	
hla_c_se1	
hla_c_allele2	
hla_c_se2					
hla_drb_allele1	
hla_drb_se1	
hla_drb_allele2	
hla_drb_se2					
hla_dqa_allele1	
hla_dqa_se1	
hla_dqa_allele2	
hla_dqa_se2					
hla_dqb_allele1	
hla_dqb_se1	
hla_dqb_allele2	
hla_dqb_se2					
hla_dpa_allele1	
hla_dpa_se1	
hla_dpa_allele2	
hla_dpa_se2					
hla_dpb_allele1	
hla_dpb_allele2	
hla_dpb_se1	
hla_dpb_se2					
drb5_status	
drb3_status	
drb4_status	
hla_drb5_allele1	
hla_drb5_se1	
hla_drb5_allele2	
hla_drb5_se2
hla_drb3_allele1	
hla_drb3_se1	
hla_drb3_allele2	
hla_drb3_se2
hla_drb4_allele1	
hla_drb4_se1	
hla_drb4_allele2	
hla_drb4_se2
data_entered_byb6					
b6_recipient_hla_typing_complete								
		);
proc print data=mylib.b6;
run;

*b7;
%selectvars(b7,										
hlaa_status_donor	
hlab_status_donor	
hlac_status_donor	
hladrb1_status_donor					
hladpa1_status_donor	
hladpb1_status_donor	
hladqa1_status_donor	
hladqb1_status_donor					
hla_a_allele1_donor	
hla_a_se1_donor	
hla_a_allele2_donor	
hla_a_se2_donor					
hla_b_allele1_donor	
hla_b_se1_donor	
hla_b_allele2_donor	
hla_b_se2_donor					
hla_c_allele1_donor	
hla_c_se1_donor	
hla_c_allele2_donor	
hla_c_se2_donor					
hla_drb_allele1_donor	
hla_drb_se1_donor	
hla_drb_allele2_donor	
hla_drb_se2_donor					
hla_dqa_allele1_donor	
hla_dqa_se1_donor	
hla_dqa_allele2_donor	
hla_dqa_se2_donor					
hla_dqb_allele1_donor	
hla_dqb_se1_donor	
hla_dqb_allele2_donor	
hla_dqb_se2_donor					
hla_dpa_allele1_donor	
hla_dpa_se1_donor	
hla_dpa_allele2_donor	
hla_dpa_se2_donor					
hla_dpb_allele1_donor	
hla_dpb_allele2_donor	
hla_dpb_se1_donor	
hla_dpb_se2_donor					
drb5_status_donor	
drb3_status_donor	
drb4_status_donor
hla_drb5_allele1_donor	
hla_drb5_se1_donor	
hla_drb5_allele2_donor	
hla_drb5_se2_donor
hla_drb3_allele1_donor	
hla_drb3_se1_donor	
hla_drb3_allele2_donor	
hla_drb3_se2_donor
hla_drb4_allele1_donor	
hla_drb4_se1_donor	
hla_drb4_allele2_donor	
hla_drb4_se2_donor
data_entered_byb7
b7_donor_hla_typing_complete
		);
proc print data=mylib.b7;
run;
										
*b8;
%selectvars(b8,										
pra_test	
pra_dt	
cpra	
pra_method					
data_entered_byb8	
b8_recipient_hla_antibodies_comp							
		);								
proc print data=mylib.b8;										
run;										
										
*b9;
%selectvars(b9,										
pra_test_specificity	
class1_a_specificities	
class1_a_specificities_value
class1_b_specificities	
class1_b_specificities_value
class1_c_specificities	
class1_c_specificities_value
class1_dr_specificities	
class1_dr_specificities_value
class1_dq_specificities	
class1_dq_specificities_value
class1_dp_specificities	
class1_dp_specificities_value
data_entered_byb9	
b9_recipient_pra_specificities_u						
		);
proc print data=mylib.b9;
run;

*b10;
%selectvars(b10,										
crossmatch_dt	
t_cell_x_match_result	
b_cell_x_match_result	
t_cell_x_match_method					
b_cell_x_match_method	
t_cell_mcs	
t_cell_mfi	
b_cell_mcs					
b_cell_mfi	
data_entered_byb10	
b10_crossmatch_test_complete						
		);								
proc print data=mylib.b10;										
run;	

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

**b1;

proc contents data=mylib.b1 order=varnum;
run;

data b1;
set mylib.b1;
rename sex_2 = age;
run;

data b1;
set b1;
keep
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
age
sex
ethnicity
race___1
race___2
race___3
race___4
race___5
race___6
race___7
predom_race
residence
country_of_birth
other_country
donor_type
birth_yr_ld
sex_ld
ethnicity_ld
ancestry_ld___1
ancestry_ld___2
ancestry_ld___3
ancestry_ld___4
ancestry_ld___5
ancestry_ld___6
ancestry_ld___7
race_ld
birth_yr_dd
sex_dd
ethnicity_dd
ancestry_dd___1
ancestry_dd___2
ancestry_dd___3
ancestry_dd___4
ancestry_dd___5
ancestry_dd___6
ancestry_dd___7
race_dd
;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data b1;
set b1;
label 
age = "Recipient Age at time of transplant"
sex = "Gender"
ethnicity = "Ethnicity"
race___1 = "Race checkbox = White"
race___2 = "Race checkbox = Black or African American"
race___3 = "Race checkbox = Asian"
race___4 = "Race checkbox = American Indian or Alaska Native"
race___5 = "Race checkbox = Native Hawaiian or other Pacific Islander"
race___6 = "Race checkbox = Unknown"
race___7 = "Race checkbox = Not Reported"
predom_race ="Predominant Race, select one"
residence = "Country of Residence"
country_of_birth ="Country of BIRTH"
other_country = "If country of BIRTH is other, specify it here"
donor_type ="Type of current kidney donor"
birth_yr_ld = "Year of Birth of the Living Kidney Donor"
sex_ld = "Gender of the Living Kidney Donor"
ethnicity_ld = "Ethnicity of the Living Kidney Donor"
ancestry_ld___1 = "Living Kidney Donor ancestry = White"
ancestry_ld___2 = "Living Kidney Donor ancestry = Black or African American"
ancestry_ld___3 = "Living Kidney Donor ancestry = Asian"
ancestry_ld___4 = "Living Kidney Donor ancestry = American Indian or Alaska Native"
ancestry_ld___5 = "Living Kidney Donor ancestry = Native Hawaiian or other Pacific Islander"
ancestry_ld___6 = "Living Kidney Donor ancestry = Unknown"
ancestry_ld___7 = "Living Kidney Donor ancestry = Not Reported"
race_ld = "Predominant race of the Living Kidney Donor (Select one)"
birth_yr_dd = "Year of Birth of the Deceased Kidney Donor"
sex_dd = "Gender of the Deceased Kidney Donor"
ethnicity_dd = "Ethnicity of the Deceased Kidney Donor"
ancestry_dd___1 = "Deceased Kidney Donor ancestry = White"
ancestry_dd___2 = "Deceased Kidney Donor ancestry = Black or African American"
ancestry_dd___3 = "Deceased Kidney Donor ancestry = Asian"
ancestry_dd___4 = "Deceased Kidney Donor ancestry = American Indian or Alaska Native"
ancestry_dd___5 = "Deceased Kidney Donor ancestry = Native Hawaiian or other Pacific Islander"
ancestry_dd___6 = "Deceased Kidney Donor ancestry = Unknown"
ancestry_dd___7 = "Deceased Kidney Donor ancestry = Not Reported"
race_dd = "Predominant race of the Deceased Kidney Donor (Select one)"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value sexf 1="Female" 2="Male" 3="Unknown" 4="Unspecified";
value ethnicityf 1="Hispanic or Latino" 2="Not Hispanic or Latino" 3="Unknown" 4="Unreported"; 
value predom_racef 1="White" 2="Black or African American" 3="Asian" 4="American Indian or Alaska  Native" 5="Native Hawaiian or other Pacific Islander" 6="Unknown" 7="Not Reported";
value country_of_birthf 1="Other country" 2="USA" 3="Unknown";
value donor_typef 1="Living donor" 2="Deceased donor"; 
value sex_ldf 1="Female" 2="Male" 3="Unknown" 4="Unspecified";
value ethnicity_ldf 1="Hispanic or Latino" 2="Not Hispanic or Latino" 3="Unknown" 4="Unreported"; 
value ancestry_ld___1f 1="Yes" 0="No";
value race_ldf 1="White" 2="Black or African American" 3="Asian" 4="American Indian or Alaska  Native" 5="Native Hawaiian or other Pacific Islander" 6="Unknown" 7="Not Reported";
value sex_ddf 1="Female" 2="Male" 3="Unknown" 4="Unspecified";
value ethnicity_ddf 1="Hispanic or Latino" 2="Not Hispanic or Latino" 3="Unknown" 4="Unreported"; 
value ancestry_dd___1f 1="Yes" 0="No";
value race_ddf 1="White" 2="Black or African American" 3="Asian" 4="American Indian or Alaska  Native" 5="Native Hawaiian or other Pacific Islander" 6="Unknown" 7="Not Reported";
run;

data b1;
set b1;
format sex sexf.;
format ethnicity ethnicityf.; 
format predom_race predom_racef.;
format country_of_birth country_of_birthf.;
format donor_type donor_typef.; 
format sex_ld sex_ldf.;
format ethnicity_ld ethnicity_ldf.; 
format ancestry_ld___1 ancestry_ld___1f.; 
format race_ld race_ldf.; 
format sex_dd sex_ddf.;
format ethnicity_dd ethnicity_ddf.; 
format ancestry_dd___1 ancestry_dd___1f.; 
format race_dd race_ddf.; 
run;

proc sort data=b1;
by 
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc freq data=b1;
tables
redcap_event_name redcap_repeat_instrument redcap_repeat_instance;
run;

data mylib.b1clean;
set b1;
run;

proc contents data=b1 order=varnum;
run;

/*
*Instead of trying to call the format variable in the macro, i will format in the datastep;

data b1test;
set b1;
format sex sex.;
run;

%let form = b1test;
%categ(sex,1);
%contin(age,2);
*/

**b2;

proc contents data=mylib.b2 order=varnum;
run;

data b2;
set mylib.b2;
keep
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
height_baseline
weight_baseline_kg
bmi_baseline
smoking
pets
pets_count
pets_type
diabetes_pretx
diabetes_treat_pretx___1
diabetes_treat_pretx___2
diabetes_treat_pretx___3
diabetes_treat_pretx___4
diabetes_treat_pretx___5
diabetes_treat_pretx___6
oral_hypogly_specific
diabetes_treat_other
age_at_diabetic_pretx
past_diagnoses
cor_artery_drug
cor_artery_revascular
cor_vas_drug
cor_vas_revascular
con_heart_fail
highbp
myocardialinf
strok
peri_vascular
surg_peri_vascular
hyperlipidemia_drug
malignancies
past_malignancy___1
past_malignancy___2
past_malignancy___3
past_malignancy___4
past_malignancy___5
past_malignancy___6
past_malignancy___7
past_malignancy___8
other_malignacy
height_donor_ld
weight_donor_ld
donor_scr_avail
donor_scr_value
dt_admissn_scr_ld
donor_relationship
donor_relation_type
relation_type_other
donor_bp
cmv_donor_igg
eb_donor
hepb_donor
hepc_donor
height_donor_dd
weight_donor_dd
scr_donor_avail_dd
donor_scr_value_dd
dt_final_scr_dd
donor_death_cause
cause_death_other
donor_bp_dd
dcd
ecd
dd_donor_diabetes
kdpi
cmv_dd_donor
eb_dd_donor
hepb_dd_donor
hepc_dd_donor
;
run;

data b2;
set b2;
Label
height_baseline = "Participant Height in inches -  baseline"
weight_baseline_kg = "Participant Weight in kg  - baseline"
bmi_baseline = "Participant BMI - baseline"
smoking = "Participant Smoking status"
pets = "Does the participant have any pets?"
pets_count = "If yes, how many?"
pets_type = "Select all the pets the participant has"
diabetes_pretx = "Has the participant been diagnosed with diabetes?"
diabetes_treat_pretx___1 = "Does the participant require treatment with Insulin for diabetes before the transplant?"
diabetes_treat_pretx___2 = "Does the participant require treatment with Oral hypoglycemic agents for diabetes before the transplant?"
diabetes_treat_pretx___3 = "Does the participant require treatment with Diet, alone for diabetes before the transplant?"
diabetes_treat_pretx___4 = "Does the participant require treatment with Other for diabetes before the transplant?"
diabetes_treat_pretx___5 = "Does the participant require treatment with Unknown for diabetes before the transplant?"
diabetes_treat_pretx___6 = "Does the participant require treatment with None for diabetes before the transplant?"
oral_hypogly_specific = "If oral hypoglycemic agents, please specify"
diabetes_treat_other = "If Other required treatment of diabetes was selected, please specify"
age_at_diabetic_pretx = "At what age was the diagnosis of diabetes made?"
past_diagnoses = "Does the participant have any past diagnoses to report?"
cor_artery_drug = "Coronary artery disease requiring drug treatment"
cor_artery_revascular = "Coronary artery disease requiring invasive or surgical procedure (revascularization)"
cor_vas_drug = "Coronary vascular disease requiring drug treatment"
cor_vas_revascular = "Coronary vascular disease requiring invasive or surgical procedure (revascularization)"
con_heart_fail = "Congestive heart failure"
highbp = "Hypertension requiring treatment"
myocardialinf = "Myocardial infarction"
strok = "Stroke"
peri_vascular = "Peripheral vascular disease (excluding venous disease)"
surg_peri_vascular = "Peripheral vascular disease requiring invasive or surgical procedure (revascularization or amputation)"
hyperlipidemia_drug = "Hyperlipidemia requiring drug treatment"
malignancies = "Malignancies"
past_malignancy___1 = "Past malignancies = Bone marrow ( e.g. leukemia,multiple myeloma)"
past_malignancy___2 = "Past malignancies = Brain"
past_malignancy___3 = "Past malignancies = Breast"
past_malignancy___4 = "Past malignancies = Colon"
past_malignancy___5 = "Past malignancies = Esophagus"
past_malignancy___6 = "Past malignancies = Gastrointestinal tract"
past_malignancy___7 = "Past malignancies = Kidney malignancy"
past_malignancy___8 = "Past malignancies = Other"
other_malignacy = "If other malignancy was chosen in the previous field, please specify it here"
height_donor_ld = "Living kidney donor Height in inches"
weight_donor_ld = "Living kidney donor Weight in kg"
donor_scr_avail = "Is the living kidney donor's admission serum Creatinine measurement available?"
donor_scr_value = "If yes, what is the value of living kidney donor serum Creatinine closest to the time of admission"
dt_admissn_scr_ld = "Living kidney donor serum Creatinine draw date"
donor_relationship = "Was the living kidney donor biologically related to the recipient"
donor_relation_type = "Living kidney donor relation to recipient"
relation_type_other = "If other relationship, specify"
donor_bp = "Does the living kidney donor have a history of hypertension"
cmv_donor_igg = "CMV serostatus (IgG)"
eb_donor = "Epstein-Barr (IgG)"
hepb_donor = "Hepatitis B (Hep B sAg)"
hepc_donor = "Hepatitis C"
height_donor_dd = "Deceased kidney donor height in inches"
weight_donor_dd = "Deceased kidney donor  weight in kg"
scr_donor_avail_dd = "Is the deceased kidney donor serum Creatinine measurement available?"
donor_scr_value_dd = "If yes, what is the final deceased kidney donor serum Creatinine value?"
dt_final_scr_dd = "Final deceased kidney donor serum Creatinine draw date"
donor_death_cause = "Primary cause of donor death"
cause_death_other = "If cause of death is other, specify"
donor_bp_dd = "Did the deceased kidney donor have a history of hypertension"
dcd = "Is this donation a donation after cardiac death (DCD)"
ecd = "Is this donor considered an expanded criteria donor (ECD)"
dd_donor_diabetes = "Did the donor have a history of diabetes?"
kdpi = "Donor KDPI (kidney donor profile index) as provided by UNOS"
cmv_dd_donor = "CMV serostatus (IgG)"
eb_dd_donor = "Epstein-Barr (IgG)"
hepb_dd_donor = "Hepatitis B ( Hep B sAg)"
hepc_dd_donor = "Hepatitis C"
;
run;

proc format;
value smokingf 1="Current Smoker" 2="Former Smoker" 3="Never Smoker, <100 cigarettes in life time";
value petsf 1="Yes" 0="No" 2="Unknown"; 
value pets_typef 1="Dog" 2="Cat" 3="Other";
value diabetes_treat_pretx___1f 1="Yes" 0="No";
value diabetes_treat_pretx___2f 1="Yes" 0="No";
value oral_hypogly_specificf 1="Biguanides" 2="Sulfonylureas" 3="Combination medication of sulfonylureas and metformin" 4="Thiazolidinediones" 5="Alpha-glucosidase inhibitors" 6="Meglitinides" 7="SGLT2 Inhibitors";
value cor_artery_drugf 1="Yes" 0="No";
value cor_artery_revascularf 1="Yes" 0="No";
value cor_vas_drugf 1="Yes" 0="No";
value cor_vas_revascularf 1="Yes" 0="No";
value con_heart_failf 1="Yes" 0="No";
value highbpf 1="Yes" 0="No";
value myocardialinff 1="Yes" 0="No";
value strokf 1="Yes" 0="No";
value peri_vascularf 1="Yes" 0="No";
value surg_peri_vascularf 1="Yes" 0="No";
value hyperlipidemia_drugf 1="Yes" 0="No";
value malignanciesf 1="Yes" 0="No";
value past_malignancy___1f 1="Bone marrow" 2="Brain" 3="Breast" 4="Colon" 5="Esophagus" 6="Gastrointestinal tract" 7="Kidney malignancy" 8="Other";
value donor_scr_availf  1="Yes" 0="No";
value donor_relation_typef 1="Child" 2="Parent" 3="Sibling-identical twin" 4="Sibling - HLA identical (not identical twin)" 5="Sibling - Not HLA identical" 6="Uncle or Aunt" 7="Other";
value donor_bpf 1="Yes" 2="No" 3="Unknown";
value cmv_donor_iggf  1="Positive" 2="Negative" 3="Indeterminate/equivocal" 4="Not available / not done";
value eb_donorf 1="Positive" 2="Negative" 3="Indeterminate/equivocal" 4="Not available / not done";
value hepb_donorf 1="Positive" 2="Negative" 3="Indeterminate/equivocal" 4="Not available / not done";
value hepc_donorf 1="Positive" 2="Negative" 3="Indeterminate/equivocal" 4="Not available / not done";
value scr_donor_avail_ddf 1="Yes" 0="No";
value donor_death_causef 1="Not Available" 2="Anoxia" 3="Cerebrovascular/Stroke" 4="Head trauma" 5="CNS tumor" 6="Other";
value donor_bp_ddf 1="Yes" 2="No" 3="Unknown";
value dcdf 1="Yes" 2="No" 3="Unknown";
value dd_donor_diabetesf 1="Yes" 2="No" 3="Unknown";
value cmv_dd_donorf 1="Positive" 2="Negative" 3="Indeterminate/equivocal" 4="Not available / not done";
value eb_dd_donorf 1="Positive" 2="Negative" 3="Indeterminate/equivocal" 4="Not available / not done";
value hepb_dd_donorf 1="Positive" 2="Negative" 3="Indeterminate/equivocal" 4="Not available / not done";
value hepc_dd_donorf 1="Positive" 2="Negative" 3="Indeterminate/equivocal" 4="Not available / not done";
run;

data b2;
set b2;
format smoking smokingf.;
format pets petsf.; 
format pets_type pets_typef.;
format diabetes_treat_pretx___1 diabetes_treat_pretx___1f.;
format diabetes_treat_pretx___2 diabetes_treat_pretx___2f.;
format oral_hypogly_specific oral_hypogly_specificf.;
format cor_artery_drug cor_artery_drugf.;
format cor_artery_revascular cor_artery_revascularf.;
format cor_vas_drug cor_vas_drugf.;
format cor_vas_revascular cor_vas_revascularf.;
format con_heart_fail con_heart_failf.;
format highbp highbpf.;
format myocardialinf myocardialinff.;
format strok strokf.;
format peri_vascular peri_vascularf.;
format surg_peri_vascular surg_peri_vascularf.;
format hyperlipidemia_drug hyperlipidemia_drugf.;
format malignancies malignanciesf.;
format past_malignancy___1 past_malignancy___1f.;
format donor_scr_availf donor_scr_availf.;
format donor_relation_type donor_relation_typef.;
format donor_bp donor_bpf.;
format cmv_donor_igg  cmv_donor_iggf.;
format eb_donor eb_donorf.;
format hepb_donor hepb_donorf.;
format hepc_donor hepc_donorf.;
format scr_donor_avail_dd scr_donor_avail_ddf.;
format donor_death_cause donor_death_causef.;
format donor_bp_dd donor_bp_ddf.;
format dcd dcdf.;
format dd_donor_diabetes dd_donor_diabetesf.;
format cmv_dd_donor cmv_dd_donorf.;
format eb_dd_donor eb_dd_donorf.;
format hepb_dd_donor hepb_dd_donorf.;
format hepc_dd_donor hepc_dd_donorf.;
run;

proc sort data=b2;
by 
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc freq data=b2;
tables
redcap_event_name redcap_repeat_instrument redcap_repeat_instance;
run;

data mylib.b2clean;
set b2;
run;

proc contents data=b2 order=varnum;
run;

proc print data = b2;
var kdpi cause_death_other scr_donor_avail_dd relation_type_other diabetes_treat_other pets_count;
run;

**b2a;

proc contents data=mylib.b2a order=varnum;
run;

data b2a;
set mylib.b2a;
keep
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
date_of_pk_visit	
height_at_pk	
weight_at_pk	
;
run;

data b2a;
set b2a;
label
date_of_pk_visit = "Date of PK visit"	
height_at_pk = "Participant height in inches at time of PK visit"	
weight_at_pk = "Participant Weight in kilograms at time of PK Visit"	
;
run;

proc sort data=b2a;
by 
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc print data = b2a;
run;

proc freq data=b2a;
tables
redcap_event_name redcap_repeat_instrument redcap_repeat_instance;
run;

data mylib.b2aclean;
set b2a;
run;

/*
data  b2a;
set mylib.b2aclean;
run;

data b2a;
set b2a;
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

proc print data = b2a label;
var record_id date_of_pk_visit;
title "the data for form B2a looks good to me, no additional queries at this stage";
run;

%let form = b2a;
%contin(height_at_pk);
%contin(weight_at_pk);

*/

**b3;

proc contents data=mylib.b3 order=varnum;
run;

data b3;
set mylib.b3;
keep
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
tx_dt
dt_hosp_discharge_posttx
esrd_cause
esrd_cause_glom_dis
esrd_cause_glom_dis_other
esrd_other
cause_esrd_notes
esrd_biopsy_confirm
prev_tx
donor_type_prevtx
preemptive_tx
initial_dialysis
spk
plasmapheresis
pre_im_biopsy
int_fibr_per
glom_scl
tub_atr_per
focl_inf_per
art_hyl_per
art_plaq_per
atn
cyst
calcificatn
inst_fib
tub_atr
focl_inf
art_hyl
art_plaq
mesangium
cmv_recipient
ebv_recipient
hepb_recipient
hepc_recipient
;
run;

data b3;
set b3;
label
tx_dt = "Date of Transplant"
dt_hosp_discharge_posttx = "Date of Hospital Discharge Post-Transplant"
esrd_cause = "Primary Cause of Original Kidney Disease/ ESRD (IgA Nephropathy is under Glomerular disease)"
esrd_cause_glom_dis = "If Glomerular disease was the primary cause of original kidney disease, please specify"
esrd_cause_glom_dis_other = "If other glomerular disease, please specify"
esrd_other = "If other glomerular disease, please specify"
cause_esrd_notes = "Please write notes/comments regarding other cause of ESRD if necessary"
esrd_biopsy_confirm = "Was the primary cause diagnosis of ESRD confirmed by biopsy? "
prev_tx = "Is this the participant's first kidney transplant?"
donor_type_prevtx = "If this is not the participant's first kidney transplant, what type of organ donor was the previous kidney transplant?"
preemptive_tx = "Was this current transplant pre-emptive?"
initial_dialysis = "If no, provide the date of initial dialysis treatment"
spk = "Did the subject receive a simultaneous kidney and pancreas (SPK) during the most recent transplant?"
plasmapheresis = "Did the participant receive plasmapheresis on or within 14 days prior to the date of recent transplant?"
pre_im_biopsy = "Did the participant have a pre-implantation donor biopsy prior to this current transplant?"
int_fibr_per = "Cortex with interstitial fibrosis percent"
glom_scl = "Percent glomerulosclerosis"
tub_atr_per = "Cortex with tubular atrophy percent"
focl_inf_per = "Cortex with focal inflammation percent"
art_hyl_per = "Arterioles with hyalinosis percent"
art_plaq_per = "Arterioles plaque percent"
atn = "Acute tubular necrosis (ATN)"
cyst = "Presence of cyst"
calcificatn = "Presence of calcification"
inst_fib = "Cortex with Interstitial fibrosis"
tub_atr = "Cortex with tubular atrophy"
focl_inf = "Cortex with focal inflammation"
art_hyl = "Arterioles with hyalinosis"
art_plaq = "Arterioles plaque"
mesangium = "Increased mesangium"
cmv_recipient = "CMV serostatus (IgG)"
ebv_recipient = "Epstein-Barr (IgG)"
hepb_recipient = "Hepatitis B (Hep B sAg)"
hepc_recipient = "Hepatitis C"
;
run;

proc format;
value esrd_cause 1="Glomerular disease" 2="Diabetes" 3="Polycystic kidney disease" 4="Hypertensive nephrosclerosis" 5="Renovascular and other vascular disease" 6="Congenital or rare familial or metabolic disease" 7="Tubular and interstitial disease" 8="Neoplasm" 9="Other" 10="Unknown or not reported";
value esrd_cause_glom_dis 1="IgA Nephropathy" 2="Other glomerular disease";
value esrd_biopsy_confirm 1="Yes" 2="No" 3="Unknown";
value donor_type_prevtx 1="Living Donor" 2="Dead Donor";
value atn 1="Present" 2="Absent";
value inst_fib 1="Mild" 2="Moderate" 3="Severe" 4="Not available/Not reported" ;
value tub_atr 1="Mild" 2="Moderate" 3="Severe" 4="Not available/Not reported" ;
value focl_inf 1="Mild" 2="Moderate" 3="Severe" 4="Not available/Not reported" ;
value art_hyl 1="Mild" 2="Moderate" 3="Severe" 4="Not available/Not reported" ;
value art_plaq 1="Mild" 2="Moderate" 3="Severe" 4="Not available/Not reported" ;
value mesangium 1="Mild" 2="Moderate" 3="Severe" 4="Not available/Not reported" ;
value cmv_recipient 1="Positive" 2="Negative" 3="Indeterminate/equivocal" 4="Not available / not done";
value ebv_recipient 1="Positive" 2="Negative" 3="Indeterminate/equivocal" 4="Not available / not done";
value hepb_recipient 1="Positive" 2="Negative" 3="Indeterminate/equivocal" 4="Not available / not done";
value hepc_recipient 1="Positive" 2="Negative" 3="Indeterminate/equivocal" 4="Not available / not done";
run;

data b3;
set b3;
format esrd_cause esrd_cause.;
format esrd_cause_glom_dis esrd_cause_glom_dis.;
format esrd_biopsy_confirm esrd_biopsy_confirm.;
format donor_type_prevtx donor_type_prevtx.;
format atn atn.;
format inst_fib inst_fib.;
format tub_atr tub_atr.;
format focl_inf focl_inf.;
format art_hyl art_hyl.;
format art_plaq art_plaq.;
format mesangium mesangium.;
format cmv_recipient cmv_recipient.;
format ebv_recipient ebv_recipient.;
format hepb_recipient hepb_recipient.;
format hepc_recipient hepc_recipient.;
run;

proc sort data=b3;
by 
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc freq data=b3;
tables
redcap_event_name redcap_repeat_instrument redcap_repeat_instance;
run;

data mylib.b3clean;
set b3;
run;

proc contents data=b3 order=varnum;
run;

**b4;

proc contents data=mylib.b4 order=varnum;
run;

data b4;
set mylib.b4;
keep
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
med_dt_baseline
htn_baseline
htn_med_baseline___1
htn_med_baseline___2
htn_med_baseline___3
htn_med_baseline___4
htn_med_baseline___5
htn_med_baseline___6
htn_med_baseline___7
htn_med_baseline___8
htn_med_baseline___9
htn_med_baseline___10
htn_med_baseline___11
htn_med_baseline___12
other_htn_baseline
lipid_baseline
lipid_med_baseline___1
lipid_med_baseline___2
lipid_med_baseline___3
lipid_med_baseline___4
lipid_med_baseline___5
lipid_med_baseline___6
lipid_med_baseline___7
other_lipid_med_baseline
acidreducer_baseline
acid_red_med_baseline___1
acid_red_med_baseline___2
acid_red_med_baseline___3
acid_red_med_baseline___4
other_acid_red_baseline
antiviral_baseline
antiviral_med_baseline___1
antiviral_med_baseline___2
antiviral_med_baseline___3
antiviral_med_baseline___4
antiviral_med_baseline___5
antiviral_med_baseline___6
other_antiviral_baseline
antifungal_baseline
antifungal_meds_baseline___1
antifungal_meds_baseline___2
antifungal_meds_baseline___3
antifungal_meds_baseline___4
antifungal_meds_baseline___5
antifungal_meds_baseline___6
antifungal_meds_baseline___7
antifungal_meds_baseline___8
antifungal_meds_baseline___9
antifungal_meds_baseline___10
antifungal_meds_baseline___11
antifungal_meds_baseline___12
antifungal_meds_baseline___13
antifungal_meds_baseline___14
other_antifungal_baseline
antibiotics_baseline
antibio_med_baseline___1
antibio_med_baseline___2
antibio_med_baseline___3
antibio_med_baseline___4
antibio_med_baseline___5
antibio_med_baseline___6
antibio_med_baseline___7
antibio_med_baseline___8
antibio_med_baseline___9
antibio_med_baseline___10
antibio_med_baseline___11
antibio_med_baseline___12
other_antibiotics_baseline
probiotx_baseline
immunospu_baseline
immuno_baseline_list___1
immuno_baseline_list___2
immuno_baseline_list___3
immuno_baseline_list___4
immuno_baseline_list___5
immuno_baseline_list___6
other_immuno_baseline
;
run;

data b4;
set b4;
Label
med_dt_baseline = "Date of baseline medication snapshot"
htn_baseline = "Is the subject currently given any antihypertensive medications?"
htn_med_baseline___1 = "Indicate which Baseline Hypertensive Medications the subject is currently taking = Diuretics"
htn_med_baseline___2 = "Indicate which Baseline Hypertensive Medications the subject is currently taking = Aldosterone receptor blockers"
htn_med_baseline___3 = "Indicate which Baseline Hypertensive Medications the subject is currently taking = Beta Blockers"
htn_med_baseline___4 = "Indicate which Baseline Hypertensive Medications the subject is currently taking = Ace Inhibitors"
htn_med_baseline___5 = "Indicate which Baseline Hypertensive Medications the subject is currently taking = Angiotensin II antagonists"
htn_med_baseline___6 = "Indicate which Baseline Hypertensive Medications the subject is currently taking = Calcium Channel Blockers GROUP 1"
htn_med_baseline___7 = "Indicate which Baseline Hypertensive Medications the subject is currently taking = Calcium Channel Blockers GROUP 2"
htn_med_baseline___8 = "Indicate which Baseline Hypertensive Medications the subject is currently taking = Calcium Channel Blockers GROUP 3"
htn_med_baseline___9 = "Indicate which Baseline Hypertensive Medications the subject is currently taking = Central alpha-2 agonists and other centrally acting drugs"
htn_med_baseline___10 = "Indicate which Baseline Hypertensive Medications the subject is currently taking = Direct vasodilators"
htn_med_baseline___11 = "Indicate which Baseline Hypertensive Medications the subject is currently taking = Alpha-1 blockers"
htn_med_baseline___12 = "Indicate which Baseline Hypertensive Medications the subject is currently taking = Other"
other_htn_baseline = "If yes to other antihypertensive medication, please specify"
lipid_baseline = "Is this participant currently given any antilipemic (cholesterol lowering) medications?" 
lipid_med_baseline___1 = "Baseline Antilipemic Medications = Statins [HMG CoA reductase inhibitors]"
lipid_med_baseline___2 = "Baseline Antilipemic Medications = Bile acid sequestrants"
lipid_med_baseline___3 = "Baseline Antilipemic Medications = Nicotinic acid"
lipid_med_baseline___4 = "Baseline Antilipemic Medications = Fibric acids"
lipid_med_baseline___5 = "Baseline Antilipemic Medications = Fish Oil"
lipid_med_baseline___6 = "Baseline Antilipemic Medications = Cholesterol absorption inhibitors"
lipid_med_baseline___7 = "Baseline Antilipemic Medications = Other"
other_lipid_med_baseline = "If yes to otherantilipemic medication, please specify"
acidreducer_baseline = "Is this participant currently taking any GI acid-reducing medications"
acid_red_med_baseline___1 = "Acid-reducing medications = Proton pump inhibitor"
acid_red_med_baseline___2 = "Acid-reducing medications = Ranitidine, Famotidine"
acid_red_med_baseline___3 = "Acid-reducing medications = Antacids"
acid_red_med_baseline___4 = "Acid-reducing medications = Other"
other_acid_red_baseline = "If yes to other acid-reducing medication, please specify"
antiviral_baseline = "Is this participant currently given any prophylactic antiviral agents"
antiviral_med_baseline___1 = "Antiviral agents = Valganciclovir" 
antiviral_med_baseline___2 = "Antiviral agents = Valacyclovir"
antiviral_med_baseline___3 = "Antiviral agents = Acyclovir"
antiviral_med_baseline___4 = "Antiviral agents = Ganciclovir"
antiviral_med_baseline___5 = "Antiviral agents = Other"
antiviral_med_baseline___6 = "Antiviral agents = Unknown"
other_antiviral_baseline = "If yes to other antiviral agents please specify"
antifungal_baseline = "Is the subject currently given any antifungal agents"
antifungal_meds_baseline___1 = "Antifungal Agents = Ketoconazole"
antifungal_meds_baseline___2 = "Antifungal Agents = Itraconazole"
antifungal_meds_baseline___3 = "Antifungal Agents = Fluconazole"
antifungal_meds_baseline___4 = "Antifungal Agents = Voriconazole"
antifungal_meds_baseline___5 = "Antifungal Agents = Posaconazole"
antifungal_meds_baseline___6 = "Antifungal Agents = Clotrimazole"
antifungal_meds_baseline___7 = "Antifungal Agents = Nystatin"
antifungal_meds_baseline___8 = "Antifungal Agents = Isavuconazole"
antifungal_meds_baseline___9 = "Antifungal Agents = Caspofungin"
antifungal_meds_baseline___10 = "Antifungal Agents = Anidulafungin"
antifungal_meds_baseline___11 = "Antifungal Agents = Micafungin"
antifungal_meds_baseline___12 = "Antifungal Agents = Amphotericin"
antifungal_meds_baseline___13 = "Antifungal Agents = Other"
antifungal_meds_baseline___14 = "Antifungal Agents = Unknown"
other_antifungal_baseline = "If yes to other antifungal agents please specify"
antibiotics_baseline = "Is the subject currently given any antibiotics for infection?"
antibio_med_baseline___1 = "Antibiotics = Aminoglycosides"
antibio_med_baseline___2 = "Antibiotics = Cephalosporin"
antibio_med_baseline___3 = "Antibiotics = Dapsone"
antibio_med_baseline___4 = "Antibiotics = Fluoroquinolone"
antibio_med_baseline___5 = "Antibiotics = Glycopeptides"
antibio_med_baseline___6 = "Antibiotics = Macrolides"
antibio_med_baseline___7 = "Antibiotics = Penicillin"
antibio_med_baseline___8 = "Antibiotics = Sulfonamide"
antibio_med_baseline___9 = "Antibiotics = Tetracylcine"
antibio_med_baseline___10 = "Antibiotics = Metronidazole"
antibio_med_baseline___11 = "Antibiotics = Other"
antibio_med_baseline___12 = "Antibiotics = Unknown"
other_antibiotics_baseline = "If yes to other antibiotics please specify"
probiotx_baseline = "Is the subject currently taking any probiotics?"
immunospu_baseline = "Is the subject taking any immunosuppression medication at baseline?"
immuno_baseline_list___1 = "If yes, select all that apply = Cyclosporine"
immuno_baseline_list___2 = "If yes, select all that apply = Tacrolimus"
immuno_baseline_list___3 = "If yes, select all that apply = Mycophenolate"
immuno_baseline_list___4 = "If yes, select all that apply = Steroid, oral"
immuno_baseline_list___5 = "If yes, select all that apply = Azathioprine"
immuno_baseline_list___6 = "If yes, select all that apply = Other"
other_immuno_baseline = "If other, specify"
;
run;

proc format;
value htn_baselinef 1="Yes" 2="No" 3="Unknown";
value htn_med_baseline___1f 1="Yes" 0 = "No";
value htn_med_baseline___2f 1="Yes" 0 = "No";
value htn_med_baseline___3f 1="Yes" 0 = "No";
value htn_med_baseline___4f 1="Yes" 0 = "No";
value htn_med_baseline___5f 1="Yes" 0 = "No";
value htn_med_baseline___6f 1="Yes" 0 = "No";
value htn_med_baseline___7f 1="Yes" 0 = "No";
value htn_med_baseline___8f 1="Yes" 0 = "No";
value htn_med_baseline___9f 1="Yes" 0 = "No";
value htn_med_baseline___10f 1="Yes" 0 = "No";
value htn_med_baseline___11f 1="Yes" 0 = "No";
value htn_med_baseline___12f 1="Yes" 0 = "No";
value lipid_baselinef 1="Yes" 2="No" 3="Unknown";
value lipid_med_baseline___1f 1="Yes" 0 = "No";
value lipid_med_baseline___2f 1="Yes" 0 = "No";
value lipid_med_baseline___3f 1="Yes" 0 = "No";
value lipid_med_baseline___4f 1="Yes" 0 = "No";
value lipid_med_baseline___5f 1="Yes" 0 = "No";
value lipid_med_baseline___6f 1="Yes" 0 = "No";
value lipid_med_baseline___7f 1="Yes" 0 = "No";
value acidreducer_baselinef 1="Yes" 2="No" 3="Unknown";
value acid_red_med_baseline___1f 1="Yes" 0 = "No";
value acid_red_med_baseline___2f 1="Yes" 0 = "No";
value acid_red_med_baseline___3f 1="Yes" 0 = "No";
value acid_red_med_baseline___4f 1="Yes" 0 = "No";
value antiviral_baselinef 1="Yes" 2="No" 3="Unknown";
value antiviral_med_baseline___1f 1="Yes" 0 = "No";
value antiviral_med_baseline___2f 1="Yes" 0 = "No";
value antiviral_med_baseline___3f 1="Yes" 0 = "No";
value antiviral_med_baseline___4f 1="Yes" 0 = "No";
value antiviral_med_baseline___5f 1="Yes" 0 = "No";
value antiviral_med_baseline___6f 1="Yes" 0 = "No";
value antifungal_baselinef 1="Yes" 2="No" 3="Unknown";
value antifungal_meds_baseline___1f 1="Yes" 0 = "No";
value antifungal_meds_baseline___2f 1="Yes" 0 = "No";
value antifungal_meds_baseline___3f 1="Yes" 0 = "No";
value antifungal_meds_baseline___4f 1="Yes" 0 = "No";
value antifungal_meds_baseline___5f 1="Yes" 0 = "No";
value antifungal_meds_baseline___6f 1="Yes" 0 = "No";
value antifungal_meds_baseline___7f 1="Yes" 0 = "No";
value antifungal_meds_baseline___8f 1="Yes" 0 = "No";
value antifungal_meds_baseline___9f 1="Yes" 0 = "No";
value antifungal_meds_baseline___10f 1="Yes" 0 = "No";
value antifungal_meds_baseline___11f 1="Yes" 0 = "No";
value antifungal_meds_baseline___12f 1="Yes" 0 = "No";
value antifungal_meds_baseline___13f 1="Yes" 0 = "No";
value antifungal_meds_baseline___14f 1="Yes" 0 = "No";
value antibiotics_baselinef 1="Yes" 2="No" 3="Unknown";
value antibio_med_baseline___1f 1="Yes" 0 = "No";
value antibio_med_baseline___2f 1="Yes" 0 = "No";
value antibio_med_baseline___3f 1="Yes" 0 = "No";
value antibio_med_baseline___4f 1="Yes" 0 = "No";
value antibio_med_baseline___5f 1="Yes" 0 = "No";
value antibio_med_baseline___6f 1="Yes" 0 = "No";
value antibio_med_baseline___7f 1="Yes" 0 = "No";
value antibio_med_baseline___8f 1="Yes" 0 = "No";
value antibio_med_baseline___9f 1="Yes" 0 = "No";
value antibio_med_baseline___10f 1="Yes" 0 = "No";
value antibio_med_baseline___11f 1="Yes" 0 = "No";
value antibio_med_baseline___12f 1="Yes" 0 = "No";
value probiotx_baselinef 1="Yes" 2="No" 3="Unknown";
value immunospu_baselinef 1="Yes" 2="No" 3="Unknown";
value immuno_baseline_list___1f 1="Yes" 0 = "No";
value immuno_baseline_list___2f 1="Yes" 0 = "No";
value immuno_baseline_list___3f 1="Yes" 0 = "No";
value immuno_baseline_list___4f 1="Yes" 0 = "No";
value immuno_baseline_list___5f 1="Yes" 0 = "No";
value immuno_baseline_list___6f 1="Yes" 0 = "No";
run;

data b4;
set b4;
format	htn_baseline	htn_baselinef.;
format	htn_med_baseline___1	htn_med_baseline___1f.;
format	htn_med_baseline___2	htn_med_baseline___2f.;
format	htn_med_baseline___3	htn_med_baseline___3f.;
format	htn_med_baseline___4	htn_med_baseline___4f.;
format	htn_med_baseline___5	htn_med_baseline___5f.;
format	htn_med_baseline___6	htn_med_baseline___6f.;
format	htn_med_baseline___7	htn_med_baseline___7f.;
format	htn_med_baseline___8	htn_med_baseline___8f.;
format	htn_med_baseline___9	htn_med_baseline___9f.;
format	htn_med_baseline___10	htn_med_baseline___10f.;
format	htn_med_baseline___11	htn_med_baseline___11f.;
format	htn_med_baseline___12	htn_med_baseline___12f.;
format	lipid_baseline	lipid_baselinef.;
format	lipid_med_baseline___1	lipid_med_baseline___1f.;
format	lipid_med_baseline___2	lipid_med_baseline___2f.;
format	lipid_med_baseline___3	lipid_med_baseline___3f.;
format	lipid_med_baseline___4	lipid_med_baseline___4f.;
format	lipid_med_baseline___5	lipid_med_baseline___5f.;
format	lipid_med_baseline___6	lipid_med_baseline___6f.;
format	lipid_med_baseline___7	lipid_med_baseline___7f.;
format	acidreducer_baseline	acidreducer_baselinef.;
format	acid_red_med_baseline___1	acid_red_med_baseline___1f.;
format	acid_red_med_baseline___2	acid_red_med_baseline___2f.;
format	acid_red_med_baseline___3	acid_red_med_baseline___3f.;
format	acid_red_med_baseline___4	acid_red_med_baseline___4f.;
format	antiviral_baseline	antiviral_baselinef.;
format	antiviral_med_baseline___1	antiviral_med_baseline___1f.;
format	antiviral_med_baseline___2	antiviral_med_baseline___2f.;
format	antiviral_med_baseline___3	antiviral_med_baseline___3f.;
format	antiviral_med_baseline___4	antiviral_med_baseline___4f.;
format	antiviral_med_baseline___5	antiviral_med_baseline___5f.;
format	antiviral_med_baseline___6	antiviral_med_baseline___6f.;
format	antifungal_baseline	antifungal_baselinef.;
format	antifungal_meds_baseline___1	antifungal_meds_baseline___1f.;
format	antifungal_meds_baseline___2	antifungal_meds_baseline___2f.;
format	antifungal_meds_baseline___3	antifungal_meds_baseline___3f.;
format	antifungal_meds_baseline___4	antifungal_meds_baseline___4f.;
format	antifungal_meds_baseline___5	antifungal_meds_baseline___5f.;
format	antifungal_meds_baseline___6	antifungal_meds_baseline___6f.;
format	antifungal_meds_baseline___7	antifungal_meds_baseline___7f.;
format	antifungal_meds_baseline___8	antifungal_meds_baseline___8f.;
format	antifungal_meds_baseline___9	antifungal_meds_baseline___9f.;
format	antifungal_meds_baseline___10	antifungal_meds_baseline___10f.;
format	antifungal_meds_baseline___11	antifungal_meds_baseline___11f.;
format	antifungal_meds_baseline___12	antifungal_meds_baseline___12f.;
format	antifungal_meds_baseline___13	antifungal_meds_baseline___13f.;
format	antifungal_meds_baseline___14	antifungal_meds_baseline___14f.;
format	antibiotics_baseline	antibiotics_baselinef.;
format	antibio_med_baseline___1	antibio_med_baseline___1f.;
format	antibio_med_baseline___2	antibio_med_baseline___2f.;
format	antibio_med_baseline___3	antibio_med_baseline___3f.;
format	antibio_med_baseline___4	antibio_med_baseline___4f.;
format	antibio_med_baseline___5	antibio_med_baseline___5f.;
format	antibio_med_baseline___6	antibio_med_baseline___6f.;
format	antibio_med_baseline___7	antibio_med_baseline___7f.;
format	antibio_med_baseline___8	antibio_med_baseline___8f.;
format	antibio_med_baseline___9	antibio_med_baseline___9f.;
format	antibio_med_baseline___10	antibio_med_baseline___10f.;
format	antibio_med_baseline___11	antibio_med_baseline___11f.;
format	antibio_med_baseline___12	antibio_med_baseline___12f.;
format	probiotx_baseline	probiotx_baselinef.;
format	immunospu_baseline	immunospu_baselinef.;
format	immuno_baseline_list___1	immuno_baseline_list___1f.;
format	immuno_baseline_list___2	immuno_baseline_list___2f.;
format	immuno_baseline_list___3	immuno_baseline_list___3f.;
format	immuno_baseline_list___4	immuno_baseline_list___4f.;
format	immuno_baseline_list___5	immuno_baseline_list___5f.;
format	immuno_baseline_list___6	immuno_baseline_list___6f.;
run;

proc sort data=b4;
by 
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc freq data=b4;
tables
redcap_event_name redcap_repeat_instrument redcap_repeat_instance;
run;

proc freq data=b4;
tables
immunospu_baseline
immuno_baseline_list___1
immuno_baseline_list___2
immuno_baseline_list___3
immuno_baseline_list___4
immuno_baseline_list___5
immuno_baseline_list___6
other_immuno_baseline;
run;

proc print data=b4;
var record_id
immunospu_baseline
immuno_baseline_list___1
immuno_baseline_list___2
immuno_baseline_list___3
immuno_baseline_list___4
immuno_baseline_list___5
immuno_baseline_list___6
other_immuno_baseline;
run;

data mylib.b4clean;
set b4;
run;

proc contents data=b4 order=varnum;
run;

**b5;

proc contents data=mylib.b5 order=varnum;
run;

data b5;
set mylib.b5;
keep
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
cold_ischem_time
pump_perfusn
transfusion
abx_preop
abx_preop_med___1
abx_preop_med___2
abx_preop_med___3
abx_preop_med___4
abx_preop_med___5
abx_preop_med___6
abx_preop_med___7
abx_preop_med___8
abx_preop_med___9
abx_preop_med___10
abx_preop_med___11
abx_preop_med___12
other_abx_preop
;
run;

data b5;
set b5;
Label
cold_ischem_time = "Cold ischemia time (Round to the nearest 15 minute)"
pump_perfusn = "Was pump perfusion employed on donor kidney?"
transfusion = "Did the participant receive any blood transfusions within three days of this transplant surgery, excluding plasmapheresis?"
abx_preop = "Was the subject given any preoperative antibiotics or during the transplant?"
abx_preop_med___1 = "Preoperative Antibiotics = Aminoglycosides"
abx_preop_med___2 = "Preoperative Antibiotics = Cephalosporin"
abx_preop_med___3 = "Preoperative Antibiotics = Dapsone"
abx_preop_med___4 = "Preoperative Antibiotics = Fluoroquinolone"
abx_preop_med___5 = "Preoperative Antibiotics = Glycopeptides"
abx_preop_med___6 = "Preoperative Antibiotics = Macrolides"
abx_preop_med___7 = "Preoperative Antibiotics = Penicillin"
abx_preop_med___8 = "Preoperative Antibiotics = Sulfonamide"
abx_preop_med___9 = "Preoperative Antibiotics = Tetracylcine"
abx_preop_med___10 = "Preoperative Antibiotics = Metronidazole"
abx_preop_med___11 = "Preoperative Antibiotics = Other"
abx_preop_med___12 = "Preoperative Antibiotics = Unknown"
other_abx_preop = "If yes to other antibiotics please specify"
;
run;

proc format;
value pump_perfusnf 1="Yes" 2="No" 3="Unknown";
value transfusionf 1="Yes" 2="No" 3="Unknown";
value abx_preopf 1="Yes" 2="No" 3="Unknown";
value abx_preop_med___1f  1="Yes" 0="No";
value abx_preop_med___2f  1="Yes" 0="No";
value abx_preop_med___3f  1="Yes" 0="No";
value abx_preop_med___4f  1="Yes" 0="No";
value abx_preop_med___5f  1="Yes" 0="No";
value abx_preop_med___6f  1="Yes" 0="No";
value abx_preop_med___7f  1="Yes" 0="No";
value abx_preop_med___8f  1="Yes" 0="No";
value abx_preop_med___9f  1="Yes" 0="No";
value abx_preop_med___10f  1="Yes" 0="No";
value abx_preop_med___11f  1="Yes" 0="No";
value abx_preop_med___12f  1="Yes" 0="No";
run;

data b5;
set b5;
format pump_perfusn pump_perfusnf.;
format transfusion transfusionf.;
format abx_preop abx_preopf.;
format abx_preop_med___1 abx_preop_med___1f.;
format abx_preop_med___2 abx_preop_med___2f.;
format abx_preop_med___3 abx_preop_med___3f.;
format abx_preop_med___4 abx_preop_med___4f.;
format abx_preop_med___5 abx_preop_med___5f.;
format abx_preop_med___6 abx_preop_med___6f.;
format abx_preop_med___7 abx_preop_med___7f.;
format abx_preop_med___8 abx_preop_med___8f.;
format abx_preop_med___9 abx_preop_med___9f.;
format abx_preop_med___10 abx_preop_med___10f.;
format abx_preop_med___11 abx_preop_med___11f.;
format abx_preop_med___12 abx_preop_med___12f.;
run;

proc sort data=b5;
by 
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc freq data=b5;
tables
redcap_event_name redcap_repeat_instrument redcap_repeat_instance;
run;

data mylib.b5clean;
set b5;
run;

proc contents data=b5 order=varnum;
run;

**b6;

proc contents data=mylib.b6 order=varnum;
run;

data b6;
set mylib.b6;
keep
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
hlaa_status
hlab_status
hlac_status
hladrb1_status
hladpa1_status
hladpb1_status
hladqa1_status
hladqb1_status
hla_a_allele1
hla_a_se1
hla_a_allele2
hla_a_se2
hla_b_allele1
hla_b_se1
hla_b_allele2
hla_b_se2
hla_c_allele1
hla_c_se1
hla_c_allele2
hla_c_se2
hla_drb_allele1
hla_drb_se1
hla_drb_allele2
hla_drb_se2
hla_dqa_allele1
hla_dqa_se1
hla_dqa_allele2
hla_dqa_se2
hla_dqb_allele1
hla_dqb_se1
hla_dqb_allele2
hla_dqb_se2
hla_dpa_allele1
hla_dpa_se1
hla_dpa_allele2
hla_dpa_se2
hla_dpb_allele1
hla_dpb_allele2
hla_dpb_se1
hla_dpb_se2
drb5_status
drb3_status
drb4_status
hla_drb5_allele1
hla_drb5_se1
hla_drb5_allele2
hla_drb5_se2
hla_drb3_allele1
hla_drb3_se1
hla_drb3_allele2
hla_drb3_se2
hla_drb4_allele1
hla_drb4_se1
hla_drb4_allele2
hla_drb4_se2
;
run;

data b6;
set b6;
label
hlaa_status = "HLA-A"
hlab_status = "HLA-B"
hlac_status = "HLA-C"
hladrb1_status = "HLA-DR B1"
hladpa1_status = "HLA-DP A1*"
hladpb1_status = "HLA-DP B1*"
hladqa1_status = "HLA-DQ A1*"
hladqb1_status = "HLA-DQ B1*"
hla_a_allele1 = "HLA-A Allele 1 (most likely test to be performed)"
hla_a_se1 = "HLA-A Serologic equivalent 1"
hla_a_allele2 = "HLA-A Allele 2 (most likely test to be performed)"
hla_a_se2 = "HLA-A Serologic equivalent 2"
hla_b_allele1 = "HLA-B Allele 1 (most likely test to be performed)"
hla_b_se1 = "HLA-B Serologic equivalent 1"
hla_b_allele2 = "HLA-B Allele 2 (most likely test to be performed)"
hla_b_se2 = "HLA-B Serologic equivalent 2"
hla_c_allele1 = "HLA-C Allele 1 (most likely test to be performed)"
hla_c_se1 = "HLA-C Serologic equivalent 1"
hla_c_allele2 = "HLA-C Allele 2 (most likely test to be performed)"
hla_c_se2 = "HLA-C Serologic equivalent 2"
hla_drb_allele1 = "HLA-DRB1 Allele 1 (most likely test to be performed)"
hla_drb_se1 = "HLA-DRB1 Serologic equivalent 1"
hla_drb_allele2 = "HLA-DRB1 Allele 2 (most likely test to be performed)"
hla_drb_se2 = "HLA-DRB1 Serologic equivalent 2"
hla_dqa_allele1 = "HLA-DQ A1 Allele 1(most likely test to be performed)"
hla_dqa_se1 = "HLA-DQ A1 Serologic equivalent 1"
hla_dqa_allele2 = "HLA-DQ A1 Allele 2 (most likely test to be performed)"
hla_dqa_se2 = "HLA-DQ A1 Serologic equivalent 2"
hla_dqb_allele1 = "HLA-DQ B1 Allele 1(most likely test to be performed)"
hla_dqb_se1 = "HLA-DQ B1 Serologic equivalent 1"
hla_dqb_allele2 = "HLA-DQ B1 Allele 2 (most likely test to be performed)"
hla_dqb_se2 = "HLA-DQ B1 Serologic equivalent 2"
hla_dpa_allele1 = "HLA-DP A1 Allele 1 (most likely test to be performed)"
hla_dpa_se1 = "HLA-DP A1  Serologic equivalent 1"
hla_dpa_allele2 = "HLA-DP A1  Allele 2 (most likely test to be performed)"
hla_dpa_se2 = "HLA-DP A1  Serologic equivalent 2"
hla_dpb_allele1 = "HLA-DP B1 Allele 1(most likely test to be performed)"
hla_dpb_allele2 = "HLA-DP B1  Serologic equivalent 1"
hla_dpb_se1 = "HLA-DP B1  Allele 2 (most likely test to be performed)"
hla_dpb_se2 = "HLA-DP B1  Serologic equivalent 2"
drb5_status = "HLA-DR51 (DRB5)"
drb3_status = "HLA-DR52 (DRB3)"
drb4_status = "HLA-DR53 (DRB4)"
hla_drb5_allele1 = "HLA-DR51 (DRB5) Allele 1 (most likely test performed)"
hla_drb5_se1 = "HLA-DR51 (DRB5)  Serologic equivalent 1"
hla_drb5_allele2 = "HLA-DR51 (DRB5) Allele 2 (most likely test performed)"
hla_drb5_se2 = "HLA-DR51 (DRB5) Serologic equivalent 2"
hla_drb3_allele1 = "HLA-DR52 (DRB3) Allele 1 (most likely test performed)"
hla_drb3_se1 = "HLA-DR52 (DRB3)  Serologic equivalent 1"
hla_drb3_allele2 = "HLA-DR52 (DRB3)  Allele 2 (most likely test performed)"
hla_drb3_se2 = "HLA-DR52 (DRB3) Serologic equivalent 2"
hla_drb4_allele1 = "HLA-DR53 (DRB4) Allele 1 (most likely test performed)"
hla_drb4_se1 = "HLA-DR53 (DRB4)  Serologic equivalent 1"
hla_drb4_allele2 = "HLA-DR53 (DRB4)  Allele 2 (most likely test performed)"
hla_drb4_se2 = "HLA-DR53 (DRB4) Serologic equivalent 2"
;
run;

proc format;
value hlaa_status 1="Yes" 2="Not Done" 3="No 2nd Allele identified";
value hlab_status 1="Yes" 2="Not Done" 3="No 2nd Allele identified";
value hlac_status 1="Yes" 2="Not Done" 3="No 2nd Allele identified";
value hladrb1_status 1="Yes" 2="Not Done" 3="No 2nd Allele identified";
value hladpa1_status 1="Yes" 2="Not Done" 3="No 2nd Allele identified";
value hladpb1_status 1="Yes" 2="Not Done" 3="No 2nd Allele identified";
value hladqa1_status 1="Yes" 2="Not Done" 3="No 2nd Allele identified";
value hladqb1_status 1="Yes" 2="Not Done" 3="No 2nd Allele identified";
value drb5_status 1="Present" 2="Null / No Allele" 3="Not done";
value drb3_status 1="Present" 2="Null / No Allele" 3="Not done";
value drb4_status 1="Present" 2="Null / No Allele" 3="Not done";
run;

data b6;
set b6;
format hlaa_status hlaa_status.;
format hlab_status hlab_status.;
format hlac_status hlac_status.;
format hladrb1_status hladrb1_status.;
format hladpa1_status hladpa1_status.;
format hladpb1_status hladpb1_status.;
format hladqa1_status hladqa1_status.;
format hladqb1_status hladqb1_status.;
format drb5_status drb5_status.;
format drb3_status drb3_status.;
format drb4_status drb4_status.;
run;

proc sort data=b6;
by 
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc freq data=b6;
tables
redcap_event_name redcap_repeat_instrument redcap_repeat_instance;
run;

data mylib.b6clean;
set b6;
run;

proc contents data=b6 order=varnum;
run;

**b7;

proc contents data=mylib.b7 order=varnum;
run;

data b7;
set mylib.b7;
keep
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
hlaa_status_donor
hlab_status_donor
hlac_status_donor
hladrb1_status_donor
hladpa1_status_donor
hladpb1_status_donor
hladqa1_status_donor
hladqb1_status_donor
hla_a_allele1_donor
hla_a_se1_donor
hla_a_allele2_donor
hla_a_se2_donor
hla_b_allele1_donor
hla_b_se1_donor
hla_b_allele2_donor
hla_b_se2_donor
hla_c_allele1_donor
hla_c_se1_donor
hla_c_allele2_donor
hla_c_se2_donor
hla_drb_allele1_donor
hla_drb_se1_donor
hla_drb_allele2_donor
hla_drb_se2_donor
hla_dqa_allele1_donor
hla_dqa_se1_donor
hla_dqa_allele2_donor
hla_dqa_se2_donor
hla_dqb_allele1_donor
hla_dqb_se1_donor
hla_dqb_allele2_donor
hla_dqb_se2_donor
hla_dpa_allele1_donor
hla_dpa_se1_donor
hla_dpa_allele2_donor
hla_dpa_se2_donor
hla_dpb_allele1_donor
hla_dpb_allele2_donor
hla_dpb_se1_donor
hla_dpb_se2_donor
drb5_status_donor
drb3_status_donor
drb4_status_donor
hla_drb5_allele1_donor
hla_drb5_se1_donor
hla_drb5_allele2_donor
hla_drb5_se2_donor
hla_drb3_allele1_donor
hla_drb3_se1_donor
hla_drb3_allele2_donor
hla_drb3_se2_donor
hla_drb4_allele1_donor
hla_drb4_se1_donor
hla_drb4_allele2_donor
hla_drb4_se2_donor
;
run;

data b7;
set b7;
label
hlaa_status_donor = "HLA-A"
hlab_status_donor = "HLA-B"
hlac_status_donor = "HLA-C"
hladrb1_status_donor = "HLA-DR B1"
hladpa1_status_donor = "HLA-DP A1*"
hladpb1_status_donor = "HLA-DP B1*"
hladqa1_status_donor = "HLA-DQ A1*"
hladqb1_status_donor = "HLA-DQ B1*"
hla_a_allele1_donor = "HLA-A Allele 1 (most likely test to be performed)"
hla_a_se1_donor = "HLA-A Serologic equivalent 1"
hla_a_allele2_donor = "HLA-A Allele 2 (most likely test to be performed)"
hla_a_se2_donor = "HLA-A Serologic equivalent 2"
hla_b_allele1_donor = "HLA-B Allele 1 (most likely test to be performed)"
hla_b_se1_donor = "HLA-B Serologic equivalent 1"
hla_b_allele2_donor = "HLA-B Allele 2 (most likely test to be performed)"
hla_b_se2_donor = "HLA-B Serologic equivalent 2"
hla_c_allele1_donor = "HLA-C Allele 1 (most likely test to be performed)"
hla_c_se1_donor = "HLA-C Serologic equivalent 1"
hla_c_allele2_donor = "HLA-C Allele 2 (most likely test to be performed)"
hla_c_se2_donor = "HLA-C Serologic equivalent 2"
hla_drb_allele1_donor = "HLA-DRB1 Allele 1 (most likely test to be performed)"
hla_drb_se1_donor = "HLA-DRB1 Serologic equivalent 1"
hla_drb_allele2_donor = "HLA-DRB1 Allele 2 (most likely test to be performed)"
hla_drb_se2_donor = "HLA-DRB1 Serologic equivalent 2"
hla_dqa_allele1_donor = "HLA-DQ A1 Allele 1(most likely test to be performed)"
hla_dqa_se1_donor = "HLA-DQ A1 Serologic equivalent 1"
hla_dqa_allele2_donor = "HLA-DQ A1 Allele 2 (most likely test to be performed)"
hla_dqa_se2_donor = "HLA-DQ A1 Serologic equivalent 2"
hla_dqb_allele1_donor = "HLA-DQ B1 Allele 1(most likely test to be performed)"
hla_dqb_se1_donor = "HLA-DQ B1 Serologic equivalent 1"
hla_dqb_allele2_donor = "HLA-DQ B1 Allele 2 (most likely test to be performed)"
hla_dqb_se2_donor = "HLA-DQ B1 Serologic equivalent 2"
hla_dpa_allele1_donor = "HLA-DP A1 Allele 1 (most likely test to be performed)"
hla_dpa_se1_donor = "HLA-DP A1  Serologic equivalent 1"
hla_dpa_allele2_donor = "HLA-DP A1  Allele 2 (most likely test to be performed)"
hla_dpa_se2_donor = "HLA-DP A1  Serologic equivalent 2"
hla_dpb_allele1_donor = "HLA-DP B1 Allele 1(most likely test to be performed)"
hla_dpb_allele2_donor = "HLA-DP B1  Serologic equivalent 1"
hla_dpb_se1_donor = "HLA-DP B1  Allele 2 (most likely test to be performed)"
hla_dpb_se2_donor = "HLA-DP B1  Serologic equivalent 2"
drb5_status_donor = "HLA-DR51 (DRB5)"
drb3_status_donor = "HLA-DR52 (DRB3)"
drb4_status_donor = "HLA-DR53 (DRB4)"
hla_drb5_allele1_donor = "HLA-DR51 (DRB5) Allele 1 (most likely test performed)"
hla_drb5_se1_donor = "HLA-DR51 (DRB5)  Serologic equivalent 1"
hla_drb5_allele2_donor = "HLA-DR51 (DRB5) Allele 2 (most likely test performed)"
hla_drb5_se2_donor = "HLA-DR51 (DRB5) Serologic equivalent 2"
hla_drb3_allele1_donor = "HLA-DR52 (DRB3) Allele 1 (most likely test performed)"
hla_drb3_se1_donor = "HLA-DR52 (DRB3)  Serologic equivalent 1"
hla_drb3_allele2_donor = "HLA-DR52 (DRB3)  Allele 2 (most likely test performed)"
hla_drb3_se2_donor = "HLA-DR52 (DRB3) Serologic equivalent 2"
hla_drb4_allele1_donor = "HLA-DR53 (DRB4) Allele 1 (most likely test performed)"
hla_drb4_se1_donor = "HLA-DR53 (DRB4)  Serologic equivalent 1"
hla_drb4_allele2_donor = "HLA-DR53 (DRB4)  Allele 2 (most likely test performed)"
hla_drb4_se2_donor = "HLA-DR53 (DRB4) Serologic equivalent 2"
;
run;

proc format;
value hlaa_status_donor 1="Yes" 2="Not Done" 3="No 2nd Allele identified";
value hlab_status_donor 1="Yes" 2="Not Done" 3="No 2nd Allele identified";
value hlac_status_donor 1="Yes" 2="Not Done" 3="No 2nd Allele identified";
value hladrb1_status_donor 1="Yes" 2="Not Done" 3="No 2nd Allele identified";
value hladpa1_status_donor 1="Yes" 2="Not Done" 3="No 2nd Allele identified";
value hladpb1_status_donor 1="Yes" 2="Not Done" 3="No 2nd Allele identified";
value hladqa1_status_donor 1="Yes" 2="Not Done" 3="No 2nd Allele identified";
value hladqb1_status_donor 1="Yes" 2="Not Done" 3="No 2nd Allele identified";
value drb5_status_donor 1="Present" 2="Null / No Allele" 3="Not done";
value drb3_status_donor 1="Present" 2="Null / No Allele" 3="Not done";
value drb4_status_donor 1="Present" 2="Null / No Allele" 3="Not done";
run;

data b7;
set b7;
format hlaa_status_donor hlaa_status_donor.;
format hlab_status_donor hlab_status_donor.;
format hlac_status_donor hlac_status_donor.;
format hladrb1_status_donor hladrb1_status_donor.;
format hladpa1_status_donor hladpa1_status_donor.;
format hladpb1_status_donor hladpb1_status_donor.;
format hladqa1_status_donor hladqa1_status_donor.;
format hladqb1_status_donor hladqb1_status_donor.;
format drb5_status_donor drb5_status_donor.;
format drb3_status_donor drb3_status_donor.;
format drb4_status_donor drb4_status_donor.;
run;

proc print data = b7;
run;

proc sort data=b7;
by 
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc freq data=b7;
tables
redcap_event_name redcap_repeat_instrument redcap_repeat_instance;
run;

data mylib.b7clean;
set b7;
run;

proc contents data=b7 order=varnum;
run;

 
**b8;

proc contents data=mylib.b8 order=varnum;
run;

data b8;
set mylib.b8;
keep
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
pra_test
pra_dt
cpra
pra_method
;
run;

data b8;
set b8;
label
pra_test = "Was a PRA Single Antigen Test performed?"
pra_dt = "If yes, Date of collection"
cpra = "Calculated (c) PRA %"
pra_method = "Methodology"
;
run;

proc sort data=b8;
by 
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc freq data=b8;
tables
redcap_event_name redcap_repeat_instrument redcap_repeat_instance;
run;

data mylib.b8clean;
set b8;
run;

proc contents data=b8 order=varnum;
run;

**b9;
** In "0_01_David_MissionStudy_CS_GOedits" This form is for PRA tests and there was no further cleaning in the onerec code;

/*b9;
%selectvars(b9,										
pra_test_specificity	
class1_a_specificities	
class1_a_specificities_value
class1_b_specificities	
class1_b_specificities_value
class1_c_specificities	
class1_c_specificities_value
class1_dr_specificities	
class1_dr_specificities_value
class1_dq_specificities	
class1_dq_specificities_value
class1_dp_specificities	
class1_dp_specificities_value
data_entered_byb9	
b9_recipient_pra_specificities_u						
		);
proc print data=mylib.b9;
run;*/

proc contents data=mylib.b9 order=varnum;
run;

data b9;
set mylib.b9;
keep
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
pra_test_specificity	
class1_a_specificities	
class1_a_specificities_value
class1_b_specificities	
class1_b_specificities_value
class1_c_specificities	
class1_c_specificities_value
class1_dr_specificities	
class1_dr_specificities_value
class1_dq_specificities	
class1_dq_specificities_value
class1_dp_specificities	
class1_dp_specificities_value
;
run;

data b9;
set b9;
label
pra_test_specificity = "Were there specificities identified using the PRA single antigen test?"
class1_a_specificities = "Class I - A specificities (unacceptable antigens)"
class1_a_specificities_value = "Class I - A specificities (unacceptable antigens)  value"
class1_b_specificities = "Class I - B specificities (unacceptable antigens)"
class1_b_specificities_value = "Class I - B specificities (unacceptable antigens) value"
class1_c_specificities = "Class I - C specificities (unacceptable antigens)"
class1_c_specificities_value = "Class I - C specificities (unacceptable antigens) value"
class1_dr_specificities = "Class I - DR specificities (unacceptable antigens)"
class1_dr_specificities_value = "Class I - DR specificities (unacceptable antigens) value"
class1_dq_specificities = "Class I - DQ specificities (unacceptable antigens)"
class1_dq_specificities_value = "Class I - DQ specificities (unacceptable antigens) value"
class1_dp_specificities = "Class I -DP specificities (unacceptable antigens)"
class1_dp_specificities_value = "Class I - DP specificities (unacceptable antigens) value"
;
run;

proc print data = b9;
run;

proc sort data=b9;
by 
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc freq data=b9;
tables
redcap_event_name redcap_repeat_instrument redcap_repeat_instance;
run;

data mylib.b9clean;
set b9;
run;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

data b9;
set mylib.b9clean;
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

proc print data = b9;
run;

proc contents data = b9;
run;

data b9long;
set b9;
keep 
record_id	
redcap_repeat_instance
class1_a_specificities 
class1_a_specificities_value 
class1_b_specificities 
class1_b_specificities_value 
class1_c_specificities 
class1_c_specificities_value 
class1_dp_specificities 
class1_dp_specificities_value 
class1_dq_specificities 
class1_dq_specificities_value 
class1_dr_specificities 
class1_dr_specificities_value 
pra_test_specificity
;
run;


proc contents data = b9long;
run;

proc print data = b9long;
run;

proc sort data = b9long;
by record_id;
run;

proc print data = b9long;
run;

/*
proc transpose data=d2long out=d2widestooldna prefix=label_feces_sample_;
    by record_id;
    id mb_sample_timepoint;
    var label_feces_sample;
run;

proc print data = d2widestooldna;
run;
*/

proc transpose data=b9long out=class1awide prefix=class1_a_specificities_;
    by record_id;
    id redcap_repeat_instance;
    var class1_a_specificities;
run;

proc print data = class1awide;
run;

proc transpose data=b9long out=class1avaluewide prefix=class1_a_value_;
    by record_id;
    id redcap_repeat_instance;
    var class1_a_specificities_value;
run;

proc print data = class1avaluewide;
run;

proc transpose data=b9long out=class1bwide prefix=class1_b_specificities_;
    by record_id;
    id redcap_repeat_instance;
    var class1_b_specificities;
run;

proc print data = class1bwide;
run;

proc transpose data=b9long out=class1bvaluewide prefix=class1_b_specificities_value_;
    by record_id;
    id redcap_repeat_instance;
    var class1_b_specificities_value;
run;

proc print data = class1bvaluewide;
run;

proc transpose data=b9long out=class1cwide prefix=class1_c_specificities_;
    by record_id;
    id redcap_repeat_instance;
    var class1_c_specificities;
run;

proc print data = class1cwide;
run;

proc transpose data=b9long out=class1cvaluewide prefix=class1_c_specificities_value_;
    by record_id;
    id redcap_repeat_instance;
    var class1_c_specificities_value;
run;

proc print data = class1cvaluewide;
run;

proc transpose data=b9long out=class1dpwide prefix=class1_dp_specificities_;
    by record_id;
    id redcap_repeat_instance;
    var class1_dp_specificities;
run;

proc print data = class1dpwide;
run;

proc transpose data=b9long out=class1dpvaluewide prefix=class1_dp_specificities_value_;
    by record_id;
    id redcap_repeat_instance;
    var class1_dp_specificities_value;
run;

proc print data = class1dpvaluewide;
run;

proc transpose data=b9long out=class1dqwide prefix=class1_dq_specificities_;
    by record_id;
    id redcap_repeat_instance;
    var class1_dq_specificities;
run;

proc print data = class1dqwide;
run;

proc transpose data=b9long out=class1dqvaluewide prefix=class1_dq_specificities_value_;
    by record_id;
    id redcap_repeat_instance;
    var class1_dq_specificities_value;
run;

proc print data = class1dqvaluewide;
run;

proc transpose data=b9long out=class1drwide prefix=class1_dr_specificities_;
    by record_id;
    id redcap_repeat_instance;
    var class1_dr_specificities;
run;

proc print data = class1drwide;
run;

proc transpose data=b9long out=class1drvaluewide prefix=class1_dr_specificities_value_;
    by record_id;
    id redcap_repeat_instance;
    var class1_dr_specificities_value;
run;

proc print data = class1drvaluewide;
run;

proc transpose data=b9long out=pratestspecificwide prefix=pra_test_specificity_;
    by record_id;
    id redcap_repeat_instance;
    var pra_test_specificity;
run;

proc print data = pratestspecificwide;
run;


data mylib.b9wide;
    merge  class1awide(drop=_name_) class1avaluewide(drop=_name_) class1bwide(drop=_name_) class1bvaluewide(drop=_name_) class1cwide(drop=_name_) class1cvaluewide(drop=_name_)
    class1dpwide(drop=_name_) class1dpvaluewide(drop=_name_) class1dqwide(drop=_name_) class1dqvaluewide(drop=_name_) class1drwide(drop=_name_) class1drvaluewide(drop=_name_)
    pratestspecificwide(drop=_name_);
    by record_id;
run;

proc print data=mylib.b9wide;
run;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

**b10;

proc contents data=mylib.b10 order=varnum;
run;

data b10;
set mylib.b10;
keep
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
crossmatch_dt
t_cell_x_match_result
b_cell_x_match_result
t_cell_x_match_method
b_cell_x_match_method
t_cell_mcs
t_cell_mfi
b_cell_mcs
b_cell_mfi
;
run;

data b10;
set b10;
Label
crossmatch_dt = "Date of crossmatch test"
t_cell_x_match_result = "Cross match test results"
b_cell_x_match_result = "Cross match test results"
t_cell_x_match_method = "Cross match test method"
b_cell_x_match_method = "Cross match test method"
t_cell_mcs = "T-cell Median Channel Shift value (MCS) (1-1000)"
t_cell_mfi = "T-cell MFI (0.5-10)"
b_cell_mcs = "B-cell Median Channel Shift value (MCS) (1-1000)"
b_cell_mfi = "B-cell MFI (0.5-10)"
;
run;

proc format;
value t_cell_x_match_result 1="Posive" 2="Negative";
value b_cell_x_match_result 1="Posive" 2="Negative";
value t_cell_x_match_method 1="AHG CDC" 2="CDC" 3="FCXM";
value b_cell_x_match_method 1="AHG CDC" 2="CDC" 3="FCXM";
run;

data b10;
set b10;
format t_cell_x_match_result t_cell_x_match_result.;
format b_cell_x_match_result b_cell_x_match_result.;
format t_cell_x_match_method t_cell_x_match_method.;
format b_cell_x_match_method b_cell_x_match_method.;
run;

proc sort data=b10;
by 
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

data mylib.b10clean;
set b10;
run;

** merge (B8 and B9 needs to be transposed from long to wide first);

data mylib.b;
merge mylib.b1clean mylib.b2clean /*mylib.b2aclean*/ mylib.b3clean mylib.b4clean mylib.b5clean mylib.b6clean mylib.b7clean mylib.b8clean /*mylib.b9wide*/ mylib.b10clean;
by record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;


data mylib.b;
merge mylib.b  mylib.b2aclean mylib.b9wide;
by record_id;
run;

proc freq data=mylib.b noprint;
tables record_id / out=freqs;
proc freq data=freqs;
tables count;
run;

proc print data=mylib.b (obs=10);
run;

proc contents data=mylib.b varnum;
run;

*****************************************************************************************************************************;
*****************************************************************************************************************************;
*****************************************************************************************************************************;

*Cleaning the HLA data for donors and recipients to calculate the number of HLA mismatches;

data mylib.ab;
merge mylib.aclean mylib.b;
by record_id;
run;

data ab;
set mylib.ab;
run;

* add number of HLA mismatches;

*proc print data=merged1;
proc print data=ab;
var record_id
hla_a_allele1
hla_a_se1
hla_a_allele2
hla_a_se2

hla_b_allele1
hla_b_se1
hla_b_allele2
hla_b_se2

hla_drb_allele1
hla_drb_se1
hla_drb_allele2
hla_drb_se2
;
where site=3;
run;

*proc print data=merged1;
proc print data=ab;
var record_id
hla_a_allele1
hla_a_se1
hla_a_allele2
hla_a_se2

hla_b_allele1
hla_b_se1
hla_b_allele2
hla_b_se2

hla_drb_allele1
hla_drb_se1
hla_drb_allele2
hla_drb_se2
;
where site=4;
run;


*proc print data=merged1;
proc print data=ab;
var record_id
hla_a_allele1_donor
hla_a_se1_donor
hla_a_allele2_donor
hla_a_se2_donor

hla_b_allele1_donor
hla_b_se1_donor
hla_b_allele2_donor
hla_b_se2_donor

hla_drb_allele1_donor
hla_drb_se1_donor
hla_drb_allele2_donor
hla_drb_se2_donor
;
where site=3;
run;

*proc print data=merged1;
proc print data=ab;
var record_id
hla_a_allele1_donor
hla_a_se1_donor
hla_a_allele2_donor
hla_a_se2_donor

hla_b_allele1_donor
hla_b_se1_donor
hla_b_allele2_donor
hla_b_se2_donor

hla_drb_allele1_donor
hla_drb_se1_donor
hla_drb_allele2_donor
hla_drb_se2_donor
;
where site=4;
run;


%macro cleanuphla(var);

	if &var. = "NA" then &var. = "";
	if &var. = "N/A" then &var. = "";
	if &var. = "n/a" then &var. = "";
	if &var. = "-" then &var. = "";
	if &var. = "0" then &var. = "";

	if &var. = "03(17)" then &var. = "3";
	if &var. = "3(17)" then &var. = "3";
	if &var. = "14(65)" then &var. = "14";
	if &var. = "15(62)" then &var. = "15";
	if &var. = "15 (62)" then &var. = "15";
	if &var. = "15(63)" then &var. = "15";
	if &var. = "40(60)" then &var. = "40";
	if &var. = "40(61)" then &var. = "40";

	if &var. = "A*01" then &var. = "1";
	if &var. = "A*1" then &var. = "1";	
	if &var. = "A*01:01" then &var. = "1";	
	if &var. = "A*02" then &var. = "2";
	if &var. = "A*02:01" then &var. = "2";	
	if &var. = "A*2" then &var. = "2";
	if &var. = "*02" then &var. = "2";	
	if &var. = "A*03" then &var. = "3";
	if &var. = "A*03:01" then &var. = "3";	
	if &var. = "A*3" then &var. = "3";
	if &var. = "A*8" then &var. = "8";	
	if &var. = "A*11" then &var. = "11";
	if &var. = "A*11:01" then &var. = "11";		
	if &var. = "A*11:02" then &var. = "11";	
	if &var. = "A*23" then &var. = "23";
	if &var. = "A*23:01" then &var. = "23";	
	if &var. = "A*24" then &var. = "24";
	if &var. = "A*24:02" then &var. = "24";
	if &var. = "A*25" then &var. = "25";	
	if &var. = "A*26" then &var. = "26";
	if &var. = "A*29" then &var. = "29";
	if &var. = "A*30" then &var. = "30";
	if &var. = "A*31" then &var. = "31";
	if &var. = "A*32" then &var. = "32";
	if &var. = "A*32:01" then &var. = "32";	
	if &var. = "A*33" then &var. = "33";
	if &var. = "A*34" then &var. = "34";	
	if &var. = "A*66" then &var. = "66";	
	if &var. = "A*68" then &var. = "68";
	if &var. = "A*68:01" then &var. = "68";	

	if &var. = "B*07" then &var. = "7";
	if &var. = "B*07:02" then &var. = "7";	
	if &var. = "B*7" then &var. = "7";
	if &var. = "B*08" then &var. = "8";
	if &var. = "B*8" then &var. = "8";	
	if &var. = "B*08:01" then &var. = "8";	
	if &var. = "B*13" then &var. = "13";	
	if &var. = "B*14" then &var. = "14";
	if &var. = "B*14:01" then &var. = "14";	
	if &var. = "B*14:65" then &var. = "14";		
	if &var. = "B*15" then &var. = "15";
	if &var. = "B*15:02" then &var. = "15";	
	if &var. = "B*15:07" then &var. = "15";		
	if &var. = "B*15:18" then &var. = "15";
	if &var. = "B*15:62" then &var. = "15";	
	if &var. = "B*15:63" then &var. = "15";
	if &var. = "B*18" then &var. = "18";				
	if &var. = "B*27" then &var. = "27";
	if &var. = "B*27:05" then &var. = "27";	
	if &var. = "B*35" then &var. = "35";
	if &var. = "B*35:01" then &var. = "35";	
	if &var. = "B*37" then &var. = "37";
	if &var. = "B*38" then &var. = "38";
	if &var. = "B*39" then &var. = "39";
	if &var. = "B*39:01" then &var. = "39";	
	if &var. = "B*39:06" then &var. = "39";		
	if &var. = "B*40" then &var. = "40";
	if &var. = "B*40:01" then &var. = "40";	
	if &var. = "B*40:02" then &var. = "40";	
	if &var. = "B*40:60" then &var. = "40";
	if &var. = "B*40(60)" then &var. = "40";
	if &var. = "B*40:61" then &var. = "40";				
	if &var. = "B*41" then &var. = "41";
	if &var. = "B*42" then &var. = "42";	
	if &var. = "B*44" then &var. = "44";
	if &var. = "B*44:03" then &var. = "44";		
	if &var. = "B*44:05" then &var. = "44";	
	if &var. = "B*45" then &var. = "45";
	if &var. = "B*48" then &var. = "48";		
	if &var. = "B*48:01" then &var. = "48";	
	if &var. = "B*49" then &var. = "49";
	if &var. = "B*49:01" then &var. = "49";	
	if &var. = "B*50" then &var. = "50";
	if &var. = "B*50:01" then &var. = "50";		
	if &var. = "B*51" then &var. = "51";
	if &var. = "B*51:01" then &var. = "51";
	if &var. = "B*52" then &var. = "52";	
	if &var. = "B*53" then &var. = "53";
	if &var. = "B*55" then &var. = "55";
	if &var. = "B*56" then &var. = "56";	
	if &var. = "B*57" then &var. = "57";
	if &var. = "B*58" then &var. = "58";
	if &var. = "B*60" then &var. = "60";
	if &var. = "B*61" then &var. = "61";
	if &var. = "B*62" then &var. = "62";
	if &var. = "B*63" then &var. = "63";
	if &var. = "B*64" then &var. = "64";	
	if &var. = "B*65" then &var. = "65";
	if &var. = "B*71" then &var. = "71";	
	if &var. = "B*72" then &var. = "72";
	if &var. = "B*73" then &var. = "72";			
	if &var. = "B*75" then &var. = "75";	

	if &var. = "DRB1*01" then &var. = "1";
	if &var. = "DRB1*01:01" then &var. = "1";	
	if &var. = "DRB1*1" then &var. = "1";
	if &var. = "DRB1*03" then &var. = "3";
	if &var. = "DRB1*03:17" then &var. = "3";
	if &var. = "DRB1*03:01" then &var. = "3";	
	if &var. = "DRB1*3:17" then &var. = "3";		
	if &var. = "DRB1*04" then &var. = "4";
	if &var. = "DR*04" then &var. = "4";	
	if &var. = "DRB1*04:03" then &var. = "4";
	if &var. = "DRB1*04:04" then &var. = "4";
	if &var. = "DRB1*04:08" then &var. = "4";		
	if &var. = "DRB1*4" then &var. = "4";
	if &var. = "DRB1*07" then &var. = "7";
	if &var. = "DRB1*7" then &var. = "7";
	if &var. = "DRB1*08" then &var. = "8";
	if &var. = "DRB1*8" then &var. = "8";
	if &var. = "DRB1*08:01" then &var. = "8";	
	if &var. = "DRB1*09" then &var. = "9";
	if &var. = "DRB1*09:01" then &var. = "9";	
	if &var. = "DRB1*9" then &var. = "9";
	if &var. = "DRB1*10" then &var. = "10";	
	if &var. = "DRB1*11" then &var. = "11";
	if &var. = "DRB1*11:01" then &var. = "11";
	if &var. = "DRB1*11:04" then &var. = "11";	
	if &var. = "DRB1*12" then &var. = "12";
	if &var. = "DRB1*12:01" then &var. = "12";		
	if &var. = "DRB1*12:02" then &var. = "12";	
	if &var. = "DRB1*13" then &var. = "13";
	if &var. = "DRB1*13:02" then &var. = "13";	
	if &var. = "DRB1*14" then &var. = "14";
	if &var. = "DRB1*14:54" then &var. = "14";
	if &var. = "DRB1*15" then &var. = "15";
	if &var. = "DRB1*16" then &var. = "16";
	if &var. = "DRB1*16:01" then &var. = "16";	
	if &var. = "DRB1*17" then &var. = "17";
	if &var. = "DRB1*18" then &var. = "18";
	if &var. = "DRB1*25" then &var. = "25";		

%mend;


*data merged1p1;
*set merged1;

data ab1;
set ab;

	%cleanuphla(hla_a_allele1);
	%cleanuphla(hla_a_se1);
	%cleanuphla(hla_a_allele2);
	%cleanuphla(hla_a_se2);

	%cleanuphla(hla_b_allele1);
	%cleanuphla(hla_b_se1);
	%cleanuphla(hla_b_allele2);
	%cleanuphla(hla_b_se2);

	%cleanuphla(hla_drb_allele1);
	%cleanuphla(hla_drb_se1);
	%cleanuphla(hla_drb_allele2);
	%cleanuphla(hla_drb_se2);


	%cleanuphla(hla_a_allele1_donor);
	%cleanuphla(hla_a_se1_donor);
	%cleanuphla(hla_a_allele2_donor);
	%cleanuphla(hla_a_se2_donor);

	%cleanuphla(hla_b_allele1_donor);
	%cleanuphla(hla_b_se1_donor);
	%cleanuphla(hla_b_allele2_donor);
	%cleanuphla(hla_b_se2_donor);

	%cleanuphla(hla_drb_allele1_donor);
	%cleanuphla(hla_drb_se1_donor);
	%cleanuphla(hla_drb_allele2_donor);
	%cleanuphla(hla_drb_se2_donor);
run;



*proc print data=merged1p1;
proc print data=ab1;
var record_id
hla_a_allele1
hla_a_se1
hla_a_allele2
hla_a_se2

hla_b_allele1
hla_b_se1
hla_b_allele2
hla_b_se2

hla_drb_allele1
hla_drb_se1
hla_drb_allele2
hla_drb_se2
;
where site=3;
run;

*proc print data=merged1p1;
proc print data=ab1;
var record_id
hla_a_allele1
hla_a_se1
hla_a_allele2
hla_a_se2

hla_b_allele1
hla_b_se1
hla_b_allele2
hla_b_se2

hla_drb_allele1
hla_drb_se1
hla_drb_allele2
hla_drb_se2
;
where site=4;
run;


*proc print data=merged1p1;
proc print data=ab1;
var record_id
hla_a_allele1_donor
hla_a_se1_donor
hla_a_allele2_donor
hla_a_se2_donor

hla_b_allele1_donor
hla_b_se1_donor
hla_b_allele2_donor
hla_b_se2_donor

hla_drb_allele1_donor
hla_drb_se1_donor
hla_drb_allele2_donor
hla_drb_se2_donor
;
where site=3;
run;

*proc print data=merged1p1;
proc print data=ab1;
var record_id
hla_a_allele1_donor
hla_a_se1_donor
hla_a_allele2_donor
hla_a_se2_donor

hla_b_allele1_donor
hla_b_se1_donor
hla_b_allele2_donor
hla_b_se2_donor

hla_drb_allele1_donor
hla_drb_se1_donor
hla_drb_allele2_donor
hla_drb_se2_donor
;
where site=4;
run;

**The HLA data table can be found at "https://www.ufrgs.br/imunovet/molecular_immunology/hla.html";

*****************************************************************************************************************************;
*****************************************************************************************************************************;
*****************************************************************************************************************************;

*data merged2;
*set merged1p1;

**Original backup section in case the code gets messed up;

/*
data ab2;
set ab1;

	a1 = input(hla_a_allele1, 8.);
	if missing(a1) then a1 = input(hla_a_se1, 8.);

	a2 = input(hla_a_allele2, 8.);
	if missing(a2) then a2 = input(hla_a_se2, 8.);

	if missing(a2) and not missing(a1) then a2=a1;


	b1 = input(hla_b_allele1, 8.);
	if missing(b1) then b1 = input(hla_b_se1, 8.);

	b2 = input(hla_b_allele2, 8.);
	if missing(b2) then b2 = input(hla_b_se2, 8.);

	if missing(b2) and not missing(b1) then b2=b1;


	dr1 = input(hla_drb_allele1, 8.);
	if missing(dr1) then dr1 = input(hla_drb_se1, 8.);

	dr2 = input(hla_drb_allele2, 8.);
	if missing(dr2) then dr2 = input(hla_drb_se2, 8.);

	if missing(dr2) and not missing(dr1) then dr2=dr1;



	a1_donor = input(hla_a_allele1_donor, 8.);
	if missing(a1_donor) then a1_donor = input(hla_a_se1_donor, 8.);

	a2_donor = input(hla_a_allele2_donor, 8.);
	if missing(a2_donor) then a2_donor = input(hla_a_se2_donor, 8.);

	if missing(a2_donor) and not missing(a1_donor) then a2_donor=a1_donor;


	b1_donor = input(hla_b_allele1_donor, 8.);
	if missing(b1_donor) then b1_donor = input(hla_b_se1_donor, 8.);

	b2_donor = input(hla_b_allele2_donor, 8.);
	if missing(b2_donor) then b2_donor = input(hla_b_se2_donor, 8.);

	if missing(b2_donor) and not missing(b1_donor) then b2_donor=b1_donor;


	dr1_donor = input(hla_drb_allele1_donor, 8.);
	if missing(dr1_donor) then dr1_donor = input(hla_drb_se1_donor, 8.);

	dr2_donor = input(hla_drb_allele2_donor, 8.);
	if missing(dr2_donor) then dr2_donor = input(hla_drb_se2_donor, 8.);

	if missing(dr2_donor) and not missing(dr1_donor) then dr2_donor=dr1_donor;


	label hlamismatch = "HLA mismatch";
	label nummismatch = "Number of HLA mismatches";

*/

    /* HLA Mismatch;
      *DEFINITION: If an HLA allotype (A1, A2, B1, B2, DR1, or DR2) occurs in the donor, it must appear
	   in the recipient or it is a mismatch.  The reverse is not true - a recipient may have an HLA type
	   that is not Present in the donor and this is not a mismatch.  A participant can have up to 6 mismatches
	   (A1, A2, B1, B2, DR1, and DR2).  The HLA mismatch code now accounts for all the subtype equivalences (a9,
       a10, a19, a28, b5, b12, b14, b15, b16, b17, b21, b22, b40, b70, dr2, dr3, dr5, and dr6).  In looking for
	   these subtype matches, I found only 17 of them: a28 (3), b14 (1), b15 (1), b40 (1), b70 (1), dr2 (6), dr3
       (3) and dr6 (1).  This code is only run for a given patient if they have at least one A, B and DR
	   allotype for the recipient as well as for the donor.*/


	*ONLY RUN THIS CODE IF THE RECIPIENT HAS AT LEAST ONE ALLOTYPE ON THE A, B AND DR LOCI AND THE DONOR
	 HAS AT LEAST ONE ALLOTYPE ON THE A, B AND DR LOCI;
	 
	 /*
    if (missing(a1) and missing(a2)) or (missing(b1) and missing(b2)) or (missing(dr1) and missing(dr2)) then missrcpt=1;
    if (missing(a1_donor) and missing(a2_donor)) or (missing(b1_donor) and missing(b2_donor)) or (missing(dr1_donor) and missing(dr2_donor)) then missdonor=1;

    if missdonor ne 1 and missrcpt ne 1 then 
        do;
            nummismatch=0;
            subtypematchnum_a9=0;
            subtypematchnum_a10=0;
			subtypematchnum_a19=0;
			subtypematchnum_a28=0;
            subtypematchnum_b5=0;
            subtypematchnum_b12=0;
            subtypematchnum_b14=0;
            subtypematchnum_b15=0;
            subtypematchnum_b16=0;
            subtypematchnum_b17=0;
            subtypematchnum_b21=0;
            subtypematchnum_b22=0;
            subtypematchnum_b40=0;
            subtypematchnum_b70=0;
            subtypematchnum_dr2=0;
            subtypematchnum_dr3=0;
            subtypematchnum_dr5=0;
			subtypematchnum_dr6=0;

            *LOOK FOR DONOR A1 VS RECIPIENT A1 OR A2 MISMATCHES;
			if a1_donor=9 and (a1 not in (9,23,24) and a2 not in (9,23,24)) then nummismatch = nummismatch+1;
            else if a1_donor=10 and (a1 not in (10,25,26,34,66) and a2 not in (10,25,26,34,66)) then nummismatch = nummismatch+1;
			else if a1_donor=19 and (a1 not in (19,29,30,31,32,33,74) and a2 not in (19,29,30,31,32,33,74)) then nummismatch = nummismatch+1;
			else if a1_donor=28 and (a1 not in (28,68,69) and a2 not in (28,68,69)) then nummismatch = nummismatch+1;
            else if a1_donor ne a1 and a1_donor ne a2 then nummismatch = nummismatch+1;
            
            */

			/*From Mike Cecka: If the donor A1 and A2 are not the same, look to see if donor A2 matches recipient A1 or A2.  
			  If the donor is homozygous, meaning donor A1 and A2 are equal, then any mismatch is counted only once */
	    	
	    	/*
	    	if a1_donor ne a2_donor then 
			    do;
                    if a2_donor=9 then 
                        do;
                            if (a1 not in (9,23,24) and a2 not in (9,23,24)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if a2_donor=10 then
                        do;
                            if (a1 not in (10,25,26,34,66) and a2 not in (10,25,26,34,66)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if a2_donor=19 then
                        do;
                            if (a1 not in (19,29,30,31,32,33,74) and a2 not in (19,29,30,31,32,33,74)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if a2_donor=28 then
                        do;
                            if (a1 not in (28,68,69) and a2 not in (28,68,69)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if a2_donor ne a1 and a2_donor ne a2 then nummismatch = nummismatch+1;
                end;

			*LOOK FOR A LOCUS SUBTYPE EQUIVALENCES;
			if (a1_donor=9 or a2_donor=9) and a1 ne 9 and a2 ne 9 and (a1 in (23,24) or a2 in (23,24))
                then subtypematchnum_a9=1; 
			if (a1_donor=10 or a2_donor=10) and a1 ne 10 and a2 ne 10 and (a1 in (25,26,34,66) or a2 in (25,26,34,66)) 
                then subtypematchnum_a10=1;
			if (a1_donor=19 or a2_donor=19) and a1 ne 19 and a2 ne 19 and (a1 in (29,30,31,32,33,74) or a2 in (29,30,31,32,33,74)) 
                then subtypematchnum_a19=1;
			if (a1_donor=28 or a2_donor=28) and a1 ne 28 and a2 ne 28 and (a1 in (68,69) or a2 in (68,69)) 
                then subtypematchnum_a28=1;
           
            *LOOK FOR DONOR B1 VS RECIPIENT B1 OR B2 MISMATCHES;
			if b1_donor=5 and (b1 not in (5,51,52) and b2 not in (5,51,52)) then nummismatch = nummismatch+1;
            else if b1_donor=12 and (b1 not in (12,44,45) and b2 not in (12,44,45)) then nummismatch = nummismatch+1;
			else if b1_donor=14 and (b1 not in (14,64,65) and b2 not in (14,64,65)) then nummismatch = nummismatch+1;
			else if b1_donor=15 and (b1 not in (15,62,63,75,76,77) and b2 not in (15,62,63,75,76,77)) then nummismatch = nummismatch+1;
			else if b1_donor=16 and (b1 not in (16,38,39) and b2 not in (16,38,39)) then nummismatch = nummismatch+1;
			else if b1_donor=17 and (b1 not in (17,57,58) and b2 not in (17,57,58)) then nummismatch = nummismatch+1;
            else if b1_donor=21 and (b1 not in (21,49,50) and b2 not in (21,49,50)) then nummismatch = nummismatch+1;
            else if b1_donor=22 and (b1 not in (22,54,55,56) and b2 not in (22,54,55,56)) then nummismatch = nummismatch+1;
            else if b1_donor=40 and (b1 not in (40,60,61) and b2 not in (40,60,61)) then nummismatch = nummismatch+1;
            else if b1_donor=70 and (b1 not in (70,71,72) and b2 not in (70,71,72)) then nummismatch = nummismatch+1;
            else if b1_donor ne b1 and b1_donor ne b2 then nummismatch = nummismatch+1;
            
            */

			/*From Mike Cecka: If the donor B1 and B2 are not the same, look to see if donor B2 matches recipient B1 or B2.  
			  If the donor is homozygous, meaning donor B1 and B2 are equal, then any mismatch is counted only once */
			 
			 /*
			if b1_donor ne b2_donor then 
			    do;
                    if b2_donor=5 then
                        do;
                            if (b1 not in (5,51,52) and b2 not in (5,51,52)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor=12 then 
                        do;
                            if (b1 not in (12,44,45) and b2 not in (12,44,45)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor=14 then
                        do;
                            if (b1 not in (14,64,65) and b2 not in (14,64,65)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor=15 then 
                        do;
                            if (b1 not in (15,62,63,75,76,77) and b2 not in (15,62,63,75,76,77)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor=16 then 
                        do;
                            if (b1 not in (16,38,39) and b2 not in (16,38,39)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor=17 then 
                        do;
                            if (b1 not in (17,57,58) and b2 not in (17,57,58)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor=21 then 
                        do;
                            if (b1 not in (21,49,50) and b2 not in (21,49,50)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor=22 then 
                        do;
                            if (b1 not in (22,54,55,56) and b2 not in (22,54,55,56)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor=40 then 
                        do;
                            if (b1 not in (40,60,61) and b2 not in (40,60,61)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor=70 then 
                        do;
                            if (b1 not in (70,71,72) and b2 not in (70,71,72)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor ne b1 and b2_donor ne b2 then nummismatch = nummismatch+1;
                end;

			*LOOK FOR B LOCUS SUBTYPE EQUIVALENCES;
			if (b1_donor=5 or b2_donor=5) and b1 ne 5 and b2 ne 5 and (b1 in (51,52) or b2 in (51,52))
                then subtypematchnum_b5=1; 
			if (b1_donor=12 or b2_donor=12) and b1 ne 12 and b2 ne 12 and (b1 in (44,45) or b2 in (44,45)) 
                then subtypematchnum_b12=1;
			if (b1_donor=14 or b2_donor=14) and b1 ne 14 and b2 ne 14 and (b1 in (64,65) or b2 in (64,65)) 
                then subtypematchnum_b14=1;
			if (b1_donor=15 or b2_donor=15) and b1 ne 15 and b2 ne 15 and (b1 in (62,63,75,76,77) or b2 in (62,63,75,76,77)) 
                then subtypematchnum_b15=1;
			if (b1_donor=16 or b2_donor=16) and b1 ne 16 and b2 ne 16 and (b1 in (38,39) or b2 in (38,39)) 
                then subtypematchnum_b16=1;
			if (b1_donor=17 or b2_donor=17) and b1 ne 17 and b2 ne 17 and (b1 in (57,58) or b2 in (57,58)) 
                then subtypematchnum_b17=1;
			if (b1_donor=21 or b2_donor=21) and b1 ne 21 and b2 ne 21 and (b1 in (49,50) or b2 in (49,50)) 
                then subtypematchnum_b21=1;
			if (b1_donor=22 or b2_donor=22) and b1 ne 22 and b2 ne 22 and (b1 in (54,55,56) or b2 in (54,55,56)) 
                then subtypematchnum_b22=1;
			if (b1_donor=40 or b2_donor=40) and b1 ne 40 and b2 ne 40 and (b1 in (60,61) or b2 in (60,61)) 
                then subtypematchnum_b40=1;
			if (b1_donor=70 or b2_donor=70) and b1 ne 70 and b2 ne 70 and (b1 in (71,72) or b2 in (71,72)) 
                then subtypematchnum_b70=1;

            *LOOK FOR DONOR B1 VS RECIPIENT B1 OR B2 MISMATCHES;
	        if dr1_donor=2 and (dr1 not in (2,15,16) and dr2 not in (2,15,16)) then nummismatch = nummismatch+1;
			else if dr1_donor=3 and (dr1 not in (3,17,18) and dr2 not in (3,17,18)) then nummismatch = nummismatch+1;
			else if dr1_donor=5 and (dr1 not in (5,11,12) and dr2 not in (5,11,12)) then nummismatch = nummismatch+1;
			else if dr1_donor=6 and (dr1 not in (6,13,14) and dr2 not in (6,13,14)) then nummismatch = nummismatch+1;
            else if dr1_donor ne dr1 and dr1_donor ne dr2 then nummismatch = nummismatch+1;
            
            */
			
			/*From Mike Cecka: If the donor DR1 and DR2 are not the same, look to see if donor DR2 matches recipient DR1 or DR2.  
			  If the donor is homozygous, meaning donor DR1 and DR2 are equal, then any mismatch is counted only once */
			 
			 /*
			if dr1_donor ne dr2_donor then 
			    do;
                    if dr2_donor=2  then 
                        do;
                            if (dr1 not in (2,15,16) and dr2 not in (2,15,16)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if dr2_donor=3  then 
                        do;
                            if (dr1 not in (3,17,18) and dr2 not in (3,17,18)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if dr2_donor=5  then 
                        do;
                            if (dr1 not in (5,11,12) and dr2 not in (5,11,12)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if dr2_donor=6  then 
                        do;
                            if (dr1 not in (6,13,14) and dr2 not in (6,13,14)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if dr2_donor ne dr1 and dr2_donor ne dr2 then nummismatch = nummismatch+1;
	            end;

           *LOOK FOR DR LOCUS SUBTYPE EQUIVALENCES;
			if (dr1_donor=2 or dr2_donor=2) and dr1 ne 2 and dr2 ne 2 and (dr1 in (15,16) or dr2 in (15,16)) 
                then subtypematchnum_dr2=1;
			if (dr1_donor=3 or dr2_donor=3) and dr1 ne 3 and dr2 ne 3 and (dr1 in (17,18) or dr2 in (17,18)) 
                then subtypematchnum_dr3=1;
			if (dr1_donor=5 or dr2_donor=5) and dr1 ne 5 and dr2 ne 5 and (dr1 in (11,12) or dr2 in (11,12)) 
                then subtypematchnum_dr5=1;
			if (dr1_donor=6 or dr2_donor=6) and dr1 ne 6 and dr2 ne 6 and (dr1 in (13,14) or dr2 in (13,14)) 
                then subtypematchnum_dr6=1;

            if nummismatch ge 1 then hlamismatch=1; 
            else hlamismatch=0;
       end;
      


drop
missrcpt
missdonor
subtypematchnum_a9
subtypematchnum_a10
subtypematchnum_a19
subtypematchnum_a28
subtypematchnum_b5
subtypematchnum_b12
subtypematchnum_b14
subtypematchnum_b15
subtypematchnum_b16
subtypematchnum_b17
subtypematchnum_b21
subtypematchnum_b22
subtypematchnum_b40
subtypematchnum_b70
subtypematchnum_dr2
subtypematchnum_dr3
subtypematchnum_dr5
subtypematchnum_dr6
;
run;

*/

*****************************************************************************************************************************;
*****************************************************************************************************************************;
*****************************************************************************************************************************;

*data merged2;
*set merged1p1;

proc freq data = ab1;
table hla_a_allele1*hla_a_se1 hla_a_allele2*hla_a_se2/nocol norow nopercent; 
run;

proc freq data = ab1;
table hla_b_allele1*hla_b_se1 hla_b_allele2*hla_b_se2/nocol norow nopercent;  
run;

proc freq data = ab1;
table hla_drb_allele1*hla_drb_se1 hla_drb_allele2*hla_drb_se2/nocol norow nopercent; 
run;

proc freq data = ab1;
table hla_a_allele1_donor*hla_a_se1_donor hla_a_allele2_donor*hla_a_se2_donor/nocol norow nopercent;  
run;

proc freq data = ab1;
table hla_b_allele1_donor*hla_b_se1_donor hla_b_allele2_donor*hla_b_se2_donor/nocol norow nopercent;  
run;

proc freq data = ab1;
table hla_drb_allele1_donor*hla_drb_se1_donor hla_drb_allele2_donor*hla_drb_se2_donor/nocol norow nopercent; 
run;

data ab2;
set ab1;

	a1 = input(hla_a_allele1, 8.);
	if missing(a1) then a1 = input(hla_a_se1, 8.);

	a2 = input(hla_a_allele2, 8.);
	if missing(a2) then a2 = input(hla_a_se2, 8.);

	if missing(a2) and not missing(a1) then a2=a1;


	b1 = input(hla_b_allele1, 8.);
	if missing(b1) then b1 = input(hla_b_se1, 8.);

	b2 = input(hla_b_allele2, 8.);
	if missing(b2) then b2 = input(hla_b_se2, 8.);

	if missing(b2) and not missing(b1) then b2=b1;


	dr1 = input(hla_drb_allele1, 8.);
	if missing(dr1) then dr1 = input(hla_drb_se1, 8.);

	dr2 = input(hla_drb_allele2, 8.);
	if missing(dr2) then dr2 = input(hla_drb_se2, 8.);

	if missing(dr2) and not missing(dr1) then dr2=dr1;



	a1_donor = input(hla_a_allele1_donor, 8.);
	if missing(a1_donor) then a1_donor = input(hla_a_se1_donor, 8.);

	a2_donor = input(hla_a_allele2_donor, 8.);
	if missing(a2_donor) then a2_donor = input(hla_a_se2_donor, 8.);

	if missing(a2_donor) and not missing(a1_donor) then a2_donor=a1_donor;


	b1_donor = input(hla_b_allele1_donor, 8.);
	if missing(b1_donor) then b1_donor = input(hla_b_se1_donor, 8.);

	b2_donor = input(hla_b_allele2_donor, 8.);
	if missing(b2_donor) then b2_donor = input(hla_b_se2_donor, 8.);

	if missing(b2_donor) and not missing(b1_donor) then b2_donor=b1_donor;


	dr1_donor = input(hla_drb_allele1_donor, 8.);
	if missing(dr1_donor) then dr1_donor = input(hla_drb_se1_donor, 8.);

	dr2_donor = input(hla_drb_allele2_donor, 8.);
	if missing(dr2_donor) then dr2_donor = input(hla_drb_se2_donor, 8.);

	if missing(dr2_donor) and not missing(dr1_donor) then dr2_donor=dr1_donor;


	label hlamismatch = "HLA mismatch";
	label nummismatch = "Number of HLA mismatches";


    /* HLA Mismatch;
      *DEFINITION: If an HLA allotype (A1, A2, B1, B2, DR1, or DR2) occurs in the donor, it must appear
	   in the recipient or it is a mismatch.  The reverse is not true - a recipient may have an HLA type
	   that is not Present in the donor and this is not a mismatch.  A participant can have up to 6 mismatches
	   (A1, A2, B1, B2, DR1, and DR2).  The HLA mismatch code now accounts for all the subtype equivalences (a9,
       a10, a19, a28, b5, b12, b14, b15, b16, b17, b21, b22, b40, b70, dr2, dr3, dr5, and dr6).  In looking for
	   these subtype matches, I found only 17 of them: a28 (3), b14 (1), b15 (1), b40 (1), b70 (1), dr2 (6), dr3
       (3) and dr6 (1).  This code is only run for a given patient if they have at least one A, B and DR
	   allotype for the recipient as well as for the donor.*/


	*ONLY RUN THIS CODE IF THE RECIPIENT HAS AT LEAST ONE ALLOTYPE ON THE A, B AND DR LOCI AND THE DONOR
	 HAS AT LEAST ONE ALLOTYPE ON THE A, B AND DR LOCI;
    if (missing(a1) and missing(a2)) or (missing(b1) and missing(b2)) or (missing(dr1) and missing(dr2)) then missrcpt=1;
    if (missing(a1_donor) and missing(a2_donor)) or (missing(b1_donor) and missing(b2_donor)) or (missing(dr1_donor) and missing(dr2_donor)) then missdonor=1;

    if missdonor ne 1 and missrcpt ne 1 then 
        do;
            nummismatch=0;
            subtypematchnum_a9=0;
            subtypematchnum_a10=0;
			subtypematchnum_a19=0;
			subtypematchnum_a28=0;
            subtypematchnum_b5=0;
            subtypematchnum_b12=0;
            subtypematchnum_b14=0;
            subtypematchnum_b15=0;
            subtypematchnum_b16=0;
            subtypematchnum_b17=0;
            subtypematchnum_b21=0;
            subtypematchnum_b22=0;
            subtypematchnum_b40=0;
            subtypematchnum_b70=0;
            subtypematchnum_dr2=0;
            subtypematchnum_dr3=0;
            subtypematchnum_dr5=0;
			subtypematchnum_dr6=0;

            *LOOK FOR DONOR A1 VS RECIPIENT A1 OR A2 MISMATCHES;
			if a1_donor=9 and (a1 not in (9,23,24) and a2 not in (9,23,24)) then nummismatch = nummismatch+1;
            else if a1_donor=10 and (a1 not in (10,25,26,34,66) and a2 not in (10,25,26,34,66)) then nummismatch = nummismatch+1;
			else if a1_donor=19 and (a1 not in (19,29,30,31,32,33,74) and a2 not in (19,29,30,31,32,33,74)) then nummismatch = nummismatch+1;
			else if a1_donor=28 and (a1 not in (28,68,69) and a2 not in (28,68,69)) then nummismatch = nummismatch+1;
            else if a1_donor ne a1 and a1_donor ne a2 then nummismatch = nummismatch+1;

			/*From Mike Cecka: If the donor A1 and A2 are not the same, look to see if donor A2 matches recipient A1 or A2.  
			  If the donor is homozygous, meaning donor A1 and A2 are equal, then any mismatch is counted only once */
	    	if a1_donor ne a2_donor then 
			    do;
                    if a2_donor=9 then 
                        do;
                            if (a1 not in (9,23,24) and a2 not in (9,23,24)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if a2_donor=10 then
                        do;
                            if (a1 not in (10,25,26,34,66) and a2 not in (10,25,26,34,66)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if a2_donor=19 then
                        do;
                            if (a1 not in (19,29,30,31,32,33,74) and a2 not in (19,29,30,31,32,33,74)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if a2_donor=28 then
                        do;
                            if (a1 not in (28,68,69) and a2 not in (28,68,69)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if a2_donor ne a1 and a2_donor ne a2 then nummismatch = nummismatch+1;
                end;

			*LOOK FOR A LOCUS SUBTYPE EQUIVALENCES;
			if (a1_donor=9 or a2_donor=9) and a1 ne 9 and a2 ne 9 and (a1 in (23,24) or a2 in (23,24))
                then subtypematchnum_a9=1; 
			if (a1_donor=10 or a2_donor=10) and a1 ne 10 and a2 ne 10 and (a1 in (25,26,34,66) or a2 in (25,26,34,66)) 
                then subtypematchnum_a10=1;
			if (a1_donor=19 or a2_donor=19) and a1 ne 19 and a2 ne 19 and (a1 in (29,30,31,32,33,74) or a2 in (29,30,31,32,33,74)) 
                then subtypematchnum_a19=1;
			if (a1_donor=28 or a2_donor=28) and a1 ne 28 and a2 ne 28 and (a1 in (68,69) or a2 in (68,69)) 
                then subtypematchnum_a28=1;
           
            *LOOK FOR DONOR B1 VS RECIPIENT B1 OR B2 MISMATCHES;
			if b1_donor=5 and (b1 not in (5,51,52) and b2 not in (5,51,52)) then nummismatch = nummismatch+1;
            else if b1_donor=12 and (b1 not in (12,44,45) and b2 not in (12,44,45)) then nummismatch = nummismatch+1;
			else if b1_donor=14 and (b1 not in (14,64,65) and b2 not in (14,64,65)) then nummismatch = nummismatch+1;
			else if b1_donor=15 and (b1 not in (15,62,63,75,76,77) and b2 not in (15,62,63,75,76,77)) then nummismatch = nummismatch+1;
			else if b1_donor=16 and (b1 not in (16,38,39) and b2 not in (16,38,39)) then nummismatch = nummismatch+1;
			else if b1_donor=17 and (b1 not in (17,57,58) and b2 not in (17,57,58)) then nummismatch = nummismatch+1;
            else if b1_donor=21 and (b1 not in (21,49,50) and b2 not in (21,49,50)) then nummismatch = nummismatch+1;
            else if b1_donor=22 and (b1 not in (22,54,55,56) and b2 not in (22,54,55,56)) then nummismatch = nummismatch+1;
            else if b1_donor=40 and (b1 not in (40,60,61) and b2 not in (40,60,61)) then nummismatch = nummismatch+1;
            else if b1_donor=70 and (b1 not in (70,71,72) and b2 not in (70,71,72)) then nummismatch = nummismatch+1;
            else if b1_donor ne b1 and b1_donor ne b2 then nummismatch = nummismatch+1;

			/*From Mike Cecka: If the donor B1 and B2 are not the same, look to see if donor B2 matches recipient B1 or B2.  
			  If the donor is homozygous, meaning donor B1 and B2 are equal, then any mismatch is counted only once */
			if b1_donor ne b2_donor then 
			    do;
                    if b2_donor=5 then
                        do;
                            if (b1 not in (5,51,52) and b2 not in (5,51,52)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor=12 then 
                        do;
                            if (b1 not in (12,44,45) and b2 not in (12,44,45)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor=14 then
                        do;
                            if (b1 not in (14,64,65) and b2 not in (14,64,65)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor=15 then 
                        do;
                            if (b1 not in (15,62,63,75,76,77) and b2 not in (15,62,63,75,76,77)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor=16 then 
                        do;
                            if (b1 not in (16,38,39) and b2 not in (16,38,39)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor=17 then 
                        do;
                            if (b1 not in (17,57,58) and b2 not in (17,57,58)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor=21 then 
                        do;
                            if (b1 not in (21,49,50) and b2 not in (21,49,50)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor=22 then 
                        do;
                            if (b1 not in (22,54,55,56) and b2 not in (22,54,55,56)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor=40 then 
                        do;
                            if (b1 not in (40,60,61) and b2 not in (40,60,61)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor=70 then 
                        do;
                            if (b1 not in (70,71,72) and b2 not in (70,71,72)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if b2_donor ne b1 and b2_donor ne b2 then nummismatch = nummismatch+1;
                end;

			*LOOK FOR B LOCUS SUBTYPE EQUIVALENCES;
			if (b1_donor=5 or b2_donor=5) and b1 ne 5 and b2 ne 5 and (b1 in (51,52) or b2 in (51,52))
                then subtypematchnum_b5=1; 
			if (b1_donor=12 or b2_donor=12) and b1 ne 12 and b2 ne 12 and (b1 in (44,45) or b2 in (44,45)) 
                then subtypematchnum_b12=1;
			if (b1_donor=14 or b2_donor=14) and b1 ne 14 and b2 ne 14 and (b1 in (64,65) or b2 in (64,65)) 
                then subtypematchnum_b14=1;
			if (b1_donor=15 or b2_donor=15) and b1 ne 15 and b2 ne 15 and (b1 in (62,63,75,76,77) or b2 in (62,63,75,76,77)) 
                then subtypematchnum_b15=1;
			if (b1_donor=16 or b2_donor=16) and b1 ne 16 and b2 ne 16 and (b1 in (38,39) or b2 in (38,39)) 
                then subtypematchnum_b16=1;
			if (b1_donor=17 or b2_donor=17) and b1 ne 17 and b2 ne 17 and (b1 in (57,58) or b2 in (57,58)) 
                then subtypematchnum_b17=1;
			if (b1_donor=21 or b2_donor=21) and b1 ne 21 and b2 ne 21 and (b1 in (49,50) or b2 in (49,50)) 
                then subtypematchnum_b21=1;
			if (b1_donor=22 or b2_donor=22) and b1 ne 22 and b2 ne 22 and (b1 in (54,55,56) or b2 in (54,55,56)) 
                then subtypematchnum_b22=1;
			if (b1_donor=40 or b2_donor=40) and b1 ne 40 and b2 ne 40 and (b1 in (60,61) or b2 in (60,61)) 
                then subtypematchnum_b40=1;
			if (b1_donor=70 or b2_donor=70) and b1 ne 70 and b2 ne 70 and (b1 in (71,72) or b2 in (71,72)) 
                then subtypematchnum_b70=1;

            *LOOK FOR DONOR B1 VS RECIPIENT B1 OR B2 MISMATCHES;
	        if dr1_donor=2 and (dr1 not in (2,15,16) and dr2 not in (2,15,16)) then nummismatch = nummismatch+1;
			else if dr1_donor=3 and (dr1 not in (3,17,18) and dr2 not in (3,17,18)) then nummismatch = nummismatch+1;
			else if dr1_donor=5 and (dr1 not in (5,11,12) and dr2 not in (5,11,12)) then nummismatch = nummismatch+1;
			else if dr1_donor=6 and (dr1 not in (6,13,14) and dr2 not in (6,13,14)) then nummismatch = nummismatch+1;
            else if dr1_donor ne dr1 and dr1_donor ne dr2 then nummismatch = nummismatch+1;
			
			/*From Mike Cecka: If the donor DR1 and DR2 are not the same, look to see if donor DR2 matches recipient DR1 or DR2.  
			  If the donor is homozygous, meaning donor DR1 and DR2 are equal, then any mismatch is counted only once */
			if dr1_donor ne dr2_donor then 
			    do;
                    if dr2_donor=2  then 
                        do;
                            if (dr1 not in (2,15,16) and dr2 not in (2,15,16)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if dr2_donor=3  then 
                        do;
                            if (dr1 not in (3,17,18) and dr2 not in (3,17,18)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if dr2_donor=5  then 
                        do;
                            if (dr1 not in (5,11,12) and dr2 not in (5,11,12)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if dr2_donor=6  then 
                        do;
                            if (dr1 not in (6,13,14) and dr2 not in (6,13,14)) then nummismatch = nummismatch+1;
							else nummismatch=nummismatch+0;
                        end;
                    else if dr2_donor ne dr1 and dr2_donor ne dr2 then nummismatch = nummismatch+1;
	            end;

           *LOOK FOR DR LOCUS SUBTYPE EQUIVALENCES;
			if (dr1_donor=2 or dr2_donor=2) and dr1 ne 2 and dr2 ne 2 and (dr1 in (15,16) or dr2 in (15,16)) 
                then subtypematchnum_dr2=1;
			if (dr1_donor=3 or dr2_donor=3) and dr1 ne 3 and dr2 ne 3 and (dr1 in (17,18) or dr2 in (17,18)) 
                then subtypematchnum_dr3=1;
			if (dr1_donor=5 or dr2_donor=5) and dr1 ne 5 and dr2 ne 5 and (dr1 in (11,12) or dr2 in (11,12)) 
                then subtypematchnum_dr5=1;
			if (dr1_donor=6 or dr2_donor=6) and dr1 ne 6 and dr2 ne 6 and (dr1 in (13,14) or dr2 in (13,14)) 
                then subtypematchnum_dr6=1;

            if nummismatch ge 1 then hlamismatch=1; 
            else hlamismatch=0;
       end;


drop
missrcpt
missdonor
subtypematchnum_a9
subtypematchnum_a10
subtypematchnum_a19
subtypematchnum_a28
subtypematchnum_b5
subtypematchnum_b12
subtypematchnum_b14
subtypematchnum_b15
subtypematchnum_b16
subtypematchnum_b17
subtypematchnum_b21
subtypematchnum_b22
subtypematchnum_b40
subtypematchnum_b70
subtypematchnum_dr2
subtypematchnum_dr3
subtypematchnum_dr5
subtypematchnum_dr6
;
run;

*proc print data=merged2;
proc print data=ab2;
var
record_id
/*hla_a_allele1*/
/*hla_a_se1*/
/*hla_a_allele2*/
/*hla_a_se2*/

a1
a2

/*hla_a_allele1_donor*/
/*hla_a_se1_donor*/
/*hla_a_allele2_donor*/
/*hla_a_se2_donor*/

a1_donor
a2_donor

/*hla_b_allele1*/
/*hla_b_se1*/
/*hla_b_allele2*/
/*hla_b_se2*/

b1
b2

/*hla_b_allele1_donor*/
/*hla_b_se1_donor*/
/*hla_b_allele2_donor*/
/*hla_b_se2_donor*/

b1_donor
b2_donor

/*hla_drb_allele1*/
/*hla_drb_se1*/
/*hla_drb_allele2*/
/*hla_drb_se2*/

dr1
dr2

/*hla_drb_allele1_donor*/
/*hla_drb_se1_donor*/
/*hla_drb_allele2_donor*/
/*hla_drb_se2_donor*/

dr1_donor
dr2_donor

nummismatch
hlamismatch
;
run;

proc freq data = ab2;
table a1	a2	a1_donor	a2_donor	b1	b2	b1_donor	b2_donor	dr1	dr2	dr1_donor	dr2_donor / nocol norow nopercent missing;
run;

&clean.;
*proc contents data=merged2 order=varnum;
proc contents data=ab2 order=varnum;
run;

data mylib.ab2;
set ab2;
run;

*****************************************************************************************************************************;
*****************************************************************************************************************************;
*****************************************************************************************************************************;

ods excel file="/home/u63327094/analysis_MISSION_PS_data_reports/HLA_nummismatch_ps.csv";

*Checking the HLA data for our meeting with David;

proc print data=ab1;
var record_id
hla_a_allele1
hla_a_se1
hla_a_allele2
hla_a_se2

hla_b_allele1
hla_b_se1
hla_b_allele2
hla_b_se2

hla_drb_allele1
hla_drb_se1
hla_drb_allele2
hla_drb_se2
;
where site=3;
run;

*proc print data=merged1p1;
proc print data=ab1;
var record_id
hla_a_allele1
hla_a_se1
hla_a_allele2
hla_a_se2

hla_b_allele1
hla_b_se1
hla_b_allele2
hla_b_se2

hla_drb_allele1
hla_drb_se1
hla_drb_allele2
hla_drb_se2
;
where site=4;
run;


*proc print data=merged1p1;
proc print data=ab1;
var record_id
hla_a_allele1_donor
hla_a_se1_donor
hla_a_allele2_donor
hla_a_se2_donor

hla_b_allele1_donor
hla_b_se1_donor
hla_b_allele2_donor
hla_b_se2_donor

hla_drb_allele1_donor
hla_drb_se1_donor
hla_drb_allele2_donor
hla_drb_se2_donor
;
where site=3;
run;

*proc print data=merged1p1;
proc print data=ab1;
var record_id
hla_a_allele1_donor
hla_a_se1_donor
hla_a_allele2_donor
hla_a_se2_donor

hla_b_allele1_donor
hla_b_se1_donor
hla_b_allele2_donor
hla_b_se2_donor

hla_drb_allele1_donor
hla_drb_se1_donor
hla_drb_allele2_donor
hla_drb_se2_donor
;
where site=4;
run;


*Nummismatch;
proc print data=ab2;
var
record_id
/*hla_a_allele1*/
/*hla_a_se1*/
/*hla_a_allele2*/
/*hla_a_se2*/

a1
a2

/*hla_a_allele1_donor*/
/*hla_a_se1_donor*/
/*hla_a_allele2_donor*/
/*hla_a_se2_donor*/

a1_donor
a2_donor

/*hla_b_allele1*/
/*hla_b_se1*/
/*hla_b_allele2*/
/*hla_b_se2*/

b1
b2

/*hla_b_allele1_donor*/
/*hla_b_se1_donor*/
/*hla_b_allele2_donor*/
/*hla_b_se2_donor*/

b1_donor
b2_donor

/*hla_drb_allele1*/
/*hla_drb_se1*/
/*hla_drb_allele2*/
/*hla_drb_se2*/

dr1
dr2

/*hla_drb_allele1_donor*/
/*hla_drb_se1_donor*/
/*hla_drb_allele2_donor*/
/*hla_drb_se2_donor*/

dr1_donor
dr2_donor

nummismatch
hlamismatch
;
run;

ods excel close;

*****************************************************************************************************************************;
*****************************************************************************************************************************;
*****************************************************************************************************************************;

*c;

*c1;
%selectvars(c1,										
		dialysis_post_tx	dt_dialysis_posttx	reason_dialysis_posttx	other_diaysis_posttx					
		dt_last_dialysis	dialysis_post_tx_count	data_entered_byc1	c1_postoperative_information_com					
		);								
proc print data=mylib.c1;										
run;										
										
*c2;
%selectvars(c2,										
		scr_day5_avail	scr_day7_avail	date_creatinine_day5	creatinine_day5					
		date_creatinine_day7	creatinine_day7	data_entered_byc2	c2_postoperative_week_1_serum_cr					
		);								
proc print data=mylib.c2;										
run;	

*C1;

data c1;
set mylib.c1;
run;

proc contents data = c1 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data c1;
set c1;
label 
dialysis_post_tx = "Did the participant receive dialysis after transplantation? (within first week post-transplant)"
reason_dialysis_posttx = "If yes, record the primary indication for dialysis"
other_diaysis_posttx = "if other, please specify"
dt_last_dialysis = "If yes, record the date of the last dialysis therapy received"
dialysis_post_tx_count = "If yes, was there more than one dialysis run conducted?"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value dialysis_post_tx 1="Yes" 0="No";
value reason_dialysis_posttx 1 = "Acute Tubular Necrosis/Delayed Graft Function" 2 = "Thrombosis" 3 = "Volume Overload" 4 = "Hyperkalemia" 5 = "Other" 6 = "Not known";
value dialysis_post_tx_count 1="Yes" 0="No";
run;

data c1;
set c1;
format dialysis_post_tx dialysis_post_tx.;
format reason_dialysis_posttx reason_dialysis_posttx.;
format dialysis_post_tx_count dialysis_post_tx_count.;
run;

data mylib.c1clean;
set c1;
run;

proc contents data=c1 order=varnum;
run;

*C2;

data c2;
set mylib.c2;
run;

proc contents data = c2 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data c2;
set c2;
label 
scr_day5_avail = "Serum creatinine Day 5 post - transplant availability"
scr_day7_avail = "Serum creatinine Day 7 post - transplant availability"	
date_creatinine_day5	= "Serum creatinine Day 5 post - transplant date"
creatinine_day5	= "Serum creatinine Day 5 post - transplant value"
date_creatinine_day7 = "Serum creatinine Day 7 post - transplant date"
creatinine_day7	= "Serum creatinine Day 7 post - transplant value"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value scr_day5_avail 1="Yes" 2="No";
value scr_day7_avail 1="Yes" 2="No";
run;

data c2;
set c2;
format scr_day5_avail scr_day5_avail.;
format scr_day7_avail scr_day7_avail.;
run;

data mylib.c2clean;
set c2;
run;

*Running a report for C2 using the macro now;

proc contents data=c2 order=varnum;
run;

data mylib.c;
merge mylib.c1clean mylib.c2clean;
by record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

*d1;
%selectvars(d1,										
		study	participating_site	blood	blood_collectn_dt					
		blood_tubes	blood_label_1	blood_label_2	person_collecting					
		blood_ship_dt	person_shipping	d1_sample_collection_for_dna_and						
		);								
proc print data=mylib.d1;										
run;										
										
*d2;
%selectvars(d2,										
		study_mb	site_name_mb	mbsamples_collect	mbsamples_nocollect					
		rec___1	rec___2	rec___3	rec___0					
		sal___1	sal___2	sal___3	sal___0					
		uri___1	uri___2	uri___3	uri___0					
		ton___1	ton___2	ton___3	ton___0					
		gin___1	gin___2	gin___3	gin___0					
		hpl___1	hpl___2	hpl___3	hpl___0					
		buc___1	buc___2	buc___3	buc___0					
		nas___1	nas___2	nas___3	nas___0					
		mb_sample_timepoint	mb_samples	collectn_dt_mb	stool_mb_collectdt					
		stool_mb_collect_time	stool_mb_rcvd_lab_date	stool_mb_rcvd_lab_time	stool_mb_rnalater					
		urine_mb_collect_date	urine_mb_collect_time	urine_mb_rcvd_lab_time	label_feces_sample					
		label_feces_dna1	label_feces_dna2	label_feces_dna3	label_feces_dna4					
		label_feces_dna5	label_feces_dna6	label_feces_dna7	label_feces_dna8					
		label_feces_dna9	label_feces_dna10	label_feces_rna	label_sal_dna					
		label_sal_rna	label_urine_sample	label_urine_mrna	label_urine_dna					
		label_urine_rna	label_urine_metabolites1	label_urine_metabolites2	label_urine_metabolites3					
		label_urine_metabolites4	label_ton_dna	label_ton_rna	label_ton_metabolite					
		label_hpl_dna	label_hpl_rna	label_hpl_metabolite	label_buc_dna					
		label_buc_rna	label_buc_metabolite	label_gin_dna	label_gin_rna					
		label_gin_metabolite	label_nas_dna	label_nas_rna	label_nas_metabolite					
		person_collecting_mb	blood_ship_dt_mb	person_shipping_mb	d2_sample_collection_and_transpo					
		);								
proc print data=mylib.d2;										
run;										
										
*d3;
%selectvars(d3,
		hour_recall	recall_study_visit	recall_conducted_dt	begin_recall_dt
		end_recall_dt	data_entered_byd3	d3_dietary_recalls_complete
		);
proc print data=mylib.d3;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

*D1;

data d1;
set mylib.d1;
run;

proc contents data = d1 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data d1;
set d1;
label 
blood = "Blood samples collected, Yes vs No"
blood_collectn_dt = "Blood samples collection date"				
blood_tubes	= "Number of blood tubes, 1x10mL or 2x5mL"
blood_label_1 = "Blood label ID"	
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value blood 1="Yes" 0="No";
run;

data d1;
set d1;
format blood blood.;
run;

*Running a report for d1 using the macro now;

proc contents data=d1 order=varnum;
run;

data mylib.d1clean;
set d1;
run;

*D2;

data d2;
set mylib.d2;
run;

proc contents data = d2 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data d2;
set d2;
label 		
mbsamples_collect = "Were microbiome samples collected?"		
rec___1 = "Feces DNA collected"
rec___2	= "Feces RNA collected"
rec___3	= "Feces metabolite collected"
rec___0	= "Feces sample not collected"				
mb_sample_timepoint	= "Microbiome sample collection timepoint"
mb_samples	= "Were all the microbiome samples collected on the same date?"
collectn_dt_mb	= "Microbiome sample collection date"
collectn_dt_mb	= "Microbiome sample collection date"
stool_mb_collectdt = "Stool microbiome sample collection date"
stool_mb_collect_time = "Stool microbiome sample collection time"					
stool_mb_rcvd_lab_date = "Stool microbiome sample lab received date"
stool_mb_rcvd_lab_time = "Stool microbiome sample lab received date"
label_feces_sample = "Stool microbiome sample label"										
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value mbsamples_collect 1="Yes" 0="No";		
value rec1label 1="Yes" 0="No";
value rec2label	1="Yes" 0="No";
value rec3label	1="Yes" 0="No";
value rec0label	1="Yes" 0="No";				
value mb_sample_timepoint	1="Week 1" 2="MMF PK Study Visit" 5="Month 2" 3="Month 4" 4="Month 6";
value mb_samples	1="Yes" 0="No";
run;

data d2;
set d2;
format mbsamples_collect mbsamples_collect.;		
format rec___1 rec1label.;
format rec___2	rec2label.;
format rec___3	rec3label.;
format rec___0	rec0label.;				
format mb_sample_timepoint	mb_sample_timepoint.;
format mb_samples  mb_samples.;
run;


data d2date;
set d2;
where mbsamples_collect = 1; 
datecheck =  stool_mb_rcvd_lab_date - stool_mb_collectdt;
run;

data mylib.d2clean;
set d2;
run;

*Running a report for d2 using the macro now;

proc contents data=d2 order=varnum;
run;

**I will need to transpose D2 so we don't have repeated observations;
**https://stats.oarc.ucla.edu/sas/modules/how-to-reshape-data-long-to-wide-using-proc-transpose/;
**https://stats.oarc.ucla.edu/sas/modules/how-to-reshape-data-wide-to-long-using-proc-transpose/;

data d2;
set mylib.d2clean;
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

proc print data = d2;
run;

data d2long;
set d2;
keep 
record_id	
redcap_event_name 
mb_sample_timepoint	
mb_samples 
collectn_dt_mb
stool_mb_collectdt 
stool_mb_collect_time 					
stool_mb_rcvd_lab_date 
stool_mb_rcvd_lab_time 
label_feces_sample
label_feces_rna;
run;

proc print data = d2long;
run;

proc sort data = d2long;
by record_id;
run;

proc print data = d2long;
run;

/*
proc transpose data=d2long out=d2widestooldna prefix=label_feces_sample_;
    by record_id;
    id mb_sample_timepoint;
    var label_feces_sample;
run;

proc print data = d2widestooldna;
run;
*/

proc transpose data=d2long out=d2widestooldna prefix=label_feces_sample_;
    by record_id;
    id redcap_event_name;
    var label_feces_sample;
run;

proc print data = d2widestooldna;
run;


ods excel file="/home/u63327094/analysis_MISSION_PS_data_reports/stool_Ids_tac_UMGC_01042024.xlsx";

proc print data = d2widestooldna;
run;

ods excel close;

proc print data = d2widestooldna label;
run;

/*
proc transpose data=d2long out=d2widestoolrna prefix=label_feces_rna_;
    by record_id;
    id mb_sample_timepoint;
    var label_feces_rna;
run;

proc print data = d2widestoolrna;
run;
*/

proc transpose data=d2long out=d2widestoolrna prefix=label_feces_rna_;
    by record_id;
    id redcap_event_name;
    var label_feces_rna;
run;

proc print data = d2widestoolrna;
run;

/*
proc transpose data=d2long out=d2widestooldate prefix=collectn_dt_mb_;
    by record_id;
    id mb_sample_timepoint;
    var collectn_dt_mb;
run;

proc print data = d2widestooldate;
run;
*/

proc transpose data=d2long out=d2widestooldate prefix=collectn_dt_mb_;
    by record_id;
    id redcap_event_name;
    var collectn_dt_mb;
run;

proc print data = d2widestooldate;
run;

proc transpose data=d2long out=d2widestoolsampledate prefix=stool_mb_collectdt_;
    by record_id;
    id redcap_event_name;
    var stool_mb_collectdt;
run;

proc print data = d2widestoolsampledate;
run;

proc transpose data=d2long out=d2widestoolsampletime prefix=stool_mb_collect_time_;
    by record_id;
    id redcap_event_name;
    var stool_mb_collect_time;
run;

proc print data = d2widestoolsampletime;
run;

proc transpose data=d2long out=d2widelabsampledate prefix=stool_mb_rcvd_lab_date_;
    by record_id;
    id redcap_event_name;
    var stool_mb_rcvd_lab_date;
run;

proc print data = d2widelabsampledate;
run;

proc transpose data=d2long out=d2widelabsampletime prefix=stool_mb_rcvd_lab_time_;
    by record_id;
    id redcap_event_name;
    var stool_mb_rcvd_lab_time;
run;

proc print data = d2widelabsampletime;
run;

data d2widestool;
    merge  d2widestooldna(drop=_name_) d2widestoolrna(drop=_name_) d2widestooldate(drop=_name_) d2widestoolsampledate(drop=_name_) d2widestoolsampletime(drop=_name_) d2widelabsampledate(drop=_name_) d2widelabsampletime(drop=_name_);
    by record_id;
run;

proc print data=d2widestool;
run;

data mylib.d2widestool;
set d2widestool;
run;

proc export 
  data= mylib.d2widestool
  dbms=xlsx 
  outfile="/home/u63327094/analysis_MISSION_PS_data_reports/mission_demo_microbiome_ps_toshare_03012024.xlsx" 
  replace;
run;

*D3;

data d3;
set mylib.d3;
run;

proc contents data = d3 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data d3;
set d3;
label 		
hour_recall	= "Was a 48H recall collected?"
recall_study_visit = "48H recall collection timepoint"	
recall_conducted_dt	= "48H recall collection date"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value hour_recall 1="Yes" 0="No";		
value recall_study_visit 1="Week 1 Post-Transplant" 2="Pre-PK Study Visit" 3="During PK Study Visit (12 hour dietary recall)" 4= "Month 2" 5= "Month 4" 6= "Month 6";
run;

data d3;
set d3;
format hour_recall hour_recall.;		
format recall_study_visit recall_study_visit.;
run;

*Running a report for d3 using the macro now;

proc contents data=d3 order=varnum;
run;

data mylib.d3clean;
set d3;
run;

proc print data=mylib.d3clean;
run;

proc sort data=mylib.d3clean;
by record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance;
run;

data mylib.d;
merge mylib.d1clean mylib.d3clean;
by record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc sort data = mylib.d2widestool;
by record_id;
run;

data mylib.d;
merge mylib.d1clean mylib.d2widestool;
by record_id
;
run;

proc print data = mylib.d;
run;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

*e1;
%selectvars(e1,
		possible_anemia	anemia_dt	hb_value_ane	hematocrit_value_ane					
		mpa_intake	mpa_drug_change_anemia	mpa_dose_reductn_ane	mpa_dose_reductn_dt_ane					
		mpa_discont_ane	mpa_discont_dt_ane	erythro_therapy_ane	erythro_therapy_dt_ane					
		anemia_bleed	low_hb_abtherapy_ane	anemia_ar	mpa_anemia_confirm					
		alemtuzumab_ane	azathioprine_ane	basiliximab_ane	sirolimus_ane					
		tacrolimus_ane	foscarnet_ane	ganciclovir_ane	valganciclovir_ane					
		ribavirin_ane	telaprevir_ane	penicillin_ane	dapsone_ane					
		linezolid_ane	bactrim_ane	arixtra_ane	losartan_use_ane					
		lisinopril_use_ane	iron_supplement_ane	iron_iv_ane	mpa_resolve_ane					
		mpa_resolvedt_ane	mpa_resolve_hgb_ane	mpa_resolve_hct_ane	mpa_dose_reductn_resume_ane					
		mpa_discont_resume_ane	mpa_discont_resumedt_ane	erythro_therapy_discont_ane	erythro_therapy_discontdt_ane					
		data_entered_bye1	e1_mpa_toxicity_anemia_complete
		);
proc print data=mylib.e1;										
run;										
										
*e2;
%selectvars(e2,										
		leukopenia_check	possible_leukopenia	leukopenia_dt	wbc_value					
		mpa_intake_leukopenia	mpa_leuco_drug_change	mpa_dose_reductn_leu	mpa_dose_reductn_dt_leu					
		mpa_discont_leu	mpa_discont_dt_leu	gcsf_leu	gcsf_dt_leu					
		cmv_leu	abtherapy_leu	ar_leu	mpa_confirm_leu					
		alemtuzumab_leu	atgam_leu	thymoglobulin_leu	azathioprine_leu					
		basiliximab_leu	corticosteroid_leu	sirolimus_leu	tacrolimus_leu					
		acyclovir_leu	foscarnet_leu	ganciclovir_leu	valacyclovir_leu					
		valganciclovir_leu	atovazuone_leu	cefuroxime_leu	dapsone_leu					
		fluconazole_leu	linezolid_leu	micafungin_leu	bactrim_leu					
		minocycline_leu	captopril_leu	enalapril_leu	ticlopidine_leu					
		fluoxetine_leu	fluphenazine_leu	clozapine_leu	buproprion_leu					
		lamotrigine_leu	mpa_resolve_leu	mpa_resolvedt_leu	mpa_resolve_wbc_leu					
		mpa_dose_resume_leu	mpa_discont_resume_leu	mpa_discont_resumedt_leu	gcsf_discont_leu					
		gcsf_discontdt_leu	data_entered_bye2	e2_mpa_toxicity_leukopenia_compl						
		);								
proc print data=mylib.e2;										
run;										
										
*e3;
%selectvars(e3,										
		possible_diarrhea	diarrhea_event_dt	take_mpa_diarrhea	mpa_intake_diarrhea					
		mpa_dose_adj_diarrhea___1	mpa_dose_adj_diarrhea___2	mpa_dose_adj_diarrhea___3	mpa_dose_adj_diarrhea___4					
		mpa_dose_adj_diarrhea___5	mpa_dose_adj_diarrhea___6	mpa_doese_adj_dia_dt	diarrhea_othercause					
		stool_culture	stool_infection	infexn_diarrhea_type	diarrhea_resolve					
		diarrhea_resolve_dt	data_entered_bye3	e3_mpa_toxicity_diarrhea_complet						
		);								
proc print data=mylib.e3;										
run;										
										
*e4;
%selectvars(e4,										
		diabetesmed_baseline	pretx_diabetes_presence	diabetesmed_posttx	nodat_confirm					
		nodat_dt	diabetes_posttx_type	dt_glu_drug_nodat_avail	med_initiation_nodat_dt					
		nodat_med	oral_hypogly_nodat	diet_date_nodat_avail	diet_modificatn_nodat_dt					
		tac_name_nodat___1	tac_name_nodat___2	tac_name_nodat___3	tac_name_nodat___4					
		measure_avail_nod	dt_diag_nodat	serum_glu_nod	type_measurement_nod					
		measure_avail_nod_confirm	dt_confirm_nodat_2	serum_glu_nodat_confirm	measure_nodat_confirm					
		data_entered_bye4	e4_new_onset_diabetes_after_tran							
		);								
proc print data=mylib.e4;										
run;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

*E1;

data e1;
set mylib.e1;
run;

proc contents data = e1 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data e1;
set e1;
label 
possible_anemia = "Did the participant experience possible episode(s) of mycophenolate-related anemia in the first 12 months post-transplant?"
anemia_dt = "If yes, record the date and value of blood count measure with either a hemoglobin of less than 10 g/dL or a hematocrit of less than 30%. Record both if they are available and drawn on the same day."	
hb_value_ane = 	"Hemoglobin value"
hematocrit_value_ane = "Hematocrit value"					
mpa_intake = "Was the participant taking (prescribed) mycophenolate (CellCept, Myfortic or generic ) within 14 days prior to the date of low hemoglobin or hematocrit given in question 2?"	
mpa_drug_change_anemia = "If yes to possible episode of MPA-related anemia, was there any changes made to the participant's mycophenolate regimen within 30 days following the low hemoglobin or hematocrit measure given in question 2? "
mpa_dose_reductn_ane = "Mycophenolate total daily dose reduction lasting at least 2 weeks"	
mpa_dose_reductn_dt_ane = "Date of Dose Reduction"					
mpa_discont_ane	= "Mycophenolate discontinued for at least 2 weeks"
mpa_discont_dt_ane = "Date of Discontinuation"	
erythro_therapy_ane	= "Initiation of erythropoietin or peginesatide therapy in response to the low red blood count"
erythro_therapy_dt_ane = "Date of Prescription for Erythropoietin or Peginesatide therapy"					
anemia_bleed = "On the date of the low hemoglobin or hematocrit measure in question 2, was there a case of active bleeding?"	
low_hb_abtherapy_ane = "If no, was the low hemoglobin or hematocrit measure in question 2, obtained within two weeks following a dose of antibody therapy"	
anemia_ar = "Between the date of the low hemoglobin or hematocrit measure given in question 2 and the last action taken in question 4, was the participant diagnosed with acute rejection?"	
mpa_anemia_confirm = "Based on the data researched and entered above, did a Mycophenolate related Anemia event occur?"					
alemtuzumab_ane = "Alemtuzumab (Campath)"
azathioprine_ane = "Azathioprine (Imuran)"	
basiliximab_ane	= "Basiliximab (Simulect)"
sirolimus_ane = "Sirolimus (Rapamune)"					
tacrolimus_ane = "Tacrolimus (Prograf)"	
foscarnet_ane = "Foscarnet (Foscavir)"	
ganciclovir_ane	= "Ganciclovir (Cytovene)"
valganciclovir_ane = "Valganciclovir (Valcyte)"					
ribavirin_ane = "Ribavirin (Moderiba, Rebetol)"	
telaprevir_ane = "Telaprevir (Incivek, Incivo)"	
penicillin_ane = "Penicillin"	
dapsone_ane	= "Dapsone"				
linezolid_ane = "Linezolid"	
bactrim_ane	= "Suifamethoxazole /Trimethoprim (Co-Trimoxazole, Bactrim)"
arixtra_ane	= "Fondaparimux (Arixtra)"
losartan_use_ane = "Losartan (Cozaar)"					
lisinopril_use_ane = "Lisinopril (Prinivil, Zestril)"
iron_supplement_ane	= "Was the participant prescribed an iron supplement prior to the date of the low hemoglobin or hematocrit measure given in  question 2"
iron_iv_ane = "Was the participant given intravenous iron within two weeks following the date of low red hemoglobin or hematocrit measure given in question 2?"	
mpa_resolve_ane	= "Did the mycophenolate-related anemia resolve?"				
mpa_resolvedt_ane = "Date of lab value(s) showing resolution of MPA-related anemia"	
mpa_resolve_hgb_ane	= "Hemoglobin value"
mpa_resolve_hct_ane	= "Hematocrit value"
mpa_dose_reductn_resume_ane	= "If a mycophenolate dose reduction occurred, was the mycophenolate dose reduction still present at the time the anemia resolved?"				
mpa_discont_resume_ane = "If mycophenolate was discontinued after the anemia event, was it restarted"	
mpa_discont_resumedt_ane = "When was mycophenolate restarted?"	
erythro_therapy_discont_ane	= "If erythropoietin or peginestatide was initiated, was erythropoietin or peginestatide discontinued or no more doses given after the resolution of this anemia event?"
erythro_therapy_discontdt_ane = "Date of last dose"	
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value possible_anemia 1="Yes" 0="No";
value mpa_intake 1="Yes" 0="No";
value mpa_drug_change_anemia 1="Yes" 0="No";
value mpa_discont_ane	1="Yes" 0="No";
value erythro_therapy_ane	1="Yes" 0="No";
value anemia_bleed 1="Yes" 0="No";	
value low_hb_abtherapy_ane 1="Yes" 0="No";	
value anemia_ar 1="Yes" 0="No";	
value mpa_anemia_confirm 1="Yes" 0="No";					
value alemtuzumab_ane 1="Yes" 2="No";
value azathioprine_ane 1="Yes" 2="No";	
value basiliximab_ane	1="Yes" 2="No";
value sirolimus_ane 1="Yes" 2="No";					
value tacrolimus_ane 1="Yes" 2="No";	
value foscarnet_ane 1="Yes" 2="No";	
value ganciclovir_ane	1="Yes" 2="No";
value valganciclovir_ane 1="Yes" 2="No";					
value ribavirin_ane 1="Yes" 2="No";
value telaprevir_ane 1="Yes" 2="No";	
value penicillin_ane 1="Yes" 2="No";	
value dapsone_ane	1="Yes" 2="No";				
value linezolid_ane 1="Yes" 2="No";	
value bactrim_ane	1="Yes" 2="No";
value arixtra_ane	1="Yes" 2="No";
value losartan_use_ane 1="Yes" 2="No";				
value lisinopril_use_ane 1="Yes" 2="No";
value iron_supplement_ane	1="Yes" 0="No";
value iron_iv_ane 1="Yes" 0="No";
value mpa_resolve_ane	1="Yes" 0="No";				
value mpa_dose_reductn_resume_ane	1="Yes" 0="No";				
value mpa_discont_resume_ane 1="Yes" 0="No";	
value erythro_therapy_discont_ane	1="Yes" 0="No";
run;

data e1;
set e1;
format possible_anemia possible_anemia.;
format mpa_intake mpa_intake.;
format mpa_drug_change_anemia mpa_intake.;
format mpa_discont_ane mpa_discont_ane.;
format erythro_therapy_ane erythro_therapy_ane.;
format anemia_bleed erythro_therapy_ane.;	
format low_hb_abtherapy_ane low_hb_abtherapy_ane.;	
format anemia_ar anemia_ar.;	
format mpa_anemia_confirm mpa_anemia_confirm.;					
format alemtuzumab_ane alemtuzumab_ane.;
format azathioprine_ane azathioprine_ane.;	
format basiliximab_ane basiliximab_ane.;
format sirolimus_ane sirolimus_ane.;					
format tacrolimus_ane tacrolimus_ane.;	
format foscarnet_ane foscarnet_ane.;	
format ganciclovir_ane ganciclovir_ane.;
format valganciclovir_ane valganciclovir_ane.;					
format ribavirin_ane ribavirin_ane.;
format telaprevir_ane telaprevir_ane.;	
format penicillin_ane penicillin_ane.;	
format dapsone_ane dapsone_ane.;				
format linezolid_ane linezolid_ane.;	
format bactrim_ane bactrim_ane.;
format arixtra_ane arixtra_ane.;
format losartan_use_ane losartan_use_ane.;				
format lisinopril_use_ane lisinopril_use_ane.;
format iron_supplement_ane	iron_supplement_ane.;
format iron_iv_ane iron_supplement_ane.;
format mpa_resolve_ane	mpa_resolve_ane.;				
format mpa_dose_reductn_resume_ane	mpa_dose_reductn_resume_ane.;				
format mpa_discont_resume_ane mpa_discont_resume_ane.;	
format erythro_therapy_discont_ane	erythro_therapy_discont_ane.;
run;

proc contents data=e1 order=varnum;
run;

data e1pos;
set e1;
where possible_anemia = 1;
run;

proc print data = e1pos;
run;

data mylib.e1clean;
set e1;
run;

*e2;

data e2;
set mylib.e2;
run;

proc contents data = e2 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data e2;
set e2;
label 		
leukopenia_check = "Which months' look back is this for?"
possible_leukopenia	= "Did the participant experience a possible episode(s) of leukopenia in [leukopenia_check] post-transplant?"
leukopenia_dt = "Date obtained"
wbc_value = "WBC value (cells/cubic mm)"
mpa_intake_leukopenia = "Was the participant taking (prescribed) mycophenolate (CellCept, Myfortic or generic ) within 14 days prior to the date of low white blood count measure given in question 3"
mpa_leuco_drug_change =	"If the participant possibly experienced leukopenia, were there any changes made to the participant's mycophenolate regimen or GCSF initiated within 30 days following the low white blood count measure given in question 3"
mpa_dose_reductn_leu =	"Mycophenolate total daily dose reduction lasting at least 2 weeks"
mpa_dose_reductn_dt_leu	= "Date of Dose Reduction"
mpa_discont_leu	= "Mycophenolate discontinued for at least 2 weeks"
mpa_discont_dt_leu = "Date of Discontinuation"
gcsf_leu = "Adminstration of GCSF [e.g. filgrastim (Neupogen)]."
gcsf_dt_leu	= "Date of initiation of GCSF"
cmv_leu	= "As of the date of low white blood count given in question 3, was there concurrent sepsis or active CMV infection?"
abtherapy_leu = "If no in Question 6, was the low white blood count measure in question 3, obtained within two weeks following a dose of antibody therapy?"
ar_leu = "Between the date of the low white blood count measure given in question 3 and the last action taken in question 5, was the participant diagnosed with acute rejection?"
mpa_confirm_leu	= "Based on the data researched and entered above, did a mycophenolate-related leukopenia event occur?"
alemtuzumab_leu	= "Alemtuzumab (Campath)"
atgam_leu = "Antithymocyte Globulin (equine) (Atgam)"
thymoglobulin_leu = "Antithymocyte Globulin (rabbit) (Thymoglobulin)"
azathioprine_leu = "Azathioprine (Imuran)"
basiliximab_leu	= "Basiliximab (Simulect)"
corticosteroid_leu = "Corticosteroid (Prednisone, Methylprednisone, Dexamethasone etc.)"
sirolimus_leu = "Sirolimus (Rapamune)"
tacrolimus_leu =	"Tacrolimus (Prograf)"
acyclovir_leu =	"Acyclovir (Zovirax)"
foscarnet_leu = "Foscarnet (Foscavir)"
ganciclovir_leu = "Ganciclovir (Cytovene)"
valacyclovir_leu = "Valacyclovir (Valtrex)"
valganciclovir_leu = "Valganciclovir (Valcyte)"
atovazuone_leu = "Atovazuone (Mepron)"
cefuroxime_leu = "Cefuroxime (Ceftin, Zinacef)"
dapsone_leu	= "Dapsone"
fluconazole_leu	= "Fluconazole (Diflucan)"
linezolid_leu = "Linezolid"
micafungin_leu = "Micafungin (Mycamine)"
bactrim_leu = "Suifamethoxazole /Trimethoprim (Co-Trimoxazole, Bactrim )"
minocycline_leu	= "Minocycline (Minocin)"
captopril_leu = "Captopril (Captopen)"
enalapril_leu = "Enalapril (Vaseretic,Vasotec)"
ticlopidine_leu = "Ticlopidine (Ticlid)"
fluoxetine_leu = "Fluoxetine (Prozac)"
fluphenazine_leu = "Fluphenazine (Proloxin)"
clozapine_leu = "Clozapine (Clozaril)"
buproprion_leu = "Bupropion (Wellbutrin)"
lamotrigine_leu = "Lamotrigine (Lamictal)"
mpa_resolve_leu = "Did the mycophenolate-related leukopenia resolve?"
mpa_resolvedt_leu = "Date of lab value showing resolution of MPA-related leukopenia."
mpa_resolve_wbc_leu = "WBC value (cells/cubic mm)"
mpa_dose_resume_leu = "If a mycophenolate dose reduction occurred, was the mycophenolate dose reduction still present at time of leukopenia resolution?"
mpa_discont_resume_leu = "If mycophenolate was discontinued after the leukopenia event, was it restarted?"
mpa_discont_resumedt_leu = "Date mycophenolate was restarted"
gcsf_discont_leu = "If GCSF was initiated, was GCSF discontinued or no more doses given after resolution the of this leukopenia event?"
gcsf_discontdt_leu = "Date of last dose"										
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value leukopenia_check 1="0-6 months" 2="7-12 months";
value possible_leukopenia	1="Yes" 0="No";
value mpa_intake_leukopenia 1="Yes" 0="No";
value mpa_leuco_drug_change 1="Yes" 0="No";
value mpa_dose_reductn_leu 1="Yes" 0="No";
value mpa_discont_leu 1="Yes" 0="No";
value gcsf_leu 1="Yes" 0="No";
value cmv_leu	1="Yes" 0="No";
value abtherapy_leu 1="Yes" 0="No";
value ar_leu 1="Yes" 0="No";
value mpa_confirm_leu	1="Yes" 0="No";
value alemtuzumab_leu	1="Yes" 2="No";
value atgam_leu 1="Yes" 2="No";
value thymoglobulin_leu 1="Yes" 2="No";
value azathioprine_leu 1="Yes" 2="No";
value basiliximab_leu	1="Yes" 2="No";
value corticosteroid_leu 1="Yes" 2="No";
value sirolimus_leu 1="Yes" 2="No";
value tacrolimus_leu 1="Yes" 2="No";
value acyclovir_leu 1="Yes" 2="No";
value foscarnet_leu 1="Yes" 2="No";
value ganciclovir_leu 1="Yes" 2="No";
value valacyclovir_leu 1="Yes" 2="No";
value valganciclovir_leu 1="Yes" 2="No";
value atovazuone_leu 1="Yes" 2="No";
value cefuroxime_leu 1="Yes" 2="No";
value dapsone_leu	1="Yes" 2="No";
value fluconazole_leu	1="Yes" 2="No";
value linezolid_leu 1="Yes" 2="No";
value micafungin_leu 1="Yes" 2="No";
value bactrim_leu 1="Yes" 2="No";
value minocycline_leu	1="Yes" 2="No";
value captopril_leu 1="Yes" 2="No";
value enalapril_leu 1="Yes" 2="No";
value ticlopidine_leu 1="Yes" 2="No";
value fluoxetine_leu 1="Yes" 2="No";
value fluphenazine_leu 1="Yes" 2="No";
value clozapine_leu 1="Yes" 2="No";
value buproprion_leu 1="Yes" 2="No";
value lamotrigine_leu 1="Yes" 2="No";
value mpa_resolve_leu 1="Yes" 0="No";
value mpa_dose_resume_leu 1="Yes" 0="No";
value mpa_discont_resume_leu 1="Yes" 0="No";
value gcsf_discont_leu 1="Yes" 0="No";
run;

data e2;
set e2;
format leukopenia_check	leukopenia_check.;
format possible_leukopenia	possible_leukopenia.;
format mpa_intake_leukopenia	mpa_intake_leukopenia.;
format mpa_leuco_drug_change	mpa_leuco_drug_change.;
format mpa_dose_reductn_leu	mpa_dose_reductn_leu.;
format mpa_discont_leu	mpa_discont_leu.;
format gcsf_leu	gcsf_leu.;
format cmv_leu	cmv_leu.;
format abtherapy_leu	abtherapy_leu.;
format ar_leu	ar_leu.;
format mpa_confirm_leu	mpa_confirm_leu.;
format alemtuzumab_leu	alemtuzumab_leu.;
format atgam_leu	atgam_leu.;
format thymoglobulin_leu	thymoglobulin_leu.;
format azathioprine_leu	azathioprine_leu.;
format basiliximab_leu	basiliximab_leu.;
format corticosteroid_leu	corticosteroid_leu.;
format sirolimus_leu	sirolimus_leu.;
format tacrolimus_leu	tacrolimus_leu.;
format acyclovir_leu	acyclovir_leu.;
format foscarnet_leu	foscarnet_leu.;
format ganciclovir_leu	ganciclovir_leu.;
format valacyclovir_leu	valacyclovir_leu.;
format valganciclovir_leu	valganciclovir_leu.;
format atovazuone_leu	atovazuone_leu.;
format cefuroxime_leu	cefuroxime_leu.;
format dapsone_leu	dapsone_leu.;
format fluconazole_leu	fluconazole_leu.;
format linezolid_leu	linezolid_leu.;
format micafungin_leu	micafungin_leu.;
format bactrim_leu	bactrim_leu.;
format minocycline_leu	minocycline_leu.;
format captopril_leu	captopril_leu.;
format enalapril_leu	enalapril_leu.;
format ticlopidine_leu	ticlopidine_leu.;
format fluoxetine_leu	fluoxetine_leu.;
format fluphenazine_leu	fluphenazine_leu.;
format clozapine_leu	clozapine_leu.;
format buproprion_leu	buproprion_leu.;
format lamotrigine_leu	lamotrigine_leu.;
format mpa_resolve_leu	mpa_resolve_leu.;
format mpa_dose_resume_leu	mpa_dose_resume_leu.;
format mpa_discont_resume_leu	mpa_discont_resume_leu.;
format gcsf_discont_leu	gcsf_discont_leu.;
run;

*Running a report for e2 using the macro now;

proc contents data=e2 order=varnum;
run;

data e2pos;
set e2;
where possible_leukopenia = 1;
run;

proc contents data=e2pos order=varnum;
run;

data mylib.e2clean;
set e2;
run;

*E3;

data e3;
set mylib.e3;
run;

proc contents data = e3 order=varnum;
run;

/*
proc print data = e3;
var record_id redcap_event_name redcap_repeat_instrument redcap_repeat_instance possible_diarrhea take_mpa_diarrhea mpa_intake_diarrhea mpa_dose_adj_diarrhea;
where record_id = 3509;
run;

proc print data = e3;
var record_id redcap_event_name redcap_repeat_instrument redcap_repeat_instance possible_diarrhea take_mpa_diarrhea mpa_intake_diarrhea mpa_dose_adj_diarrhea;
where record_id = 3512;
run;
*/

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data e3;
set e3;
label 
possible_diarrhea =	"Did the participant experience diarrhea?"
diarrhea_event_dt =	"Date diarrhea event began or was noted in the EMR"
take_mpa_diarrhea =	"Was the participant on mycophenolate at the time of diarrhea"
mpa_intake_diarrhea = "Which mycophenolate product was the participant taking within 14 days prior to the date of diarrhea documented in question 2?"
mpa_dose_adj_diarrhea___1 = "Check if any of the following occurred following the date of diarrhea documented in Question 2. (Check all that apply): Mycophenolate total daily dose reduction (not discontinued) for  >= 24 hours"
mpa_dose_adj_diarrhea___2 = "Check if any of the following occurred following the date of diarrhea documented in Question 2. (Check all that apply): Mycophenolate interval change, but total daily dose kept constant for >= 24 hours"
mpa_dose_adj_diarrhea___3 = "Check if any of the following occurred following the date of diarrhea documented in Question 2. (Check all that apply): Mycophenolate discontinuation for >= 24 hours"
mpa_dose_adj_diarrhea___4 = "Check if any of the following occurred following the date of diarrhea documented in Question 2. (Check all that apply): Switch to an alternate formulation of mycophenolate"
mpa_dose_adj_diarrhea___5 = "Check if any of the following occurred following the date of diarrhea documented in Question 2. (Check all that apply): Mycophenolate total daily dose reduction and interval change for >= 24 hours"
mpa_dose_adj_diarrhea___6 = "Check if any of the following occurred following the date of diarrhea documented in Question 2. (Check all that apply): No dose modifications"
mpa_doese_adj_dia_dt = "Date of action(s) in Question 4."
diarrhea_othercause	= "Was the diarrhea potentially attributed to drugs other than mycophenolate or disease conditions?"
stool_culture =	"Was a stool culture test was done at the time (+/- 7 days) of diarrhea noted in EMR?"
stool_infection = "Was the diarrhea potentially caused by any infections?"
diarrhea_resolve = "Did the diarrhea resolve?"
diarrhea_resolve_dt = "Date of diarrhea resolution"		
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value possible_diarrhea 1="Yes" 0="No";	
value take_mpa_diarrhea 1="Yes" 0="No";	
value mpa_intake_diarrhea 1="Mycophenolate mofetil (Cellcept, generic)" 2="Mycophenolic acid (Myfortic)";
value mpa_dose_adj_diarrhea___1f  1="Yes" 0="No";	
value mpa_dose_adj_diarrhea___2f  1="Yes" 0="No";	
value mpa_dose_adj_diarrhea___3f  1="Yes" 0="No";	
value mpa_dose_adj_diarrhea___4f  1="Yes" 0="No";	
value mpa_dose_adj_diarrhea___5f  1="Yes" 0="No";	
value mpa_dose_adj_diarrhea___6f  1="Yes" 0="No";	
value diarrhea_othercause 1="Yes" 0="No" 2="Not known";	
value stool_culture 1="Yes" 0="No";	
value diarrhea_resolve  1="Yes" 2="No" 3="Unknown";	
run;

data e3;
set e3;
format possible_diarrhea possible_diarrhea.;
format diarrhea_event_dt diarrhea_event_dt.;
format take_mpa_diarrhea take_mpa_diarrhea.;
format mpa_intake_diarrhea mpa_intake_diarrhea.;
format mpa_dose_adj_diarrhea___1 mpa_dose_adj_diarrhea___1f.;
format mpa_dose_adj_diarrhea___2 mpa_dose_adj_diarrhea___2f.;
format mpa_dose_adj_diarrhea___3 mpa_dose_adj_diarrhea___3f.;
format mpa_dose_adj_diarrhea___4 mpa_dose_adj_diarrhea___4f.;
format mpa_dose_adj_diarrhea___5 mpa_dose_adj_diarrhea___5f.;
format mpa_dose_adj_diarrhea___6 mpa_dose_adj_diarrhea___6f.;
format diarrhea_othercause diarrhea_othercause.;
format stool_culture stool_culture.;
format diarrhea_resolve diarrhea_resolve.;
run;

*Running a report for e3 using the macro now;

proc contents data=e3 order=varnum;
run;

data e3pos;
set e3;
where possible_diarrhea = 1;
run;

proc contents data=e3pos order=varnum;
run;

proc print data = e3pos;
run;

data mylib.e3clean;
set e3;
run;

**I will need to transpose E3 so we don't have repeated observations;
**https://stats.oarc.ucla.edu/sas/modules/how-to-reshape-data-long-to-wide-using-proc-transpose/;
**https://stats.oarc.ucla.edu/sas/modules/how-to-reshape-data-wide-to-long-using-proc-transpose/;

data e3long;
set e3;
if  mpa_dose_adj_diarrhea___1 = 1 then mpa_dose_adj_diarrhea_demo = 1;
else if mpa_dose_adj_diarrhea___2 = 1 then mpa_dose_adj_diarrhea_demo = 2;
else if mpa_dose_adj_diarrhea___3 = 1 then mpa_dose_adj_diarrhea_demo = 3;
else if mpa_dose_adj_diarrhea___4 = 1 then mpa_dose_adj_diarrhea_demo = 4;
else if mpa_dose_adj_diarrhea___5 = 1 then mpa_dose_adj_diarrhea_demo = 5;
else if mpa_dose_adj_diarrhea___6 = 1 then mpa_dose_adj_diarrhea_demo = 6;
else mpa_dose_adj_diarrhea_demo = 0;
run;

proc format;
value mpa_dose_adj_diarrhea_demof 0 ="no data reported" 1="Mycophenolate total daily dose reduction (not discontinued) for  >= 24 hours" 2="Mycophenolate interval change, but total daily dose kept constant for >= 24 hours" 3="Mycophenolate discontinuation for >= 24 hours" 4= "Switch to an alternate formulation of mycophenolate" 5="Mycophenolate total daily dose reduction and interval change for >= 24 hours" 6="No dose modifications";
run;

data e3long;
set e3long;
format mpa_dose_adj_diarrhea_demo mpa_dose_adj_diarrhea_demof.;
run;

proc print data = e3long label;
run;

proc freq data = e3long;
tables mpa_dose_adj_diarrhea_demo;
run;

proc print data = e3long;
run;

*I will try to sort by both recordid and redcap event name;
proc sort data = e3long;
by record_id redcap_event_name;
run;

proc transpose data=e3long out=e3widepossible_diarrhea prefix=possible_diarrhea_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var possible_diarrhea;
run;

proc print data = e3widepossible_diarrhea;
run;

proc transpose data=e3long out=e3widediarrhea_event_dt prefix=diarrhea_event_dt_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var diarrhea_event_dt;
run;

proc print data = e3widediarrhea_event_dt;
run;

proc transpose data=e3long out=e3widetake_mpa_diarrhea prefix=take_mpa_diarrhea_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var take_mpa_diarrhea;
run;

proc print data = e3widetake_mpa_diarrhea;
run;

proc transpose data=e3long out=e3widempa_intake_diarrhea prefix=mpa_intake_diarrhea_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var mpa_intake_diarrhea;
run;

proc print data = e3widempa_intake_diarrhea;
run;	

proc transpose data=e3long out=e3widempa_doese_adj_dia_dt prefix=mpa_doese_adj_dia_dt_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var mpa_doese_adj_dia_dt;
run;

proc print data = e3widempa_doese_adj_dia_dt;
run;

proc transpose data=e3long out=e3widediarrhea_othercause prefix=diarrhea_othercause_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var diarrhea_othercause;
run;

proc print data = e3widediarrhea_othercause;
run;

proc transpose data=e3long out=e3widestool_culture prefix=stool_culture_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var stool_culture;
run;

proc print data = e3widestool_culture;
run;

proc transpose data=e3long out=e3widestool_infection prefix=stool_infection_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var stool_infection;
run;

proc print data = e3widestool_infection;
run;

proc transpose data=e3long out=e3wideinfexn_diarrhea_type prefix=infexn_diarrhea_type_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var infexn_diarrhea_type;
run;

proc print data = e3wideinfexn_diarrhea_type;
run;

proc transpose data=e3long out=e3widempa_dose_adj_diarrhea_demo prefix=mpa_dose_adj_diarrhea_demo_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var mpa_dose_adj_diarrhea_demo;
run;

proc print data = e3widempa_dose_adj_diarrhea_demo;
run;

data e3widestool;
    merge  e3widepossible_diarrhea(drop=_name_) e3widediarrhea_event_dt(drop=_name_) e3widetake_mpa_diarrhea(drop=_name_) e3widempa_intake_diarrhea(drop=_name_) e3widempa_doese_adj_dia_dt(drop=_name_) e3widempa_doese_adj_dia_dt(drop=_name_) e3widediarrhea_othercause(drop=_name_) e3widestool_culture(drop=_name_) e3widestool_infection(drop=_name_) e3wideinfexn_diarrhea_type(drop=_name_)  e3widempa_dose_adj_diarrhea_demo(drop=_name_);
    by record_id redcap_event_name;
run;

proc print data=e3widestool;
run;

data mylib.e3widestool;
set e3widestool;
run;

data e3widestool6months;
set e3widestool;
where redcap_event_name = "month_6_followup_arm_1";
run;

proc print data = e3widestool6months;
run;

proc contents data = e3widestool6months;
run;

data mylib.e3widestool6months;
set e3widestool6months;
run;

**************************************************************************************************************************************************************************;
**************************************************************************************************************************************************************************;
**************************************************************************************************************************************************************************;

*E4;

data e4;
set mylib.e4;
run;

proc contents data = e4 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data e4;
set e4;
label 
diabetesmed_baseline = "Was the participant prescribed glucose lowering drug therapy at baseline? (If yes, then not NODAT)	"
pretx_diabetes_presence	= "Did the participant have a pre-transplant diabetes diagnosis and treatment? (If yes, then not NODAT)	"
has_the_subject_had_a_noda = "Has the subject had a NODAT since the last entry?	"
diabetesmed_posttx = "Did the participant initiate glucose-lowering drug therapy after date of transplant? (If yes, then NODAT)	"
nodat_confirm = " Based on the data entered above, did the participant experience a NODAT event? "
nodat_dt = " Record the date of diagnosis of NODAT	"
diabetes_posttx_type = "Does the new onset diabetes after transplant require therapy"
dt_glu_drug_nodat_avail	= "Is the date of initiation of new glucose lowering drug therapy known?"
med_initiation_nodat_dt	= "Record the date of initiation of new glucose lowering drug therapy  "
nodat_med = "Record the type of new glucose lowering drug therapy initiated as of the date"
oral_hypogly_nodat = "If oral hypoglycemic agent, please specify"
diet_date_nodat_avail = "Was diet modification initiated along with glucose lowering drug therapy initiated?"
diet_modificatn_nodat_dt = "Record the date of initiation of diet modification for diabetes, if known."
tac_name_nodat = "Indicate if the participant was receiving any of the following at time of onset of NODAT. (Check all that apply)	"
measure_avail_nod =	"Is the glucose measurement available that <i> <u> made the diagnosis of NODAT  <i> <u>?	"
dt_diag_nodat = "Date of glucose measurement used in<i> <u> making the diagnosis of NODAT <i> <u>	"
serum_glu_nod = "Serum glucose value used in  <i> <u> making the diagnosis of NODAT </u> </i>	"
type_measurement_nod = "Type of measurement available used in<i> <u> making the diagnosis of NODAT in Question 4</u> </i>	"
measure_avail_nod_confirm = "Is a glucose measurement available for<i> <u>confirming the NODAT  <i> <u>	"
dt_confirm_nodat_2	= "Date of glucose measurement used in <i> <u>confirming NODAT  <i> <u>	"
serum_glu_nodat_confirm	= "Serum glucose value used in <i> <u>confirming the  NODAT </u> </i>	"
measure_nodat_confirm = "Type of measurement available used in <i> <u> confirming the NODAT </u> </i>	";
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value diabetesmed_baseline 1="Yes" 0="No";	
value pretx_diabetes_presence 1="Yes" 0="No";	
value has_the_subject_had_a_noda 1="Yes" 0="No";	
value diabetesmed_posttx 1="Yes" 0="No";	
value nodat_confirm 1="Yes" 0="No";	
value diabetes_posttx_type 1="Require glucose lowering drug therapy" 2="Require glucose lowering drug therapy and diet modification";
value dt_glu_drug_nodat_avail 1="Yes" 0="No";
value nodat_med 1="Oral hypoglycemic agent" 2="Insulin" 3="Not known";
value oral_hypogly_nodat 1="Biguanides - metformin (Glucophage, Fortamet, Glumetza, Riomet)" 2="Sulfonylureas - glimepiride (Amaryl), glipizide (Glucotrol), glyburide (Micronase, DiaBeta, Glynase Pres-Tab), Tolazamide (Tolinase), Tolbutamide (Orinase, Tol-Tab), Acetohexamide (Dymelor), chlorpropamide (Diabinese)" 3="Combination of sulfonylureas plus metformin - Will be listed by generic names of the sulfonylureas and metformin. glipizide/metformin (Metaglip), glyburide/metformin (Glucovance)" 4="Thiazolidinediones (Tzd) - pioglitazone (Actos, rosiglitazone (Avandia)" 5="Alpha-glucosidase inhibitors - Acarbose (Precose), Miglitol (Glycet)" 6="Meglitinides - nateglinide (Starlix), Repaglinide (Prandin)";
value diet_date_nodat_avail 1="Yes" 0="No";	
value tac_name_nodat 1="Tacrolimus" 2="Cyclosporine" 3="Steroid" 4="Mycophenolate";
value measure_avail_nod 1="Yes" 0="No";
value type_measurement_nod 1="Random/casual" 2="Fasting" 3="Two-hour postload OGTT" 4="Not known";
value measure_avail_nod_confirm 1="Yes" 0="No";
value measure_nodat_confirm 1="Random/casual" 2="Fasting" 3="Two-hour postload OGTT" 4="Not known";
run;

data e4;
set e4;
format diabetesmed_baseline	diabetesmed_baseline.;
format pretx_diabetes_presence	pretx_diabetes_presence.;
format has_the_subject_had_a_noda	has_the_subject_had_a_noda.;
format diabetesmed_posttx	diabetesmed_posttx.;
format nodat_confirm	nodat_confirm.;
format diabetes_posttx_type	diabetes_posttx_type.;
format dt_glu_drug_nodat_avail	dt_glu_drug_nodat_avail.;
format nodat_med	nodat_med.;
format oral_hypogly_nodat	oral_hypogly_nodat.;
format diet_date_nodat_avail	diet_date_nodat_avail.;
format tac_name_nodat	tac_name_nodat.;
format measure_avail_nod	measure_avail_nod.;
format type_measurement_nod	type_measurement_nod.;
format measure_avail_nod_confirm	measure_avail_nod_confirm.;
format measure_nodat_confirm	measure_nodat_confirm.;
run;

*Running a report for e4 using the macro now;

proc contents data=e4 order=varnum;
run;

data e4pos;
set e4;
where diabetesmed_posttx = 1;
run;

proc contents data=e4pos order=varnum;
run;

data mylib.e4clean;
set e4;
run;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

*F;

*f1;
%selectvars(f1,										
bilirubin_above_3x	
crcl_less_30mlpermin	
mpa	
txn_dt_pk					
pk_event_dt	
days_after_posttx_pk	
antacid_pk	
vomit_pk					
doses_pk	
confirm_pkcohort	
mmf_dose_missing_pk	
missing_immunosup_dose_pk					
missed_immuno_dose_freq_pk	
data_entered_byf1	
f1_mmf_pharmacokinetics_study_vi
		);								
proc print data=mylib.f1;										
run;										
										
*f2;
%selectvars(f2,										
mmf_dosefreq_pk
mmf_daily_dose_pk
mmf_dose_at_pk 
pk_mmf_dose_time_1					
pk_mmf_dose_time_2	
pk_mmf_dose_at_time_2	
data_entered_byf2	
f2_mmf_dosing_at_the_time_of_pk_					
		);								
proc print data=mylib.f2;										
run;										
										
*f3;
%selectvars(f3,										
date_lab_pk	
time_lab_pk	
glucose	
urea_nitrogen_bun					
scr_value_pk	
sodium	
potassium	
chloride					
carbondioxide	
bun	
total_protein	
alb_value					
alkaline_phosphatase_alp	
ast	
alt_value	
bilirubin_total					
urine_crcl	
data_entered_byf3	
f3_lab_data_for_mmf_pk_assessmen						
		);								
proc print data=mylib.f3;										
run;										
										
*f4;
%selectvars(f4,										
pid_pk	
participating_site_pk	
blood_pk	
dt_pk					
pk_timepoints___1	
pk_timepoints___2	
pk_timepoints___3	
pk_timepoints___4					
pk_timepoints___5	
pk_timepoints___6	
pk_timepoints___7	
pk_timepoints___8					
pk_timepoints___9	
pk_timepoints___10	
pk_timepoints___11	
pk_timepoints___12					
pk_timepoints___13	
pk_timepoints___14	
blood_collectn_time_0	
blood_collectn_time_0_5					
blood_collectn_time_1	
blood_collectn_time_2	
blood_collectn_time_3	
blood_collectn_time_4					
blood_collectn_time_5	
blood_collectn_time_6a	
blood_collectn_time_6b	
blood_collectn_time_7					
blood_collectn_time_8	
blood_collectn_time_9	
blood_collectn_time_10	
blood_collectn_time_11					
blood_collectn_time_12	
blood_tubes_pk	
zero_six_total_volume	
urine_hrzero_time_start_pk					
urine_hr6_time_end_pk	
six_twelve_total_volume	
urine_hr6_time_start_pk	
urine_h12_time_end					
twelve_hr_urine_tvolume	
plasma_label_pk_1	
xplasma_label_pk	
plasma_label_pk_2					
xplasma_label_pk_2	
plasma_label_pk_3	
xplasma_label_pk3	
plasma_label_pk_4					
xplasma_label_pk4	
plasma_label_pk_5	
xplasma_label_pk5	
plasma_label_pk_6					
xplasma_label_pk6	
plasma_label_pk_7	
xplasma_label_pk7	
plasma_label_pk_8					
xplasma_label_pk8	
unb_mpa_plasma_pk_6	
plasma_label_pk_9	
xplasma_label_pk9					
plasma_label_pk_10	
xplasma_label_pk10	
plasma_label_pk_11	
xplasma_label_pk11					
plasma_label_pk_12	
xplasma_label_pk12	
plasma_label_pk_13	
xplasma_label_pk13					
plasma_label_pk_14	
xplasma_label_pk14	
urine_hrs6_12_pk	
urine_hrs0_6_pk					
eat_before_cru_visit	
eat_cru_pk	
food_recorded_pk	
food_enter_ndsr_pk					
time_bf_pk
bf_pk
data_entered_byf4
f4_sample_collection_pk_assessme					
		);
proc print data=mylib.f4;
run;

*f5;
%selectvars(f5,
		pay_site	payment_pk	date_payment	paid_by
		f5_payment_form_for_mmf_pk_asses
		);
proc print data=mylib.f5;
run;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

*F1;

data f1;
set mylib.f1;
run;

proc contents data = f1 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data f1;
set f1;
label 
bilirubin_above_3x = "At the time of PK Visit, only the participants with total bilirubin < 3x upper limit of normal (1.2 mg/dL) and CrCl >=30 ml/min are eligible to participate in this PK event. The event needs to be rescheduled until the liver and kidney function improves"
crcl_less_30mlpermin = "To calculate the serum creatinine clearance, use the MDRD equation found at the below website: http://www.mdrd.com; Use the ""CKD-EPI Creatinine EQ (2009)"" option for the equation."
mpa	= "mpa level"
txn_dt_pk = "Date of Transplant"
pk_event_dt = "Date of the pharmacokinetic assessment"
days_after_posttx_pk = "Number of days between PK event date and transplant date"
antacid_pk = "Did the participant take any antacids, iron, calcium or magnesium supplements within the 12 hours prior to initial blood draw of the PK event?"
vomit_pk = " Did the participant report vomiting within 2 hours of any of the MMF doses in the last 36 hours prior to the PK event? "
doses_pk = "Has the participant taken 3 or more unchanged doses of MMF prior to admission for pharmacokinetic study?"
confirm_pkcohort = "Confirm the PK cohort"
mmf_dose_missing_pk	= "Did the participant miss any MMF dose specifically in the last week?"
missing_immunosup_dose_pk = "Did the participant miss more than one consecutive dose of any  immunosuppressive medications in the past 4 weeks?	"
missed_immuno_dose_freq_pk = "Did the participant miss a dose of any immunosuppressive medication in the past 4 weeks?	"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;	
value bilirubin_above_3x 1="Yes" 0="No";
value crcl_less_30mlpermin 1="Yes" 0="No";
value mpa 1="Yes" 0="No";
value antacid_pk 1="Yes" 0="No";
value vomit_pk 1="Yes" 0="No";				
value doses_pk 1="Yes" 0="No";
value confirm_pkcohort 1="Yes" 0="No";
value mmf_dose_missing_pk 1="Yes" 0="No";
value missing_immunosup_dose_pk 1="Yes" 0="No";					
value missed_immuno_dose_freq_pk 1 = "Every day" 2 = "More than once a week" 3 = "Once a week" 4 = "Once every 2 weeks" 5 = "Once a month" 6 = "Never";
run;

data f1;
set f1;
format bilirubin_above_3x bilirubin_above_3x.;
format crcl_less_30mlpermin crcl_less_30mlpermin.;
format  mpa  mpa.;
format antacid_pk antacid_pk.;
format vomit_pk vomit_pk.;
format doses_pk doses_pk.;
format confirm_pkcohort confirm_pkcohort.;
format mmf_dose_missing_pk mmf_dose_missing_pk.;
format missing_immunosup_dose_pk missing_immunosup_dose_pk.;
format missed_immuno_dose_freq_pk missed_immuno_dose_freq_pk.;
run;

*Running a report for f1 using the macro now;

proc contents data=f1 order=varnum;
run;

proc print data = f1;
run;

data mylib.f1clean;
set f1;
run;

data f1pos;
set f1;
where f1_mmf_pharmacokinetics_study_vi = 2;
run;

data f1neg;
set f1;
where f1_mmf_pharmacokinetics_study_vi = 0;
run;

*f2;

data f2;
set mylib.f2;
run;

proc contents data = f2 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data f2;
set f2;
label 		
mmf_dosefreq_pk	= "What is the dose frequency of MMF? (The dose frequency must be twice daily for this participant to be eligible for the PK cohort)"
mmf_daily_dose_pk = "MMF total daily dose (mg) "
mmf_dose_at_pk = "What is the morning MMF dose for which PK Study was performed?"
pk_mmf_dose_time_1 = "What time was the MMF dose taken on the morning of the PK Study Visit?"
pk_mmf_dose_time_2 = "What time was the MMF dose taken on the evening before the PK Study Visit?"
pk_mmf_dose_at_time_2 = "What was the MMF dose taken on the evening before the PK Study Visit?"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value mmf_dosefreq_pk 1="twice/day";
value mmf_daily_dose_pk 1="500 mg" 7="750 mg" 2="1000 mg" 3="1500 mg" 4="2000 mg" 5="2500 mg" 6="3000 mg";
value mmf_dose_at_pk 1="250 mg" 2="500 mg" 3="750 mg" 4="1000 mg" 5="1250 mg" 6="1500 mg";
value pk_mmf_dose_at_time_2f 1="250 mg" 2="500 mg" 3="750 mg" 4="1000 mg" 5="1250 mg" 6="1500 mg";
run;

data f2;
set f2;
format mmf_dosefreq_pk mmf_dosefreq_pk.;
format mmf_daily_dose_pk mmf_daily_dose_pk.;
format mmf_dose_at_pk mmf_dose_at_pk.;
format pk_mmf_dose_at_time_2 pk_mmf_dose_at_time_2f.;
run;

*Running a report for e2 using the macro now;

proc contents data=f2 order=varnum;
run;

data mylib.f2clean;
set f2;
run;

*F3;

data f3;
set mylib.f3;
run;

proc contents data = f3 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data f3;
set f3;
label 
date_lab_pk	= "Date of Lab Work"
time_lab_pk	= "Collection time of labs"
glucose	= "Glucose (mg/dL)"
urea_nitrogen_bun = "Blood Urea Nitrogen (BUN) (mg/dL)"
scr_value_pk = "Serum Creatinine value (mg/dL)"
sodium = "Sodium (mmol/L)"
potassium = "Potassium (mmol/L)"
chloride = "Chloride (mmol/L)"
carbondioxide = "Carbon dioxide (mmol/L)"
bun	= "Calcium (mg/dL)"
total_protein = "Total Protein (g/dL)"
alb_value = "Serum albumin (mg/dL)"
alkaline_phosphatase_alp = "Alkaline Phosphatase (ALP) (IU/L)"
ast	= "AST (IU/L)"
alt_value = "ALT (IU/L)"
bilirubin_total	= "Bilirubin (total) (mg/dL) "
urine_crcl = "Calculated 12 - hour Urine Creatinine Clearance (per Fairview) (mL/min/1.7)"	
data_entered_byf3 = "Data entered by"	
;
run;

*Running a report for f3 using the macro now;

proc contents data=f3 order=varnum;
run;

data f3;
set f3;
bun_num = input(bun, 8.);
urine_crcl_num = input(urine_crcl, 8.);
run;

data mylib.f3clean;
set f3;
run;

*F4;

data f4;
set mylib.f4;
run;

proc contents data = f4 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data f4;
set f4;
label 
pid_pk = "Participant ID"
participating_site_pk = "Enrollment Site"
blood_pk = "PK blood samples collected"
dt_pk = "Pharmacokinetic event date"
pk_timepoints___1 = "Check all of the timepoints when the blood was drawn"
pk_timepoints___2 = "Check all of the timepoints when the blood was drawn"
pk_timepoints___3 = "Check all of the timepoints when the blood was drawn"
pk_timepoints___4 = "Check all of the timepoints when the blood was drawn"
pk_timepoints___5 = "Check all of the timepoints when the blood was drawn"
pk_timepoints___6 = "Check all of the timepoints when the blood was drawn"
pk_timepoints___7 = "Check all of the timepoints when the blood was drawn"
pk_timepoints___8 = "Check all of the timepoints when the blood was drawn"
pk_timepoints___9 = "Check all of the timepoints when the blood was drawn"
pk_timepoints___10 = "Check all of the timepoints when the blood was drawn"
pk_timepoints___11 = "Check all of the timepoints when the blood was drawn"
pk_timepoints___12 = "Check all of the timepoints when the blood was drawn"
pk_timepoints___13 = "Check all of the timepoints when the blood was drawn"
pk_timepoints___14 = "Check all of the timepoints when the blood was drawn"
blood_collectn_time_0 =	"Blood collection -time (HR 0)"
blood_collectn_time_0_5 = "Blood collection - time (HR 0.5)"
blood_collectn_time_1 =	"Blood collection - time (HR 1)"
blood_collectn_time_2 =	"Blood collection - time (HR 2)"
blood_collectn_time_3 =	"Blood collection - time (HR 3)"
blood_collectn_time_4 =	"Blood collection - time (HR 4)"
blood_collectn_time_5 =	"Blood collection - time (HR 5)"
blood_collectn_time_6a = "Blood collection - time (HR 6)"
blood_collectn_time_6b = "Unbound MPA blood collection (One-time collection) - time (HR 6)"
blood_collectn_time_7 =	"Blood collection - time (HR 7)"
blood_collectn_time_8 =	"Blood collection - time (HR 8)"
blood_collectn_time_9 =	"Blood collection time - (HR 9)"
blood_collectn_time_10 = "Blood collection - time (HR 10)"
blood_collectn_time_11 = "Blood collection - time (HR 11)"
blood_collectn_time_12 = "Blood collection - time (HR 12)"
blood_tubes_pk = "Number of tubes collected (For the PK blood draws, there should be 15 tubes of blood collected total)"
zero_six_total_volume = "0-6 Hour urine, total volume (ml)"
urine_hrzero_time_start_pk = "Time Hour 0 of urine collection started"
urine_hr6_time_end_pk = "Time Hour 6 of urine collection ended"
six_twelve_total_volume	= "6-12 Hour urine, total volume (ml)"
urine_hr6_time_start_pk = "Time Hour 6 of urine collection started"
urine_h12_time_end = "Time Hour 12 of urine collection ended"
twelve_hr_urine_tvolume	= "0-12 Hour urine, total volume (ml)"
plasma_label_pk_1 = "MPA Total, Plasma tube Hour 0 label ID"
xplasma_label_pk = "MPA Total, Plasma Extra tube Hour 0 label ID"
plasma_label_pk_2 = "MPA Total, Plasma tube Hour 0.5 label ID"
xplasma_label_pk_2 = "MPA Total, Plasma Extra tube Hour 0.5 label ID"
plasma_label_pk_3 =	"MPA Total, Plasma tube Hour 1 label ID"
xplasma_label_pk3 =	"MPA Total, Plasma Extra tube Hour 1 label ID"
plasma_label_pk_4 =	"MPA Total, Plasma tube Hour 2 label ID"
xplasma_label_pk4 =	"MPA Total, Plasma Extra tube Hour 2 label ID"
plasma_label_pk_5 =	"MPA Total, Plasma tube Hour 3 label ID"
xplasma_label_pk5 =	"MPA Total, Plasma Extra tube Hour 3 label ID"
plasma_label_pk_6 =	"MPA Total, Plasma tube Hour 4 label ID"
xplasma_label_pk6 =	"MPA Total, Plasma Extra tube Hour 4 label ID"
plasma_label_pk_7 =	"MPA Total, Plasma tube Hour 5 label ID"
xplasma_label_pk7 =	"MPA Total, Plasma Extra tube Hour 5 label ID"
plasma_label_pk_8 =	"MPA Total, Plasma tube Hour 6 label ID"
xplasma_label_pk8 =	"MPA Total, Plasma Extra tube Hour 6 label ID"
unb_mpa_plasma_pk_6	= "Unbound MPA, Plasma tube Hour 6 label ID"
plasma_label_pk_9 =	"MPA Total, Plasma tube Hour 7 label ID"
xplasma_label_pk9 =	"MPA Total, Plasma Extra tube Hour 7 label ID"
plasma_label_pk_10 = "MPA Total, Plasma tube Hour 8 label ID"
xplasma_label_pk10 = "MPA Total, Plasma Extra tube Hour 8 label ID"
plasma_label_pk_11 = "MPA Total, Plasma tube Hour 9 label ID"
xplasma_label_pk11 = "MPA Total, Plasma Extra tube Hour 9 label ID"
plasma_label_pk_12 = "MPA Total, Plasma tube Hour 10 label ID"
xplasma_label_pk12 = "MPA Total, Plasma Extra tube hour 10 label ID"
plasma_label_pk_13 = "MPA Total, Plasma tube Hour 11 label ID"
xplasma_label_pk13 = "MPA Total, Plasma Extra tube Hour 11 label ID"
plasma_label_pk_14 = "MPA Total, Plasma tube Hour 12 label ID"
xplasma_label_pk14 = "MPA Total, Plasma Extra tube Hour 12 label ID"
urine_hrs6_12_pk = "Urine MPA, Hours 0-6 label ID"
urine_hrs0_6_pk	= "Urine MPA, Hours 6-12 label ID"
eat_before_cru_visit = "Did the participant eat anything at home before arriving in CRU?"
eat_cru_pk = "Did the participant eat and/or drink during the PK Study Visit at the CRU?"
food_recorded_pk = "Was food and drink intake during the PK Study Visit recorded by the participant?"
food_enter_ndsr_pk = "Has the food and drink intake during the PK Study Visit been entered into NDSR?"
time_bf_pk = "If so , what time?"
bf_pk = "If so , what was eaten?"
data_entered_byf4 = "Data entered by"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value participating_site_pk 1="HHRI" 2="UMN";	
value blood_pk 1="Yes" 0="No";
value eat_before_cru_visit 1="Yes" 0="No";
value eat_cru_pk 1="Yes" 0="No";
value food_recorded_pk 1="Yes" 0="No";
value food_enter_ndsr_pk 1="Yes" 0="No";
run;

data f4;
set f4;
format participating_site_pk participating_site_pk.;	
format blood_pk blood_pk.;
format eat_before_cru_visit eat_before_cru_visit.;
format eat_cru_pk eat_cru_pk.;
format food_recorded_pk food_recorded_pk.;
format food_enter_ndsr_pk food_enter_ndsr_pk.;
run;

*Running a report for f4 using the macro now;

proc contents data=f4 order=varnum;
run;

data mylib.f4clean;
set f4;
run;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

*g1;
%selectvars(g1,
covid19_recip_test	
covid19_recip_result	
covid19_recip_test_when	
covid19_recip_test_datetime					
covid19_antibodytest_recip	
covid19_antibodytestresult_recip	
covid19_antibodytestdt_recip	
covid19_recip_vaccine
covid19_vaccinetype_recip
covid19_vaccinetype_other_recip
covid19_vaccinedt
covid19_vaccinedt2
booster
covid19_vaccinetype_recip_2
covid19_vaccinedt_2
covid19_recip_prophylaxis	
covid19_recip_prophylaxis_med	
covid19_recip_prophylaxis_med_ot					
covid19_recip_prophylaxis_med_fr	
/*covid19_recip_prophylaxis_med_ot*/
covid19_recip_prophylaxis_med_da	
covid19_recip_prophylaxis_startd					
covid19_recip_prophylaxis_stopdt	
covid19_recip_pos_test_treat	
covid19_recip_pos_test_treat_sta	
covid19_recip_pos_test_treat_sto					
/*covid19_recip_pos_test_med___1	
covid19_recip_pos_test_med___2	
covid19_recip_pos_test_med___3	
covid19_recip_pos_test_med___4					
covid19_recip_pos_test_med___5*/
covid19_recip_pos_test_med___6	
covid19_recip_pos_test_med___7	
covid19_recip_pos_test_med_other					
covid19_recip_pos_test_med_freq	
covid19_recip_pos_test_med_dose	
another_medication
covid19_hospit_recip
covid19_hospitoxy_recip					
covid19_hospitoxytype_recip	
covid19_hospiticu_recip	
covid19_hospitresult_recip	
g1_recipient_covid19_history_and					
);
proc print data=mylib.g1;
run;
										
*g2;
%selectvars(g2,
donor_type										
covid19_ld_test	
covid19_ld_result	
covid19_ld_test_dt	
covid19_antibodytest_donor					
covid19_antibodytestresult_donor	
covid19_antibodytestdt_donor	
covid19_ld_treat	
covid19_dd_test					
covid19_dd_test_result	
covid19_dd_test_where	
covid19_dd_testdt	
covid19_antibodytest_dd					
covid19_antibodytestresult_dd	
covid19_antibodytestdt_dd	
g2_donor_covid19_history_complet						
		);								
proc print data=mylib.g2;										
run;										
										
*g3;
%selectvars(g3,										
use_induct_meds
induct_meds___1
induct_meds___2
induct_meds___3
induct_meds___4
induct_meds___5
induct_med_other	
thymo_freq	
thymo_first_dose					
thymo_sec_dose	
thymo_third_dose	
thymo_fourth_dose	
thymo_start_dt					
thymo_stop_dt	
thymo_last_dose	
thymo_total_dose
simu_freq					
simu_first_dose	
simu_sec_dose	
simu_start_dt	
simu_stop_dt					
simu_last_dose	
simu_total_dose	
cam_freq	
cam_first_dose					
cam_sec_dose	
cam_start_dt	
cam_stop_dt	
cam_last_dose					
cam_total_dose	
ritu_freq	
ritu_first_dose	
ritu_sec_dose					
ritu_start_dt	
ritu_stop_dt	
ritu_last_dose	
ritu_total_dose					
induct_other_freq	
induct_other_first_dose	
induct_other_sec_dose	
induct_other_third_dose					
induct_other_fourth_dose	
induct_other_start_dt	
induct_other_stop_dt	
induct_other_last_dose					
induct_other_total_dose	
induct_med_steroid	
data_entered_byg1	
g3_induction_medications_complet					
		);								
proc print data=mylib.g3;										
run;										
										
*g4;
%selectvars(g4,										
ind_steroid_use	
ind_steroid_name	
other_ind_steroid	
ind_steroid_dosefreq					
ind_steroid_dose	
ind_steroid_sec_dose	
ind_steroid_third_dose	
ind_steroid_fourth_dose					
ind_steroid_start_dt
ind_steroid_stop_dt	
ind_steroid_dose_duration	
ind_steroid_dose_change					
data_entered_byg4	
/*g4_induction_steroid_medications*/							
		);								
proc print data=mylib.g4;										
run;										
										
*g5;
%selectvars(g5,										
steroid_pk	
steroid_use	
steroid_name
other_steroid					
steroid_dosefreq
steroid_first_dose
steroid_sec_dose
steroid_third_dose					
steroid_fourth_dose	
steroid_start_dt
steroid_stop_dt
steroid_dose_duration					
data_entered_byg5	
g5_steroid_medications_complete							
		);								
proc print data=mylib.g5;										
run;										
										
*g6;
%selectvars(g6,										
med_dt_post	
htn_post	
htn_med_post___1
htn_med_post___2					
htn_med_post___3
htn_med_post___4
htn_med_post___5
htn_med_post___6					
htn_med_post___7
htn_med_post___8
htn_med_post___9
htn_med_post___10					
htn_med_post___11
other_htn_post
lipid_post
lipid_med_post___1					
lipid_med_post___2
lipid_med_post___3
lipid_med_post___4
lipid_med_post___5					
lipid_med_post___6
lipid_med_post___7
lipid_med_post___8
lipid_other_post					
acidred_post
acid_red_med_post___1
acid_red_med_post___2
acid_red_med_post___3					
acid_red_med_post___4
other_acidred_med_post
dm_post
dm_meds_post___1					
dm_meds_post___2
dm_meds_post___3
dm_meds_post___4
dm_med_other_post					
antiviral_yn_post
antiviral_med_post___1
antiviral_med_post___2
antiviral_med_post___3					
antiviral_med_post___4
antiviral_med_post___5
antiviral_med_post___6
other_antiviral_med_post					
antifungal_yn_post
antifungal_meds_post___1
antifungal_meds_post___2
antifungal_meds_post___3					
antifungal_meds_post___4
antifungal_meds_post___5
antifungal_meds_post___6
antifungal_meds_post___7					
antifungal_meds_post___8
antifungal_meds_post___9
other_antifungal_post
antibiotics_yn_post					
allantibio_post___1
allantibio_post___2
allantibio_post___3
allantibio_post___4					
allantibio_post___5	
allantibio_post___6	
allantibio_post___7	
allantibio_post___8					
allantibio_post___9	
allantibio_post___10	
allantibio_post___11	
allantibio_post___12					
other_antibiotics_post	
other_med_post	
other_med_details_post	
data_entered_byg6					
g6_posttransplantation_concomita								
		);								
proc print data=mylib.g6;										
run;										
										
*g7;
%selectvars(g7,	
weight_collected									
current_weight	
current_weight_dt	
bmi_2	
bg_1					
bg_2
fasting_bg
a1c	
bg_1_value					
bg_1_date
bg_2_value
bg_2_date
fasting_bg_value					
fasting_bg_date	
a1c_value
a1c_dt
data_entered_byg7					
g7_weight_blood_glucose_and_a1c_								
		);
proc print data=mylib.g7;
run;

*g8;
%selectvars(g8,
acr_tested_v1	
acr_dt_v1	
acr_time_v1	
acr_albumin_v1					
acr_cr_v1	
uacr_calc_v1	
pcr_tested_v1	
pcr_dt_v1					
prc_time_v1	
pcr_protein_v1	
pcr_cr_v1	
upcr_calc_v1					
data_entered_byg8	
g8_urine_measurements_complete							
		);
proc print data=mylib.g8;
run;
										
*g9;
%selectvars(g9,										
dsa_identified	
dsa_dt	
dsa_specificities	
class1_a_specificities_dsa					
class1a_mfi	
class1_b_specificities_dsa	
class1_b_mfi	
class1_c_specificities_dsa					
class1c_mfi	
class1_drb1_speci_dsa
class1_drb1_mfi	
class1_dqa1_speci_dsa					
class1_dqa1_mfi	
class1_dqb1_speci_dsa	
class1_dqb1_mfi	
class1_dpa1_speci_dsa					
class1_dpa1_mfi	
class1_dpb1_speci_dsa	
class1_dpb1	
data_entered_byg9					
g9_recipient_dsa_specificities_c								
		);								
proc print data=mylib.g9;										
run;										
										
*g10;
%selectvars(g10,										
mpaauc	
mpaauc_dt	
mpaauc_value	
mpaauc_num_meas					
mpaauc_firstdraw_time	
mpaauc_firstdraw_conc	
mpaauc_secdraw_time	
mpaauc_secdraw_conc					
mpaauc_thirddraw_time	
mpaauc_thirddraw_conc	
mpaauc_fourthdraw_time	
mpaauc_fourthdraw_conc					
mpaauc_calc_inhibitor	
mpaauc_calc_inhibitor_type	
mpa_level	
mpa_dt					
mpa_trough_concentration	
mpag	
mpag_date	
mpag_conc					
mpa_name
other_mpa_drug
mpa_dosefreq
other_mpa_dose_freq					
mpa_daily_dose
mpa_daily_dose_other
mpa_route_of_admn
mpa_last_dose					
/*data_entered_byg10*/	
g10_mpa_clinical_drug_concentrat							
		);								
proc print data=mylib.g10;										
run;										
										
*g11;
%selectvars(g11,										
mpa_startdt	
mpa_type	
mpa_other	
mpa_route					
mpa_dose_b4_change	
mpa_dose_b4_change_other	
mpa_freq_b4_change	
mpa_change					
mpa_change_how___1	
mpa_change_how___2	
mpa_change_how___3
mpa_change_how___4
mpa_change_mpa					
mpa_change_mpa_other	
mpa_change_dose	
mpa_change_dose_other	
mpa_change_interval					
mpa_change_startdt	
mpa_change_enddt	
/*data_entered_byg11*/	
g11_mycophenolate_product_dose_a					
		);								
proc print data=mylib.g11;										
run;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

*G1;

data g1;
set mylib.g1;
run;

proc contents data = g1 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data g1;
set g1;
label 
covid19_recip_test = "Has the recipient had a COVID-19 test since the last data point?"
covid19_recip_result = "Was the COVID 19 test result Positive or Negative?"
covid19_recip_test_when = "When was the COVID-19 test conducted?"
covid19_recip_test_datetime = "Date and time specimen was collected for the COVID-19 test"
covid19_antibodytest_recip = "Has the recipient had the SAR CoV2 antibody serology test?"
covid19_antibodytestresult_recip = "What was the result of the recipient's SAR CoV2 antibody test?"
covid19_antibodytestdt_recip = "What is the date of the recipient's SAR CoV2 antibody serology test?"
covid19_recip_vaccine = "Has the recipient received a vaccine for COVID-19 since their last visit?"
covid19_vaccinetype_recip = "What type of COVID 19 vaccine did the recipient receive?"
covid19_vaccinetype_other_recip = "If Other vaccine type was marked, please specify"
covid19_vaccinedt =	"Date of vaccination"
covid19_vaccinedt2 = "Date of second vaccination"
booster = "Did the recipient receive a booster vaccination?"
covid19_vaccinetype_recip_2 = "What type of COVID 19 booster vaccine did the recipient receive?"
covid19_vaccinedt_2 = "Enter the date of booster vaccination."
covid19_recip_prophylaxis = "Did the recipient receive any COVID-19 prophylaxis?"
covid19_recip_prophylaxis_med = "If the recipient did receive COVID-19 prophylaxis, please indicate medication."
covid19_recip_prophylaxis_med_ot = "If Other, please indicate medication name."
covid19_recip_prophylaxis_med_fr = "Frequency of [covid19_recip_prophylaxis_med]."
covid19_recip_prophylaxis_med_da = "What was the total daily dose of [covid19_recip_prophylaxis_med]?"
covid19_recip_prophylaxis_startd = "Date prophylaxis was started."
covid19_recip_prophylaxis_stopdt = "Date prophylaxis was stopped."
covid19_recip_pos_test_treat = "Was the recipient treated with medication when tested positive for COVID-19?"
covid19_recip_pos_test_treat_sta = "Date treatment started."
covid19_recip_pos_test_treat_sto = "Date treatment ended."
covid19_hospit_recip = "Was the recipient hospitalized for COVID-19?"
covid19_hospitoxy_recip = "Did the recipient require any supplemental oxygen?"
covid19_hospitoxytype_recip = "What type of supplemental oxygen did the recipient receive?"
covid19_hospiticu_recip = "Was the recipient admitted to the ICU?"
covid19_hospitresult_recip = "What was the outcome of the hospitalization of the recipient for COVID-19?";
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;	
value covid19_recip_test 1="Yes" 0="No" 2="Unknown";
value covid19_recip_result 1="Positive" 0="Negative";
value covid19_recip_test_when 1="Pre-transplant" 2="Post-transplant" 3="Unknown";
value covid19_antibodytest_recip	1="Yes" 0="No" 2="Unknown";
value covid19_antibodytestresult_recip 1="Positive for antibodies" 0="Negative for antibodies" 2="Unknown";
value covid19_recip_vaccine 1="Yes" 0="No" 2="Unknown";
value covid19_vaccinetype_recip 1="Johnson & Johnson" 2="Pfizer" 3="Moderna" 4="Other" 5="Unknown";
value booster	0="Yes" 1="No" 2="Unknown";
value covid19_vaccinetype_recip_2f 1="Johnson & Johnson" 2="Pfizer" 3="Moderna" 4="Other" 5="Unknown";
value covid19_recip_prophylaxis 1="Yes" 0="No" 2="Unknown";
value covid19_recip_prophylaxis_med 1="Hydroxychloroquine" 2="Chloroquine" 3="[insert name]" 4="[insert name]" 5="[insert name]" 6="Other" 7="Unknown";
value covid19_recip_prophylaxis_med_fr 1="Once/day" 2="Twice/day" 3="Three times/day" 4="Four times/day" 5="Other" 6="Unknown";
value covid19_recip_pos_test_treat 1="Yes" 2="No" 3="Unknown";
value covid19_hospit_recip 1="Yes" 0="No" 2="Unknown";
value covid19_hospitoxy_recip	1="Yes" 0="No" 2="Unknown";
value covid19_hospitoxytype_recip	1="Any supplemental oxygen (nasal cannula)" 2="Non-invasive mechanical ventilation (e.g. BIPAP, PAV, CPAP, facemask, high flow nasal cannula)" 3="Invasive mechanical vential (e.g. endotracheal intubation, ECMO)" 4="Unknown";
value covid19_hospiticu_recip	1="Yes" 0="No" 2="Unknown";
value covid19_hospitresult_recip	1="Discharge" 2="Death" 3="Unknown";				
run;

data g1;
set g1;
format covid19_recip_test covid19_recip_test.;
format covid19_recip_result covid19_recip_result.;
format covid19_recip_test_when covid19_recip_test_when.;
format covid19_antibodytest_recip covid19_antibodytest_recip.;
format covid19_antibodytestresult_recip covid19_antibodytestresult_recip.;
format covid19_recip_vaccine covid19_recip_vaccine.;
format covid19_vaccinetype_recip covid19_vaccinetype_recip.;
format booster booster.;
format covid19_vaccinetype_recip_2 covid19_vaccinetype_recip_2f.;
format covid19_recip_prophylaxis covid19_recip_prophylaxis.;
format covid19_recip_prophylaxis_med covid19_recip_prophylaxis_med.;
format covid19_recip_prophylaxis_med_fr covid19_recip_prophylaxis_med_fr.;
format covid19_recip_pos_test_treat covid19_recip_pos_test_treat.;
format covid19_hospit_recip covid19_hospit_recip.;
format covid19_hospitoxy_recip covid19_hospitoxy_recip.;
format covid19_hospitoxytype_recip covid19_hospitoxytype_recip.;
format covid19_hospiticu_recip covid19_hospiticu_recip.;
format covid19_hospitresult_recip covid19_hospitresult_recip.;
run;

*Running a report for g1 using the macro now;

proc contents data=g1 order=varnum;
run;

proc print data = g1;
run;

data mylib.g1clean;
set g1;
run;

*g2;

data g2;
set mylib.g2;
run;

proc contents data = g2 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data g2;
set g2;
label
donor_type ="Type of current kidney donor" 		
covid19_ld_test = "Did the living donor have a PCR COVID-19 test performed prior to donation?"
covid19_ld_result = "What was the result of the living donor's PCR COVID-19 test?"
covid19_ld_test_dt = "Date of living donor specimen collection"
covid19_antibodytest_donor = "Did the living donor have an antibody serology for SARS CoV2 at any time?"
covid19_antibodytestresult_donor = "What was the result of the antibody serology for SAR CoV2?"
covid19_antibodytestdt_donor = "Date of living donor SAR CoV2 antibody serology"
covid19_ld_treat = "Was the living donor treated with medication for COVID-19 prior to donation?"
covid19_dd_test = "Was the deceased donor tested for COVID-19 prior to organ procurement?"
covid19_dd_test_result = "What was the test result?"
covid19_dd_test_where = "Where was the deceased donor's specimen collected from?"
covid19_dd_testdt = "Date specimen was collected"
covid19_antibodytest_dd = "Has the deceased donor had an antibody serology test performed for SAR CoV2?"
covid19_antibodytestresult_dd = "What was the result of the deceased donor's SAR CoV2 antibody serology?"
covid19_antibodytestdt_dd = "What is the date of the deceased donor's SAR CoV2 antibody serology test?"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value donor_typef 1="Living donor" 2="Deceased donor"; 
value covid19_ld_test	1="Yes" 0 = "No" 2="Unknown" 3="Not applicable";
value covid19_ld_result	1 = "Positive" 0 = "Negative" 2 = "Unknown";
value covid19_antibodytest_donor	1 = "Yes" 0 = "No" 2 = "Unknown";
value covid19_antibodytestresult_donor 1 = "Positive for antibodies" 0 = "Negative for antibodies" 2 = "Unknown";
value covid19_ld_treat 1 = "Yes" 0 = "No" 2 = "Unknown";
value covid19_dd_test_result	1 = "Yes" 0 = "No" 2 = "Unknown" 3 ="Not applicable";
value covid19_dd_test_where 1 = "Nasopharyngeal and Oropharyngeal" 2 ="Bronchoalveolar Lavage" 3 ="Unknown";
value covid19_antibodytest_dd 1 = "Yes" 0 ="No" 2 ="Unknown";
value covid19_antibodytestresult_dd 1 = "Positive for antibodies" 0 = "Negative for antibodies" 2 = "Unknown";
run;

data g2;
set g2;
format donor_type donor_typef.; 
format covid19_ld_test covid19_ld_test.;
format covid19_ld_result covid19_ld_result.;
format covid19_antibodytest_donor covid19_antibodytest_donor.;
format covid19_antibodytestresult_donor covid19_antibodytestresult_donor.;
format covid19_ld_treat covid19_ld_treat.;
format covid19_dd_test_result covid19_dd_test_result.;
format covid19_dd_test_where covid19_dd_test_where.;
format covid19_antibodytest_dd covid19_antibodytest_dd.;
format covid19_antibodytestresult_dd covid19_antibodytestresult_dd.;
format covid19_antibodytestdt_dd covid19_antibodytestdt_dd.;
run;

*Running a report for g2 using the macro now;

proc contents data=g2 order=varnum;
run;

data mylib.g2clean;
set g2;
run;

proc contents data=mission order=varnum;
run;

proc freq data = mission;
tables donor_type / nocol norow nopercent;
run;

proc print data = mission;
var record_id donor_type;
where donor_type ne .;
run;

*g3;

data g3;
set mylib.g3;
run;

proc contents data = g3 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data g3;
set g3;
label 
use_induct_meds	= "Has the subject received any induction medications?"
induct_meds___1	= "Thymoglobulin (anti-thymocyte globulin [rabbit], ATG rabbit)"
induct_meds___2	= "Simulect (basiliximab)"
induct_meds___3	= "Campath (alemtuzumab)"
induct_meds___4	= "Rituxan (rituximab)"
induct_meds___5	= "Induction medications given (Other)"
induct_med_other = "If yes to other induction medication, please specify"
thymo_freq = "Thymoglobulin - What is the dose frequency?"
thymo_first_dose = "First dose of Thymoglobulin amount (mg):"
thymo_sec_dose = "Second dose of Thymoglobulin amount (mg):"
thymo_third_dose = "Third dose of Thymoglobulin amount (mg):"
thymo_fourth_dose = " Fourth dose of Thymoglobulin amount (mg):"
thymo_start_dt = " Thymoglobulin Dose - Start Date"
thymo_stop_dt = "Thymoglobulin Dose - Stop Date"
thymo_last_dose = "Was this the last dose of Thymoglobulin given as induction?"
thymo_total_dose = "How many total number of doses of Thymoglobulin were given over the induction period?"
simu_freq = "Simulect - What is the dose frequency?"
simu_first_dose	= "First dose of Simulect amount (mg):"
simu_sec_dose = "Second dose of Simulect amount (mg):"
simu_start_dt = "Simulect Dose - Start Date:"
simu_stop_dt = "Simulect Dose - Stop Date:"
simu_last_dose = "Was this the last dose of Simulect given for induction?"
simu_total_dose	= "How many total number of doses of Simulect were given over the induction period?"
cam_freq = "Campath - What is the dose frequency?"
cam_first_dose = "First dose of Campath amount (mg):"
cam_sec_dose = "Second dose of Campath amount (mg):"
cam_start_dt = "Campath Dose - Start Date"
cam_stop_dt = "Campath Dose - Stop Date"
cam_last_dose = "Was this the last dose of Campath given for induction?"
cam_total_dose = "How many total number of doses of Campath were given over the induction period?"
ritu_freq = "Rituxan - What is the dose frequency?"
ritu_first_dose	= "First dose of Rituxan amount (mg):"
ritu_sec_dose = "Second dose of Rituxan amount (mg)"
ritu_start_dt = "Rituxan Dose - Start Date"
ritu_stop_dt = "Rituxan Dose - Stop Date"
ritu_last_dose = "Was this the last dose of Rituxan given for induction?"
ritu_total_dose	= "How many total number of doses of Rituxan were given over the induction period?"
induct_other_freq = "[induct_med_other] - What is the dose frequency?"
induct_other_first_dose = "First dose of [induct_med_other] amount (mg):"
induct_other_sec_dose = "Second dose of [induct_med_other] amount (mg):"
induct_other_third_dose	= "Third dose of [induct_med_other] amount (mg):"
induct_other_fourth_dose = "Fourth dose of [induct_med_other] amount (mg):"
induct_other_start_dt = "[induct_med_other] Dose - Start Date"
induct_other_stop_dt = "[induct_med_other] Dose - Stop Date"
induct_other_last_dose = "Was this the last dose of [induct_med_other] given for induction?"
induct_other_total_dose	= "How many total number of doses of [induct_med_other] were given over the induction period?"
induct_med_steroid = "Was a steroid given as induction?"
data_entered_byg1 =	"Data entered by"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value induct_meds___1f 0 = "Drug not received" 1 = "Thymoglobulin (anti-thymocyte globulin [rabbit], ATG rabbit)";
value induct_meds___2f 0 = "Drug not received" 1 = "Simulect (basiliximab)";
value induct_meds___3f 0 = "Drug not received" 1 = "Campath (alemtuzumab)";
value induct_meds___4f 0 = "Drug not received" 1 = "Rituxan (rituximab)";
value induct_meds___5f 0 = "Drug not received" 1 = "Other";
value thymo_freq 1 = "Once/day" 2 = "Twice/day" 3 = "Three times/day" 4 = "Four times/day" 5 = "Dose information not available";
value thymo_last_dose 1 = "Yes" 0 = "No";
value simu_freq 1 = "Once/day" 2 = "Twice/day" 5 = "Dose information not available";
value simu_last_dose 1 = "Yes" 0 = "No";
value cam_freq 1 = "Once/day" 2 = "Twice/day" 5 = "Dose information not available";
value cam_last_dose 1 = "Yes" 0 = "No";
value ritu_freq 1 = "Once/day" 2 = "Twice/day" 5 = "Dose information not available";
value ritu_last_dose 1 = "Yes" 0 = "No";
value induct_other_freq 1 = "Once/day" 2 = "Twice/day" 3 = "Three times/day" 4 = "Four times/day" 5 = "Dose information not available";
value induct_other_last_dose 1 = "Yes" 0 = "No";
run;

data g3;
set g3;
format induct_meds___1	induct_meds___1f.;
format induct_meds___2	induct_meds___2f.;
format induct_meds___3	induct_meds___3f.;
format induct_meds___4	induct_meds___4f.;
format induct_meds___5	induct_meds___5f.;
format thymo_freq	thymo_freq.;
format thymo_last_dose	thymo_last_dose.;
format simu_freq	simu_freq.;
format simu_last_dose	simu_last_dose.;
format cam_freq	cam_freq.;
format cam_last_dose	cam_last_dose.;
format ritu_freq	ritu_freq.;
format ritu_last_dose	ritu_last_dose.;
format induct_other_freq	induct_other_freq.;
format induct_other_last_dose	induct_other_last_dose.;
run;

*Running a report for g3 using the macro now;

proc contents data=g3 order=varnum;
run;

data mylib.g3clean;
set g3;
run;

*G4;

data g4;
set mylib.g4;
run;

proc contents data = g4 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data g4;
set g4;
label 
ind_steroid_use	= "Has the participant received any steroids for induction?"
ind_steroid_name = "Steroid Name"
other_ind_steroid = "If other steroid is selected, please specify"
ind_steroid_dosefreq = "[ind_steroid_name] - What is the induction dose frequency?"
ind_steroid_dose = "What was [ind_steroid_name]  first induction dose taken (mg):"
ind_steroid_sec_dose = "What was [ind_steroid_name] second induction dose taken (mg):"
ind_steroid_third_dose	= "What was [ind_steroid_name] third induction dose taken (mg):"
ind_steroid_fourth_dose	= "What was [ind_steroid_name] fourth induction dose taken (mg):"
ind_steroid_start_dt = "[ind_steroid_name] Induction Dose - Start Date"
ind_steroid_stop_dt	= "[ind_steroid_name] Induction Dose - Stop Date"
ind_steroid_dose_duration =	"Duration of [ind_steroid_name] dose"
ind_steroid_dose_change = "Were steroids continued after completion of induction steroids? (e.g. Was the patient switched to maintenance steroids after discharge from the hospital? If the patient is taking a steroid after discharge, please select Yes"
data_entered_byg4 = " Data entered by:"
g4_induction_steroid_medications = "If another steroid dose change has been made for induction, record the new dose modification information as a new instance by clicking 'Save & add new instance' at the bottom of this form."
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value ind_steroid_use 1="Yes" 0="No";
value ind_steroid_name 1 = "Prednisone" 2 = "Methylprednisolone" 3 = "Other Steroid";
value ind_steroid_dosefreq 1 = "once/day" 2 ="twice/day" 3 = "three times/day" 4 = "four times/day" 5 = "once/two days" 6 = "dose info not available";
value ind_steroid_dose_change	1="Yes" 0="No";
run;

data g4;
set g4;
format ind_steroid_use	ind_steroid_use.;
format ind_steroid_name	ind_steroid_name.;
format ind_steroid_dosefreq	ind_steroid_dosefreq.;
format ind_steroid_dose_change	ind_steroid_dose_change.;
run;

*Running a report for g4 using the macro now;

proc contents data=g4 order=varnum;
run;

data mylib.g4clean;
set g4;
run;

*G5;

data g5;
set mylib.g5;
run;

proc contents data = g5 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data g5;
set g5;
label 
steroid_pk = "Is this for the PK Study Visit?"
steroid_use = "Has the participant received any steroids? (Not used for induction)"
steroid_name = "Steroid Name"
other_steroid = "If other steroid is selected, please specify."
steroid_dosefreq = "[steroid_name] - what is the dose frequency?"
steroid_first_dose = "What was [steroid_name] first dose taken (mg):"
steroid_sec_dose = "What was [steroid_name] second dose taken (mg):"
steroid_third_dose = "What was [steroid_name] third dose taken (mg):"
steroid_fourth_dose = "What was [steroid_name] fourth dose taken (mg):"
steroid_start_dt = "[steroid_name] Dose - Start Date"
steroid_stop_dt = "[steroid_name] Dose - Stop Date"
steroid_dose_duration = "Duration of [steroid_name] dose"
data_entered_byg5 = "Data entered by:"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value steroid_pk	1="Yes" 0="No";
value steroid_use	1="Yes" 0="No";
value steroid_name 1 = "Prednisone" 2 = "Methylprednisolone" 3 = "Other Steroid";
value steroid_dosefreq 1 = "Once/day" 2 = "Twice/day" 3 = "Three times/day" 4 = "Four times/day" 5 = "Once/two days" 6 = "Dose information not available";
run;

data g5;
set g5;
format steroid_pk	steroid_pk.;
format steroid_use	steroid_use.;
format steroid_name	steroid_name.;
format steroid_dosefreq	steroid_dosefreq.;
run;

*Running a report for g5 using the macro now;

proc contents data=g5 order=varnum;
run;

data g5;
set g5;
steroid_first_dose_num = input(steroid_first_dose, 8.);
steroid_third_dose_num = input(steroid_first_dose, 8.);
steroid_fourth_dose_num = input(steroid_first_dose, 8.);
run;

data mylib.g5clean;
set g5;
run;

*G6;

data g6;
set mylib.g6;
run;

proc contents data = g6 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data g6;
set g6;
label 
med_dt_post	= "Date of post-transplantation medication snapshot"
htn_post	= "Is the subject currently given any antihypertensive medications?"
htn_med_post___1	= "Diuretics (including thiazide diuretics, loop diuretics or potassium-sparing diuretics)"
htn_med_post___2	= "Aldosterone receptor blockers [plerenon (Inspra), spironolactone (Aldactone)"
htn_med_post___3	= "Beta Blockers (with or without sympathomimetic activity) [atenolol (Tenormin), betaxolol (Kerlone), bisoprolol (Zebeta), metroprolol (Lopressor, ToprolXL), nadolol (Corgard), propranolol (Inderal, Inderal LA), timolol (Blocadren), acebutolol (Sectral), penbutolol (Levatol), pindolol (generic)"
htn_med_post___4	= "Ace Inhibitors [benazepril (Lotensin), captopril (Capoten), enalapril (Vasotec), fosinopril (Monopril), lisinopril (Prinivil, Zestril), moexipril (Univasc), perindopril (Aceon), quinapril (Accupril), ramipril (Altace), trandolapril (Mavik)"
htn_med_post___5	= "Angiotensin II antagonists [candesartan (Atacand), eprosartan (Teveten), irbesartan (Avapro), losartan (Cozaar), olmesartan (Benicar), telmisartan (Micardis), valsartan (Diovan)"
htn_med_post___6	= "Calcium Channel Blockers GROUP 1: [amlodipine (Norvasc, Lotrel, Azor, Caduct, Exforge), felodipine (Plendil, Lexxel), nimodipine (Nimotop), nisoldipine (Sular)"
htn_med_post___7	= "Calcium Channel Blockers GROUP 2: [isradipine (DynaCirc), nicardipine (Cardene), nifedipine (Adalat, Procardia)"
htn_med_post___8	= "Calcium Channel Blockers GROUP3: [diltiazem (Cardizem, Cartia, Dilacor, Diltia, Tiazac,Taztia), verapamil (Calan, Coer, Covera, Isoptin, Verelan, Isoptin, Tarka)"
htn_med_post___9	= "Central alpha-2 agonists and other centrally acting drugs [c1onidine (Catapres, Catapres-TIS), methyldopa (Aldomet), reserpine (generic), guanfacine (Tenex)"
htn_med_post___10	= "Direct vasodilators [hydralazine (Apresoline, Apo- Hydralazine, Novo- Hyalazin), minoxidil (Loniten)"
htn_med_post___11	= "Other"
other_htn_post	= "If yes to other antihypertensive medication, please specify"
lipid_post	= "Is this participant currently given any antilipemic medications?"
lipid_med_post___1	= "Statins [HMG CoA reductase inhibitors (lovastatin, pravastatin, simvastatin, atorvastatin, rosuvastatin, etc.)"
lipid_med_post___2	= "Bile acid sequestrants (Cholestyramine, Colestipol, Colesevelam)"
lipid_med_post___3	= "Nicotinic acid (generic, Niaspan)"
lipid_med_post___4	= "Fibric acids (Gemfibrozil, Fenofibrate, Clofibrate)"
lipid_med_post___5	= "Fish Oil"
lipid_med_post___6	= "Niacin"
lipid_med_post___7	= "Cholesterol absorption inhibitors [ezetimibe, Zetia)"
lipid_med_post___8	= "Other"
lipid_other_post	= "If yes to other antilipemic medication, please specify"
acidred_post	=	"Is this participant currently taking any GI acid reducing medications?"
acid_red_med_post___1	= "Proton pump inhibitor (e.g. omeprazole, pantoprazole, esomeprazole, lansoprazole, rabeprazole)"
acid_red_med_post___2	= "Ranitidine, famotidine (or other H2 antagonists)"
acid_red_med_post___3	= "Antacids (e.g. TUMS, Maalox, Mylanta, Pepto Bismol)"
acid_red_med_post___4	= "Other"
other_acidred_med_post	= "If yes to other GI acid reducing medication, please specify"
dm_post	= "Has the subject been diagnosed with diabetes?"
dm_meds_post___1	= "Insulin"
dm_meds_post___2	= "Oral hypoglycemic agents"
dm_meds_post___3	= "Other "
dm_meds_post___4	= "None"
dm_med_other_post	= "If yes to other hypoglycemic agent please specify"
antiviral_yn_post	= "Is this participant currently given any antiviral agents (e.g., acyclovir (Zovirax), ganciclovir (DHRG, Cytovene), etc.)? (Record both prophylactic and treatment antivirals)"
antiviral_med_post___1	= "Valgancyclovir (Valcyte)"
antiviral_med_post___2	= "Valacyclovir (Valtrex)"
antiviral_med_post___3	= "Acyclovir"
antiviral_med_post___4	= "Ganciclovir"
antiviral_med_post___5	= "Other"
antiviral_med_post___6	= "Unknown"
other_antiviral_med_post	= "If yes to other antiviral agents please specify"
antifungal_yn_post	= "Is the participant currently prescribed any antifungal agents? (Record all prophylactic and treatment antifungals)"	
antifungal_meds_post___1	= "Ketoconazole (Nizoral)"
antifungal_meds_post___2	= "Itraconazole (Sporanox)"
antifungal_meds_post___3	= "Fluconazole (Diflucan)"
antifungal_meds_post___4	= "Voriconazole (Vfend)"
antifungal_meds_post___5	= "Posaconazole (Noxafil)"
antifungal_meds_post___6	= "Clotrimazole"
antifungal_meds_post___7	= "Nystatin "
antifungal_meds_post___8	= "Other"
antifungal_meds_post___9	= "Unknown"
other_antifungal_post	= "If yes to other antifungal agent please specify"
antibiotics_yn_post	= "Is the subject currently prescribed any antibiotics? (Record all prophylactic and treatment antibiotics)"	
allantibio_post___1	= "Aminoglycosides (e.g. gentamicin, tobramycin) "
allantibio_post___2	= "Cephalosporn (e.g. cefazolin, cephalexin, cefixime, cefpodoxime, cefactor, cefprozil)"
allantibio_post___3	= "Dapsone"
allantibio_post___4	= "Fluoroquinolone (e.g. ciprofloxacin, gemifloxacin, levofloxacin, moxifloxacin, ofloxacin)"
allantibio_post___5 = "Glycopeptides (e.g. vancomycin, teicoplanin, telavancin, ramoplanin, and decaplanin)"
allantibio_post___6 = "Macrolides (e.g. erythromycin, roxithromycin, azithromycin, clarithromycin)"
allantibio_post___7 = "Penicillin (e.g. ampicillin, amoxicillin, amoxicillin-clavulanate)"
allantibio_post___8	= "Sulfonamide (e.g. sulfamethoxazole/ trimethoprim (Bactrim))"
allantibio_post___9 = "Tetracycline (e.g. doxycycline, minocycline)"
allantibio_post___10 = "Metronidazole (Metro, Flagyl)"
allantibio_post___11 = "Other"
allantibio_post___12 = "Unknown"
other_antibiotics_post = " If other antibiotics is selected please specify"
other_med_post = "Is the subject currently given any additional medications not captured above?"
other_med_details_post = "Report all additional medications the participant is currently taking."
data_entered_byg6 = "Data entered by:"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value htn_postf 1 = "Yes" 2 = "No" 3 = "Unknown";
value htn_med_post___1f 0 = "No Drug reported" 1 = "Diuretics (including thiazide diuretics, loop diuretics or potassium-sparing diuretics)"; 
value htn_med_post___2f 0 = "No Drug reported" 1 = "Aldosterone receptor blockers [plerenon (Inspra), spironolactone (Aldactone)"; 
value htn_med_post___3f 0 = "No Drug reported" 1 = "Beta Blockers (with or without sympathomimetic activity) [atenolol (Tenormin), betaxolol (Kerlone), bisoprolol (Zebeta), metroprolol (Lopressor, ToprolXL), nadolol (Corgard), propranolol (Inderal, Inderal LA), timolol (Blocadren), acebutolol (Sectral), penbutolol (Levatol), pindolol (generic)"; 
value htn_med_post___4f 0 = "No Drug reported" 1 = "Ace Inhibitors [benazepril (Lotensin), captopril (Capoten), enalapril (Vasotec), fosinopril (Monopril), lisinopril (Prinivil, Zestril), moexipril (Univasc), perindopril (Aceon), quinapril (Accupril), ramipril (Altace), trandolapril (Mavik)";
value htn_med_post___5f 0 = "No Drug reported" 1 = "Angiotensin II antagonists [candesartan (Atacand), eprosartan (Teveten), irbesartan (Avapro), losartan (Cozaar), olmesartan (Benicar), telmisartan (Micardis), valsartan (Diovan)";
value htn_med_post___6f 0 = "No Drug reported" 1 = "Calcium Channel Blockers GROUP 1: [amlodipine (Norvasc, Lotrel, Azor, Caduct, Exforge), felodipine (Plendil, Lexxel), nimodipine (Nimotop), nisoldipine (Sular)"; 
value htn_med_post___7f 0 = "No Drug reported" 1 = "Calcium Channel Blockers GROUP 2: [isradipine (DynaCirc), nicardipine (Cardene), nifedipine (Adalat, Procardia)";
value htn_med_post___8f 0 = "No Drug reported" 1 = "Calcium Channel Blockers GROUP3: [diltiazem (Cardizem, Cartia, Dilacor, Diltia, Tiazac,Taztia), verapamil (Calan, Coer, Covera, Isoptin, Verelan, Isoptin, Tarka)"; 
value htn_med_post___9f 0 = "No Drug reported" 1 = "Central alpha-2 agonists and other centrally acting drugs [c1onidine (Catapres, Catapres-TIS), methyldopa (Aldomet), reserpine (generic), guanfacine (Tenex)"; 
value htn_med_post___10f 0 = "No Drug reported" 1 = "Direct vasodilators [hydralazine (Apresoline, Apo- Hydralazine, Novo- Hyalazin), minoxidil (Loniten)"; 
value htn_med_post___11f 0 = "No Drug reported" 1 = "Other";
value lipid_postf 1 = "Yes" 2 = "No" 3 = "Unknown";
value lipid_med_post___1f 0 = "No Drug reported" 1 = "Statins [HMG CoA reductase inhibitors (lovastatin, pravastatin, simvastatin, atorvastatin, rosuvastatin, etc.)"; 
value lipid_med_post___2f 0 = "No Drug reported" 1 = "Bile acid sequestrants (Cholestyramine, Colestipol, Colesevelam)"; 
value lipid_med_post___3f 0 = "No Drug reported" 1 = "Nicotinic acid (generic, Niaspan)"; 
value lipid_med_post___4f 0 = "No Drug reported" 1 = "Fibric acids (Gemfibrozil, Fenofibrate, Clofibrate)"; 
value lipid_med_post___5f 0 = "No Drug reported" 1 = "Fish Oil"; 
value lipid_med_post___6f 0 = "No Drug reported" 1 = "Niacin"; 
value lipid_med_post___7f 0 = "No Drug reported" 1 = "Cholesterol absorption inhibitors [ezetimibe, Zetia)"; 
value lipid_med_post___8f 80 = "No Drug reported" 1 = "Other";
value acidred_postf 1 = "Yes" 2 = "No" 3 = "Unknown";
value acid_red_med_post___1f 0 = "No Drug reported" 1 = "Proton pump inhibitor (e.g. omeprazole, pantoprazole, esomeprazole, lansoprazole, rabeprazole)"; 
value acid_red_med_post___2f 0 = "No Drug reported" 1 = "Ranitidine, famotidine (or other H2 antagonists)"; 
value acid_red_med_post___3f 0 = "No Drug reported" 1 = "Antacids (e.g. TUMS, Maalox, Mylanta, Pepto Bismol)"; 
value acid_red_med_post___4f 0 = "No Drug reported" 1 = "Other";
value dm_postf 1 = "Yes" 2 = "No" 3 = "Unknown";
value dm_meds_post___1f 0 = "No Drug reported" 1 = "Insulin"; 
value dm_meds_post___2f 0 = "No Drug reported" 1 = "Oral hypoglycemic agents"; 
value dm_meds_post___3f 0 = "No Drug reported" 1 = "Other"; 
value dm_meds_post___4f 0 = "No Drug reported" 1 = "None";
value antiviral_yn_postf 1 = "Yes" 2 = "No" 3 = "Unknown";
value antiviral_med_post___1f 0 = "No Drug reported" 1 = "Valgancyclovir (Valcyte)"; 
value antiviral_med_post___2f 0 = "No Drug reported" 1 = "Valacyclovir (Valtrex)"; 
value antiviral_med_post___3f 0 = "No Drug reported" 1 = "Acyclovir";
value antiviral_med_post___4f 0 = "No Drug reported" 1 = "Ganciclovir"; 
value antiviral_med_post___5f 0 = "No Drug reported" 1 = "Other"; 
value antiviral_med_post___6f 0 = "No Drug reported" 1 = "Unknown";
value antifungal_yn_postf 1 = "Yes" 2 = "No" 3 = "Unknown";
value antifungal_meds_post___1f 0 = "No Drug reported" 1 = "Ketoconazole (Nizoral)"; 
value antifungal_meds_post___2f 0 = "No Drug reported" 1 = "Itraconazole (Sporanox)"; 
value antifungal_meds_post___3f 0 = "No Drug reported" 1 = "Fluconazole (Diflucan)"; 
value antifungal_meds_post___4f 0 = "No Drug reported" 1 = "Voriconazole (Vfend)"; 
value antifungal_meds_post___5f 0 = "No Drug reported" 1 = "Posaconazole (Noxafil)"; 
value antifungal_meds_post___6f 0 = "No Drug reported" 1 = "Clotrimazole"; 
value antifungal_meds_post___7f 0 = "No Drug reported" 1 = "Nystatin"; 
value antifungal_meds_post___8f 0 = "No Drug reported" 1 = "Other";
value antifungal_meds_post___9f 0 = "No Drug reported" 1 = "Unknown";
value antibiotics_yn_postf 1 = "Yes" 2 = "No" 3 = "Unknown";
value allantibio_post___1f 0 = "No Drug reported" 1 = "Aminoglycosides (e.g. gentamicin, tobramycin)";
value allantibio_post___2f 0 = "No Drug reported" 1 = "Cephalosporin (e.g. cefazolin, cephalexin, cefixime, cefpodoxime, cefactor, cefprozil)"; 
value allantibio_post___3f 0 = "No Drug reported" 1 = "Dapsone"; 
value allantibio_post___4f 0 = "No Drug reported" 1 = "Fluoroquinolone (e.g. ciprofloxacin, gemifloxacin, levofloxacin, moxifloxacin, ofloxacin)"; 
value allantibio_post___5f 0 = "No Drug reported" 1 = "Glycopeptides (e.g. vancomycin, teicoplanin, telavancin, ramoplanin, and decaplanin)";
value allantibio_post___6f 0 = "No Drug reported" 1 = "Macrolides (e.g. erythromycin, roxithromycin, azithromycin, clarithromycin)"; 
value allantibio_post___7f 0 = "No Drug reported" 1 = "Penicillin (e.g. ampicillin, amoxicillin, amoxicillin-clavulanate)"; 
value allantibio_post___8f 0 = "No Drug reported" 1 = "Sulfonamide (e.g. sulfamethoxazole/ trimethoprim (Bactrim))"; 
value allantibio_post___9f 0 = "No Drug reported" 1 = "Tetracycline (e.g. doxycycline, minocycline)"; 
value allantibio_post___10f 0 = "No Drug reported" 1 = "Metronidazole (Metro, Flagyl)"; 
value allantibio_post___11f 0 = "No Drug reported" 1 = "Other";
value allantibio_post___12f 0 = "No Drug reported" 1 = "Unknown";
value other_med_postf	0 = "No Drug reported" 1 = "Yes" 2 = "No" 3 = "Unknown";
run;

data g6;
set g6;
format	htn_post	htn_postf.;
format	htn_med_post___1	htn_med_post___1f.;
format	htn_med_post___2	htn_med_post___2f.;
format	htn_med_post___3	htn_med_post___3f.;
format	htn_med_post___4	htn_med_post___4f.;
format	htn_med_post___5	htn_med_post___5f.;
format	htn_med_post___6	htn_med_post___6f.;
format	htn_med_post___7	htn_med_post___7f.;
format	htn_med_post___8	htn_med_post___8f.;
format	htn_med_post___9	htn_med_post___9f.;
format	htn_med_post___10	htn_med_post___10f.;
format	htn_med_post___11	htn_med_post___11f.;
format	lipid_post	lipid_postf.;
format	lipid_med_post___1	lipid_med_post___1f.;
format	lipid_med_post___2	lipid_med_post___2f.;
format	lipid_med_post___3	lipid_med_post___3f.;
format	lipid_med_post___4	lipid_med_post___4f.;
format	lipid_med_post___5	lipid_med_post___5f.;
format	lipid_med_post___6	lipid_med_post___6f.;
format	lipid_med_post___7	lipid_med_post___7f.;
format	lipid_med_post___8	lipid_med_post___8f.;
format	acidred_post	acidred_postf.;
format	acid_red_med_post___1	acid_red_med_post___1f.;
format	acid_red_med_post___2	acid_red_med_post___2f.;
format	acid_red_med_post___3	acid_red_med_post___3f.;
format	acid_red_med_post___4	acid_red_med_post___4f.;
format	dm_post	dm_postf.;
format	dm_meds_post___1	dm_meds_post___1f.;
format	dm_meds_post___2	dm_meds_post___2f.;
format	dm_meds_post___3	dm_meds_post___3f.;
format	dm_meds_post___4	dm_meds_post___4f.;
format	antiviral_yn_post	antiviral_yn_postf.;
format	antiviral_med_post___1	antiviral_med_post___1f.;
format	antiviral_med_post___2	antiviral_med_post___2f.;
format	antiviral_med_post___3	antiviral_med_post___3f.;
format	antiviral_med_post___4	antiviral_med_post___4f.;
format	antiviral_med_post___5	antiviral_med_post___5f.;
format	antiviral_med_post___6	antiviral_med_post___6f.;
format	antifungal_yn_post	antifungal_yn_postf.;
format	antifungal_meds_post___1	antifungal_meds_post___1f.;
format	antifungal_meds_post___2	antifungal_meds_post___2f.;
format	antifungal_meds_post___3	antifungal_meds_post___3f.;
format	antifungal_meds_post___4	antifungal_meds_post___4f.;
format	antifungal_meds_post___5	antifungal_meds_post___5f.;
format	antifungal_meds_post___6	antifungal_meds_post___6f.;
format	antifungal_meds_post___7	antifungal_meds_post___7f.;
format	antifungal_meds_post___8	antifungal_meds_post___8f.;
format	antifungal_meds_post___9	antifungal_meds_post___9f.;
format	antibiotics_yn_post	antibiotics_yn_postf.;
format	allantibio_post___1	allantibio_post___1f.;
format	allantibio_post___2	allantibio_post___2f.;
format	allantibio_post___3	allantibio_post___3f.;
format	allantibio_post___4	allantibio_post___4f.;
format	allantibio_post___5	allantibio_post___5f.;
format	allantibio_post___6	allantibio_post___6f.;
format	allantibio_post___7	allantibio_post___7f.;
format	allantibio_post___8	allantibio_post___8f.;
format	allantibio_post___9	allantibio_post___9f.;
format	allantibio_post___10	allantibio_post___10f.;
format	allantibio_post___11	allantibio_post___11f.;
format	allantibio_post___12	allantibio_post___12f.;
format	other_med_post	other_med_postf.;
run;

*Running a report for g6 using the macro now;

proc contents data=g6 order=varnum;
run;

data mylib.g6clean;
set g6;
run;

*G7;

data g7;
set mylib.g7;
run;

proc contents data = g7 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data g7;
set g7;
label 
current_weight = "Please enter current weight of the participant in kg"
current_weight_dt = "Date the weight was recorded"
bmi_2 = "BMI"
bg_1 = "Random (non-fasting) blood glucose 1"
bg_2 = "Random (non-fasting ) blood glucose 2"
fasting_bg = "Fasting blood glucose"
a1c	= "A1C"
bg_1_value = "Random blood glucose 1 - value"
bg_1_date = "Random blood glucose 1- Date obtained"
bg_2_value = "Random Blood glucose 2 - value"
bg_2_date = "Random blood glucose 2- Date obtained"
fasting_bg_value = "Fasting Blood glucose - value"
fasting_bg_date	= "Fasting blood glucose - Date obtained"
a1c_value = "If the participant had an A1C test done, enter the value here"
a1c_dt = "A1C test - Date obtained"
data_entered_byg7 = "Data entered by:"
g7_weight_blood_glucose_and_a1c_= "Save all of the available measurements by clicking  <i> <u> 'Save & add  new instance' </i> </u>at the bottom of the form for each measurement and save them as new instances. </center>"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value weight_collectedf 1 = "Yes" 0 = "No";
value	bg_1f 1 = "Yes" 2 = "No" 3 = "Not known";
value	bg_2f 1 = "Yes" 2 = "No" 3 = "Not known";
value	fasting_bgf 1 = "Yes" 2 = "No" 3 = "Not known";
value	a1cf 1 = "Yes" 2 = "No" 3 = "Not known";
run;

data g7;
set g7;
format weight_collected weight_collectedf.;
format	bg_1 bg_1f.;
format	bg_2 bg_2f.;
format	fasting_bg fasting_bgf.;
format	a1c	a1cf.;
run;

*Running a report for g7 using the macro now;

proc contents data=g7 order=varnum;
run;

data mylib.g7clean;
set g7;
run;

*G8;

data g8;
set mylib.g8;
run;

proc contents data = g8 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data g8;
set g8;
label 
acr_tested_v1 = "Has the subject had a urine microalbumin to creatinine ratio test performed?"
acr_dt_v1 = "Date on which albumin/Cr ratio was obtained"
acr_time_v1 = "Type of measurement"
acr_albumin_v1 = "Urine Albumin measurement-value (mg/L)"
acr_cr_v1 = "Urine creatinine measurement-value (mg/dL)"
uacr_calc_v1 = "Urine microalbumin to creatinine ratio (mg/g)"
pcr_tested_v1 = "Has the subject had a urine protein to creatinine (protein/Cr) ratio test performed?"
pcr_dt_v1 = "Date on which protein/Cr ratio was obtained"
prc_time_v1 = "Type of measurement"
pcr_protein_v1 = "Total protein measurement-value (g/L)"
pcr_cr_v1 = "Urine creatinine measurement-value (mg/dL)"
upcr_calc_v1 = "Urine Protein to Cr ratio measurement-value (g/g)"
data_entered_byg8 = "Data entered by:"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value acr_tested_v1f 1 = "yes" 0 = "no";
value acr_time_v1f 5 = "spot urine" 6 = "24-hour urine";
value pcr_tested_v1f 1 = "yes" 0 = "no";
value prc_time_v1f 5 = "spot urine" 6 = "24-hour urine";
run;

data g8;
set g8;
format acr_tested_v1 acr_tested_v1f.;
format acr_time_v1 acr_time_v1f.;
format pcr_tested_v1 pcr_tested_v1f.;
format prc_time_v1 prc_time_v1f.;
run;

*Running a report for g8 using the macro now;

proc contents data=g8 order=varnum;
run;

data mylib.g8clean;
set g8;
run;

*G9;

data g9;
set mylib.g9;
run;

proc contents data = g9 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data g9;
set g9;
label 
dsa_identified = "Was there any DSA (donor specific antigen) testing done at the time of transplant and/or post-transplant?"
dsa_dt = "If yes, please provide the date of DSA"
dsa_specificities = "Were there any specificities identified?"
class1_a_specificities_dsa = "Class I - A specificities"
class1a_mfi	= "MFI value ( Class 1-A)"
class1_b_specificities_dsa = "Class I - B specificities"
class1_b_mfi = "MFI value ( Class 1-B)"
class1_c_specificities_dsa = "Class I - C specificities"
class1c_mfi	= "MFI value ( Class 1-C)"
class1_drb1_speci_dsa = "Class I - DR B1 specificities"
class1_drb1_mfi	= "MFI value ( Class 1-DRB1)"
class1_dqa1_speci_dsa = "Class I - DQ A1 specificities"
class1_dqa1_mfi	= "MFI value ( Class 1-DQA1)"
class1_dqb1_speci_dsa = "Class I - DQ B1 specificities"
class1_dqb1_mfi	= "MFI value ( Class 1-DQB1)"
class1_dpa1_speci_dsa = "Class I - DP A1 specificities"
class1_dpa1_mfi	= "MFI value ( Class 1-DPA1)"
class1_dpb1_speci_dsa = "Class I - DP B1 specificities"
class1_dpb1	= "MFI value ( Class 1-DPB1)"
data_entered_byg9 = "Data entered by:"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value dsa_identified 1 = "yes" 0 = "no";
value dsa_specificities 1 = "yes" 0 = "no";
run;

data g9;
set g9;
format dsa_identified dsa_identifiedf.;
format dsa_specificities dsa_specificitiesf.;
run;

*Running a report for g9 using the macro now;

proc contents data=g9 order=varnum;
run;

data mylib.g9clean;
set g9;
run;

*G10;

data g10;
set mylib.g10;
run;

proc contents data = g10 order=varnum;
run;

proc print data = g10;
run;

proc export 
  data= g10
  dbms=csv
  outfile="/home/u63327094/analysis_MISSION_PS_data_reports/MPA_AUC_list_LSS.csv" 
  replace;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data g10;
set g10;
label 
mpaauc = "Is there a MPA area under the curve (AUC) available?"
mpaauc_dt = "Date of MPA AUC"
mpaauc_value = "Calculated AUC value (in mg/hr L)"
mpaauc_num_meas = "How many MPA measurements were taken to calculate AUC?"
mpaauc_firstdraw_time = "Time of first draw"
mpaauc_firstdraw_conc = "MPA measurement #1 (mcg/mL)"
mpaauc_secdraw_time = "Time of second draw"
mpaauc_secdraw_conc = "MPA measurement #2 (mcg/mL)"
mpaauc_thirddraw_time = "Time of third draw"
mpaauc_thirddraw_conc = "MPA measurement #3 (mcg/mL)"
mpaauc_fourthdraw_time = "Time of fourth draw"
mpaauc_fourthdraw_conc = "MPA measurement #4 (mcg/mL)"
mpaauc_calc_inhibitor = "Is the participant receiving a calcineurin inhibitor at the time of the MPA AUC measurement?"
mpaauc_calc_inhibitor_type	=	"What type of calcineurin inhibitor is the participant taking?"
mpa_level = "Is there a mycophenolic acid (MPA) trough measurement available?"
mpa_dt = "If yes, date of measurement"
mpa_trough_concentration = "If yes, trough concentration at time of trough measurement (mcg/mL)"
mpag = "Is there a mycophenolic acid (MPA) glucuronide trough measurement available?"
mpag_date = "If yes, date of measurement"
mpag_conc = "If yes, MPA glucuronide concentration (ug/ml)"
mpa_name = "Mycophenolate product Name"
other_mpa_drug = "If other MPA drug is selected specify"
mpa_dosefreq = "Mycophenolate - dose frequency at time of trough measurement"
other_mpa_dose_freq	= "If other, record the mycophenolate dose frequency"
mpa_daily_dose = "Mycophenolate Total Daily Dose (in mg) at the time of trough"
mpa_daily_dose_other = "If yes to Other Total Daily Dose of mycophenolate, please specify"
mpa_route_of_admn = "Mycophenolate route of administration"
mpa_last_dose = "Last dose of mycophenolate taken before trough (mg)"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value mpaaucf 1 = "yes" 0 = "no";
value mpaauc_calc_inhibitorf 1 = "yes" 0 = "no";
value mpa_levelf 1 = "yes" 0 = "no";
value mpagf 1 = "yes" 0 = "no";
run;

data g10;
set g10;
format mpaauc mpaaucf.;
format mpaauc_calc_inhibitor mpaauc_calc_inhibitorf.;
format mpa_level mpa_levelf.;
format mpag mpagf.;
run;

*Running a report for g10 using the macro now;

proc contents data=g10 order=varnum;
run;

proc print data= g10;
var record_id mpaauc_fourthdraw_conc mpa_last_dose mpa_trough_concentration;
run;

data g10;
set g10;
mpaauc_fourthdraw_conc_num = input(mpaauc_fourthdraw_conc, 8.);
mpa_trough_concentration_num = input(mpa_trough_concentration, 8.);
mpa_last_dose_num = input(mpa_last_dose, 8.);
run;

data mylib.g10clean;
set g10;
run;

*G11;

data g11;
set mylib.g11;
run;

proc contents data = g11 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data g11;
set g11;
label 
mpa_startdt = "When did the participant begin mycophenolate?"
mpa_type = "What mycophenolate product are they receiving?"
mpa_other = "If Other MPA product, please specify"
mpa_route = "Route or mycophenolate administration"
mpa_dose_b4_change = "Mycophenolate total daily dose (mg)"
mpa_dose_b4_change_other = "If yes to Other total daily dose of mycophenolate, please specify"
mpa_freq_b4_change = "Frequency of mycophenolate"
mpa_change = "Was there a modification of mycophenolate product, dose, or frequency?"
mpa_change_how___1 = "If so, was it a product, dose, and/or frequency change? (Check all that apply) (If there is a mycophenolate product change, also check Dose changed and Frequency of doses changed to enter the information of the new mycophenolate)"
mpa_change_how___2 = "If so, was it a product, dose, and/or frequency change? (Check all that apply) (If there is a mycophenolate product change, also check Dose changed and Frequency of doses changed to enter the information of the new mycophenolate)"
mpa_change_how___3 = "If so, was it a product, dose, and/or frequency change? (Check all that apply) (If there is a mycophenolate product change, also check Dose changed and Frequency of doses changed to enter the information of the new mycophenolate)"
mpa_change_how___4 = "If so, was it a product, dose, and/or frequency change? (Check all that apply) (If there is a mycophenolate product change, also check Dose changed and Frequency of doses changed to enter the information of the new mycophenolate)"
mpa_change_mpa = "Record the new mycophenolate product the participant is receiving after the modification."
mpa_change_mpa_other = "If yes to Other MPA product, please specify."
mpa_change_dose = "Record the new total daily dose of the mycophenolate (mg)"
mpa_change_dose_other = "If yes to Other total daily dose of mycophenolate, please specify"
mpa_change_interval = "Record the new mycophenolate frequency change"
mpa_change_startdt = "Start date of mycophenolate modification:"
mpa_change_enddt = "End date of mycophenolate modification:"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value	mpa_typef 1 = "Mycophenolate mofetil (Cellcept or generic)" 2 = "Mycophenolic acid (Myfortic)" 3 = "Other MPA";
value	mpa_routef 1 = "IV" 2 = "Oral";
value	mpa_dose_b4_changef 1 = "250 mg" 2 = "500 mg" 3 = "750 mg" 4 = "1000 mg" 5 = "1250 mg" 6 = "1500 mg" 7 = "2000 mg" 8 = "3000 mg" 9 ="180 mg" 10 = "360 mg" 11 = "720 mg" 12 = "1440 mg" 13 = "Other total daily dose";
value	mpa_freq_b4_changef 1 = "Once/day" 2 = "Twice/day" 3 = "Three times/day" 4 = "Four times/day" 5 = "Once every other day" 6 = "Dose frequency not available";
value	mpa_changef	1 = "yes" 0 = "no";
value	mpa_change_how___1f	1 = "Product changed" 0 = "NA"; 
value	mpa_change_how___2f	1 = "Dose changed" 0 = "NA";
value	mpa_change_how___3f	1 = "Frequency of doses changed" 0 = "NA"; 
value	mpa_change_how___4f	1 = "All MPA products stopped" 0 = "NA";
value	mpa_change_mpaf	1 = "Mycophenolate mofetil (Cellcept or generic)" 2 = "Mycophenolic acid (Myfortic)" 3 = "Other MPA";
value	mpa_change_dosef 1 = "250 mg" 2 = "500 mg" 3 = "750 mg" 4 = "1000 mg" 5 = "1250 mg" 6 = "1500 mg" 7 = "2000 mg"  8 = "3000 mg" 9 = "180 mg" 10 = "360 mg" 11 = "720 mg" 12 = "1440 mg" 13 = "Other total daily dose";
value	mpa_change_intervalf 1 = "Once/day" 2 = "Twice/day" 3 = "Three times/day" 4 = "Four times/day" 5 = "Once every other day";
run;

data g11;
set g11;
format	mpa_type	mpa_typef.;
format	mpa_route	mpa_routef.;
format	mpa_dose_b4_change	mpa_dose_b4_changef.;
format	mpa_freq_b4_change	mpa_freq_b4_changef.;
format	mpa_change	mpa_changef.;
format	mpa_change_how___1	mpa_change_how___1f.;
format	mpa_change_how___2	mpa_change_how___2f.;
format	mpa_change_how___3	mpa_change_how___3f.;
format	mpa_change_how___4	mpa_change_how___4f.;
format	mpa_change_mpa	mpa_change_mpaf.;
format	mpa_change_dose	mpa_change_dosef.;
format	mpa_change_interval	mpa_change_intervalf.;
run;

*Running a report for g11 using the macro now;

proc contents data=g11 order=varnum;
run;

data mylib.g11clean;
set g11;
run;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

*h1;
%selectvars(h1,										
date_scr	
cr_level	
tx_dt_4	
day_posttx_scr1					
data_entered_byh1	
h1_serum_creatinine_levels_compl							
		);								
proc print data=mylib.h1;										
run;										
										
*h2;
%selectvars(h2,										
tac_level	
tac_trough	
tac_dt	
tac_name					
tac_dose	
tac_dosefreq	
tac_dose_freq_other	
tac_iv_oral					
tac_hgb	
tac_hgb_dt	
tac_tac_hgb_days	
tac_hct					
tac_hct_dt	
tac_tac_hct_days	
tx_dt_1	
day_posttx_tac					
week_posttx_tac	
data_entered_byh2	
h2_tacrolimus_clinical_trough_le						
		);								
proc print data=mylib.h2;										
run;										

*everolimus, added 05/23, needs more checking;
%selectvars(h21,										
level_cyclo
first_dose_cyclo
start_date_cyclo
trough_cyclo
dt_cyclo
dose_cyclo
dosefreq_cyclo
dose_freq_other_cyclo
iv_oral_cyclo
date_of_transplant_cyclo
day_posttx_cyclo
week_posttx_cyclo
data_entered_cyclo
instrxn_taclevelcyclo						
		);								
proc print data=mylib.h21;										
run;										
										
*cyclosporine, added 05/23 needs more checking;
%selectvars(h22,										
level_evero
first_dose_evero
start_date_evero
trough_evero
dt_evero
dose_evero
dosefreq_evero
dose_freq_other_cycloevero
iv_oral_evero
date_of_transplant_evero
day_posttx_evero
week_posttx_evero
data_entered_cycloevero
instrxn_taclevelcycloevero				
		);								
proc print data=mylib.h22;										
run;

										
*h3;
%selectvars(h3,										
cmp_dt	
cmp_sodium	
cmp_potassium	
cmp_chloride					
cmp_co2	
cmp_anion_gap	
cmp_glu	
cmp_bun					
cmp_creatinine	
cmp_egfr	
cmp_egfr_aa	
cmp_calcium					
lft_dt	
cmp_bilirubin	
cmp_albumin	
cmp_protein					
cmp_alk_phos	
cmp_alt	
cmp_ast	
cbc_dt					
cbc_wbc	
cbc_rbc	
cbc_hgb	
cbc_hct					
cbc_mcv	
cbc_mch	
cbc_mchc	
cbc_rdw					
cbc_platelet	
cbc_per_neutrophil	
cbc_per_lymphocytes	
cbc_per_monocytes					
cbc_per_eosinophils	
cbc_per_immature_granulocytes	
cbc_nucleated_rbc	
cbc_abs_neutrophil					
cbc_abs_lymphocytes	
cbc_abs_monocytes	
cbc_abs_eosinophils	
cbc_abs_basophils					
cbc_abs_immat_gran	
cbc_abs_nucleated_rbc	
data_entered_byh3	
h3_comprehensive_metabolic_panel					
		);								
proc print data=mylib.h3;										
run;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

*H1;

data h1;
set mylib.h1;
run;

proc contents data = h1 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data h1;
set h1;
label 
date_scr = "Date of SCr"
cr_level = "SCr level (mg/dL)"
tx_dt_4	= "Date of Transplant"
day_posttx_scr1	= "Number of days between SCr date and transplant date"
data_entered_byh1 = "Data entered by:"
;
run;

*Running a report for h1 using the macro now;

data mylib.h1clean;
set h1;
run;

proc contents data=h1 order=varnum;
run;

*h2;

data h2;
set mylib.h2;
run;

proc contents data = h2 order=varnum;
run;

data h2;
set h2;
tac_trough_num = input(tac_trough, 8.);
tac_dose_num = input(tac_dose, 8.);
tac_hgb_num = input(tac_hgb, 8.);
tac_hct_num = input(tac_hct, 8.);
day_posttx_tac_num = input(day_posttx_tac, 8.);
week_posttx_tac_num = input(week_posttx_tac, 8.);
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data h2;
set h2;
label 		
tac_level =	"Was there a tacolimus measurement data available?"
tac_trough = "Tacrolimus Trough (ng/ml)"
tac_trough_num = "Tacrolimus Trough (ng/ml)"
tac_dt = "Date of tacolimus trough measurement"
tac_name = "Tacrolimus Product Name at time of trough"
tac_dose = "Tacrolimus - daily dose in mg"
tac_dose_num = "Tacrolimus - daily dose in mg"
tac_dosefreq = "Tacrolimus - What is the dose frequency?"
tac_dose_freq_other = "If other, record the dose frequency here"
tac_iv_oral = "Tacrolimus route of administration"
tac_hgb = "Please enter the hemoglobin level closest to the date of the tacrolimus trough level. (Enter the lowest hemoglobin value if more than one is available for the same date. If there is not a hemoglobin level on the same day as the tacrolimus trough, use a hgb level prior to the tac trough.)"
tac_hgb_num = "Please enter the hemoglobin level closest to the date of the tacrolimus trough level. (Enter the lowest hemoglobin value if more than one is available for the same date. If there is not a hemoglobin level on the same day as the tacrolimus trough, use a hgb level prior to the tac trough.)"
tac_hgb_dt = "Date of hemoglobin result"
tac_tac_hgb_days = "Number of days between tacrolimus trough and hemoglobin result"
tac_hct	= "Please enter the hematocrit value closest to the date of the tacrolimus trough level. (Enter the lowest hematocrit percentage if more than one is available for the same date. If there is not a hematocrit value on the same day as the tacrolimus trough, use a hct value prior to the tac trough.)"
tac_hct_num	= "Please enter the hematocrit value closest to the date of the tacrolimus trough level. (Enter the lowest hematocrit percentage if more than one is available for the same date. If there is not a hematocrit value on the same day as the tacrolimus trough, use a hct value prior to the tac trough.)"
tac_hct_dt = "Date of hematocrit value"
tac_tac_hct_days = "Number of days between tacrolimus trough and hematocrit value"
tx_dt_1 = "Date of Transplant"
day_posttx_tac = "Number of days between transplant date and date of tacrolimus trough measurement"
week_posttx_tac = "Number of weeks between transplant date and date of tacrolimus trough measurement"
data_entered_byh2 =	"Data entered by:"
h2_tacrolimus_clinical_trough_le = " Save all of the available trough level measurements between previous visit date and current assessement date by clicking  <b><i><u>'Save & add  new instance' </b></i></u>at the bottom of the form for each measurement and save them as new instances"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value tac_level	1 = "Yes" 0="No";
value tac_name 1 = "Tacrolimus Immediate Release (Prograf/ generic)" 2 = "Tacrolimus Extended-Release (Astagraf XL)" 3 = "Tacrolimus Extended-Release (Envarsus XR)";
value tac_dosefreq 1 = "Once/day" 2 = "Twice/day" 3 = "Three times/day" 4 = "Four times/day" 5 = "Once every other day" 6 = "Other" 7 = "Frequency information not available";
value tac_iv_oral 1 = "IV" 2 = "Oral Capsules" 3 = "Oral Suspension";
run;

data h2;
set h2;
format tac_level tac_level.;
format tac_name tac_name.;
format tac_dosefreq tac_dosefreq.;
format tac_iv_oral	tac_iv_oral.;
run;

*Running a report for h2 using the macro now;

data mylib.h2clean;
set h2;
run;

proc print data = h2;
run;

proc contents data=h2 order=varnum;
run;

*h3;

data h3;
set mylib.h3;
run;

proc contents data = h3 order=varnum;
run;

data h3;
set h3;
cmp_chloride_num = input(cmp_chloride, 8.);
cmp_co2_num = input(cmp_co2, 8.);
cmp_anion_gap_num = input(cmp_anion_gap, 8.);
cmp_creatinine_num = input(cmp_creatinine, 8.);	
cmp_egfr_num = input(cmp_egfr, 8.);	
cmp_egfr_aa_num = input(cmp_egfr_aa, 8.);	
cmp_calcium_num = input(cmp_calcium, 8.);					
lft_dt_num = input(lft_dt, 8.);	
cmp_bilirubin_num = input(cmp_bilirubin, 8.);	
cmp_albumin_num = input(cmp_albumin, 8.);	
cmp_protein_num = input(cmp_protein, 8.);					
cmp_alk_phos_num = input(cmp_alk_phos, 8.);	
cmp_alt_num = input(cmp_alt, 8.);	
cmp_ast_num = input(cmp_ast, 8.);					
cbc_wbc_num = input(cbc_wbc, 8.);	
cbc_rbc_num = input(cbc_rbc, 8.);	
cbc_hgb_num = input(cbc_hgb, 8.);	
cbc_hct_num = input(cbc_hct, 8.);					
cbc_mcv_num = input(cbc_mcv, 8.);	
cbc_mch_num = input(cbc_mch, 8.);	
cbc_mchc_num = input(cbc_mchc, 8.);	
cbc_rdw_num = input(cbc_rdw, 8.);					
cbc_platelet_num = input(cbc_platelet, 8.);	
cbc_per_neutrophil_num = input(cbc_per_neutrophil, 8.);	
cbc_per_lymphocytes_num = input(cbc_per_lymphocytes, 8.);	
cbc_per_monocytes_num = input(cbc_per_monocytes, 8.);					
cbc_per_eosinophils_num = input(cbc_per_eosinophils, 8.);	
cbc_per_im_gran_num = input(cbc_per_immature_granulocytes, 8.);	
cbc_nucleated_rbc_num = input(cbc_nucleated_rbc, 8.);	
cbc_abs_neutrophil_num = input(cbc_abs_neutrophil, 8.);					
cbc_abs_lymphocytes_num = input(cbc_abs_lymphocytes, 8.);	
cbc_abs_monocytes_num = input(cbc_abs_monocytes, 8.);	
cbc_abs_eosinophils_num = input(cbc_abs_eosinophils, 8.);	
cbc_abs_basophils_num = input(cbc_abs_basophils, 8.);					
cbc_abs_immat_gran_num = input(cbc_abs_immat_gran, 8.);	
cbc_abs_nucleated_rbc_num = input(cbc_abs_nucleated_rbc, 8.);	
run;

proc contents data=h3 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data h3;
set h3;
label 
cmp_dt	= "Date of lab - Comprehensive Metabolic Panel"
cmp_sodium	= "Sodium (mmol/L)"
cmp_potassium = "Potassium (mmol/L)"
cmp_chloride_num = "Chloride (mmol/L)"
cmp_co2_num = "Carbon Dioxide (mmol/L)"
cmp_anion_gap_num = "Anion Gap (mmol/L)"
cmp_glu	= "Glucose (mg/dL)"
cmp_bun	= "BUN (mg/dL)"
cmp_creatinine_num	= "Creatinine (mg/dL)"
cmp_egfr_num = "eGFR (mL/min/1.73 m2)"
cmp_egfr_aa_num	= "eGFR, if African American (mL/min/1.73 m2)"
cmp_calcium_num	= "Calcium (mg/dL)"
lft_dt_num	= "Date of hepatic panel"
cmp_bilirubin_num = "Bilirubin, Total (mg/dL)"
cmp_albumin_num	= "Albumin (g/dL)"
cmp_protein_num	= "Protein, Total"
cmp_alk_phos_num = "Alkaline Phosphatase (U/L)"
cmp_alt_num	= "ALT (U/L)"
cmp_ast_num	= "AST (U/L)"
cbc_dt	= "Date of CBC"
cbc_wbc_num	= "WBC (10e9/L)"
cbc_rbc_num	= "RBC Count (10e12/L)"
cbc_hgb_num	= "Hemoglobin (g/dL)"
cbc_hct_num	= "Hematocrit (%)"
cbc_mcv_num	= "MCV (fl)"
cbc_mch_num	= "MCH (pg)"
cbc_mchc_num = "MCHC (g/dL)"
cbc_rdw_num	= "RDW (%)"
cbc_platelet_num = "Platelet Count (10e9/L)"
cbc_per_neutrophil_num	= "% Neutrophils"
cbc_per_lymphocytes_num	= "% Lymphocytes"
cbc_per_monocytes_num	= "% Monocytes"
cbc_per_eosinophils_num	= "% Eosinophils"
cbc_per_im_gran_num = "% Immature Granulocytes"
cbc_nucleated_rbc_num	= "Nucleated RBCs ( /100)"
cbc_abs_neutrophil_num	= "Absolute Neutrophil (10e9/L)"
cbc_abs_lymphocytes_num	= "Absolute Lymphocytes (10e9/L)"
cbc_abs_monocytes_num	= "Absolute Monocytes (10e9/L)"
cbc_abs_eosinophils_num	= "Absolute Eosinophils (10e9/L)"
cbc_abs_basophils_num	= "Absolute Basophils (10e9/L)"
cbc_abs_immat_gran_num	= "Absolute Immature Granulocytes (10e9/L)"
cbc_abs_nucleated_rbc_num	= "Absolute Nucleated RBC"
;
run;

*Running a report for h3 using the macro now;

data mylib.h3clean;
set h3;
run;

*I am going to be lazy and export the HBG and HCT data by hand;

proc print data = h3;
run;

proc export 
  data=h3
  dbms=xlsx 
  outfile="/home/u63327094/analysis_MISSION_06_16S_Shotgun_TAC_analysis/HGBHCT_PS_04220204.xlsx" 
  replace;
run;

proc contents data=h3 order=varnum;
run;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

*i1;
%selectvars(i1,										
infxn	
type_infxn	
other_type_infxn	
dt_viral_infxn					
viral_infxn	
cmv_load	
cmv_dt	
cmv_invasive					
ebv_dt	
bkv_load	
bkv_dt	
other_viral_infxn					
site_of_viralinfxn___1	
site_of_viralinfxn___2	
site_of_viralinfxn___3	
site_of_viralinfxn___4					
site_of_viralinfxn___5	
site_of_viralinfxn___6	
site_of_viralinfxn___7	
infxn_site_other					
antiviral_yn	
antiviral_med___1	
antiviral_med___2	
antiviral_med___3					
antiviral_med___4	
antiviral_med___5	
antiviral_med___6	
other_antiviral_med					
viralinf_lower_is	
dt_fungal_infxn	
fungal_infxn	
other_fungal_infxn					
site_of_fungalinfxn___1	
site_of_fungalinfxn___2	
site_of_fungalinfxn___3	
site_of_fungalinfxn___4					
site_of_fungalinfxn___5	
site_of_fungalinfxn___6	
site_of_fungalinfxn___7	
fungalinfxn_site_other					
antifungal_yn	
antifungal_meds___1	
antifungal_meds___2	
antifungal_meds___3					
antifungal_meds___4	
antifungal_meds___5	
antifungal_meds___6	
antifungal_meds___7					
antifungal_meds___8	
antifungal_meds___9	
antifungal_meds___10	
antifungal_meds___11					
antifungal_meds___12	
antifungal_meds___13	
antifungal_meds___14	
other_antifungal					
fungal_infxn_lower_is	
dt_bacterial_infxn	
bacterial_infxn___1	
bacterial_infxn___2					
bacterial_infxn___3	
bacterial_infxn___4	
bacterial_infxn___5	
bacterial_infxn___6					
bacterial_infxn___7	
bacterial_infxn___8	
bacterial_infxn___9	
bacterial_infxn___10					
bacterial_infxn___11	
bacterial_infxn___12	
bacterial_infxn___13	
bacterial_infxn___14					
other_bacterial_infxn	
site_of_bac_infxn___1	
site_of_bac_infxn___2	
site_of_bac_infxn___3					
site_of_bac_infxn___4	
site_of_bac_infxn___5	
site_of_bac_infxn___6	
site_of_bac_infxn___7					
bac_infxn_site_other	
antibiotics_yn	
allantibio___1	
allantibio___2					
allantibio___3	
allantibio___4	
allantibio___5	
allantibio___6					
allantibio___7	
allantibio___8	
allantibio___9	
allantibio___10					
allantibio___11	
allantibio___12	
other_antibiotics	
bacterial_infxn_lower_is					
otherinf_protainf_dt	
otherinf_name	
otherinf_protainf_site___1	
otherinf_protainf_site___2					
otherinf_protainf_site___3	
otherinf_protainf_site___4	
otherinf_protainf_site___5	
otherinf_protainf_site___6					
otherinf_protainf_site___7	
otherinf_protainf_othersite	
otherinf_protainf_treat	other_infxn_lower_is___1					
other_infxn_lower_is___0	
other_infxn_lower_is___2	
data_entered_byi1	
i1_infection_events_complete					
		);								
proc print data=mylib.i1;										
run;										
										
*i2;
%selectvars(i2,										
sae_event	
infectn_phlebotom_site	
exanguination_phelb_site	
fainitng_during_phelbotomy					
sae_dt	
sae_stop_dt	
sae_outcome	
squelae_description					
ctcae_grade	
blood_draw	
action_procedure	
seriousness_sae___1					
seriousness_sae___2	
seriousness_sae___3	
sae_status	
treatment_sae					
medical_history_sae	
lab_test_sae	
contributing_factor_sae	
comments_sae					
pi_sign	data_entered_byi2	
i2_serious_adverse_events_comple						
		);								
proc print data=mylib.i2;										
run;										
										
*i3;
%selectvars(i3,										
biopsy	
biopsy_dt_bx	
reason_biopsy_bx___1	
reason_biopsy_bx___2					
reason_biopsy_bx___3	
reason_biopsy_bx___4	
reason_biopsy_bx___5	
reason_biopsy_bx___6					
reason_biopsy_bx___7	
reason_biopsy_bx___8	
reason_biopsy_bx___9	
reason_biopsy_bx___10					
reason_biopsy_bx___11	
reason_biopsy_bx___12	
reason_biopsy_bx___13	
reason_biopsy_bx___14					
reason_biopsy_bx___15	
other_reason_biopsy_bx	
info_glom_bx	
info_sc_glom_bx					
info_of_art_bx	
glom_bx	
scl_glom_bx	
arteries_bx					
specimen_bx	
pri_diagnosis_bx___1	
pri_diagnosis_bx___2	
pri_diagnosis_bx___3					
pri_diagnosis_bx___4	
pri_diagnosis_bx___5	
pri_diagnosis_bx___6	
pri_diagnosis_bx___7					
pri_diagnosis_bx___8	
pri_diagnosis_bx___9	
pri_diagnosis_bx___10	
pri_diagnosis_bx___11					
pri_diagnosis_bx___12	
pri_diagnosis_bx___13	
pri_diagnosis_bx___14	
pri_diagnosis_bx___15					
pri_diagnosis_bx___16	
pri_diagnosis_bx___17	
pri_diagnosis_bx___18	
pri_diagnosis_bx___19					
other_diag_bx	
sec_diag_bx	
biopsy_secondary_dx___1	
biopsy_secondary_dx___2					
biopsy_secondary_dx___3	
biopsy_secondary_dx___4	
biopsy_secondary_dx___5	
biopsy_secondary_dx___6					
biopsy_secondary_dx___7	
biopsy_secondary_dx___8	
biopsy_secondary_dx___9	
biopsy_secondary_dx___10					
biopsy_secondary_dx___11	
biopsy_secondary_dx___12	
biopsy_secondary_dx___13	
biopsy_secondary_dx___14					
biopsy_secondary_dx___15	
biopsy_secondary_dx___16	
biopsy_secondary_dx___17	
biopsy_secondary_dx___18					
biopsy_secondary_dx___19	
biopsy_secondary_dx_other	
banff_bx	
g_score_bx					
i_score_bx	
t_score_bx	
v_score_bx	
ptc_score_bx					
no_pmnl_bx	
infarction_bx	
arteritis_damage_bx	
cg_score_bx					
ci_score_bx	
ct_score_bx	
cv_score_bx	
mm_score_bx					
ah_score_bx	
aah_score_bx	
arteriolitis_bx	
tatr_score_bx					
iatr_score_bx	
ti_score_bx	
i_ifta_score_bx	
c4d_yn_bx					
c4d_bx	
c4d_method_bx	
elc_microscopy_bx	
peri_cap_bm_bx					
double_gbm_bx	
acute_tcmr_grade_bx	
chronicactive_grade_bx	
chronic_grade_bx					
scr_bx	
scr_value_bx	
scr_dt_bx	
alb_cr_ratio_bx					
pro_cr_ratio_bx	
alb_cr_ratio_dt_bx	
pro_cr_ratio_dt_bx	
type_alb_cr_bx					
type_pro_cr_bx	
albumin_unit_bx	
albumin_value_bx	
urinecr_unit_bx					
urinecr_value_bx	
alb_cr_unit_bx	
alb_cr_unit_value_bx	
protein_unit_bx					
pro_value_bx	
uricr_unit_bx	
uri_cr_value_bx	
pro_cr_unit_bx					
pro_cr_value_bx	
data_entered_byi3	
i3_kidney_biopsy_events_complete						
		);								
proc print data=mylib.i3;										
run;										
										
*i4;
%selectvars(i4,										
rejxn	
rejxn_date	
biopsy_ar	
dt_bx_ar					
dt_bx_diag_dt	
type_rjxn	
rejxn_treatment_dt	
treatment_ar___1					
treatment_ar___2	
treatment_ar___3	
treatment_ar___4	
treatment_ar___5					
treatment_ar___6	
treatment_ar_other	
presc_ar___1	
presc_ar___2					
presc_ar___3	
presc_ar___4	
presc_ar___5	
presc_ar___6					
presc_ar___7	
other_treatment_ar	
ar_cr1_event1	
ar_cr1_dt_event1					
ar_cr2_event1	
ar_cr2_dt_event1	
ar_cr3_event1	
ar_cr3_dt_event1					
ar_cr4_event1	
ar_cr4_dt_event1	
ar_cr5_event1	
ar_cr5_dt_event1					
ar_cr6_event1	
ar_cr6_dt_event1	
data_entered_byi4	
i4_acute_rejection_events_comple					
		);								
proc print data=mylib.i4;										
run;										
										
*i5;
%selectvars(i5,										
graftfailure	
graftfail_date	
graftfail_death	
site_aware_gf_dt					
primary_cause_gf	
primary_cause_gf_other	
clinical_cause_gf	
ar_gf					
noncom_gf	
bk_gf	
thrombosis_gf	
is_reductn_gf					
re_disease_gf	
can_gf	
other_clincal_gf	
clincal_cause_other_gf					
scr_gf_avail	
scr_value_gf	
scr_value_gf_2	
data_entered_byi5					
i5_notification_of_non_fatal_gra								
		);								
proc print data=mylib.i5;										
run;										
										
*i6;
%selectvars(i6,										
death_event	
death_dt	
cause_death_1	
cause_death_2					
cause_death_3	
clincal_cause_known
clincal_causes___1	
clincal_causes___2					
clincal_causes___3	
clincal_causes___4	
clincal_causes___5	
clincal_causes___6					
clincal_causes___7	
clincal_causes___8	
other_clinical_cause	
scr_death_avail					
scr_date_death	
scr_value_death	
data_entered_byi6	
i6_death_form_complete					
		);								
proc print data=mylib.i6;										
run;								

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

*I1;

data i1;
set mylib.i1;
run;

proc contents data = i1 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data i1;
set i1;
label 
infxn = "Has the subject been diagnosed/treated for an acute infection event?	"
type_infxn = "Please indicate the type infection diagnosed in Question 1.	"
other_type_infxn = "If other type of infection is selected, please specify 	"
dt_viral_infxn = "If yes to viral infection, please specify the date when the viral infection event was diagnosed?	"
viral_infxn = "If viral infection, please specify	"
cmv_load = "If it is a CMV infection, what is the highest level of CMV viral load in the blood with this infection event?	"
cmv_dt = "Please specify the date of the highest level of viral load entered above.	"
cmv_invasive = "If yes to CMV infection please mention if it is tissue invasive	"
ebv_dt = "If yes to EBV, specify the date of EBV diagnosis	"
bkv_load = "If it is a BKV infection, what is the highest level of BK viral load in the blood with this infection event?	"
bkv_dt = "Please specify the date of the highest level of viral load entered above.	"
other_viral_infxn = "If other type of viral infection is selected, please specify	"
site_of_viralinfxn___1 = "If yes to viral infection, please specify the site of infection (1, Blood)	"
site_of_viralinfxn___2 = "If yes to viral infection, please specify the site of infection ( 2, Mouth)	"
site_of_viralinfxn___3 = "If yes to viral infection, please specify the site of infection ( 3, Lung)	"
site_of_viralinfxn___4 = "If yes to viral infection, please specify the site of infection ( 4, Stool)	"
site_of_viralinfxn___5 = "If yes to viral infection, please specify the site of infection ( 5, Urine)	"
site_of_viralinfxn___6 = "If yes to viral infection, please specify the site of infection ( 6, Other)	"
site_of_viralinfxn___7 = "If yes to viral infection, please specify the site of infection ( 7, Unknown)	"
infxn_site_other = "If other is selected, for site of infection, please specify 	"
antiviral_yn = "Was the subject given any antiviral agents as treatment for this viral infection?	"
antiviral_med___1 = "If yes, which antiviral agent was given to treat infection? (1, Valgancyclovir)	"
antiviral_med___2 = "If yes, which antiviral agent was given to treat infection? (2, Acyclovir)	"
antiviral_med___3 = "If yes, which antiviral agent was given to treat infection? (3, Ganciclovir)	"
antiviral_med___4 = "If yes, which antiviral agent was given to treat infection? (4, Other)	"
antiviral_med___5 = "If yes, which antiviral agent was given to treat infection? (5, None)	"
antiviral_med___6 = "If yes, which antiviral agent was given to treat infection? (6, Unknown)	"
other_antiviral_med	= "	If yes to other antiviral agent please specify 	"
viralinf_lower_is = "Did the viral infection listed above result in lowering of immune suppression from time of diagnosis to end of treatment? (lowering of tacrolimus trough target; lowering dose of tacrolimus, mycophenolate or steroid; or the discontinuation of immunosuppressants)	"
dt_fungal_infxn = "If yes to fungal infection, please specify the date on which the fungal infection event was diagnosed.	"
fungal_infxn = "If fungal infection, please specify	"
other_fungal_infxn = "If other fungal infection is selected, please specify	"
site_of_fungalinfxn___1 = "If yes to fungal infection, please specify the site of infection (1, Blood)	"
site_of_fungalinfxn___2 = "If yes to fungal infection, please specify the site of infection ( 2, Mouth)	"
site_of_fungalinfxn___3 = "If yes to fungal infection, please specify the site of infection (3, Lung)	"
site_of_fungalinfxn___4 = "If yes to fungal infection, please specify the site of infection (4, Stool)	"
site_of_fungalinfxn___5 = "If yes to fungal infection, please specify the site of infection (5, Urine)	"
site_of_fungalinfxn___6 = "If yes to fungal infection, please specify the site of infection (6, Other)	"
site_of_fungalinfxn___7 = "If yes to fungal infection, please specify the site of infection (7, Unknown)	"
fungalinfxn_site_other = "If other is selected, for site of fungal infection, please specify	"
antifungal_yn = "Was the subject prescribed any antifungal agents for the infection? 	"
antifungal_meds___1 = "Antifungal Agents - 1, Ketoconazole (Nizoral) 	"
antifungal_meds___2 = "Antifungal Agents -  2, Itraconazole (Sporanox) 	"
antifungal_meds___3 = "Antifungal Agents -  3, Fluconazole (Diflucan) 	"
antifungal_meds___4	= "Antifungal Agents -  4, Voriconazole (Vfend) 	"
antifungal_meds___5	= "Antifungal Agents -  5, Posaconazole (Noxafil) 	"
antifungal_meds___6	= "Antifungal Agents -  6, Clotrimazole (Mycelex) 	"
antifungal_meds___7	= "Antifungal Agents -  7, Nystatin (Mycostatin) 	"
antifungal_meds___8	= "Antifungal Agents -  8, Isavuconazole (Cresemba) 	"
antifungal_meds___9	= "Antifungal Agents -  9, Caspofungin (Cancidas) 	"
antifungal_meds___10 = "Antifungal Agents -  10, Anidulafungin (Eraxis) 	"
antifungal_meds___11 = "Antifungal Agents -  11, Micafungin (Mycamine) 	"
antifungal_meds___12 = "Antifungal Agents -  12, amphotericin (Abelcet, AmBisome, Amphocin, Amphotec, Fungizone) 	"
antifungal_meds___13 = "Antifungal Agents -  13, Other 	"
antifungal_meds___14 = "Antifungal Agents -  14, Unknown	"
other_antifungal = "If yes to other antifungal agent please specify 	"
fungal_infxn_lower_is = "Did the fungal infection listed above result in the lowering of immunosuppression from the time of diagnosis to end of treatment? (e.g. lowering of tacrolimus trough target; lowering dose of tacrolimus, mycophenolate or steroid; or the discontinuation of immunosuppressants)	"
dt_bacterial_infxn = "If yes to bacterial infection, please specify the date on which he bacterial infection event was diagnosed?	"
bacterial_infxn___1 = "If bacterial infection, please specify (1, P. jiroveci (Pneumocystis pneumonia, PCP))	"
bacterial_infxn___2 = "If bacterial infection, please specify (2, Escherichia coli)	"
bacterial_infxn___3 = "If bacterial infection, please specify (3, Mycobacterium)	"
bacterial_infxn___4	= "If bacterial infection, please specify (4, Vancomycin resistant enterococcus (VRE))	"
bacterial_infxn___5 = "If bacterial infection, please specify (5, Staph aureus, methicillin sensitive (MSSA))	"
bacterial_infxn___6	= "If bacterial infection, please specify (6, Staph aureus, methicillin resistant (MRSA))	"
bacterial_infxn___7	= "If bacterial infection, please specify (7, Proteus mirabilis)	"
bacterial_infxn___8	= "If bacterial infection, please specify (8, Streptococcus spp)	"
bacterial_infxn___9	= "If bacterial infection, please specify (9, Klebsiella Pneumoniae)	"
bacterial_infxn___10 = "If bacterial infection, please specify (10, Enterobacter)	"
bacterial_infxn___11 = "If bacterial infection, please specify (11, Pseudomonas aeruginosa)	"
bacterial_infxn___12 = "If bacterial infection, please specify (12, Clostridium difficile (C. diff))	"
bacterial_infxn___13 = "If bacterial infection, please specify (13, Other)	"
bacterial_infxn___14 = "If bacterial infection, please specify (14, Type Unknown)	"
other_bacterial_infxn = "If other bacterial infection is selected, please specify 	"
site_of_bac_infxn___1 = "If yes to bacterial infection, please specify the site of infection (1, Blood)	"
site_of_bac_infxn___2 = "If yes to bacterial infection, please specify the site of infection (2, Mouth)	"
site_of_bac_infxn___3 = "If yes to bacterial infection, please specify the site of infection (3, Lung)	"
site_of_bac_infxn___4 = "If yes to bacterial infection, please specify the site of infection (4, Stool)	"
site_of_bac_infxn___5 = "If yes to bacterial infection, please specify the site of infection (5, Urine)	"
site_of_bac_infxn___6 = "If yes to bacterial infection, please specify the site of infection (6, Other)	"
site_of_bac_infxn___7 = "If yes to bacterial infection, please specify the site of infection (7, Unknown)	"
bac_infxn_site_other = "If other is selected, for site of infection, please specify	"
antibiotics_yn = "Was the subject prescribed any antibiotics for the bacterial infection?	"
allantibio___1 = "If yes, to bacterial infection specify which antibacterial agent was given to treat the infection (1, Aminoglycosides (e.g. gentamicin, tobramycin)).	"
allantibio___2 = "If yes, to bacterial infection specify which antibacterial agent was given to treat the infection (2, Cephalosporin (e.g. cefazolin, cephalexin, cefixime, cefpodoxime, cefactor, cefprozil)).	"
allantibio___3 = "If yes, to bacterial infection specify which antibacterial agent was given to treat the infection (3, Dapsone).	"
allantibio___4 = "If yes, to bacterial infection specify which antibacterial agent was given to treat the infection (4, Fluoroquinolone (e.g. ciprofloxacin, gemifloxacin, levofloxacin, moxifloxacin, ofloxacin)).	"
allantibio___5 = "If yes, to bacterial infection specify which antibacterial agent was given to treat the infection (5, Glycopeptides (e.g. vancomycin, teicoplanin, telavancin, ramoplanin, and decaplanin)).	"
allantibio___6 = "If yes, to bacterial infection specify which antibacterial agent was given to treat the infection (6, Macrolides (e.g. erythromycin, roxithromycin, azithromycin, clarithromycin)).	"
allantibio___7 = "If yes, to bacterial infection specify which antibacterial agent was given to treat the infection (7, Penicillin (e.g. ampicillin, amoxicillin, amoxicillin-clavulanate)).	"
allantibio___8 = "If yes, to bacterial infection specify which antibacterial agent was given to treat the infection (8, Sulfonamide (e.g. sulfamethoxazole/ trimethoprim (Bactrim))).	"
allantibio___9 = "If yes, to bacterial infection specify which antibacterial agent was given to treat the infection (9, Tetracycline (e.g. doxycycline, minocycline)).	"
allantibio___10 = "If yes, to bacterial infection specify which antibacterial agent was given to treat the infection (10, Metronidazole (Flagyl)).	"
allantibio___11 = "If yes, to bacterial infection specify which antibacterial agent was given to treat the infection (11, Other).	"
allantibio___12 = "If yes, to bacterial infection specify which antibacterial agent was given to treat the infection (12, Unknown).	"
other_antibiotics = "If other antibiotics is selected please specify	"
bacterial_infxn_lower_is = "Did the bacterial infection listed above result in the lowering of immunosuppression from the time of diagnosis to end of treatment? (e.g. lowering of tacrolimus trough target; lowering dose of tacrolimus, mycophenolate or steroid; or the discontinuation of immunosuppressants)	"
otherinf_protainf_dt = "If yes to Other or Protazoal infection, please specify the date this infection was diagnosed:	"
otherinf_name = "Name of other infection	"
otherinf_protainf_site___1 = "If yes to other infection, please specify the site of the infection (1, Blood):	"
otherinf_protainf_site___2 = "If yes to other infection, please specify the site of the infection (2, Mouth):	"
otherinf_protainf_site___3 = "If yes to other infection, please specify the site of the infection (3, Lung):	"
otherinf_protainf_site___4 = "If yes to other infection, please specify the site of the infection (4, Stool):	"
otherinf_protainf_site___5 = "If yes to other infection, please specify the site of the infection (5, Urine):	"
otherinf_protainf_site___6 = "If yes to other infection, please specify the site of the infection (6, Other):	"
otherinf_protainf_site___7 = "If yes to other infection, please specify the site of the infection (7, Unknown):	"
otherinf_protainf_othersite = "If other site is specified for other infection, please specify.	"
otherinf_protainf_treat = "How was the infection treated?	"
other_infxn_lower_is___1 = "Did the [otherinf_name] infection listed above result in the lowering of immunosuppression from the time of diagnosis to end of treatment? (1, Yes)	"
other_infxn_lower_is___0 = "Did the [otherinf_name] infection listed above result in the lowering of immunosuppression from the time of diagnosis to end of treatment? ( 0, No)	"
other_infxn_lower_is___2 = "Did the [otherinf_name] infection listed above result in the lowering of immunosuppression from the time of diagnosis to end of treatment? ( 2, Unknown)	"
data_entered_byi1 = "Data entered by:	"
i1_infection_events_complete	=	"	<center> If more than one infection event was identified between the 6-month period, click <i> <u> 'Save & Add New Instance' </i> </u>at the bottom of the form. Another form in the same format will appear as a new instance. Fill each event information as new instance and save them.  </center>	"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value	infxnf	1 = "Yes" 0 = "No";								
value	type_infxnf	1 = "Viral" 2 = "Fungal" 3 = "Bacterial" 4 = "Protazoan" 5 = "Other" 6 = "Unknown";				
value	viral_infxnf 1 = "Cytomegalovirus (CMV)" 2 = "Epstein Barr Virus (EBV)" 3 = "BK polyoma virus (BKV)" 4 = "Human papillomavirus (HPV)" 5 = "Hepatitis C virus (HCV)" 6 = "Hepatitis C virus (HBV)" 7 = "Herpes Simplex Virus (HSV)" 8 = "Adenovirus" 9 = "Other" 10 = "Type Unknown/presumed";
value	site_of_viralinfxn___1f	1 = "Yes" 0 = "No";								
value	site_of_viralinfxn___2f	1 = "Yes" 0 = "No";								
value	site_of_viralinfxn___3f	1 = "Yes" 0 = "No";								
value	site_of_viralinfxn___4f	1 = "Yes" 0 = "No";								
value	site_of_viralinfxn___5f	1 = "Yes" 0 = "No";								
value	site_of_viralinfxn___6f	1 = "Yes" 0 = "No";								
value	site_of_viralinfxn___7f	1 = "Yes" 0 = "No";							
value	antiviral_ynf	1 = "Yes" 2 = "No" 3 = "Unknown";								
value	antiviral_med___1f	1 = "Yes" 0 = "No";								
value	antiviral_med___2f	1 = "Yes" 0 = "No";								
value	antiviral_med___3f	1 = "Yes" 0 = "No";								
value	antiviral_med___4f	1 = "Yes" 0 = "No";								
value	antiviral_med___5f	1 = "Yes" 0 = "No";								
value	antiviral_med___6f	1 = "Yes" 0 = "No";								
value	viralinf_lower_isf	1 = "Yes" 0 = "No" 2 = "Unknown";							
value	fungal_infxnf	1 = "Aspergillosis" 2 = "Blastomycosis" 3 = "Candidiasis" 4 = "Histoplasmosis" 5 = "Mucormycosis" 6 = "Sporotrichosis" 7 = "Cryptococcus" 8 = "Other" 9 = "Unknown";	
value	site_of_fungalinfxn___1f	1 = "Yes" 0 = "No";								
value	site_of_fungalinfxn___2f	1 = "Yes" 0 = "No";								
value	site_of_fungalinfxn___3f	1 = "Yes" 0 = "No";							
value	site_of_fungalinfxn___4f	1 = "Yes" 0 = "No";								
value	site_of_fungalinfxn___5f	1 = "Yes" 0 = "No";								
value	site_of_fungalinfxn___6f	1 = "Yes" 0 = "No";								
value	site_of_fungalinfxn___7f	1 = "Yes" 0 = "No";							
value	antifungal_ynf	1 = "Yes" 2 = "No" 3 = "Unknown";								
value	antifungal_meds___1f	1 = "Yes" 0 = "No";								
value	antifungal_meds___2f	1 = "Yes" 0 = "No";								
value	antifungal_meds___3f	1 = "Yes" 0 = "No";								
value	antifungal_meds___4f	1 = "Yes" 0 = "No";								
value	antifungal_meds___5f	1 = "Yes" 0 = "No";								
value	antifungal_meds___6f	1 = "Yes" 0 = "No";								
value	antifungal_meds___7f	1 = "Yes" 0 = "No";								
value	antifungal_meds___8f	1 = "Yes" 0 = "No";								
value	antifungal_meds___9f	1 = "Yes" 0 = "No";								
value	antifungal_meds___10f	1 = "Yes" 0 = "No";								
value	antifungal_meds___11f	1 = "Yes" 0 = "No";								
value	antifungal_meds___12f	1 = "Yes" 0 = "No";								
value	antifungal_meds___13f	1 = "Yes" 0 = "No";								
value	antifungal_meds___14f	1 = "Yes" 0 = "No";								
value	fungal_infxn_lower_isf	1 = "Yes" 0 = "No" 2 = "Unknown";							
value	bacterial_infxn___1f	1 = "Yes" 0 = "No";								
value	bacterial_infxn___2f	1 = "Yes" 0 = "No";								
value	bacterial_infxn___3f	1 = "Yes" 0 = "No";								
value	bacterial_infxn___4f	1 = "Yes" 0 = "No";							
value	bacterial_infxn___5f	1 = "Yes" 0 = "No";								
value	bacterial_infxn___6f	1 = "Yes" 0 = "No";								
value	bacterial_infxn___7f	1 = "Yes" 0 = "No";								
value	bacterial_infxn___8f	1 = "Yes" 0 = "No";								
value	bacterial_infxn___9f	1 = "Yes" 0 = "No";								
value	bacterial_infxn___10f	1 = "Yes" 0 = "No";								
value	bacterial_infxn___11f	1 = "Yes" 0 = "No";							
value	bacterial_infxn___12f	1 = "Yes" 0 = "No";								
value	bacterial_infxn___13f	1 = "Yes" 0 = "No";								
value	bacterial_infxn___14f	1 = "Yes" 0 = "No";								
value	site_of_bac_infxn___1f	1 = "Yes" 0 = "No";								
value	site_of_bac_infxn___2f	1 = "Yes" 0 = "No";								
value	site_of_bac_infxn___3f	1 = "Yes" 0 = "No";								
value	site_of_bac_infxn___4f	1 = "Yes" 0 = "No";								
value	site_of_bac_infxn___5f	1 = "Yes" 0 = "No";								
value	site_of_bac_infxn___6f	1 = "Yes" 0 = "No";								
value	site_of_bac_infxn___7f	1 = "Yes" 0 = "No";							
value	antibiotics_ynf	1 = "Yes" 2 = "No" 3 = "Unknown";								
value	allantibio___1f	1 = "Yes" 0 = "No";								
value	allantibio___2f	1 = "Yes" 0 = "No";								
value	allantibio___3f	1 = "Yes" 0 = "No";								
value	allantibio___4f	1 = "Yes" 0 = "No";								
value	allantibio___5f	1 = "Yes" 0 = "No";								
value	allantibio___6f	1 = "Yes" 0 = "No";								
value	allantibio___7f	1 = "Yes" 0 = "No";							
value	allantibio___8f	1 = "Yes" 0 = "No";								
value	allantibio___9f	1 = "Yes" 0 = "No";								
value	allantibio___10f	1 = "Yes" 0 = "No";								
value	allantibio___11f	1 = "Yes" 0 = "No";								
value	allantibio___12f	1 = "Yes" 0 = "No";							
value	bacterial_infxn_lower_isf	1 = "Yes" 0 = "No" 2 = "Unknown";						
value	otherinf_protainf_site___1f	1 = "Yes" 0 = "No";								
value	otherinf_protainf_site___2f	1 = "Yes" 0 = "No";								
value	otherinf_protainf_site___3f	1 = "Yes" 0 = "No";								
value	otherinf_protainf_site___4f	1 = "Yes" 0 = "No";								
value	otherinf_protainf_site___5f	1 = "Yes" 0 = "No";								
value	otherinf_protainf_site___6f	1 = "Yes" 0 = "No";								
value	otherinf_protainf_site___7f	1 = "Yes" 0 = "No";								
value	other_infxn_lower_is___1f	1 = "Yes" 0 = "No";								
value	other_infxn_lower_is___0f	1 = "Yes" 0 = "No";								
value	other_infxn_lower_is___2f	1 = "Yes" 0 = "No";
run;

data i1;
set i1;
format	infxn	infxnf.;
format	type_infxn	type_infxnf.;
format	viral_infxn	viral_infxnf.;
format	site_of_viralinfxn___1	site_of_viralinfxn___1f.;
format	site_of_viralinfxn___2	site_of_viralinfxn___2f.;
format	site_of_viralinfxn___3	site_of_viralinfxn___3f.;
format	site_of_viralinfxn___4	site_of_viralinfxn___4f.;
format	site_of_viralinfxn___5	site_of_viralinfxn___5f.;
format	site_of_viralinfxn___6	site_of_viralinfxn___6f.;
format	site_of_viralinfxn___7	site_of_viralinfxn___7f.;
format	antiviral_yn	antiviral_ynf.;
format	antiviral_med___1	antiviral_med___1f.;
format	antiviral_med___2	antiviral_med___2f.;
format	antiviral_med___3	antiviral_med___3f.;
format	antiviral_med___4	antiviral_med___4f.;
format	antiviral_med___5	antiviral_med___5f.;
format	antiviral_med___6	antiviral_med___6f.;
format	viralinf_lower_is	viralinf_lower_isf.;
format	fungal_infxn	fungal_infxnf.;
format	site_of_fungalinfxn___1	site_of_fungalinfxn___1f.;
format	site_of_fungalinfxn___2	site_of_fungalinfxn___2f.;
format	site_of_fungalinfxn___3	site_of_fungalinfxn___3f.;
format	site_of_fungalinfxn___4	site_of_fungalinfxn___4f.;
format	site_of_fungalinfxn___5	site_of_fungalinfxn___5f.;
format	site_of_fungalinfxn___6	site_of_fungalinfxn___6f.;
format	site_of_fungalinfxn___7	site_of_fungalinfxn___7f.;
format	antifungal_yn	antifungal_ynf.;
format	antifungal_meds___1	antifungal_meds___1f.;
format	antifungal_meds___2	antifungal_meds___2f.;
format	antifungal_meds___3	antifungal_meds___3f.;
format	antifungal_meds___4	antifungal_meds___4f.;
format	antifungal_meds___5	antifungal_meds___5f.;
format	antifungal_meds___6	antifungal_meds___6f.;
format	antifungal_meds___7	antifungal_meds___7f.;
format	antifungal_meds___8	antifungal_meds___8f.;
format	antifungal_meds___9	antifungal_meds___9f.;
format	antifungal_meds___10	antifungal_meds___10f.;
format	antifungal_meds___11	antifungal_meds___11f.;
format	antifungal_meds___12	antifungal_meds___12f.;
format	antifungal_meds___13	antifungal_meds___13f.;
format	antifungal_meds___14	antifungal_meds___14f.;
format	fungal_infxn_lower_is	fungal_infxn_lower_isf.;
format	bacterial_infxn___1	bacterial_infxn___1f.;
format	bacterial_infxn___2	bacterial_infxn___2f.;
format	bacterial_infxn___3	bacterial_infxn___3f.;
format	bacterial_infxn___4	bacterial_infxn___4f.;
format	bacterial_infxn___5	bacterial_infxn___5f.;
format	bacterial_infxn___6	bacterial_infxn___6f.;
format	bacterial_infxn___7	bacterial_infxn___7f.;
format	bacterial_infxn___8	bacterial_infxn___8f.;
format	bacterial_infxn___9	bacterial_infxn___9f.;
format	bacterial_infxn___10	bacterial_infxn___10f.;
format	bacterial_infxn___11	bacterial_infxn___11f.;
format	bacterial_infxn___12	bacterial_infxn___12f.;
format	bacterial_infxn___13	bacterial_infxn___13f.;
format	bacterial_infxn___14	bacterial_infxn___14f.;
format	site_of_bac_infxn___1	site_of_bac_infxn___1f.;
format	site_of_bac_infxn___2	site_of_bac_infxn___2f.;
format	site_of_bac_infxn___3	site_of_bac_infxn___3f.;
format	site_of_bac_infxn___4	site_of_bac_infxn___4f.;
format	site_of_bac_infxn___5	site_of_bac_infxn___5f.;
format	site_of_bac_infxn___6	site_of_bac_infxn___6f.;
format	site_of_bac_infxn___7	site_of_bac_infxn___7f.;
format	antibiotics_yn	antibiotics_ynf.;
format	allantibio___1	allantibio___1f.;
format	allantibio___2	allantibio___2f.;
format	allantibio___3	allantibio___3f.;
format	allantibio___4	allantibio___4f.;
format	allantibio___5	allantibio___5f.;
format	allantibio___6	allantibio___6f.;
format	allantibio___7	allantibio___7f.;
format	allantibio___8	allantibio___8f.;
format	allantibio___9	allantibio___9f.;
format	allantibio___10	allantibio___10f.;
format	allantibio___11	allantibio___11f.;
format	allantibio___12	allantibio___12f.;
format	bacterial_infxn_lower_is	bacterial_infxn_lower_isf.;
format	otherinf_protainf_site___1	otherinf_protainf_site___1f.;
format	otherinf_protainf_site___2	otherinf_protainf_site___2f.;
format	otherinf_protainf_site___3	otherinf_protainf_site___3f.;
format	otherinf_protainf_site___4	otherinf_protainf_site___4f.;
format	otherinf_protainf_site___5	otherinf_protainf_site___5f.;
format	otherinf_protainf_site___6	otherinf_protainf_site___6f.;
format	otherinf_protainf_site___7	otherinf_protainf_site___7f.;
format	other_infxn_lower_is___1	other_infxn_lower_is___1f.;
format	other_infxn_lower_is___0	other_infxn_lower_is___0f.;
format	other_infxn_lower_is___2	other_infxn_lower_is___2f.;
run;


*Running a report for i1 using the macro now;

proc contents data=i1 order=varnum;
run;

data i1;
set i1;
cmv_load_num = input(cmv_load, 8.);
bkv_load_num = input(bkv_load, 8.);
run;

data mylib.i1clean;
set i1;
run;

*i2;

data i2;
set mylib.i2;
run;

proc contents data = i2 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data i2;
set i2;
label 		
sae_event = "Is there a serious adverse event to report in this 6-month look back period related to study procedures/visit? Record any SAEs to Month 6.	"
infectn_phlebotom_site = "Infection at the phlebotomy site	"
exanguination_phelb_site = "Exsanguination at the phelbotomy site	"
fainitng_during_phelbotomy = "Fainting during phlebotomy resulting in further injury	"
sae_dt = "SAE start date	"
sae_stop_dt = "SAE stop date	"
sae_outcome = "SAE Outcome	"
squelae_description = "If resolved with squelae describe the squelae	"
ctcae_grade = "CTCAE grade of SAE	"
blood_draw = "Relationship to Study Procedure (Blood Draw) : 	"
action_procedure = "Action taken after SAE	"
seriousness_sae___1 = "Seriousness Criteria: 1, Required hospitalization 	"
seriousness_sae___2 = "Seriousness Criteria:  2, Prolongation of existing hospitalization 	"
seriousness_sae___3 = "Seriousness Criteria:  3, none of the above	"
sae_status = "What was the outcome of the SAE?	"
treatment_sae = "Treatment/Procedures for SAE	"
medical_history_sae = "Relevant medical history (include only relevant past or concurrent medical disorders, surgeries etc, that may help explain the SAE)	"
lab_test_sae = "Relevant diagnostic/Laboratory tests	"
contributing_factor_sae = "Possible contributing factors to SAE other than blood draw or underlying disease being studied"
comments_sae = "Narrative/comments (provide a textual description of the SAE including chronological clinical presentation and evolution of the SAE and associated signs/symptoms):	"
pi_sign	= " PI signature with date:	"
data_entered_byi2 = "Data entered by:	"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value sae_eventf 1 = "Yes" 0 = "No";				
value infectn_phlebotom_sitef 1 = "Yes" 0 = "No";				
value exanguination_phelb_sitef 1 = "Yes" 0 = "No";				
value fainitng_during_phelbotomyf 1 = "Yes" 0 = "No";				
value sae_outcomef 1 = "Resolved without a sequelae" 2 = "Resolved with a sequelae" 3 = "Ongoing" 4 = "Death";		
value ctcae_gradef 1 = "Grade 1 (Mild)" 2 = "Grade 2 (Moderate)" 3 = "Grade 3 (Severe and undesirable)" 4 = "Grade 4 (Life-threatening or disabling)" 5 = "Grade 5 (Death)" 6 = "None";
value blood_drawf 1 = "Unrelated" 2 = "Unlikely" 3 = "Possible" 4 = "Probable" 5 = "Definite";	
value action_proceduref 1 = "None" 2 = "Observation only" 3 = "Drug or fluid therapy treatment";			
value seriousness_sae___1f 1 = "Yes" 0 = "No";			
value seriousness_sae___2f 1 = "Yes" 0 = "No";				
value seriousness_sae___3f	1 = "Yes" 0 = "No";				
value sae_statusf 1 = "Life-threatening" 2 = "Persistent or significant disability" 3 = "An event required intervention to prevent permanent impairment or damage"  4 = "Death" 5 = "None of the above";	
value contributing_factor_saef 1 = "None apparent" 2 = "Concurrent illness, disease or other external factors" 3 = "Concurrent medication " 4 = "Accident, trauma or other external factors";
run;

data i2;
set i2;
format	sae_event	sae_eventf.;
format	infectn_phlebotom_site	infectn_phlebotom_sitef.;
format	exanguination_phelb_site	exanguination_phelb_sitef.;
format	fainitng_during_phelbotomy	fainitng_during_phelbotomyf.;
format	sae_outcome	sae_outcomef.;
format	ctcae_grade	ctcae_gradef.;
format	blood_draw	blood_drawf.;
format	action_procedure	action_proceduref.;
format	seriousness_sae___1	seriousness_sae___1f.;
format	seriousness_sae___2	seriousness_sae___2f.;
format	seriousness_sae___3	seriousness_sae___3f.;
format	sae_status	sae_statusf.;
format	contributing_factor_sae	contributing_factor_saef.;
run;

*Running a report for i2 using the macro now;

proc contents data=i2 order=varnum;
run;

data mylib.i2clean;
set i2;
run;

*i3;

data i3;
set mylib.i3;
run;

proc contents data = i3 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data i3;
set i3;
label 
biopsy = "Were there any clinically-indicated biopsies performed during this visit period?	"
biopsy_dt_bx = "Date of biopsy	"
reason_biopsy_bx___1 = "Primary reason for biopsy (1, Failure of serum creatinine to decline following transplant)	"
reason_biopsy_bx___2 = "Primary reason for biopsy ( 2, Increase in serum creatinine)	"
reason_biopsy_bx___3 = "Primary reason for biopsy (3, Proteinuria)	"
reason_biopsy_bx___4 = "Primary reason for biopsy ( 4, Protocol biopsy)	"
reason_biopsy_bx___5 = "Primary reason for biopsy ( 5, Possible/known BKV infection)	"
reason_biopsy_bx___6 = "Primary reason for biopsy ( 6, Evaluation after treatment for infection)	"
reason_biopsy_bx___7 = "Primary reason for biopsy (7, De novo DSA)	"
reason_biopsy_bx___8 = "Primary reason for biopsy ( 8, Historical DSA)	"
reason_biopsy_bx___9 = "Primary reason for biopsy ( 9, Delayed graft function)	"
reason_biopsy_bx___10 = "Primary reason for biopsy ( 10, Intraoperative complications)	"
reason_biopsy_bx___11 = "Primary reason for biopsy ( 11, Rule out pancreas rejection)	"
reason_biopsy_bx___12 = "Primary reason for biopsy ( 12, Decreased urine output)	"
reason_biopsy_bx___13 = "Primary reason for biopsy ( 13, Obstruction of urinary tract)	"
reason_biopsy_bx___14 = "Primary reason for biopsy ( 14, Suspected/known/Non-compliance)	"
reason_biopsy_bx___15 = "Primary reason for biopsy (15, Other)	"
other_reason_biopsy_bx = "If other, specify	"
info_glom_bx = "Was information on number of glomeruli obtained?	"
info_sc_glom_bx = "Was information on number of sclerotic glomeruli obtained?	"
info_of_art_bx = "Was information on number of arteries obtained?	"
glom_bx = "If yes, record the number of glomeruli present	"
scl_glom_bx = "If yes, record the number of sclerotic  glomeruli present	"
arteries_bx = "If yes, record the number of arteries present	"
specimen_bx = "Does the pathology report describe the specimen as inadequate?	"
pri_diagnosis_bx___1 = "Primary Diagnosis on biopsy report, 1, Acute Rejection - Cellular 	"
pri_diagnosis_bx___2 = "Primary Diagnosis on biopsy report, 2, Borderline changes -Cellular 	"
pri_diagnosis_bx___3 = "Primary Diagnosis on biopsy report,  3, Acute Rejection - Antibody-Mediated 	"
pri_diagnosis_bx___4 = "Primary Diagnosis on biopsy report,  4, Acute rejection - mixed, cellular and antibody-mediated 	"
pri_diagnosis_bx___5 = "Primary Diagnosis on biopsy report,  5, Chronic rejection  - cellular 	"
pri_diagnosis_bx___6 = "Primary Diagnosis on biopsy report,  6, Chronic rejection - Antibody-mediated 	"
pri_diagnosis_bx___7 = "Primary Diagnosis on biopsy report,  7, Active chronic rejection - cellular 	"
pri_diagnosis_bx___8 = "Primary Diagnosis on biopsy report,  8, Active chronic rejection - antibody-mediated 	"
pri_diagnosis_bx___9 = "Primary Diagnosis on biopsy report,  9, Acute Tubular Necrosis 	"
pri_diagnosis_bx___10 = "Primary Diagnosis on biopsy report,  10, Allograft Nephropathy 	"
pri_diagnosis_bx___11 = "Primary Diagnosis on biopsy report,  11, Calcineurin Inhibitor Toxicity 	"
pri_diagnosis_bx___12 = "Primary Diagnosis on biopsy report,  12, Glomerulonephritis (denovo only) 	"
pri_diagnosis_bx___13 = "Primary Diagnosis on biopsy report,  13, Arterial nephrosclerosis 	"
pri_diagnosis_bx___14 = "Primary Diagnosis on biopsy report,  14, Arterial hyalinosis 	"
pri_diagnosis_bx___15 = "Primary Diagnosis on biopsy report,  15, Polyoma (BK) virus Infection 	"
pri_diagnosis_bx___16 = "Primary Diagnosis on biopsy report,  16, Recurrent Disease 	"
pri_diagnosis_bx___17 = "Primary Diagnosis on biopsy report,  17, No abnormalities 	"
pri_diagnosis_bx___18 = "Primary Diagnosis on biopsy report,  18, Unknown 	"
pri_diagnosis_bx___19 = "Primary Diagnosis on biopsy report,  19, Other diagnosis	"
other_diag_bx = "If other diagnosis, please specify	"
sec_diag_bx = "Was there a secondary diagnosis?	"
biopsy_secondary_dx___1	= "Biopsy Secondary Diagnosis, 1, Acute rejection - Cellular 	"
biopsy_secondary_dx___2	= "Biopsy Secondary Diagnosis,  2, Borderline changes - Cellular 	"
biopsy_secondary_dx___3	= "Biopsy Secondary Diagnosis,  3, Acute rejection - Antibody mediated 	"
biopsy_secondary_dx___4	= "Biopsy Secondary Diagnosis,  4, Acute rejection - Mixed, cellular and antibody mediated 	"
biopsy_secondary_dx___5	= "Biopsy Secondary Diagnosis,  5, Chronic rejection - Cellular 	"
biopsy_secondary_dx___6	= "Biopsy Secondary Diagnosis,  6, Chronic rejection - Antibody mediated 	"
biopsy_secondary_dx___7	= "Biopsy Secondary Diagnosis,  7, Active chronic rejection - Cellular 	"
biopsy_secondary_dx___8	= "Biopsy Secondary Diagnosis,  8, Active chronic rejection - Antibody mediated 	"
biopsy_secondary_dx___9	= "Biopsy Secondary Diagnosis,  9, Acute tubular necrosis 	"
biopsy_secondary_dx___10 = "Biopsy Secondary Diagnosis,  10, Chronic allograft nephropathy 	"
biopsy_secondary_dx___11 = "Biopsy Secondary Diagnosis,  11, Calcinerin inhibitor toxicity 	"
biopsy_secondary_dx___12 = "Biopsy Secondary Diagnosis,  12, Glomuerulonephritis (de novo only) 	"
biopsy_secondary_dx___13 = "Biopsy Secondary Diagnosis,  13, Arterial nephrosclerosis 	"
biopsy_secondary_dx___14 = "Biopsy Secondary Diagnosis,  14, Arterial hyalinosis 	"
biopsy_secondary_dx___15 = "Biopsy Secondary Diagnosis,  15, Polyoma (BK) virus infection 	"
biopsy_secondary_dx___16 = "Biopsy Secondary Diagnosis,  16, Recurrent disease 	"
biopsy_secondary_dx___17 = "Biopsy Secondary Diagnosis,  17, No abnormalities 	"
biopsy_secondary_dx___18 = "Biopsy Secondary Diagnosis,  18, Other 	"
biopsy_secondary_dx___19 = "Biopsy Secondary Diagnosis,  19, Unknown	"
biopsy_secondary_dx_other = "If other secondary diagnosis, please specify.	"
banff_bx = "Was there a banff scoring available for this biopsy?	"
g_score_bx = "<i> g  </i> (Early allograft glomerulitis)	"
i_score_bx = "<i> i  </i> (Interstitial inflammation)	"
t_score_bx = "<i> t  </i> (Tubulitis)	"
v_score_bx = "<i> v  </i> (Arteritis)	"
ptc_score_bx = "<i> ptc  </i> (Peritubular Capillaritis)	"
no_pmnl_bx = "Presence of remarkable numbers of Eosinophils, PMNL or plasma cells	"
infarction_bx = "Infarction and/or interstitial hemorrhage (denoted by an asterisk on any level of v-score)	"
arteritis_damage_bx	= "Number of arteries affected by arteritis	"
cg_score_bx = "<i> cg </i> (transplant glomerulopathy)	"
ci_score_bx = "<i> ci  </i> (interstitial fibrosis)	"
ct_score_bx	= "<i> ct  </i> (tubular atrophy)	"
cv_score_bx = "<i> cv  </i> (vascular sclerosis)	"
mm_score_bx	= "<i> mm  </i> (mesangial matrix increase)	"
ah_score_bx	= "<i> ah  </i> (arteriolar hyaline thickening, arterial hyalinosis)	"
aah_score_bx = "<i> aah  </i> (alternative way of quantifying arteriolar hyaline thickening)	"
arteriolitis_bx	= "Presence of arteriolitis (significance unknown)	"
tatr_score_bx = "Tubulitis in areas of tubular atrophy and/or fibrosis <i>(tatr)</i>	"
iatr_score_bx = "Inflammation in areas of interstitial atrophy and/or fibrosis <i> (iatr) </i>	"
ti_score_bx = "Total inflammation <i> (ti) </i>	"
i_ifta_score_bx = "Inflammation in area of IFTA <i> (i-IFTA) </i>	"
c4d_yn_bx = "Was a C4D staining of peritubular capillaries done?	"
c4d_bx = "C4D staining	"
c4d_method_bx = "Method used for C4D staining	"
elc_microscopy_bx = "Did the biopsy show abnormal basement membrane?	"
peri_cap_bm_bx = "If yes, was there multilayering of peritubular capillary basement memberane?	"
double_gbm_bx = "If yes, was there double contouring of glomerular basement membrane?	"
acute_tcmr_grade_bx = "Acute TCMR - grade	"
chronicactive_grade_bx = "Chronic active TCMR - grade	"
chronic_grade_bx = "Chronic TCMR - grade	"
scr_bx	= "Is there a value available for SCr on or before biopsy (but within 45 days prior) 	"
scr_value_bx = "Report the last available SCr value (mg/dL) obtained within 45 days on or prior to biopsy	"
scr_dt_bx = "Date on which the SCr value was obtained which was closest to biopsy (within 45 days prior)	"
alb_cr_ratio_bx = "Was albumin/Cr ratio obtained?	"
pro_cr_ratio_bx = "Was protein/Cr ratio obtained?	"
alb_cr_ratio_dt_bx = "Date on which albumin/Cr ratio was obtained	"
pro_cr_ratio_dt_bx = "Date on which protein/Cr ratio was obtained	"
type_alb_cr_bx = "Type of measurement for albumin/Cr ratio	"
type_pro_cr_bx = "Type of measurement for protein/Cr ratio	"
albumin_unit_bx = "Albumin measurement-unit 	"
albumin_value_bx = "Albumin measurement-value	"
urinecr_unit_bx	= "Urine creatinine measurement-unit 	"
urinecr_value_bx = "Urine creatinine measurement-value	"
alb_cr_unit_bx	= "Albumin/Cr ratio measurement-unit 	"
alb_cr_unit_value_bx = "Albumin/Cr ratio measurement-value	"
protein_unit_bx	= "Total Protein measurement-unit 	"
pro_value_bx = "Total protein measurement-value	"
uricr_unit_bx = "Urine creatinine measurement-unit 	"
uri_cr_value_bx = "Urine creatinine measurement-value	"
pro_cr_unit_bx = "Protein/Cr ratio measurement-unit 	"
pro_cr_value_bx = "Protein/Cr ratio measurement-value	"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;

value biopsyf 1 = "Yes" 0 = "No";						
value	reason_biopsy_bx___1f	1 = "Yes" 0 = "No";						
value	reason_biopsy_bx___2f	1 = "Yes" 0 = "No";						
value	reason_biopsy_bx___3f	1 = "Yes" 0 = "No";						
value	reason_biopsy_bx___4f	1 = "Yes" 0 = "No";						
value	reason_biopsy_bx___5f	1 = "Yes" 0 = "No";						
value	reason_biopsy_bx___6f	1 = "Yes" 0 = "No";						
value	reason_biopsy_bx___7f	1 = "Yes" 0 = "No";						
value	reason_biopsy_bx___8f	1 = "Yes" 0 = "No";					
value	reason_biopsy_bx___9f	1 = "Yes" 0 = "No";						
value	reason_biopsy_bx___10f	1 = "Yes" 0 = "No";						
value	reason_biopsy_bx___11f	1 = "Yes" 0 = "No";						
value	reason_biopsy_bx___12f	1 = "Yes" 0 = "No";						
value	reason_biopsy_bx___13f	1 = "Yes" 0 = "No";						
value	reason_biopsy_bx___14f	1 = "Yes" 0 = "No";						
value	reason_biopsy_bx___15f	1 = "Yes" 0 = "No";						
value	info_glom_bxf	1 = "Yes" 0 = "No";						
value	info_sc_glom_bxf	1 = "Yes" 0 = "No";						
value	info_of_art_bxf	1 = "Yes" 0 = "No";						
value	specimen_bxf	1 = "Yes" 0 = "No";						
value	pri_diagnosis_bx___1f	1 = "Yes" 0 = "No";						
value	pri_diagnosis_bx___2f	1 = "Yes" 0 = "No";						
value	pri_diagnosis_bx___3f	1 = "Yes" 0 = "No";						
value	pri_diagnosis_bx___4f	1 = "Yes" 0 = "No";						
value	pri_diagnosis_bx___5f	1 = "Yes" 0 = "No";						
value	pri_diagnosis_bx___6f	1 = "Yes" 0 = "No";						
value	pri_diagnosis_bx___7f	1 = "Yes" 0 = "No";						
value	pri_diagnosis_bx___8f	1 = "Yes" 0 = "No";						
value	pri_diagnosis_bx___9f	1 = "Yes" 0 = "No";						
value	pri_diagnosis_bx___10f	1 = "Yes" 0 = "No";						
value	pri_diagnosis_bx___11f	1 = "Yes" 0 = "No";						
value	pri_diagnosis_bx___12f	1 = "Yes" 0 = "No";						
value	pri_diagnosis_bx___13f	1 = "Yes" 0 = "No";						
value	pri_diagnosis_bx___14f	1 = "Yes" 0 = "No";						
value	pri_diagnosis_bx___15f	1 = "Yes" 0 = "No";						
value	pri_diagnosis_bx___16f	1 = "Yes" 0 = "No";					
value	pri_diagnosis_bx___17f	1 = "Yes" 0 = "No";						
value	pri_diagnosis_bx___18f	1 = "Yes" 0 = "No";						
value	pri_diagnosis_bx___19f	1 = "Yes" 0 = "No";						
value	biopsy_secondary_dx___1f	1 = "Yes" 0 = "No";						
value	biopsy_secondary_dx___2f 1 = "Yes" 0 = "No";						
value	biopsy_secondary_dx___3f	1 = "Yes" 0 = "No";						
value	biopsy_secondary_dx___4f	1 = "Yes" 0 = "No";						
value	biopsy_secondary_dx___5f	1 = "Yes" 0 = "No";						
value	biopsy_secondary_dx___6f	1 = "Yes" 0 = "No";						
value	biopsy_secondary_dx___7f	1 = "Yes" 0 = "No";						
value	biopsy_secondary_dx___8f	1 = "Yes" 0 = "No";						
value	biopsy_secondary_dx___9f	1 = "Yes" 0 = "No";						
value	biopsy_secondary_dx___10f 1 = "Yes" 0 = "No";						
value	biopsy_secondary_dx___11f 1 = "Yes" 0 = "No";						
value	biopsy_secondary_dx___12f 1 = "Yes" 0 = "No";						
value	biopsy_secondary_dx___13f 1 = "Yes" 0 = "No";						
value	biopsy_secondary_dx___14f 1 = "Yes" 0 = "No";						
value	biopsy_secondary_dx___15f 1 = "Yes" 0 = "No";						
value	biopsy_secondary_dx___16f 1 = "Yes" 0 = "No";						
value	biopsy_secondary_dx___17f 1 = "Yes" 0 = "No";						
value	biopsy_secondary_dx___18f 1 = "Yes" 0 = "No";						
value	biopsy_secondary_dx___19f 1 = "Yes" 0 = "No";					
value	banff_bxf 1 = "Yes" 0 = "No";						
value	g_score_bxf	0 = "0" 1 = "1" 2 = "2" 3 = "3" 4 = "Not Done";			
value	i_score_bxf	0 = "0" 1 = "1" 2 = "2" 3 = "3" 4 = "Not Done";			
value	t_score_bxf	0 = "0" 1 = "1" 2 = "2" 3 = "3" 4 = "Not Done";			
value	v_score_bxf	0 = "0" 1 = "1" 2 = "2" 3 = "3" 4 = "Not Done";	;			
value	ptc_score_bxf	0 = "0" 1 = "1" 2 = "2" 3 = "3" 4 = "Not Done";			
value	no_pmnl_bxf	1 = "Present" 2 = "Not Present" 3 = "Not Done";					
value	infarction_bxf	1 = "Present" 2 = "Not Present" 3 = "Not Done";						
value	cg_score_bxf	4 = "0" 1 = "1" 2 = "2" 3 = "3" 5 = "Not Done";			
value	ci_score_bxf	4 = "0" 1 = "1" 2 = "2" 3 = "3" 5 = "Not Done";			
value	ct_score_bxf	4 = "0" 1 = "1" 2 = "2" 3 = "3" 5 = "Not Done";			
value	cv_score_bxf	4 = "0" 1 = "1" 2 = "2" 3 = "3" 5 = "Not Done";			
value	mm_score_bxf	4 = "0" 1 = "1" 2 = "2" 3 = "3" 5 = "Not Done";			
value	ah_score_bxf	4 = "0" 1 = "1" 2 = "2" 3 = "3" 5 = "Not Done";			
value	aah_score_bxf	4 = "0" 1 = "1" 2 = "2" 3 = "3" 5 = "Not Done";		
value	arteriolitis_bxf	5 = "Present" 6 = "Not Present" 7 = "Not Done";					
value	tatr_score_bxf	0 = "0" 1 = "1" 2 = "2" 3 = "3" 4 = "Not Done";			
value	iatr_score_bxf	0 = "0" 1 = "1" 2 = "2" 3 = "3" 4 = "Not Done";				
value	ti_score_bxf	0 = "0" 1 = "1" 2 = "2" 3 = "3" 4 = "Not Done";				
value	i_ifta_score_bxf 0 = "0" 1 = "1" 2 = "2" 3 = "3" 4 = "Not Done";				
value	c4d_yn_bxf	1 = "Yes" 2 = "No" 3 = "Unknown";					
value	c4d_bxf	1 = "Focal positive (11-50%)" 2 = "Diffuse positive (>50%)" 3 = "Minimal focal positive (1-10%)" 4 = "Negative" 5 = "Missing";			
value	c4d_method_bxf	1 = "Immunofluorescence" 2 = "Immunoperoxidase" 3 = "Unknown";					
value	elc_microscopy_bxf	1 = "Yes" 2 = "No" 3 = "Not Done";					
value	peri_cap_bm_bxf	1 = "Yes" 2 = "No";						
value	double_gbm_bxf	1 = "Yes" 2 = "No";						
value	acute_tcmr_grade_bxf	1 = "None" 2 = "Borderline" 3 = "IA" 4 = "IB" 5 = "IIA" 6 = "IIB" 7 = "III" 8 = "Not Done";
value	chronicactive_grade_bxf	1 = "None" 2 = "IA" 3 = "IB" 4 = "II" 5 = "Not Done";			
value	chronic_grade_bxf 1 = "None" 2 = "IA" 3 = "IB" 4 = "II" 5 = "Not Done";			
value	scr_bxf	1 = "Yes" 0 = "No";						
value	alb_cr_ratio_bxf	1 = "Yes" 2 = "No";						
value	pro_cr_ratio_bxf	1 = "Yes" 2 = "No";						
value	type_alb_cr_bxf	1 = "Spot urine" 2 = "24-hour urine";						
value	type_pro_cr_bxf	1 = "Spot urine" 2 = "24-hour urine";						
value	albumin_unit_bxf	1 = "mg/dL" 2 = "g/dL" 3 = "mg" 4 = "Not available";				
value	urinecr_unit_bxf	1 = "mg/dL" 2 = "g/dL" 3 = "mmol" 4 = "Not available";				
value	alb_cr_unit_bxf	1 = "mg/g" 2 = "g/g" 3 = "mg/mmol" 4 = "Not available";				
value	protein_unit_bxf	1 = "mg/dL" 2 = "g/dL" 3 = "grams" 4 = "Not available";				
value	uricr_unit_bxf	1 = "mg/dL" 2 = "g/dL" 3 = "mmol" 4 = "Not available";				
value	pro_cr_unit_bxf	1 = "mg/g" 2 = "g/g" 3 = "mg/mmol" 4 = "g/mmol" 5 = "Not available";			
run;

data i3;
set i3;
format	biopsy	biopsyf.;
format	reason_biopsy_bx___1	reason_biopsy_bx___1f.;
format	reason_biopsy_bx___2	reason_biopsy_bx___2f.;
format	reason_biopsy_bx___3	reason_biopsy_bx___3f.;
format	reason_biopsy_bx___4	reason_biopsy_bx___4f.;
format	reason_biopsy_bx___5	reason_biopsy_bx___5f.;
format	reason_biopsy_bx___6	reason_biopsy_bx___6f.;
format	reason_biopsy_bx___7	reason_biopsy_bx___7f.;
format	reason_biopsy_bx___8	reason_biopsy_bx___8f.;
format	reason_biopsy_bx___9	reason_biopsy_bx___9f.;
format	reason_biopsy_bx___10	reason_biopsy_bx___10f.;
format	reason_biopsy_bx___11	reason_biopsy_bx___11f.;
format	reason_biopsy_bx___12	reason_biopsy_bx___12f.;
format	reason_biopsy_bx___13	reason_biopsy_bx___13f.;
format	reason_biopsy_bx___14	reason_biopsy_bx___14f.;
format	reason_biopsy_bx___15	reason_biopsy_bx___15f.;
format	info_glom_bx	info_glom_bxf.;
format	info_sc_glom_bx	info_sc_glom_bxf.;
format	info_of_art_bx	info_of_art_bxf.;
format	specimen_bx	specimen_bxf.;
format	pri_diagnosis_bx___1	pri_diagnosis_bx___1f.;
format	pri_diagnosis_bx___2	pri_diagnosis_bx___2f.;
format	pri_diagnosis_bx___3	pri_diagnosis_bx___3f.;
format	pri_diagnosis_bx___4	pri_diagnosis_bx___4f.;
format	pri_diagnosis_bx___5	pri_diagnosis_bx___5f.;
format	pri_diagnosis_bx___6	pri_diagnosis_bx___6f.;
format	pri_diagnosis_bx___7	pri_diagnosis_bx___7f.;
format	pri_diagnosis_bx___8	pri_diagnosis_bx___8f.;
format	pri_diagnosis_bx___9	pri_diagnosis_bx___9f.;
format	pri_diagnosis_bx___10	pri_diagnosis_bx___10f.;
format	pri_diagnosis_bx___11	pri_diagnosis_bx___11f.;
format	pri_diagnosis_bx___12	pri_diagnosis_bx___12f.;
format	pri_diagnosis_bx___13	pri_diagnosis_bx___13f.;
format	pri_diagnosis_bx___14	pri_diagnosis_bx___14f.;
format	pri_diagnosis_bx___15	pri_diagnosis_bx___15f.;
format	pri_diagnosis_bx___16	pri_diagnosis_bx___16f.;
format	pri_diagnosis_bx___17	pri_diagnosis_bx___17f.;
format	pri_diagnosis_bx___18	pri_diagnosis_bx___18f.;
format	pri_diagnosis_bx___19	pri_diagnosis_bx___19f.;
format	biopsy_secondary_dx___1	biopsy_secondary_dx___1f.;
format	biopsy_secondary_dx___2	biopsy_secondary_dx___2f.;
format	biopsy_secondary_dx___3	biopsy_secondary_dx___3f.;
format	biopsy_secondary_dx___4	biopsy_secondary_dx___4f.;
format	biopsy_secondary_dx___5	biopsy_secondary_dx___5f.;
format	biopsy_secondary_dx___6	biopsy_secondary_dx___6f.;
format	biopsy_secondary_dx___7	biopsy_secondary_dx___7f.;
format	biopsy_secondary_dx___8	biopsy_secondary_dx___8f.;
format	biopsy_secondary_dx___9	biopsy_secondary_dx___9f.;
format	biopsy_secondary_dx___10	biopsy_secondary_dx___10f.;
format	biopsy_secondary_dx___11	biopsy_secondary_dx___11f.;
format	biopsy_secondary_dx___12	biopsy_secondary_dx___12f.;
format	biopsy_secondary_dx___13	biopsy_secondary_dx___13f.;
format	biopsy_secondary_dx___14	biopsy_secondary_dx___14f.;
format	biopsy_secondary_dx___15	biopsy_secondary_dx___15f.;
format	biopsy_secondary_dx___16	biopsy_secondary_dx___16f.;
format	biopsy_secondary_dx___17	biopsy_secondary_dx___17f.;
format	biopsy_secondary_dx___18	biopsy_secondary_dx___18f.;
format	biopsy_secondary_dx___19	biopsy_secondary_dx___19f.;
format	banff_bx	banff_bxf.;
format	g_score_bx	g_score_bxf.;
format	i_score_bx	i_score_bxf.;
format	t_score_bx	t_score_bxf.;
format	v_score_bx	v_score_bxf.;
format	ptc_score_bx	ptc_score_bxf.;
format	no_pmnl_bx	no_pmnl_bxf.;
format	infarction_bx	infarction_bxf.;
format	cg_score_bx	cg_score_bxf.;
format	ci_score_bx	ci_score_bxf.;
format	ct_score_bx	ct_score_bxf.;
format	cv_score_bx	cv_score_bxf.;
format	mm_score_bx	mm_score_bxf.;
format	ah_score_bx	ah_score_bxf.;
format	aah_score_bx	aah_score_bxf.;
format	arteriolitis_bx	arteriolitis_bxf.;
format	tatr_score_bx	tatr_score_bxf.;
format	iatr_score_bx	iatr_score_bxf.;
format	ti_score_bx	ti_score_bxf.;
format	i_ifta_score_bx	i_ifta_score_bxf.;
format	c4d_yn_bx	c4d_yn_bxf.;
format	c4d_bx	c4d_bxf.;
format	c4d_method_bx	c4d_method_bxf.;
format	elc_microscopy_bx	elc_microscopy_bxf.;
format	peri_cap_bm_bx	peri_cap_bm_bxf.;
format	double_gbm_bx	double_gbm_bxf.;
format	acute_tcmr_grade_bx	acute_tcmr_grade_bxf.;
format	chronicactive_grade_bx	chronicactive_grade_bxf.;
format	chronic_grade_bx	chronic_grade_bxf.;
format	scr_bx	scr_bxf.;
format	alb_cr_ratio_bx	alb_cr_ratio_bxf.;
format	pro_cr_ratio_bx	pro_cr_ratio_bxf.;
format	type_alb_cr_bx	type_alb_cr_bxf.;
format	type_pro_cr_bx	type_pro_cr_bxf.;
format	albumin_unit_bx	albumin_unit_bxf.;
format	urinecr_unit_bx	urinecr_unit_bxf.;
format	alb_cr_unit_bx	alb_cr_unit_bxf.;
format	protein_unit_bx	protein_unit_bxf.;
format	uricr_unit_bx	uricr_unit_bxf.;
format	pro_cr_unit_bx	pro_cr_unit_bxf.;
run;

*Running a report for i3 using the macro now;

proc contents data=i3 order=varnum;
run;

data mylib.i3clean;
set i3;
run;

*i4;

data i4;
set mylib.i4;
run;

proc contents data = i4 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data i4;
set i4;
label 		
rejxn = "Did any rejection events occur during this visit period?	"
rejxn_date = "Date of rejection diagnosis	"
biopsy_ar = "Was the diagnosis of rejection biopsy proven? 	"
dt_bx_ar = "If yes please specify the date of biopsy 	"
dt_bx_diag_dt = "If yes is the date the same as the diagnosis date? 	"
type_rjxn = "Indicate the type of acute rejection diagnosed	"
rejxn_treatment_dt = "Date of initiation of treatment for this rejection event	"
treatment_ar___1 = "Which of the following treatments were given for the rejection event? 1, Steroids only 	"
treatment_ar___2 = "Which of the following treatments were given for the rejection event?  2, Antibodies only 	"
treatment_ar___3 = "Which of the following treatments were given for the rejection event?  3, Steroids followed by antibodies 	"
treatment_ar___4 = "Which of the following treatments were given for the rejection event?  4, Antibodies and steroids together 	"
treatment_ar___5 = "Which of the following treatments were given for the rejection event?  5, Other 	"
treatment_ar___6 = "Which of the following treatments were given for the rejection event?  6, None	"
treatment_ar_other = "If other treatment was given for the rejection event, please specify.	"
presc_ar___1 = "Were any of the  following performed/prescribed as a result of rejection event? 1, Plasmapheresis 	"
presc_ar___2 = "Were any of the  following performed/prescribed as a result of rejection event?  2, IVIG 	"
presc_ar___3 = "Were any of the  following performed/prescribed as a result of rejection event?  3, Rituximab 	"
presc_ar___4 = "Were any of the  following performed/prescribed as a result of rejection event?  4, Bortezomib 	"
presc_ar___5 = "Were any of the  following performed/prescribed as a result of rejection event?  5, Eculizumab-anti-C5 antibody 	"
presc_ar___6 = "Were any of the  following performed/prescribed as a result of rejection event?  6, Other 	"
presc_ar___7 = "Were any of the  following performed/prescribed as a result of rejection event?  7, None	"
other_treatment_ar = "If other is selected for prescription for AR, please specify	"
ar_cr1_event1 = "Scr #1: Last available SCr (mg/dL) value obtained within 45 days prior to SCr #2 value (this value should be the closest date to SCr #2 date).	"
ar_cr1_dt_event1 = "Scr #1 Date	"
ar_cr2_event1 = "Scr #2: Value (mg/dL) that triggered the biopsy.	"
ar_cr2_dt_event1 = "Scr #2 Date	"
ar_cr3_event1 = "Scr #3:  Closest to (on or prior to) the treatment initiation (within 45 days)	"
ar_cr3_dt_event1 = "Scr #3 Date	"
ar_cr4_event1 = "Scr #4: Value (mg/dL) >= 6 weeks (but < 12 weeks) after treatment initiation	"
ar_cr4_dt_event1 = "Scr #4 Date	"
ar_cr5_event1 = "Scr #5: Value (mg/dL) >= 7 days after the above date (but < 12 weeks after treatment initiation)	"
ar_cr5_dt_event1 = "Scr #5 Date	"
ar_cr6_event1 = "Scr #6: Value (mg/dL) >= 7 days after the above date (but < 12 weeks after treatment initiation)	"
ar_cr6_dt_event1 = "Scr #6 Date	"
data_entered_byi4 = "Data entered by:	"
i4_acute_rejection_events_comple = "<center> If more than one rejection event was identified in this 6-month period, click <i> <u> 'Save & Add New Instance' </i> </u>at the bottom of the form. Another form in the same format will appear as a new instance. Fill each event information as new instance and save them.  </center>	"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value	rejxnf	1 = "Yes" 0 = "No";	
value	biopsy_arf	1 = "Yes" 0 = "No";	
value	type_rjxnf	1 = "Cellular Rejection" 2 = "Antibody-mediated Rejection" 3 = "Both present" 4 = "Unknown";
value	treatment_ar___1f	1 = "Yes" 0 = "No";	
value	treatment_ar___2f	1 = "Yes" 0 = "No";	
value	treatment_ar___3f	1 = "Yes" 0 = "No";	
value	treatment_ar___4f	1 = "Yes" 0 = "No";	
value	treatment_ar___5f	1 = "Yes" 0 = "No";	
value	treatment_ar___6f	1 = "Yes" 0 = "No";	
value	presc_ar___1f	1 = "Yes" 0 = "No";	
value	presc_ar___2f	1 = "Yes" 0 = "No";	
value	presc_ar___3f	1 = "Yes" 0 = "No";	
value	presc_ar___4f	1 = "Yes" 0 = "No";	
value	presc_ar___5f	1 = "Yes" 0 = "No";	
value	presc_ar___6f	1 = "Yes" 0 = "No";	
value	presc_ar___7f	1 = "Yes" 0 = "No";	
value	other_treatment_arf	1 = "Yes" 0 = "No";	
run;

data i4;
set i4;
format	rejxn	rejxnf.;
format	biopsy_ar	biopsy_arf.;
format	type_rjxn	type_rjxnf.;
format	treatment_ar___1	treatment_ar___1f.;
format	treatment_ar___2	treatment_ar___2f.;
format	treatment_ar___3	treatment_ar___3f.;
format	treatment_ar___4	treatment_ar___4f.;
format	treatment_ar___5	treatment_ar___5f.;
format	treatment_ar___6	treatment_ar___6f.;
format	presc_ar___1	presc_ar___1f.;
format	presc_ar___2	presc_ar___2f.;
format	presc_ar___3	presc_ar___3f.;
format	presc_ar___4	presc_ar___4f.;
format	presc_ar___5	presc_ar___5f.;
format	presc_ar___6	presc_ar___6f.;
format	presc_ar___7	presc_ar___7f.;
format	other_treatment_ar	other_treatment_arf.;
run;

*Running a report for i4 using the macro now;

proc contents data=i4 order=varnum;
run;

data mylib.i4clean;
set i4;
run;

*i5;

data i5;
set mylib.i5;
run;

proc contents data = i5 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data i5;
set i5;
label 		
graftfailure = "Did a graft failure event occur during this 6-month look back period?	"
graftfail_date = "Date of Graft failure	"
graftfail_death = "Did the participant die within 14 days following the graft failure? 	"
site_aware_gf_dt = "Site awareness date (the date the site found out about this event) :	"
primary_cause_gf = "Classify the primary cause of graft failure [Choose One]	"
primary_cause_gf_other = "If other, specify here	"
clinical_cause_gf = "Per the provider and pathologist, were there any clinically contributing circumstances? 	"
ar_gf = " Acute Rejection	"
noncom_gf = "Noncompliance	"
bk_gf = "Polyoma (BK) virus nephropathy	"
thrombosis_gf = "Technical failure / Thrombosis	"
is_reductn_gf = "Withdrawal or reduction of immunosuppressive regimen	"
re_disease_gf = "Recurrent disease	"
can_gf = "Chronic Allograft Nephropathy	"
other_clincal_gf = "Other	"
clincal_cause_other_gf = "If other type of clinical cause is chosen, please specify	"
scr_gf_avail = "Is there a SCr data available immediately prior to diagnosis of graft failure?	"
scr_value_gf = "Value of SCr (mg/dL) immediately prior to diagnosis of graft failure.	"
scr_value_gf_2 = "Date of SCr immediately prior to diagnosis of graft failure.	"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value	graftfailuref	1 = "Yes" 0 = "No";	
value	graftfail_deathf	1 = "Yes" 0 = "No";	
value	primary_cause_gff 1 = "Drug toxicity" 2 = "Primary nonfunction" 3 = "Rejection" 4 = "Recurrent disease" 5 = "Technical failure / Thrombosis" 6="Viral nephropathy" 7="Chronic Allograft Nephropathy" 8= "Unknown" 9="Other";	
value	clinical_cause_gff	1 = "Yes" 0 = "No";	
value	ar_gff	1 = "Yes" 2 = "No";	
value	noncom_gff 1 = "Yes" 2 = "No";	
value	bk_gff 1 = "Yes" 2 = "No";	
value	thrombosis_gff 1 = "Yes" 2 = "No";	
value	is_reductn_gff 1 = "Yes" 2 = "No";	
value	re_disease_gff 1 = "Yes" 2 = "No";
value	can_gff 1 = "Yes" 2 = "No";
value	other_clincal_gff 1 = "Yes" 2 = "No";	
value	scr_gf_availf 1 = "Yes" 0 = "No";	
run;

data i5;
set i5;
format	graftfailure	graftfailuref.;
format	graftfail_death	graftfail_deathf.;
format	primary_cause_gf	primary_cause_gff.;
format	clinical_cause_gf	clinical_cause_gff.;
format	ar_gf	ar_gff.;
format	noncom_gf	noncom_gff.;
format	bk_gf	bk_gff.;
format	thrombosis_gf	thrombosis_gff.;
format	is_reductn_gf	is_reductn_gff.;
format	re_disease_gf	re_disease_gff.;
format	can_gf	can_gff.;
format	other_clincal_gf	other_clincal_gff.;
format	scr_gf_avail	scr_gf_availf.;
run;

*Running a report for i5 using the macro now;

proc contents data=i5 order=varnum;
run;

data i5;
set i5;
scr_value_gf_num = input(scr_value_gf, 8.);
run;

data mylib.i5clean;
set i5;
run;

*i6;

data i6;
set mylib.i6;
run;

proc contents data = i6 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data i6;
set i6;
label 		
death_event = "Has there been a death event during this 6-month look back period?	"
death_dt = "Date of death	"
cause_death_1 = "Primary cause of death (1) 	"
cause_death_2 = "Primary cause of death (2)	"
cause_death_3 = "Primary cause of death (3) 	"
clincal_cause_known = "Were there any clinical contributing circumstances to the death? 	"
clincal_causes___1 = "clincal_causes___1, 1, Acute Rejection 	"
clincal_causes___2 = "clincal_causes___2, 2, Noncompliance 	"
clincal_causes___3 = "clincal_causes___3,  3, Polyoma (BK) virus nephropathy 	"
clincal_causes___4 = "clincal_causes___4,  4, Technical failure/ Thrombosis 	"
clincal_causes___5 = "clincal_causes___5,  5, Withdrawal or reduction of immunosuppressive regimen 	"
clincal_causes___6 = "clincal_causes___6,  6, Recurrent Disease 	"
clincal_causes___7 = "clincal_causes___7,  7, Chronic Allograft Nephropathy 	"
clincal_causes___8 = "clincal_causes___8,  8, Other	"
other_clinical_cause = "If other, please specify	"
scr_death_avail = "Was SCr value available prior to the date of death?	"
scr_date_death = "Date of SCr value taken 	"
scr_value_death = "Value of SCr (mg/dL)	"
data_entered_byi6 = "Data entered by:	"
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value	death_eventf	1 = "Yes" 0 = "No";
value	cause_death_3f	1 = "Yes" 0 = "No";
value	clincal_causes___1f 1 = "Yes" 0 = "No";
value	clincal_causes___2f 1 = "Yes" 0 = "No";
value	clincal_causes___3f 1 = "Yes" 0 = "No";
value	clincal_causes___4f 1 = "Yes" 0 = "No";
value	clincal_causes___5f 1 = "Yes" 0 = "No";
value	clincal_causes___6f 1 = "Yes" 0 = "No";
value	clincal_causes___7f 1 = "Yes" 0 = "No";
value	clincal_causes___8f 1 = "Yes" 0 = "No";
run;

data i6;
set i6;
format	death_event	death_eventf.;
format	cause_death_3	cause_death_3f.;
format	clincal_causes___1	clincal_causes___1f.;
format	clincal_causes___2	clincal_causes___2f.;
format	clincal_causes___3	clincal_causes___3f.;
format	clincal_causes___4	clincal_causes___4f.;
format	clincal_causes___5	clincal_causes___5f.;
format	clincal_causes___6	clincal_causes___6f.;
format	clincal_causes___7	clincal_causes___7f.;
format	clincal_causes___8	clincal_causes___8f.;
run;

*Running a report for i6 using the macro now;

proc contents data=i6 order=varnum;
run;

data mylib.i6clean;
set i6;
run;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

*Creating a report for the A forms for Drs. Israni and Jacobson;

*i5;

%selectvars(i5,										
graftfailure	
graftfail_date	
graftfail_death	
site_aware_gf_dt					
primary_cause_gf	
primary_cause_gf_other	
clinical_cause_gf	
ar_gf					
noncom_gf	
bk_gf	
thrombosis_gf	
is_reductn_gf					
re_disease_gf	
can_gf	
other_clincal_gf	
clincal_cause_other_gf					
scr_gf_avail	
scr_value_gf	
scr_value_gf_2	
data_entered_byi5					
i5_notification_of_non_fatal_gra								
		);								
proc print data=mylib.i5;										
run;

proc contents data=mylib.i5 order=varnum;
run;

data i5;
set mylib.i5;
keep
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
graftfailure
graftfail_date
graftfail_death
site_aware_gf_dt
primary_cause_gf
primary_cause_gf_other
clinical_cause_gf
ar_gf
noncom_gf
bk_gf
thrombosis_gf
is_reductn_gf
re_disease_gf
can_gf
other_clincal_gf
clincal_cause_other_gf
scr_gf_avail
scr_value_gf
scr_value_gf_2
;
run;

proc sort data=i5;
by 
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc freq data=i5;
tables
redcap_event_name redcap_repeat_instrument redcap_repeat_instance;
run;

*multiple records per record_id;
proc freq data=i5 noprint;
tables record_id / out=freqs;
proc freq data=freqs;
tables count;
run;

data i5;
set i5;
where graftfailure=1;
drop
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc print data=i5;
run;

proc contents data=i5 order=varnum;
run;

data mylib.i5clean;
set i5;
run;

*i6;
%selectvars(i6,										
death_event	
death_dt	
cause_death_1	
cause_death_2					
cause_death_3	
clincal_cause_known
clincal_causes___1	
clincal_causes___2					
clincal_causes___3	
clincal_causes___4	
clincal_causes___5	
clincal_causes___6					
clincal_causes___7	
clincal_causes___8	
other_clinical_cause	
scr_death_avail					
scr_date_death	
scr_value_death	
data_entered_byi6	
i6_death_form_complete					
		);								
proc print data=mylib.i6;										
run;

**i6;

proc contents data=mylib.i6 order=varnum;
run;

data i6;
set mylib.i6;
keep
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
death_event	
death_dt	
cause_death_1	
cause_death_2					
cause_death_3	
clincal_cause_known
clincal_causes___1	
clincal_causes___2					
clincal_causes___3	
clincal_causes___4	
clincal_causes___5	
clincal_causes___6					
clincal_causes___7	
clincal_causes___8	
other_clinical_cause	
scr_death_avail					
scr_date_death	
scr_value_death	
data_entered_byi6	
i6_death_form_complete	
;
run;

proc sort data=i6;
by 
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc freq data=i6;
tables
redcap_event_name redcap_repeat_instrument redcap_repeat_instance;
run;

proc print data = i6;
run;

data mylib.i6clean;
set i6;
where death_event=1;
drop
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;


*j1;
%selectvars(j1,										
		withdrew_consent	dt_withdrew	comment_consent_withdrawal	data_entered_byj1					
		j1_consent_withdraw_complete								
		);								
proc print data=mylib.j1;										
run;										
										
*j2;
%selectvars(j2,										
		completed_study	dt_lastvisit	dt_last_biosample	study_termination					
		reason_study_terminatn	termination_other_reason	phy_decision_termination	data_entered_byj2					
		j2_end_of_the_data_collection_co								
		);								
proc print data=mylib.j2;										
run;										
										
*j3;
%selectvars(j3,										
		mpd_occur	mpd_dt	mpd_type___1	mpd_type___2					
		mpd_type___3	mpd_type___4	mpd_type___5	mpd_type___6					
		mpd_type___7	other_type_protocoldeviatn	mpd_txt	mpd_continue_study					
		data_entered_byj3	j3_major_protocol_deviation_comp							
		);								
proc print data=mylib.j3;										
run;		

**j1;

proc contents data=mylib.j1 order=varnum;
run;

data j1;
set mylib.j1;
keep
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
withdrew_consent
dt_withdrew
comment_consent_withdrawal
;
run;

proc sort data=j1;
by 
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc freq data=j1;
tables
redcap_event_name redcap_repeat_instrument redcap_repeat_instance;
run;

*multiple records per record_id;
proc freq data=j1 noprint;
tables record_id / out=freqs;
proc freq data=freqs;
tables count;
run;

proc print data=j1;
run;

data j1;
set j1;
where withdrew_consent=1;
drop
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc print data=j1;
run;

**j2;

proc contents data=mylib.j2 order=varnum;
run;

data j2;
set mylib.j2;
keep
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
completed_study
dt_lastvisit
dt_last_biosample
study_termination
reason_study_terminatn
termination_other_reason
phy_decision_termination
;
run;

proc format;
value study_termination 1="Yes" 0="No";
value reason_study_terminatn 1="Physician decision" 2="Study Closure" 3 = "Participant voluntarily withdrew from the study" 4 = "Participant unable to provide samples" 5 = "Lost to follw up" 6 = "Serious Adverse Events" 7 = "Non-fatal Graft Failure" 8 = "Patient Not Alive" 9 = "Patient cannot travel" 10= "other";
run;

data j2;
set j2;
format study_termination study_termination.;
format reason_study_terminatn reason_study_terminatn.;
run;

proc sort data=j2;
by 
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc freq data=j2;
tables
redcap_event_name redcap_repeat_instrument redcap_repeat_instance;
run;

*multiple records per record_id;
proc freq data=j2 noprint;
tables record_id / out=freqs;
proc freq data=freqs;
tables count;
run;

proc print data=j2;
run;

data j2;
set j2;
where completed_study=1 or study_termination=1;
run;

proc print data=j2;
run;

proc sort data=j2; by record_id dt_lastvisit;
run;

data j2_lastvisit;
set j2;
by record_id dt_lastvisit;
if last.record_id;

format max_dt_lastvisit mmddyy10.;
max_dt_lastvisit = dt_lastvisit;

drop
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
dt_lastvisit
dt_last_biosample
;
run;

proc print data=j2_lastvisit;
run;

proc sort data=j2; by record_id dt_last_biosample;
run;

data j2_lastbio;
set j2;
by record_id dt_last_biosample;
if last.record_id;

format max_dt_biosample mmddyy10.;
max_dt_biosample = dt_last_biosample;

keep
record_id
max_dt_biosample
;
run;

data j2_lastbio;
set j2_lastbio;
where not missing(max_dt_biosample);
run;

proc print data=j2_lastbio;
run;

data j2_merged;
merge j2_lastvisit j2_lastbio;
by record_id;
run;

proc print data=j2_merged;
run;

**j3;

proc contents data=mylib.j3 order=varnum;
run;

data j3;
set mylib.j3;
keep
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
mpd_occur
mpd_dt
mpd_type___1
mpd_type___2
mpd_type___3
mpd_type___4
mpd_type___5
mpd_type___6
mpd_type___7
other_type_protocoldeviatn
mpd_txt
mpd_continue_study
;
run;

proc sort data=j3;
by 
record_id
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc freq data=j3;
tables
redcap_event_name redcap_repeat_instrument redcap_repeat_instance;
run;

*multiple records per record_id;
proc freq data=j3 noprint;
tables record_id / out=freqs;
proc freq data=freqs;
tables count;
run;

proc print data=j3;
run;

data j3;
set j3;
where mpd_occur=1;
drop
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance
;
run;

proc print data=j3;
run;

proc contents data=j3 order=varnum;
run;

** merge;

data mylib.jclean;
merge j1 j2_merged j3;
by record_id;
run;

proc print data=mylib.jclean;
run;

proc freq data=mylib.jclean noprint;
tables record_id / out=freqs;
proc freq data=freqs;
tables count;
run;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

**Need to drop the redcap event name, repeat instrument and repeat instance or it will create duplicate entries;

data mylib.abclean;
merge mylib.a1clean mylib.a2clean mylib.b1clean mylib.b2clean mylib.b2aclean mylib.b3clean mylib.b4clean mylib.b5clean mylib.b6clean mylib.b7clean mylib.b8clean /*mylib.b9clean*/ mylib.b10clean mylib.jclean;
by record_id;
drop
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance;
run;

data mylib.abclean2;
merge mylib.a1clean mylib.a2clean mylib.b1clean mylib.b2clean mylib.b2aclean mylib.b3clean mylib.b4clean mylib.b5clean mylib.b6clean mylib.b7clean mylib.b8clean /*mylib.b9clean*/ mylib.b10clean mylib.i6clean mylib.jclean;
by record_id;
drop
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance;
run;

proc print data=mylib.abclean2 (obs=10);
run;

proc contents data=mylib.abclean2 varnum;
run;


***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

*prepping a demographic dataset for the ATC abstracts based on forms A, B, C, D1, D2wide, D3 for diarrhea I5, I6 and J);

**Need to drop the redcap event name, repeat instrument and repeat instance or it will create duplicate entries;
** I will not include B9 clean because there are repeated entries;

data mylib.abclean;
merge mylib.a1clean mylib.a2clean mylib.b1clean mylib.b2clean mylib.b2aclean mylib.b3clean mylib.b4clean mylib.b5clean mylib.b6clean mylib.b7clean mylib.b8clean /*mylib.b9clean*/ mylib.b10clean mylib.jclean;
by record_id;
drop
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance;
run;

data mylib.abclean2;
merge mylib.a1clean mylib.a2clean mylib.b1clean mylib.b2clean mylib.b2aclean mylib.b3clean mylib.b4clean mylib.b5clean mylib.b6clean mylib.b7clean mylib.b8clean /*mylib.b9clean*/ mylib.b10clean mylib.c1clean mylib.c2clean mylib.d1clean mylib.d2clean mylib.i6clean mylib.jclean;
by record_id;
drop
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance;
run;

proc print data=mylib.abclean2 (obs=10);
run;

proc contents data=mylib.abclean2 varnum;
run;

**I will need to transpose D2 so we don't have repeated observations;
**https://stats.oarc.ucla.edu/sas/modules/how-to-reshape-data-long-to-wide-using-proc-transpose/;
**https://stats.oarc.ucla.edu/sas/modules/how-to-reshape-data-wide-to-long-using-proc-transpose/;

data d2;
set mylib.d2clean;
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

proc print data = d2;
run;

data d2long;
set d2;
keep 
record_id	
redcap_event_name 
mb_sample_timepoint	
mb_samples 
label_feces_sample
collectn_dt_mb 
label_feces_rna;
run;

proc print data = d2long;
run;

proc sort data = d2long;
by record_id;
run;

proc print data = d2long;
run;

proc transpose data=d2long out=d2widestooldna prefix=label_feces_sample_;
    by record_id;
    id mb_sample_timepoint;
    var label_feces_sample;
run;


proc transpose data=d2long out=d2widestooldna prefix=label_feces_sample_;
    by record_id;
    id redcap_event_name;
    var label_feces_sample;
run;

ods excel file="/home/u63327094/analysis_MISSION_PS_data_reports/stool_Ids_tac_UMGC_01042024.xlsx";

proc print data = d2widestooldna;
run;

ods excel close;

proc print data = d2widestooldna label;
run;

proc transpose data=d2long out=d2widestoolrna prefix=label_feces_rna_;
    by record_id;
    id mb_sample_timepoint;
    var label_feces_rna;
run;

proc print data = d2widestoolrna;
run;

proc transpose data=d2long out=d2widestooldate prefix=collectn_dt_mb_;
    by record_id;
    id mb_sample_timepoint;
    var collectn_dt_mb;
run;

proc print data = d2widestooldate;
run;

data d2widestool;
    merge  d2widestooldna(drop=_name_) d2widestoolrna(drop=_name_) d2widestooldate(drop=_name_);
    by record_id;
run;

proc print data=d2widestool;
run;

data mylib.d2widestool;
set d2widestool;
run;

*Adding E3 since it has diarrhea data from the EHR;

*e3;
%selectvars(e3,										
		possible_diarrhea	diarrhea_event_dt	take_mpa_diarrhea	mpa_intake_diarrhea					
		mpa_dose_adj_diarrhea___1	mpa_dose_adj_diarrhea___2	mpa_dose_adj_diarrhea___3	mpa_dose_adj_diarrhea___4					
		mpa_dose_adj_diarrhea___5	mpa_dose_adj_diarrhea___6	mpa_doese_adj_dia_dt	diarrhea_othercause					
		stool_culture	stool_infection	infexn_diarrhea_type	diarrhea_resolve					
		diarrhea_resolve_dt	data_entered_bye3	e3_mpa_toxicity_diarrhea_complet						
		);								
proc print data=mylib.e3;										
run;	

*E3;

data e3;
set mylib.e3;
run;

proc contents data = e3 order=varnum;
run;

*Formatting the variable names (https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lestmtsref/n1r8ub0jx34xfsn1ppcjfe0u16pc.htm);
data e3;
set e3;
label 
possible_diarrhea =	"Did the participant experience diarrhea?"
diarrhea_event_dt =	"Date diarrhea event began or was noted in the EMR"
take_mpa_diarrhea =	"Was the participant on mycophenolate at the time of diarrhea"
mpa_intake_diarrhea = "Which mycophenolate product was the participant taking within 14 days prior to the date of diarrhea documented in question 2?"
mpa_dose_adj_diarrhea___1 = "Mycophenolate total daily dose reduction (not discontinued) for  >= 24 hours"
mpa_dose_adj_diarrhea___2 = "Mycophenolate interval change, but total daily dose kept constant for >= 24 hours"
mpa_dose_adj_diarrhea___3 = "Mycophenolate discontinuation for >= 24 hours"
mpa_dose_adj_diarrhea___4 = "Switch to an alternate formulation of mycophenolate"
mpa_dose_adj_diarrhea___5 = "Mycophenolate total daily dose reduction and interval change for >= 24 hours"
mpa_dose_adj_diarrhea___6 = "No dose modifications"
mpa_doese_adj_dia_dt = "Date of action(s) in Question 4."
diarrhea_othercause	= "Was the diarrhea potentially attributed to drugs other than mycophenolate or disease conditions?"
stool_culture =	"Was a stool culture test was done at the time (+/- 7 days) of diarrhea noted in EMR?"
stool_infection = "Was the diarrhea potentially caused by any infections?"
diarrhea_resolve = "Did the diarrhea resolve?"
diarrhea_resolve_dt = "Date of diarrhea resolution"		
;
run;

*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value possible_diarrhea 1="Yes" 0="No";	
value take_mpa_diarrhea 1="Yes" 0="No";	
value mpa_intake_diarrhea 1="Mycophenolate mofetil (Cellcept, generic)" 2="Mycophenolic acid (Myfortic)";
value mpa_dose_adj_diarrhea___1f 1="Yes" 0="No";	
value mpa_dose_adj_diarrhea___2f 1="Yes" 0="No";	
value mpa_dose_adj_diarrhea___3f 1="Yes" 0="No";	
value mpa_dose_adj_diarrhea___4f 1="Yes" 0="No";	
value mpa_dose_adj_diarrhea___5f 1="Yes" 0="No";	
value mpa_dose_adj_diarrhea___6f 1="Yes" 0="No";	
value diarrhea_othercause 1="Yes" 0="No" 2="Not known";	
value stool_culture 1="Yes" 0="No";	
value diarrhea_resolve  1="Yes" 2="No" 3="Unknown";	
run;

data e3;
set e3;
format possible_diarrhea possible_diarrhea.;
format diarrhea_event_dt diarrhea_event_dt.;
format take_mpa_diarrhea take_mpa_diarrhea.;
format mpa_intake_diarrhea mpa_intake_diarrhea.;
format mpa_dose_adj_diarrhea___1 mpa_dose_adj_diarrhea___1f.;
format mpa_dose_adj_diarrhea___2 mpa_dose_adj_diarrhea___2f.;
format mpa_dose_adj_diarrhea___3 mpa_dose_adj_diarrhea___3f.;
format mpa_dose_adj_diarrhea___4 mpa_dose_adj_diarrhea___4f.;
format mpa_dose_adj_diarrhea___5 mpa_dose_adj_diarrhea___5f.;
format mpa_dose_adj_diarrhea___6 mpa_dose_adj_diarrhea___6f.;
format diarrhea_othercause diarrhea_othercause.;
format stool_culture stool_culture.;
format diarrhea_resolve diarrhea_resolve.;
run;


**I will need to transpose D2 so we don't have repeated observations;
**https://stats.oarc.ucla.edu/sas/modules/how-to-reshape-data-long-to-wide-using-proc-transpose/;
**https://stats.oarc.ucla.edu/sas/modules/how-to-reshape-data-wide-to-long-using-proc-transpose/;


data e3long;
set e3;
if  mpa_dose_adj_diarrhea___1 = 1 then mpa_dose_adj_diarrhea_demo = 1;
else if mpa_dose_adj_diarrhea___2 = 1 then mpa_dose_adj_diarrhea_demo = 2;
else if mpa_dose_adj_diarrhea___3 = 1 then mpa_dose_adj_diarrhea_demo = 3;
else if mpa_dose_adj_diarrhea___4 = 1 then mpa_dose_adj_diarrhea_demo = 4;
else if mpa_dose_adj_diarrhea___5 = 1 then mpa_dose_adj_diarrhea_demo = 5;
else if mpa_dose_adj_diarrhea___6 = 1 then mpa_dose_adj_diarrhea_demo = 6;
else mpa_dose_adj_diarrhea_demo = 0;
run;

proc format;
value mpa_dose_adj_diarrhea_demof 0 ="no data reported" 1="Mycophenolate total daily dose reduction (not discontinued) for  >= 24 hours" 2="Mycophenolate interval change, but total daily dose kept constant for >= 24 hours" 3="Mycophenolate discontinuation for >= 24 hours" 4= "Switch to an alternate formulation of mycophenolate" 5="Mycophenolate total daily dose reduction and interval change for >= 24 hours" 6="No dose modifications";
run;

data e3long;
set e3long;
format mpa_dose_adj_diarrhea_demo mpa_dose_adj_diarrhea_demof.;
run;

proc print data = e3long label;
run;

proc freq data = e3long;
tables mpa_dose_adj_diarrhea_demo;
run;

proc print data = e3long;
run;

*I will try to sort by both recordid and redcap event name;
proc sort data = e3long;
by record_id redcap_event_name;
run;

proc transpose data=e3long out=e3widepossible_diarrhea prefix=possible_diarrhea_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var possible_diarrhea;
run;

proc print data = e3widepossible_diarrhea;
run;

proc transpose data=e3long out=e3widediarrhea_event_dt prefix=diarrhea_event_dt_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var diarrhea_event_dt;
run;

proc print data = e3widediarrhea_event_dt;
run;

proc transpose data=e3long out=e3widetake_mpa_diarrhea prefix=take_mpa_diarrhea_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var take_mpa_diarrhea;
run;

proc print data = e3widetake_mpa_diarrhea;
run;

proc transpose data=e3long out=e3widempa_intake_diarrhea prefix=mpa_intake_diarrhea_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var mpa_intake_diarrhea;
run;

proc print data = e3widempa_intake_diarrhea;
run;	

proc transpose data=e3long out=e3widempa_doese_adj_dia_dt prefix=mpa_doese_adj_dia_dt_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var mpa_doese_adj_dia_dt;
run;

proc print data = e3widempa_doese_adj_dia_dt;
run;

proc transpose data=e3long out=e3widediarrhea_othercause prefix=diarrhea_othercause_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var diarrhea_othercause;
run;

proc print data = e3widediarrhea_othercause;
run;

proc transpose data=e3long out=e3widestool_culture prefix=stool_culture_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var stool_culture;
run;

proc print data = e3widestool_culture;
run;

proc transpose data=e3long out=e3widestool_infection prefix=stool_infection_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var stool_infection;
run;

proc print data = e3widestool_infection;
run;

proc transpose data=e3long out=e3wideinfexn_diarrhea_type prefix=infexn_diarrhea_type_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var infexn_diarrhea_type;
run;

proc print data = e3wideinfexn_diarrhea_type;
run;

proc transpose data=e3long out=e3widempa_dose_adj_diarrhea_demo prefix=mpa_dose_adj_diarrhea_demo_;
    by record_id redcap_event_name;
    id redcap_repeat_instance;
    var mpa_dose_adj_diarrhea_demo;
run;

proc print data = e3widempa_dose_adj_diarrhea_demo;
run;

data e3widestool;
    merge  e3widepossible_diarrhea(drop=_name_) e3widediarrhea_event_dt(drop=_name_) e3widetake_mpa_diarrhea(drop=_name_) e3widempa_intake_diarrhea(drop=_name_) e3widempa_doese_adj_dia_dt(drop=_name_) e3widempa_doese_adj_dia_dt(drop=_name_) e3widediarrhea_othercause(drop=_name_) e3widestool_culture(drop=_name_) e3widestool_infection(drop=_name_) e3wideinfexn_diarrhea_type(drop=_name_)  e3widempa_dose_adj_diarrhea_demo(drop=_name_);
    by record_id redcap_event_name;
run;

proc print data=e3widestool;
run;

data mylib.e3widestool;
set e3widestool;
run;

data e3widestool6months;
set e3widestool;
where redcap_event_name = "month_6_followup_arm_1";
run;

proc print data = e3widestool6months;
run;

proc contents data = e3widestool6months;
run;

data mylib.e3widestool6months;
set e3widestool6months;
run;

*Running a report for e3 using the macro now;

proc contents data=e3 order=varnum;
run;

data e3pos;
set e3;
where possible_diarrhea = 1;
run;

proc contents data=e3pos order=varnum;
run;

proc print data = e3pos;
run;

data mylib.e3clean;
set e3;
run;

*Adding e3 as a wide dataset since it has EMR diarrhea data;

data mylib.onerectest;
merge mylib.a1clean mylib.a2clean mylib.b1clean mylib.b2clean mylib.b2aclean mylib.b3clean mylib.b4clean mylib.b5clean mylib.b6clean mylib.b7clean mylib.b8clean /*mylib.b9clean*/ mylib.b10clean mylib.c1clean mylib.c2clean mylib.d1clean mylib.d2widestool /*mylib.d3clean*/ mylib.e3widestool6months mylib.i5clean mylib.i6clean mylib.jclean;
by record_id;
drop
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance;
run;

proc print data=mylib.onerectest (obs=10);
run;

proc contents data=mylib.onerectest varnum;
run;

proc format;
value study_termination 1="Yes" 0="No";
value reason_study_terminatn 1="Physician decision" 2="Study Closure" 3 = "Participant voluntarily withdrew from the study" 4 = "Participant unable to provide samples" 5 = "Lost to follw up" 6 = "Serious Adverse Events" 7 = "Non-fatal Graft Failure" 8 = "Patient Not Alive" 9 = "Patient cannot travel" 10= "other";
run;

data mylib.onerectest;
set mylib.onerectest;
format study_termination study_termination.;
format reason_study_terminatn reason_study_terminatn.;
run;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

* add donor/recipient cmv, ESRD, coldtime category, donor age group, cross t or b cell, PRA positive, ca_base, cv_base;
* need to add: recip age group;

data mylib.onerectest;
merge mylib.a1clean mylib.a2clean mylib.b1clean mylib.b2clean mylib.b2aclean mylib.b3clean mylib.b4clean mylib.b5clean mylib.b6clean mylib.b7clean mylib.b8clean /*mylib.b9clean*/ mylib.b10clean mylib.c1clean mylib.c2clean mylib.d1clean mylib.d2widestool /*mylib.d3clean*/ mylib.e3widestool6months mylib.i5clean mylib.i6clean mylib.jclean;
by record_id;
drop
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance;
run;

proc print data=mylib.onerectest (obs=10);
run;

proc contents data=mylib.onerectest varnum;
run;

*For this dataset, I am using all a(a1+a2) b(B1 through b10), c (c1+c2), d2widestool, f1 + f2 + f3 (for pam's LSS paper), I5, I6 and J(j1+j2+j3);
data mylib.onerectest;
merge mylib.ab2 mylib.c mylib.d2widestool mylib.f1clean mylib.f2clean mylib.f3clean mylib.i5clean mylib.i6clean mylib.jclean;
by record_id;
drop
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance;
run;

proc print data=mylib.onerectest (obs=10);
run;

proc contents data=mylib.onerectest varnum;
run;

proc format;
value study_termination 1="Yes" 0="No";
value reason_study_terminatn 1="Physician decision" 2="Study Closure" 3 = "Participant voluntarily withdrew from the study" 4 = "Participant unable to provide samples" 5 = "Lost to follw up" 6 = "Serious Adverse Events" 7 = "Non-fatal Graft Failure" 8 = "Patient Not Alive" 9 = "Patient cannot travel" 10= "other";
run;

data mylib.onerectest;
set mylib.onerectest;
format study_termination study_termination.;
format reason_study_terminatn reason_study_terminatn.;
run;

*data merged3;
*set merged2;

data onerectest;
set mylib.onerectest;

if not missing(cmv_donor_igg) and missing(cmv_dd_donor) then cmv_donor = cmv_donor_igg;
if missing(cmv_donor_igg) and not missing(cmv_dd_donor) then cmv_donor = cmv_dd_donor;

if cmv_recipient=1 and cmv_donor=1 then cmvnew=1;
if cmv_recipient=1 and cmv_donor=2 then cmvnew=1;
if cmv_recipient=2 and cmv_donor=1 then cmvnew=2;
if cmv_recipient=2 and cmv_donor=2 then cmvnew=0;

if cmv_recipient=1 and cmv_donor=1 then cmv_grp=1;
if cmv_recipient=1 and cmv_donor=2 then cmv_grp=2;
if cmv_recipient=2 and cmv_donor=1 then cmv_grp=3;
if cmv_recipient=2 and cmv_donor=2 then cmv_grp=4;

format age_donor_group age_recip_group $5. pcausenew $8.;

if esrd_cause=2 then pcausenew="diabetes";
else if esrd_cause=1 then pcausenew="glom";
else if esrd_cause=4 then pcausenew="hyper";
else if esrd_cause=3 then pcausenew="poly";
else if esrd_cause=10 then pcausenew="unknown";
else pcausenew="other";
if missing(esrd_cause) then pcausenew="unknown";

if cold_ischem_time=. then coldtime_cat=.;
else if cold_ischem_time <= 12 then coldtime_cat=1;
else if cold_ischem_time <= 24 then coldtime_cat=2;
else coldtime_cat=3;

if not missing(birth_yr_ld) and missing(birth_yr_dd) then birth_yr_donor=birth_yr_ld;
if missing(birth_yr_ld) and not missing(birth_yr_dd) then birth_yr_donor=birth_yr_dd;

age_donor = year(tx_dt) - birth_yr_donor;

if missing(age_donor) then age_donor_group='';
else if . < age_donor < 35 then age_donor_group='0-34';
else if age_donor < 65 then age_donor_group='35-64';
else if age_donor < 85 then age_donor_group='65-84';

*age_at_tx = sex_2;

age_at_tx = age;

if missing(age_at_tx) then age_recip_group='';
else if . < age_at_tx < 35 then age_recip_group='0-34';
else if age_at_tx < 65 then age_recip_group='35-64';
else if age_at_tx < 85 then age_recip_group='65-84';

if t_cell_x_match_result=1 or b_cell_x_match_result=1 then crosstorbcell=1;
else if t_cell_x_match_result=2 and b_cell_x_match_result=2 then crosstorbcell=0;
else crosstorbcell=.;

if missing(cpra) then PRA_pos=.;
else if cpra > 10 then PRA_pos=1;
else PRA_pos=0;

if missing(strok) and missing(cor_vas_revascular) and missing(cor_vas_drug) then cv_base=.;
else if strok=1 then cv_base=3;
else if cor_vas_revascular=1 then cv_base=2;
else if cor_vas_drug=1 then cv_base=1;
else cv_base=0;

if missing(myocardialinf) and missing(cor_artery_revascular) and missing(cor_artery_drug) then ca_base=.;
else if myocardialinf=1 then ca_base=3;
else if cor_artery_revascular=1 then ca_base=2;
else if cor_artery_drug=1 then ca_base=1;
else ca_base=0;

if dialysis_post_tx=1 then do;
	if . < dt_dialysis_posttx <= (tx_dt + 7) then dial_7days = 1; else dial_7days=0;
	if . < dt_dialysis_posttx <= (tx_dt + 14) then dgf=1; else dgf=0;
end;


format commoncloseoutdate lastdate maxfupdate mmddyy10.;

commoncloseoutdate = mdy(11,01,2023);

lastdate = max(max_dt_biosample, max_dt_lastvisit); *max_cni_creatdt_perperson;

maxfupdate = min(lastdate, commoncloseoutdate, graftfail_date, death_dt);

fup_days = maxfupdate-tx_dt;
fup_years = (maxfupdate-tx_dt)/365.25;

run;

*proc freq data=merged3;
*tables age_donor age_donor_group;
*run;

proc freq data=onerectest;
tables age_donor age_donor_group;
run;

*proc freq data=merged3;
*tables sex_2 age_at_tx age_recip_group;
*run;

proc freq data=onerectest;
tables age age_at_tx age_recip_group;
run;

*proc means data=merged3;
*var fup_days
fup_years;
*run;

proc means data=onerectest;
var fup_days
fup_years;
run;

*proc print data=merged3;
*var
record_id
tx_dt
max_dt_biosample max_dt_lastvisit
lastdate

graftfailure
graftfail_date
graftfail_death
site_aware_gf_dt
death_event
death_dt

maxfupdate

fup_days
fup_years
;
*run;


proc print data=onerectest;
var
record_id
tx_dt
max_dt_biosample max_dt_lastvisit
lastdate

graftfailure
graftfail_date
graftfail_death
site_aware_gf_dt
death_event
death_dt

maxfupdate

fup_days
fup_years
;
run;

*data outputf.onerec;
*set merged3;
*run;

**exporting the full demographic dataset with everyone included as an excel file;
*https://blogs.sas.com/content/sasdummy/2012/01/25/export-to-excel-got-easier/;

data mylib.onerectest_ps;
set onerectest;
run;

proc export 
  data=onerectest
  dbms=xlsx 
  outfile="/home/u63327094/analysis_MISSION_01_PS_data_reports/mission_demo_ps_noexclusions.xlsx" 
  replace;
run;

data mylib.onerectest_toshare_ps;
set onerectest;
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

data mylib.onerectest_toshare_ps;
set mylib.onerectest_toshare_ps;
if missing(age_at_tx) then age_recip_group_report='Missing';
else if . < age_at_tx le 1 then age_recip_group_report='0-1';
else if 2 le age_at_tx le 5 then age_recip_group_report='2-6';
else if 6 le age_at_tx le 12 then age_recip_group_report='6-12';
else if 13 le age_at_tx le 17 then age_recip_group_report='13-17';
else if 18 le age_at_tx le 25 then age_recip_group_report='18-25';
else if 26 le age_at_tx le 45 then age_recip_group_report='26-45';
else if 46 le age_at_tx le 65 then age_recip_group_report='46-65';
else if 65 le age_at_tx le 75 then age_recip_group_report='65-75';
else if age_at_tx ge 76 then age_recip_group_report='76+';
run;

proc print data = mylib.onerectest_toshare_ps;
var record_id age age_at_tx age_recip_group_report;
run;

proc export 
  data= mylib.onerectest_toshare_ps
  dbms=xlsx 
  outfile="/home/u63327094/analysis_MISSION_01_PS_data_reports/mission_demo_ps_toshare_04012024.xlsx" 
  replace;
run;

*prepping a data dictionary from proc contents;

*Outputting all the resultsvariables as an excel sheet;
*https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/odsug/p09n5pw9ol0897n1qe04zeur27rv.htm;


options orientation=portrait center number pageno=1 nodate;

ods excel file="/home/u63327094/analysis_MISSION_PS_data_reports/ATC2023_mission_demo_toshare_datadictionary_03012024.xlsx";

proc contents data =  mylib.onerectest_toshare_ps;
run;

ods excel close;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

*Generating the descriptive statistics for the Table 1 Dr. israni requested;
*Based on Moataz and Dr. Jacobson's feedback, PID 4042 should be African American;

data onerectest_toshare_ps;
set mylib.onerectest_toshare_ps;
run;

proc contents data = onerectest_toshare_ps;
run;

data onerectest_toshare_ps;
set onerectest_toshare_ps;
if birth_yr_ld ne . then yr_ld = YEAR(tx_dt);
if birth_yr_ld ne . then age_ld = yr_ld-birth_yr_ld;
if birth_yr_dd ne . then yr_dd = YEAR(tx_dt);
if birth_yr_dd ne . then age_dd = yr_dd-birth_yr_dd;
run;

proc print data = onerectest_toshare_ps;
var record_id tx_dt birth_yr_ld yr_ld age_ld birth_yr_dd yr_dd age_dd;
run;

proc freq data = onerectest_toshare_ps;
table predom_race;
run;

proc print data = onerectest_toshare_ps;
var record_id predom_race;
run;

data onerectest_toshare_ps;
set onerectest_toshare_ps;
if record_id = 4042 then predom_race_2 = 2;
else predom_race_2 = predom_race;
run;

proc print data = onerectest_toshare_ps;
var record_id predom_race predom_race_2;
run;

proc freq data = onerectest_toshare_ps;
table predom_race*predom_race_2 / nocol norow;
run;

proc freq data = onerectest_toshare_ps;
table ethnicity;
run;

proc print data = onerectest_toshare_ps;
var record_id ethnicity;
run;

proc freq data = onerectest_toshare_ps;
table sex;
run;

proc means data = onerectest_toshare_ps mean std;
var age;
run;

*Switching to age at PK, based on tx date in forms f;
*Because this dataset has individuals who did not undergo PK, I will have to indicate how many got PK;

proc print data = onerectest_toshare_ps;
var record_id tx_dt age days_after_posttx_pk;
run;

data onerectest_toshare_ps;
set onerectest_toshare_ps;
if days_after_posttx_pk ne . then pk_check = 1;
if days_after_posttx_pk ne . then age_to_add = days_after_posttx_pk/365.2;
run;

data onerectest_toshare_ps;
set onerectest_toshare_ps;
if days_after_posttx_pk ne . then age_at_PK = age + age_to_add;
else age_at_pk = age;
run;

proc print data = onerectest_toshare_ps;
var record_id tx_dt age days_after_posttx_pk pk_check age_to_add age_at_pk;
run;

proc freq data = onerectest_toshare_ps;
table pk_check / missing;
run;

proc means data = onerectest_toshare_ps mean std;
var age age_at_pk;
run;

proc freq data = onerectest_toshare_ps;
table esrd_cause;
run;

proc freq data = onerectest_toshare_ps;
table diabetes_pretx;
run;

proc freq data = onerectest_toshare_ps;
table donor_type;
run;
 
proc means data = onerectest_toshare_ps mean std;
var age_ld age_dd;
run;

proc freq data = onerectest_toshare_ps;
table sex_ld sex_dd;
run;

proc means data = onerectest_toshare_ps mean std;
var cold_ischem_time;
run;

proc freq data = onerectest_toshare_ps;
table prev_tx;
run;

proc freq data = onerectest_toshare_ps;
table dialysis_post_tx/missing;
run;

proc freq data = onerectest_toshare_ps;
table pra_test /missing;
run;

proc freq data = onerectest_toshare_ps;
table t_cell_x_match_result /missing;
run;

proc freq data = onerectest_toshare_ps;
table b_cell_x_match_result /missing;
run;

proc freq data = onerectest_toshare_ps;
table plasmapheresis /missing;
run;

proc freq data = onerectest_toshare_ps;
table nummismatch /missing;
run;

data g3;
set mylib.g3clean;
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

proc contents data = g3;
run;

proc print data = g3 label;
run;

data g3demo;
set g3;
where redcap_repeat_instance = 1;
run;

proc freq data = g3demo;
tables induct_meds___1 induct_meds___5;
run;

data g3demo;
set g3demo;
if induct_meds___1 = 1 then induct_meds = "Thymoglobulin (anti-thymocyte globulin [rabbit], ATG rabbit)";
else if induct_meds___2 = 1 then induct_meds = "Simulect (basiliximab)";
else if induct_meds___3 = 1 then induct_meds = "Campath (alemtuzumab)";
else if induct_meds___4 = 1 then induct_meds = "Rituxan (rituximab)";
else induct_meds = "Drug not received";
run;

proc freq data = g3demo;
table induct_meds /missing;
run;

proc freq data = onerectest_toshare_ps;
table smoking /missing;
run;

proc freq data = onerectest_toshare_ps;
table preemptive_tx /missing;
run;

data g4;
set mylib.g4clean;
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

proc contents data = g4;
run;

proc print data = g4 label;
run;

data g4demo;
set g4;
where ind_steroid_dose_change = 1;
run;

proc print data = g4demo label;
run;

*remove duplicate PIDs;
*chrome-extension://efaidnbmnnnibpcajpcglclefindmkaj/https://support.sas.com/resources/papers/proceedings/proceedings/forum2007/069-2007.pdf;

PROC SORT data=g4demo NODUPkey;  BY record_id; RUN; 


data g10;
set mylib.g10clean;
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

proc contents data = g10;
run;

proc print data = g10 label;
run;

proc freq data = onerectest_toshare_ps;
table spk /missing;
run;

proc freq data = onerectest_toshare_ps;
table cmv_donor_igg
eb_donor
hepb_donor
hepc_donor /missing;
run;


***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

*Prepping an EOY report for Dr. israni based on the merged dataset;
*Using the dataset with all enrolled rather than the one without participants who withdrew;

data onerectest_toshare;
set mylib.onerectest;
run;

proc print data = onerectest_toshare;
var record_id age age_at_tx;
run;

data onerectest_toshare;
set mylib.onerectest;
if missing(age_at_tx) then age_recip_group_report='Missing';
else if . < age_at_tx le 1 then age_recip_group_report='0-1';
else if 2 le age_at_tx le 5 then age_recip_group_report='2-6';
else if 6 le age_at_tx le 12 then age_recip_group_report='6-12';
else if 13 le age_at_tx le 17 then age_recip_group_report='13-17';
else if 18 le age_at_tx le 25 then age_recip_group_report='18-25';
else if 26 le age_at_tx le 45 then age_recip_group_report='26-45';
else if 46 le age_at_tx le 65 then age_recip_group_report='46-65';
else if 65 le age_at_tx le 75 then age_recip_group_report='65-75';
else if age_at_tx ge 76 then age_recip_group_report='76+';
run;

proc print data = onerectest_toshare;
var record_id age age_at_tx age_recip_group_report;
run;


*use work.freq option to print out the labels;
*https://communities.sas.com/t5/SAS-Procedures/label-in-PROC-FREQ/td-p/7285;

options orientation=portrait center number pageno=1 nodate;

ods excel file="/home/u63327094/analysis_MISSION_PS_data_reports/MISSION_PS_EOWreport.xlsx";

proc freq data =  onerectest_toshare;
tables age_recip_group_report / nocol norow nopercent out=work.freq;
run;

proc print data = work.freq noobs label;
run;

proc print data =  onerectest_toshare;
var record_id age;
where age_recip_group_report = " ";
run;

proc freq data = onerectest_toshare;
table ethnicity;
run;

proc sort data = onerectest_toshare;
by ethnicity;
run;

proc freq data = onerectest_toshare;
table predom_race*sex / nocol norow nopercent  out=work.freq;
by ethnicity;
run;

proc print data = work.freq noobs label;
run;

ods excel close;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

*Creating a report for Dr. Jacobson for number enrolled, number withdrawn, and number who completed PK;

proc print data = mission;
var record_id redcap_event_name redcap_repeat_instrument redcap_repeat_instance withdrew_consent dt_withdrew death_event death_dt study_termination reason_study_terminatn mpa txn_dt_pk pk_event_dt days_after_posttx_pk confirm_pkcohort;
where withdrew_consent =1 or death_event=1 or study_termination = 1;
title "list of participants with withdrawal (form J1), death (form I6), study termination (form J2) and PK information (form F1)";
run;

*This approach will not work since the data isn't split yet;
proc print data = mission;
var record_id redcap_event_name redcap_repeat_instrument redcap_repeat_instance withdrew_consent dt_withdrew death_event death_dt study_termination reason_study_terminatn mpa txn_dt_pk pk_event_dt days_after_posttx_pk confirm_pkcohort;
title "list of participants with withdrawal (form J1), death (form I6), study termination (form J2) and PK information (form F1)";
run;

data enrollment_withdraw_pk;
merge mylib.a1clean mylib.a2clean mylib.b1clean mylib.b2clean mylib.b3clean mylib.b4clean mylib.b5clean mylib.b6clean mylib.b7clean /*mylib.b8clean*/ /*b9*/ mylib.b10clean mylib.i6clean mylib.jclean mylib.f1;
by record_id;
drop
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance;
run;

ods excel file="/home/u63327094/analysis_MISSION_PS_data_reports/PS_enrollment_withdraw_pk.xlsx";

proc print data = enrollment_withdraw_pk;
var record_id withdrew_consent dt_withdrew death_event death_dt study_termination reason_study_terminatn mpa txn_dt_pk pk_event_dt days_after_posttx_pk confirm_pkcohort;
title "list of participants with withdrawal (form J1), death (form I6), study termination (form J2) and PK information (form F1)";
run;

ods excel close;

*****************************************************************************************************************************;
*****************************************************************************************************************************;
*****************************************************************************************************************************;

**Need to drop the redcap event name, repeat instrument and repeat instance or it will create duplicate entries;

data mylib.abclean;
merge mylib.a1clean mylib.a2clean mylib.b1clean mylib.b2clean mylib.b2aclean mylib.b3clean mylib.b4clean mylib.b5clean mylib.b6clean mylib.b7clean mylib.b8clean /*mylib.b9clean*/ mylib.b10clean mylib.jclean;
by record_id;
drop
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance;
run;

data mylib.abclean2;
merge mylib.a1clean mylib.a2clean mylib.b1clean mylib.b2clean mylib.b2aclean mylib.b3clean mylib.b4clean mylib.b5clean mylib.b6clean mylib.b7clean mylib.b8clean /*mylib.b9clean*/ mylib.b10clean mylib.i6clean mylib.jclean;
by record_id;
drop
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance;
run;

proc print data=mylib.abclean2 (obs=10);
run;

*/

*****************************************************************************************************************************;
*****************************************************************************************************************************;
*****************************************************************************************************************************;

*Testing out criteria for Dr. Israni's virome sample selection;
*Used /Volumes/RAVPOWER2/ROOK_03_Professional/HHRI/Bioinf_1_Projects_05_03_MISSION_Redcap_PS_CS/B_Documents_04_Redcap data reports_APR2023/X_PS_CS_redcap_review_for Ajay and Pam/MicrobiomeAndImmunosuppression_DataDictionary_2024-02-28.csv to check;

*Checking creatinine variables;

*creatinine first weeks post tx;
proc print data = mylib.c2clean;
run;

*Creatinine levels right before the PK (include/exclude);
proc print data = mylib.f1;
run;

*Creatinine levels during the PK;
proc print data = mylib.f3clean;
run;

*Urine Creatinine levels at M6 and M12;
proc print data = mylib.g8clean;
where redcap_repeat_instrument = "g8_urine_measurements";
run;

*Serum Creatinine levels at M6 and M12;
proc print data = mylib.h1clean;
run;

*Serum Creatinine levels at M1, M2, M6 and M12;
proc print data = mylib.h3clean;
run;

*Biopsy data (we only have recorded biopsies from the UMN, but Dr. Israni said it is ok;
proc print data = mylib.i3;
run;

*Infection data;
proc print data = mylib.i1;
run;

*Serious adverse events data;
proc print data = mylib.i2;
run;

*Disease Specific Antibodies (DSA);
proc print data = mylib.g9;
where redcap_repeat_instrument = "g9_recipient_dsa_specificities";
run;

****Based on the forms above, I can pull the data desired for the virome sample selection;

* add donor/recipient cmv, ESRD, coldtime category, donor age group, cross t or b cell, PRA positive, ca_base, cv_base;
* need to add: recip age group;

data mylib.onerectest;
merge mylib.a1clean mylib.a2clean mylib.b1clean mylib.b2clean mylib.b2aclean mylib.b3clean mylib.b4clean mylib.b5clean mylib.b6clean mylib.b7clean mylib.b8clean /*mylib.b9clean*/ mylib.b10clean mylib.c1clean mylib.c2clean mylib.d1clean mylib.d2widestool /*mylib.d3clean*/ mylib.e3widestool6months mylib.i5clean mylib.i6clean mylib.jclean;
by record_id;
drop
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance;
run;

proc print data=mylib.onerectest (obs=10);
run;

proc contents data=mylib.onerectest varnum;
run;

*For this dataset, I am using all a(a1+a2) b(B1 through b10), c (c1+c2), d2widestool, f1 + f2 + f3 (for pam's LSS paper), I5, I6 and J(j1+j2+j3);
data mylib.onerectest;
merge mylib.ab2 mylib.c mylib.d2widestool mylib.f1clean mylib.f2clean mylib.f3clean mylib.i5clean mylib.i6clean mylib.jclean;
by record_id;
drop
redcap_event_name
redcap_repeat_instrument
redcap_repeat_instance;
run;

proc print data=mylib.onerectest (obs=10);
run;

proc contents data=mylib.onerectest varnum;
run;

proc format;
value study_termination 1="Yes" 0="No";
value reason_study_terminatn 1="Physician decision" 2="Study Closure" 3 = "Participant voluntarily withdrew from the study" 4 = "Participant unable to provide samples" 5 = "Lost to follw up" 6 = "Serious Adverse Events" 7 = "Non-fatal Graft Failure" 8 = "Patient Not Alive" 9 = "Patient cannot travel" 10= "other";
run;

data mylib.onerectest;
set mylib.onerectest;
format study_termination study_termination.;
format reason_study_terminatn reason_study_terminatn.;
run;

*data merged3;
*set merged2;

data onerectest;
set mylib.onerectest;

if not missing(cmv_donor_igg) and missing(cmv_dd_donor) then cmv_donor = cmv_donor_igg;
if missing(cmv_donor_igg) and not missing(cmv_dd_donor) then cmv_donor = cmv_dd_donor;

if cmv_recipient=1 and cmv_donor=1 then cmvnew=1;
if cmv_recipient=1 and cmv_donor=2 then cmvnew=1;
if cmv_recipient=2 and cmv_donor=1 then cmvnew=2;
if cmv_recipient=2 and cmv_donor=2 then cmvnew=0;

if cmv_recipient=1 and cmv_donor=1 then cmv_grp=1;
if cmv_recipient=1 and cmv_donor=2 then cmv_grp=2;
if cmv_recipient=2 and cmv_donor=1 then cmv_grp=3;
if cmv_recipient=2 and cmv_donor=2 then cmv_grp=4;

format age_donor_group age_recip_group $5. pcausenew $8.;

if esrd_cause=2 then pcausenew="diabetes";
else if esrd_cause=1 then pcausenew="glom";
else if esrd_cause=4 then pcausenew="hyper";
else if esrd_cause=3 then pcausenew="poly";
else if esrd_cause=10 then pcausenew="unknown";
else pcausenew="other";
if missing(esrd_cause) then pcausenew="unknown";

if cold_ischem_time=. then coldtime_cat=.;
else if cold_ischem_time <= 12 then coldtime_cat=1;
else if cold_ischem_time <= 24 then coldtime_cat=2;
else coldtime_cat=3;

if not missing(birth_yr_ld) and missing(birth_yr_dd) then birth_yr_donor=birth_yr_ld;
if missing(birth_yr_ld) and not missing(birth_yr_dd) then birth_yr_donor=birth_yr_dd;

age_donor = year(tx_dt) - birth_yr_donor;

if missing(age_donor) then age_donor_group='';
else if . < age_donor < 35 then age_donor_group='0-34';
else if age_donor < 65 then age_donor_group='35-64';
else if age_donor < 85 then age_donor_group='65-84';

*age_at_tx = sex_2;

age_at_tx = age;

if missing(age_at_tx) then age_recip_group='';
else if . < age_at_tx < 35 then age_recip_group='0-34';
else if age_at_tx < 65 then age_recip_group='35-64';
else if age_at_tx < 85 then age_recip_group='65-84';

if t_cell_x_match_result=1 or b_cell_x_match_result=1 then crosstorbcell=1;
else if t_cell_x_match_result=2 and b_cell_x_match_result=2 then crosstorbcell=0;
else crosstorbcell=.;

if missing(cpra) then PRA_pos=.;
else if cpra > 10 then PRA_pos=1;
else PRA_pos=0;

if missing(strok) and missing(cor_vas_revascular) and missing(cor_vas_drug) then cv_base=.;
else if strok=1 then cv_base=3;
else if cor_vas_revascular=1 then cv_base=2;
else if cor_vas_drug=1 then cv_base=1;
else cv_base=0;

if missing(myocardialinf) and missing(cor_artery_revascular) and missing(cor_artery_drug) then ca_base=.;
else if myocardialinf=1 then ca_base=3;
else if cor_artery_revascular=1 then ca_base=2;
else if cor_artery_drug=1 then ca_base=1;
else ca_base=0;

if dialysis_post_tx=1 then do;
	if . < dt_dialysis_posttx <= (tx_dt + 7) then dial_7days = 1; else dial_7days=0;
	if . < dt_dialysis_posttx <= (tx_dt + 14) then dgf=1; else dgf=0;
end;


format commoncloseoutdate lastdate maxfupdate mmddyy10.;

commoncloseoutdate = mdy(11,01,2023);

lastdate = max(max_dt_biosample, max_dt_lastvisit); *max_cni_creatdt_perperson;

maxfupdate = min(lastdate, commoncloseoutdate, graftfail_date, death_dt);

fup_days = maxfupdate-tx_dt;
fup_years = (maxfupdate-tx_dt)/365.25;

run;

*proc freq data=merged3;
*tables age_donor age_donor_group;
*run;

proc freq data=onerectest;
tables age_donor age_donor_group;
run;

*proc freq data=merged3;
*tables sex_2 age_at_tx age_recip_group;
*run;

proc freq data=onerectest;
tables age age_at_tx age_recip_group;
run;

*proc means data=merged3;
*var fup_days
fup_years;
*run;

proc means data=onerectest;
var fup_days
fup_years;
run;

*proc print data=merged3;
*var
record_id
tx_dt
max_dt_biosample max_dt_lastvisit
lastdate

graftfailure
graftfail_date
graftfail_death
site_aware_gf_dt
death_event
death_dt

maxfupdate

fup_days
fup_years
;
*run;


proc print data=onerectest;
var
record_id
tx_dt
max_dt_biosample max_dt_lastvisit
lastdate

graftfailure
graftfail_date
graftfail_death
site_aware_gf_dt
death_event
death_dt

maxfupdate

fup_days
fup_years
;
run;

*data outputf.onerec;
*set merged3;
*run;

**exporting the full demographic dataset with everyone included as an excel file;
*https://blogs.sas.com/content/sasdummy/2012/01/25/export-to-excel-got-easier/;

data mylib.onerectest_ps;
set onerectest;
run;

proc export 
  data=onerectest
  dbms=xlsx 
  outfile="/home/u63327094/analysis_MISSION_01_PS_data_reports/mission_demo_ps_noexclusions.xlsx" 
  replace;
run;

data mylib.onerectest_toshare_ps;
set onerectest;
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

data mylib.onerectest_toshare_ps;
set mylib.onerectest_toshare_ps;
if missing(age_at_tx) then age_recip_group_report='Missing';
else if . < age_at_tx le 1 then age_recip_group_report='0-1';
else if 2 le age_at_tx le 5 then age_recip_group_report='2-6';
else if 6 le age_at_tx le 12 then age_recip_group_report='6-12';
else if 13 le age_at_tx le 17 then age_recip_group_report='13-17';
else if 18 le age_at_tx le 25 then age_recip_group_report='18-25';
else if 26 le age_at_tx le 45 then age_recip_group_report='26-45';
else if 46 le age_at_tx le 65 then age_recip_group_report='46-65';
else if 65 le age_at_tx le 75 then age_recip_group_report='65-75';
else if age_at_tx ge 76 then age_recip_group_report='76+';
run;

proc print data = mylib.onerectest_toshare_ps;
var record_id age age_at_tx age_recip_group_report;
run;

proc export 
  data= mylib.onerectest_toshare_ps
  dbms=xlsx 
  outfile="/home/u63327094/analysis_MISSION_01_PS_data_reports/mission_demo_ps_toshare_04012024.xlsx" 
  replace;
run;

*prepping a data dictionary from proc contents;

*Outputting all the resultsvariables as an excel sheet;
*https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/odsug/p09n5pw9ol0897n1qe04zeur27rv.htm;


options orientation=portrait center number pageno=1 nodate;

ods excel file="/home/u63327094/analysis_MISSION_PS_data_reports/ATC2023_mission_demo_toshare_datadictionary_03012024.xlsx";

proc contents data =  mylib.onerectest_toshare_ps;
run;

ods excel close;

*Now merging the covariates by PID and Redcap event name;

*Serum Creatinine levels at M6 and M12;
proc print data = mylib.h1clean;
run;

*Serum Creatinine levels at M1, M2, M6 and M12;
proc print data = mylib.h3clean;
run;

*Biopsy data (we only have recorded biopsies from the UMN, but Dr. Israni said it is ok;
proc print data = mylib.i3;
run;

*Infection data;
proc print data = mylib.i1;
run;

*Serious adverse events data;
proc print data = mylib.i2;
run;

*Disease Specific Antibodies (DSA);
proc print data = mylib.g9;
where redcap_repeat_instrument = "g9_recipient_dsa_specificities";
run;

*Testing the merge;

*Form H1;
proc print data = mylib.h1clean;
run;

data  mylib.h1clean2;
set mylib.h1clean;
rename 	redcap_repeat_instrument = h1_redcap_repeat_instrument;
run;

proc sort data = mylib.h1clean2; by record_id redcap_event_name;
run;

proc print data = mylib.h1clean2;
run;

*calculating the change in scr between observations;
*chrome-extension://efaidnbmnnnibpcajpcglclefindmkaj/https://support.sas.com/resources/papers/proceedings/proceedings/sugi27/p015-27.pdf;

DATA LABS2;   
SET LABS;  
RETAIN OLDDOB;   
BY PATNO;   
IF FIRST.PATNO THEN OLDDOB = DOB;   
ELSE DOB = OLDDOB;   
DROP OLDDOB; 
RUN; 

proc sort data = mylib.h1clean2; by record_id date_scr;
run;

DATA mylib.h1clean2;   
SET mylib.h1clean2;  
RETAIN old_record_id;   
BY record_id;   
IF FIRST.record_id THEN old_record_id = record_id;   
ELSE record_id = old_record_id;   
DROP old_record_id; 
RUN; 

proc print data = mylib.h1clean2;
run;

DATA DIFF2;   
SET LABS2;  
BY PATNO;  
DIFF_HR = HR - LAG(HR);  
*ALTERNATIVE: DIFF_HR = DIF(HR);   
DIFF_SBP = SBP - LAG(SBP);   
DIFF_DBP = DBP - LAG(DBP);   
IF NOT FIRST.PATNO THEN OUTPUT; 
RUN; 

*I slightly modified the logic for the calculation as the first date should be blank;

proc sort data = mylib.h1clean2; by record_id date_scr;
run;

DATA mylib.h1clean2;   
SET mylib.h1clean2;  
BY record_id; 
if FIRST.date_scr then diff_cr_level = .;
else diff_cr_level = cr_level - LAG(cr_level);  
RUN; 

proc print data = mylib.h1clean2;
run;

*Adjusting the values for scr valuation based on David's cde;

*remove recipients with less than 3 months of follow up;
DATA mylib.h1clean2;   
SET mylib.h1clean2;  
BY record_id;
tx_day = day(tx_dt_4);
tx_month = month(tx_dt_4);
tx_year = year(tx_dt_4);

if tx_month in (10,11,12) then do;
	anniv_day = tx_day;
	anniv_month = tx_month + 3 - 12;
	anniv_year = tx_year + 1;
end;

else do;
	anniv_day = tx_day;
	anniv_month = tx_month + 3;
	anniv_year = tx_year;
end;

if anniv_month in (2) and anniv_day >= 28 then anniv_day = 28;
if anniv_month in (4,6,9,11) and anniv_day >= 30 then anniv_day = 30;

format annivdate_3 mmddyy10.;

annivdate_3  = mdy(anniv_month, anniv_day, anniv_year);

format creatdate_ref mmddyy10.;
creatdate_ref = annivdate_3;

/**create time to CGD variable;*/
/**/
/*format censordate_indexbiop mmddyy10.;*/
/*censordate_indexbiop = min(maxfupdate, indexbiop_date_incl);*/
/**/
/*t2indexbiop = censordate_indexbiop - annivdate_3;*/

run;

proc print data = mylib.h1clean2;
run;

DATA mylib.h1clean2;   
SET mylib.h1clean2;  
BY record_id;
if date_scr <= annivdate_3 then delete;

format creatdate_new mmddyy10.;
creatdate_new= date_scr;
creatmgdl_new=	cr_level;
run;

proc print data = mylib.h1clean2;
run;

proc sort data=mylib.h1clean2; by record_id creatdate_new;
run;

/*
DATA mylib.h1clean3;   
SET mylib.h1clean2;  
format first25incr_date creatdate_25incr mmddyy8.;
BY record_id;
	
if first.record_id then do;
	first25incr = 0;
	first25incr_date=.;
	first25incr_mgdl=.;

	creat25incr = 0;
	creatdate_25incr = .;
	creatmgdl_25incr = .;
	t2second = .;
end;

if first25incr = 1 and creat25incr = 0 and (creatdate_new - first25incr_date) > 90 then do; *60 then do;
	first25incr=0;
	first25incr_date=.;
	first25incr_mgdl=.;
end;


if first25incr = 1 and creat25incr = 0 and (creatdate_new - first25incr_date) > 14 and creatmgdl_new >= (creatmgdl_ref*1.25) then do;
	creat25incr = 1;
	creatdate_25incr = creatdate_new;
	creatmgdl_25incr = creatmgdl_new;

	t2second = creatdate_25incr - first25incr_date;
end;

if first25incr = 0 and creatmgdl_new >= (cr_level*1.25) then do;
	first25incr = 1;
	first25incr_date = creatdate_new;
	first25incr_mgdl = creatmgdl_new;
end;


if last.record_id then do;
	output;
end;

run;

proc print data = mylib.h1clean3;
run;
*/

DATA mylib.h1clean3;   
SET mylib.h1clean2;  
format first25incr_date creatdate_25incr mmddyy8.;
BY record_id;
if first.record_id then creatcheck = cr_level*1.25;
output;
if date_scr gt creatdate_new then creatcheck = lag(creatcheck);
run;

proc print data = mylib.h1clean3;
run;	

DATA mylib.h1clean3;   
SET mylib.h1clean2;  
format first25incr_date creatdate_25incr mmddyy8.;
BY record_id;
if first.record_id then first25incr = 0;
if first.record_id then first25incr_date=.;
if first.record_id then first25incr_mgdl=.;
if first.record_id then creat25incr = 0;
if first.record_id then creatdate_25incr = .;
if first.record_id then creatmgdl_25incr = .;
if first.record_id then t2second = .;
run;
	
*Copying the first value to all subsequent observations;
*https://communities.sas.com/t5/SAS-Programming/Copy-first-value-in-variable-to-all-observations-for-each-id/td-p/764521;

DATA mylib.h1clean3;   
SET mylib.h1clean2;  
BY record_id;
if first.record_id then creatcheck = cr_level*1.25;
run;

DATA mylib.h1clean3;   
SET mylib.h1clean3;  
BY record_id;
if first.record_id then _iorc_ = creatcheck;
firstcreatcheck = _iorc_;
run;

proc print data = mylib.h1clean3;
run;	

*The issue was that the creat variables were fed in as character rather than numeric;

proc contents data = mylib.h1clean3;
run;

proc print data = mylib.h1clean3;
where creatmgdl_new gt creatcheck;
title "observations with a 25% increase in creatinine level after 3 months";
run;	

DATA mylib.h1clean3;   
SET mylib.h1clean3; 
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

*Exporting the scr values for Ajay because no PID had an increase gt 25% in scr after 3 months;

proc export 
  data= mylib.h1clean3
  dbms=xlsx 
  outfile="/home/u63327094/analysis_MISSION_01_PS_data_reports/mission_virome_formh1_3monthscrbaseline_25percincreasecheck.xlsx" 
  replace;
run;

*Ajay requested the distribution of the percent increase in creatinine at each subsequent visit;

DATA mylib.h1clean3;   
SET mylib.h1clean3;  
BY record_id;
if first.record_id then _iorc_ = creatmgdl_new;
month3creat = _iorc_;
run;

proc print data = mylib.h1clean3;
run;	

DATA mylib.h1clean3;   
SET mylib.h1clean3;  
BY record_id;
creatpercdiff = ((creatmgdl_new*100)/month3creat)-100;
run;

proc print data = mylib.h1clean3;
where creatpercdiff gt 25;
title "observations with a 25% increase in creatinine level after 3 months";
run;	

*Exporting the scr values for Ajay because no PID had an increase gt 25% in scr after 3 months;

proc export 
  data= mylib.h1clean3
  dbms=xlsx 
  outfile="/home/u63327094/analysis_MISSION_01_PS_data_reports/mission_virome_formh1_3monthscrbaseline_25percincreasecheck_distributiondata.xlsx" 
  replace;
run;

*Summarizing the change in scr;
*The steps above are not working how I would like so I will look into generating a smmary dataset;

/*
 PROC MEANS DATA=LABS2 NWAY NOPRINT;   
 CLASS PATNO;   
 VAR HR SBP DBP;   
 OUTPUT OUT = SUMS(DROP=_TYPE_ RENAME=(_FREQ_=N_VISITS)) N = N_HR N_SBP N_DBP MEAN = M_HR M_SBP M_DBP; 
 RUN; 
 
 PROC MEANS DATA=mylib.g9clean2 NWAY NOPRINT;   
 CLASS record_id;   
 VAR dsa_identified;   
 OUTPUT OUT = SUMS(DROP=_TYPE_ RENAME=(_FREQ_=N_VISITS)) N = N_HR N_SBP N_DBP MEAN = M_HR M_SBP M_DBP; 
 RUN; 

*/
 
 **Solution! Use proc means to get the CV per participant;
*https://blogs.sas.com/content/iml/2014/11/19/coefficient-of-variation.html#:~:text=You%20can%20estimate%20the%20coefficient,is%20on%20the%20percent%20scale.;
proc means data = h2long6months n min max mean std cv;
var tac_trough_num;
by record_id;
run;

*Then save the data into a separate sas dataset;
*https://stackoverflow.com/questions/44072598/output-proc-means-to-a-file-sas-data-table;

proc means data = h2long6months n min max mean std cv;
var tac_trough_num;
by record_id;
output out = tactroughcv mean=mean std=std cv=cv;
run;

proc print data = work.tactroughcv;
run;

proc means data = mylib.h1clean2 mean;
var diff_cr_level;
by record_id;
output out = missionpsscr(DROP=_TYPE_ RENAME=(_FREQ_=no_scr_reported)) mean=mean_change_scr ;
run;

proc print data = work.missionpsscr;
run;

*generating a report form;

options orientation=portrait center number pageno=1 nodate;

ods rtf file="/home/u63327094/analysis_MISSION_01_PS_data_reports/mission_virome_PS_REDCAP_H1.rtf";

proc freq data = mission;
tables record_id*withdrew_consent / nocol norow nopercent;
where withdrew_consent =1;
title "list of participants who withdrew consent";
run;

proc freq data = mission;
tables record_id*study_termination / nocol norow nopercent;
where study_termination =1;
title "list of participants who terminated the study early";
run;

proc print data = mission;
var record_id; 
where f1_mmf_pharmacokinetics_study_vi = 0;
title "List of participants who did not complete a PK study";
run;

DATA mylib.h1clean2;   
SET mylib.h1clean2;  
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

proc means data =mylib.h1clean2 mean min median max ;
var  diff_cr_level;
by record_id;
title "change in serum creatinine levels reported in form H1 (monthly scr levels)";
run;

ods select histogram;
proc univariate data = mylib.h1clean2;
 where diff_cr_level ne . or " ";
 histogram diff_cr_level /normal;
 title "Distribution of the change in monthly serum creatinine levels";
 run; 

proc print data = work.missionpsscr;
title "average change in scr level in the prospective arm";
run;
 
ods rtf close;

proc export 
  data= mylib.h1clean2
  dbms=xlsx 
  outfile="/home/u63327094/analysis_MISSION_01_PS_data_reports/mission_virome_formh1export.xlsx" 
  replace;
run;

options orientation=portrait center number pageno=1 nodate;

ods rtf file="/home/u63327094/analysis_MISSION_01_PS_data_reports/mission_virome_PS_REDCAP_H1_scrchange_3moposttx.rtf";

proc freq data = mission;
tables record_id*withdrew_consent / nocol norow nopercent;
where withdrew_consent =1;
title "list of participants who withdrew consent";
run;

proc freq data = mission;
tables record_id*study_termination / nocol norow nopercent;
where study_termination =1;
title "list of participants who terminated the study early";
run;

proc print data = mission;
var record_id; 
where f1_mmf_pharmacokinetics_study_vi = 0;
title "List of participants who did not complete a PK study";
run;
 
 **Solution! Use proc means to get the CV per participant;
*https://blogs.sas.com/content/iml/2014/11/19/coefficient-of-variation.html#:~:text=You%20can%20estimate%20the%20coefficient,is%20on%20the%20percent%20scale.;
/*proc means data = h2long6months n min max mean std cv;
var tac_trough_num;
by record_id;
run;*/

*Then save the data into a separate sas dataset;
*https://stackoverflow.com/questions/44072598/output-proc-means-to-a-file-sas-data-table;

/*
proc means data = h2long6months n min max mean std cv;
var tac_trough_num;
by record_id;
output out = tactroughcv mean=mean std=std cv=cv;
run;

proc print data = work.tactroughcv;
run;
*/

DATA mylib.h1clean3;   
SET mylib.h1clean3; 
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

proc print data = mylib.h1clean3;
where creatpercdiff gt 25;
title "observations with a 25% increase in creatinine level after 3 months";
run;	

proc means data = mylib.h1clean3 mean std min max median range noprint;
var creatpercdiff;
by record_id;
output out = missionpsscrdiff (DROP=_TYPE_ RENAME=(_FREQ_=no_scr_reported)) mean=mean_change_scr std=standard_dev min=minimum_change max=maximum_change median=median_change range=range ;
run;

proc print data = work.missionpsscrdiff;
title "summary statistics for the change in serum creatinine clearance after 3 months.";
run;

ods select histogram;
proc univariate data = mylib.h1clean3;
 histogram  creatpercdiff/normal;
 title "Distribution of percent change scr values calculated from a 3 month baseline post transplant";
 run; 

ods rtf close;

*Form H3;

proc print data = mylib.h3clean;
run;

proc sort data = mylib.h3clean; by record_id cmp_dt;
run;

data  mylib.h3clean2;
set mylib.h3clean;
rename 	redcap_repeat_instrument = h3_redcap_repeat_instrument;
run;

DATA mylib.h3clean2;   
SET mylib.h3clean2;  
BY record_id; 
if FIRST.cmp_dt then diff_cmp_creatinine = .;
else diff_cmp_creatinine = cmp_creatinine - LAG(cmp_creatinine);  
RUN; 

*Form G9;

proc print data = mylib.g9clean;
where redcap_repeat_instrument = "g9_recipient_dsa_specificities";
run;

data  mylib.g9clean2;
set mylib.g9clean;
where redcap_repeat_instrument = "g9_recipient_dsa_specificities";
rename 	redcap_repeat_instrument = g9_redcap_repeat_instrument;
run;

data  mylib.g9clean2;
set mylib.g9clean2;
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

proc print data = mylib.g9clean2;
where dsa_specificities = 1;
run;

*Creating an indicator variable for having at least one DSA identified by pid;
proc contents data = mylib.g9clean2;
run;

proc sort data = mylib.g9clean2; by record_id dsa_dt;
run;

DATA mylib.g9clean2;   
SET mylib.g9clean2;  
BY record_id; 
if FIRST.record_id then dsa_indicator = dsa_specificities;
else dsa_indicator = dsa_specificities + LAG(dsa_specificities);  
RUN; 

proc print data = mylib.g9clean2;
var record_id redcap_event_name dsa_dt dsa_identified dsa_specificities dsa_indicator;
run;

*The steps above are not working how I would like so I will look into generating a smmary dataset;

 PROC MEANS DATA=LABS2 NWAY NOPRINT;   
 CLASS PATNO;   
 VAR HR SBP DBP;   
 OUTPUT OUT = SUMS(DROP=_TYPE_ RENAME=(_FREQ_=N_VISITS)) N = N_HR N_SBP N_DBP MEAN = M_HR M_SBP M_DBP; 
 RUN; 
 
 PROC MEANS DATA=mylib.g9clean2 NWAY NOPRINT;   
 CLASS record_id;   
 VAR dsa_specificities;   
 OUTPUT OUT = SUMS(DROP=_TYPE_ RENAME=(_FREQ_=frequency)) sum=sum_dsa_events ;
run;
 
 **Solution! Use proc means to get the CV per participant;
*https://blogs.sas.com/content/iml/2014/11/19/coefficient-of-variation.html#:~:text=You%20can%20estimate%20the%20coefficient,is%20on%20the%20percent%20scale.;
proc means data = h2long6months n min max mean std cv;
var tac_trough_num;
by record_id;
run;

proc means data = mylib.g9clean2 sum;
var dsa_identified;
by record_id;
run;

*Then save the data into a separate sas dataset;
*https://stackoverflow.com/questions/44072598/output-proc-means-to-a-file-sas-data-table;

proc means data = h2long6months n min max mean std cv;
var tac_trough_num;
by record_id;
output out = tactroughcv mean=mean std=std cv=cv;
run;

proc print data = work.tactroughcv;
run;

proc means data = mylib.g9clean2 sum;
var dsa_specificities;
by record_id;
output out = missionpsdsa(DROP=_TYPE_ RENAME=(_FREQ_=frequency)) sum=sum_dsa_events ;
run;

proc print data = work.missionpsdsa;
run;
 
*Now listing an indicator variable checking wheter a DSA event occured or not per pid;
 
data work.missionpsdsa;
set work.missionpsdsa;
if sum_dsa_events gt 0 then dsa_event = 1;
else dsa_event = 0;
run;

proc print data = work.missionpsdsa;
run;

proc print data = mylib.g9clean2;
where dsa_specificities = 1;
run;

*generating a report form;

options orientation=portrait center number pageno=1 nodate;

ods rtf file="/home/u63327094/analysis_MISSION_01_PS_data_reports/mission_virome_PS_REDCAP_G9updated.rtf";

proc freq data = mission;
tables record_id*withdrew_consent / nocol norow nopercent;
where withdrew_consent =1;
title "list of participants who withdrew consent";
run;

proc freq data = mission;
tables record_id*study_termination / nocol norow nopercent;
where study_termination =1;
title "list of participants who terminated the study early";
run;

proc print data = mission;
var record_id; 
where f1_mmf_pharmacokinetics_study_vi = 0;
title "List of participants who did not complete a PK study";
run;

data  mylib.g9clean2;
set mylib.g9clean2;
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

/*proc freq data = mylib.g9clean2;
tables dsa_specificities;
run;*/

proc freq data = work.missionpsdsa;
tables dsa_event;
title "number of prospective participants who reported a DSA in the mission study'";
run;

/*proc freq data = mylib.g9clean2;
tables dsa_event;
title "number of prospective participants who reported a DSA in the mission study'";
run;*/

proc means data = mylib.g9clean2 mean std min median max range;
var class1_a_specificities_dsa	class1a_mfi;
where class1_a_specificities_dsa ne . and 	dsa_specificities = 1;
title "descriptive statistics for class1_a dsa data";
run;

ods select histogram;
proc univariate data = mylib.g9clean2;
where class1_a_specificities_dsa ne . and 	dsa_specificities = 1;
 histogram class1_a_specificities_dsa	class1a_mfi/normal;
 title "figure for class1_a dsa data";
 run; 
 
proc means data = mylib.g9clean2 mean std min median max range;
var class1_b_specificities_dsa	class1_b_mfi;
where 	class1_b_specificities_dsa ne . and 	dsa_specificities = 1;
title "descriptive statistics for class1_b dsa data";
run;

ods select histogram;
proc univariate data = mylib.g9clean2;
where 	class1_b_specificities_dsa ne . and 	dsa_specificities = 1;
 histogram 	class1_b_specificities_dsa	class1_b_mfi/normal;
 title "figure for class1_b dsa data";
 run; 

proc means data = mylib.g9clean2 mean std min median max range;
var class1_c_specificities_dsa	class1c_mfi;
where 	class1_c_specificities_dsa ne . and 	dsa_specificities = 1;
title "descriptive statistics for class1_c dsa data";
run;

ods select histogram;
proc univariate data = mylib.g9clean2;
where 	class1_c_specificities_dsa ne . and 	dsa_specificities = 1;
 histogram 	class1_c_specificities_dsa	class1c_mfi/normal;
 title "figure for class1_c dsa data";
 run; 
 
proc means data = mylib.g9clean2 mean std min median max range;
var class1_drb1_speci_dsa	class1_drb1_mfi;
where 	class1_drb1_speci_dsa ne . and 	dsa_specificities = 1;
title "descriptive statistics for class1_drb1 dsa data";
run;

ods select histogram;
proc univariate data = mylib.g9clean2;
where 	class1_drb1_speci_dsa ne . and 	dsa_specificities = 1;
 histogram 	class1_drb1_speci_dsa	class1_drb1_mfi/normal;
 title "figure for class1_drb1 dsa data";
 run; 
 
proc print data = mylib.g9clean2;
where dsa_specificities = 1 and class1_drb1_speci_dsa ne .;
var record_id	redcap_event_name	g9_redcap_repeat_instrument	redcap_repeat_instance	dsa_identified	dsa_dt	dsa_specificities	class1_drb1_speci_dsa	class1_drb1_mfi;
title "please review this entry with Dr. Israni, I cannot use the class1_drb1_mfi as is curently reported as there are multiple entries per field";
run;
 
proc means data = mylib.g9clean2 mean std min median max range;
var class1_dqa1_speci_dsa	class1_dqa1_mfi;
where 	class1_dqa1_speci_dsa ne . and 	dsa_specificities = 1;
title "descriptive statistics for class1_dqa1 dsa data";
run;

ods select histogram;
proc univariate data = mylib.g9clean2;
where 	class1_dqa1_speci_dsa ne . and 	dsa_specificities = 1;
 histogram  class1_dqa1_speci_dsa	class1_dqa1_mfi/normal;
 title "figure for class1_dqa1 dsa data";
 run; 

proc means data = mylib.g9clean2 mean std min median max range;
var class1_dqb1_speci_dsa	class1_dqb1_mfi;
where 	class1_dqb1_speci_dsa ne . and 	dsa_specificities = 1;
title "descriptive statistics for class1_dqb1 dsa data";
run;

ods select histogram;
proc univariate data = mylib.g9clean2;
where 	class1_dqb1_speci_dsa ne . and 	dsa_specificities = 1;
 histogram  class1_dqb1_speci_dsa	class1_dqb1_mfi/normal;
 title "figure for class1_dqb1 dsa data";
 run;  

proc print data = mylib.g9clean2;
where dsa_specificities = 1 and class1_dpa1_speci_dsa ne .;
var record_id	redcap_event_name	g9_redcap_repeat_instrument	redcap_repeat_instance	dsa_identified	dsa_dt	dsa_specificities	class1_dpa1_speci_dsa	class1_dpa1_mfi;
title "please review this entry with Dr. Israni, I cannot use the class1_dpa1_mfi as is curently reported";
run;
 
proc means data = mylib.g9clean2 mean std min median max range;
var class1_dpb1_speci_dsa	class1_dpb1;
where 	class1_dpb1_speci_dsa ne . and 	dsa_specificities = 1;
title "descriptive statistics for class1_dpb1 dsa data";
run;

ods select histogram;
proc univariate data = mylib.g9clean2;
where 	class1_dpb1_speci_dsa ne . and 	dsa_specificities = 1;
 histogram class1_dpb1_speci_dsa	class1_dpb1/normal;
 title "figure for class1_dpb1 dsa data";
 run;  
 
/*proc print data = mylib.g9clean2;
where dsa_identified = 1;
title "please double check the DSA specificities field for PIDS who had a DSA identified";
run;

proc print data = work.missionpsdsa;
title "it looks like all participants except 4002, 4041 and 4042 have had at least 1 DSA reported, so it would not be a good metric for differentiating virome communities"
run;
*/

ods rtf close;

proc export 
  data= mylib.g9clean2
  dbms=xlsx 
  outfile="/home/u63327094/analysis_MISSION_01_PS_data_reports/mission_virome_formg9export.xlsx" 
  replace;
run;

*Form i1;

proc print data = mylib.i1clean;
run;

data  mylib.i1clean2;
set mylib.i1clean;
rename 	redcap_repeat_instrument = i1_redcap_repeat_instrument;
run;

proc print data = mylib.i1clean2;
run;

*Creating an indicator variable for having at least one infection identified by pid;


*The steps above are not working how I would like so I will look into generating a smmary dataset;

 PROC MEANS DATA=LABS2 NWAY NOPRINT;   
 CLASS PATNO;   
 VAR HR SBP DBP;   
 OUTPUT OUT = SUMS(DROP=_TYPE_ RENAME=(_FREQ_=N_VISITS)) N = N_HR N_SBP N_DBP MEAN = M_HR M_SBP M_DBP; 
 RUN; 
 
 PROC MEANS DATA=mylib.g9clean2 NWAY NOPRINT;   
 CLASS record_id;   
 VAR dsa_identified;   
 OUTPUT OUT = SUMS(DROP=_TYPE_ RENAME=(_FREQ_=N_VISITS)) N = N_HR N_SBP N_DBP MEAN = M_HR M_SBP M_DBP; 
 RUN; 
 
**Solution! Use proc freq to get the count for each type of infection per participant;

*Then save the data into a separate sas dataset;
*https://communities.sas.com/t5/SAS-Programming/PROC-FREQ-print-only-count-and-output-to-another-dataset/td-p/200458;

proc freq data = mylib.i1clean2;
table viral_infxn / out = missionpsinfection (keep = record_id viral_infxn count);
by record_id;
run;

proc print data = work.missionpsinfection;
where viral_infxn ne .;
run;

*Generating a report form;

options orientation=portrait center number pageno=1 nodate;

ods rtf file="/home/u63327094/analysis_MISSION_01_PS_data_reports/mission_virome_PS_REDCAP_I1.rtf";

proc freq data = mission;
tables record_id*withdrew_consent / nocol norow nopercent;
where withdrew_consent =1;
title "list of participants who withdrew consent";
run;

proc freq data = mission;
tables record_id*study_termination / nocol norow nopercent;
where study_termination =1;
title "list of participants who terminated the study early";
run;

proc print data = mission;
var record_id; 
where f1_mmf_pharmacokinetics_study_vi = 0;
title "List of participants who did not complete a PK study";
run;

data  mylib.i1clean2;
set mylib.i1clean2;
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

proc freq data = mylib.i1clean2;
tables infxn;
run;

proc print data = mylib.i1clean2;
where infxn = .;
title "no further follow-up needed for this entry at the moment";
run;

proc freq data = mylib.i1clean2;
tables type_infxn viral_infxn;
where infxn = 1;
title "checking the total number of viral infections among all reported infection events, no action needed ";
run;

proc print data = mylib.i1clean2;
var record_id	redcap_event_name cmv_load	cmv_dt	cmv_invasive;
where viral_infxn = 1;
title "CMV infection data, please check the CMV load field for consistent data entry between UMN and HCMC";
run;

proc print data = mylib.i1clean2;
var record_id	redcap_event_name bkv_load	bkv_dt;
where viral_infxn = 3;
title "BKV infection data, please check the BKV load field for consistent data entry between UMN and HCMC";
run;

proc print data = mylib.i1clean2;
var record_id	redcap_event_name other_viral_infxn;
where viral_infxn ge 9;
title "Infection data reported in the other category, please check if there is any additional data for 4019";
run;

proc print data = work.missionpsinfection;
where viral_infxn ne .;
title "summary of viral infections";
run;

ods rtf close;

proc export 
  data= mylib.i1clean2
  dbms=xlsx 
  outfile="/home/u63327094/analysis_MISSION_01_PS_data_reports/mission_virome_formi1export.xlsx" 
  replace;
run;

*Merging the three datasets for virome data;

proc sort data = mylib.h1clean2; by record_id redcap_event_name;
run;

proc sort data = mylib.g9clean2; by record_id redcap_event_name;
run;

proc sort data = mylib.i1clean2; by record_id redcap_event_name;
run;

data h1g9i1virome;
merge mylib.h1clean2 mylib.g9clean2 mylib.i1clean2;
by record_id redcap_event_name;
run;

proc print data = h1g9i1virome;
run;

*how will we build model selection?;

proc print data = h1g9i1virome;
var record_id
run;

*I will go back to our summary statistics and merge by PID;

proc sort data = work.missionpsscr; by record_id;
run;

proc sort data = work.missionpsdsa; by record_id;
run;

proc print data = work.missionpsinfection;
run;

data work.missionpsinfection2;
set work.missionpsinfection;
where viral_infxn ne .;
run;

proc sort data =  work.missionpsinfection2; by record_id;
run;

data summary_scr_dsa_infxn_virome;
merge work.missionpsscr work.missionpsdsa work.missionpsinfection2;
by record_id;
run;

proc print data = summary_scr_dsa_infxn_virome;
run;


*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value	viral_infxnf 1 = "Cytomegalovirus (CMV)" 2 = "Epstein Barr Virus (EBV)" 3 = "BK polyoma virus (BKV)" 4 = "Human papillomavirus (HPV)" 5 = "Hepatitis C virus (HCV)" 6 = "Hepatitis C virus (HBV)" 7 = "Herpes Simplex Virus (HSV)" 8 = "Adenovirus" 9 = "Other" 10 = "Type Unknown/presumed";

run;

data summary_scr_dsa_infxn_virome;
set summary_scr_dsa_infxn_virome;
format	viral_infxn	viral_infxnf.;
run;

proc print data = summary_scr_dsa_infxn_virome;
run;

proc export 
  data= summary_scr_dsa_infxn_virome
  dbms=xlsx 
  outfile="/home/u63327094/analysis_MISSION_01_PS_data_reports/mission_virome_criteria.xlsx" 
  replace;
run;

*****************************************************************************************************************************;
*****************************************************************************************************************************;
*****************************************************************************************************************************;
*****************************************************************************************************************************;

*****************************************************************************************************************************;
*****************************************************************************************************************************;
*****************************************************************************************************************************;
*****************************************************************************************************************************;

*****************************************************************************************************************************;
*****************************************************************************************************************************;
*****************************************************************************************************************************;
*****************************************************************************************************************************;


*Merging the datasets for overimmunosuppressed vs underimmunosuppressed;

*Form H1;

proc print data = mylib.h1clean3;
run;

proc print data = mylib.h1clean3;
where creatpercdiff gt 25;
title "observations with a 25% increase in creatinine level after 3 months";
run;	

proc means data = mylib.h1clean3 mean std min max median range noprint;
var creatpercdiff;
by record_id;
output out = missionpsscrdiff (DROP=_TYPE_ RENAME=(_FREQ_=no_scr_reported)) mean=mean_change_scr std=standard_dev min=minimum_change max=maximum_change median=median_change range=range ;
run;

proc print data = work.missionpsscrdiff;
title "summary statistics for the change in serum creatinine clearance after 3 months.";
run;

ods select histogram;
proc univariate data = mylib.h1clean3;
 histogram  creatpercdiff/normal;
 title "Distribution of percent change scr values calculated from a 3 month baseline post transplant";
 run; 

*Form G9;

proc means data = mylib.g9clean2 sum;
var dsa_specificities;
by record_id;
output out = missionpsdsa(DROP=_TYPE_ RENAME=(_FREQ_=frequency)) sum=sum_dsa_events ;
run;

proc print data = work.missionpsdsa;
run;
 
*Now listing an indicator variable checking wheter a DSA event occured or not per pid;
 
data work.missionpsdsa;
set work.missionpsdsa;
if sum_dsa_events gt 0 then dsa_event = 1;
else dsa_event = 0;
run;

proc print data = work.missionpsdsa;
run;

*Form I1;
**Solution! Use proc freq to get the count for each type of infection per participant;

*Then save the data into a separate sas dataset;
*https://communities.sas.com/t5/SAS-Programming/PROC-FREQ-print-only-count-and-output-to-another-dataset/td-p/200458;

proc print data = mylib.i1clean2;
where viral_infxn ne .;
run;

proc freq data = mylib.i1clean2;
table viral_infxn dt_viral_infxn / out = missionpsinfection (keep = record_id viral_infxn dt_viral_infxn count);
by record_id;
run;

proc print data = work.missionpsinfection;
*where viral_infxn ne .;
run;

*I will go back to our summary statistics and merge by PID;

proc sort data = work.missionpsscrdiff; by record_id;
run;

proc sort data = work.missionpsdsa; by record_id;
run;

proc sort data = work.missionpsinfection; by record_id;
run;

proc print data = work.missionpsinfection;
run;

/*data work.missionpsinfection2;
set work.missionpsinfection;
where viral_infxn ne .;
run;

proc sort data =  work.missionpsinfection2; by record_id;
run;
*/

proc print data = mylib.i1clean2;
where viral_infxn ne .;
run;

data mylib.i1clean3;
set mylib.i1clean2 (keep = record_id redcap_event_name infxn	type_infxn	other_type_infxn	dt_viral_infxn	viral_infxn	cmv_load	cmv_dt	cmv_invasive	ebv_dt	bkv_load	bkv_dt	other_viral_infxn) ;
where viral_infxn ne .;
run;

proc print data = mylib.i1clean3;
run;

proc sort data =  mylib.i1clean3; by record_id;
run;

/*
data summary_scr_dsa_infxn_virome;
merge work.missionpsscrdiff work.missionpsdsa work.missionpsinfection2;
by record_id;
run;
*/

data summary_scr_dsa_infxn_virome;
merge work.missionpsscrdiff work.missionpsdsa mylib.i1clean3;
by record_id;
run;

*Adding transplant date and dsa date the lazy way;

proc print data = mylib.h1clean3;
where redcap_event_name = "month_6_followup_arm_1" and redcap_repeat_instance = 4;
run;

/*
data mylib.h1clean4;
set mylib.h1clean3;
where redcap_event_name = "month_6_followup_arm_1" and redcap_repeat_instance = 4;
keep record_id tx_dt_4;
run;
*/

proc print data = mylib.b3clean;
run;

data mylib.b3clean2;
set mylib.b3clean;
keep record_id tx_dt;
run;

proc sort data = mylib.b3clean2;
by record_id;
run;

proc print data = mylib.g9clean2;
where dsa_specificities = 1;
run;

data mylib.g9clean3;
set mylib.g9clean2;
where dsa_specificities = 1;
run;

proc sort data = mylib.g9clean3;
by record_id dsa_dt;
run;	

data mylib.g9clean3;
set mylib.g9clean3;
by record_id;
if first.record_id then check = 1;
run;

proc print data = mylib.g9clean3;
run;

data mylib.g9clean4;
set mylib.g9clean3;
where check = 1;
keep record_id	dsa_identified	dsa_dt	dsa_specificities;	
run;

proc print data = mylib.g9clean4;
run;

data summary_scr_dsa_infxn_virome;
merge summary_scr_dsa_infxn_virome mylib.b3clean2 mylib.g9clean4;
by record_id;
run;

proc print data = summary_scr_dsa_infxn_virome;
run;


*Formating the variable values (https://stats.oarc.ucla.edu/sas/modules/labeling/);
*some variables such as malignancies will need to have the variable format edited instead of the value format edited; 
proc format;
value	viral_infxnf 1 = "Cytomegalovirus (CMV)" 2 = "Epstein Barr Virus (EBV)" 3 = "BK polyoma virus (BKV)" 4 = "Human papillomavirus (HPV)" 5 = "Hepatitis C virus (HCV)" 6 = "Hepatitis C virus (HBV)" 7 = "Herpes Simplex Virus (HSV)" 8 = "Adenovirus" 9 = "Other" 10 = "Type Unknown/presumed";

run;

data summary_scr_dsa_infxn_virome;
set summary_scr_dsa_infxn_virome;
format	viral_infxn	viral_infxnf.;
run;

proc print data = summary_scr_dsa_infxn_virome;
run;

*Creating an algorithm for over vs under IS;
data summary_scr_dsa_infxn_virome;
set summary_scr_dsa_infxn_virome;
if maximum_change ge 25 then check_scr = 1; else check_scr = 0;
if dsa_event = 1 then check_dsa = 1; else check_dsa = 0;
if viral_infxn ne . then check_viral = 1; else check_viral = 0; 
run;

data summary_scr_dsa_infxn_virome;
set summary_scr_dsa_infxn_virome;
check_UIS = check_scr + check_dsa;
check_OIS = check_viral;
check_EIS = check_scr + check_dsa + check_viral;
run;

data summary_scr_dsa_infxn_virome;
set summary_scr_dsa_infxn_virome;
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

proc freq data = summary_scr_dsa_infxn_virome;
table check_UIS check_OIS check_EIS;
run;

proc print data = summary_scr_dsa_infxn_virome;
run;

*Exportting the dataset while keeping the labels;
*https://communities.sas.com/t5/SAS-Programming/Preserving-labels-when-using-PROC-EXPORT/td-p/302764;

proc export 
  data= summary_scr_dsa_infxn_virome
  dbms=xlsx
  outfile="/home/u63327094/analysis_MISSION_01_PS_data_reports/mission_virome_criteria.xlsx"
  label
  replace;
run;

*Trying out ODS excel;
*https://communities.sas.com/t5/SAS-Programming/Export-a-Excel-file-using-variable-label-name-and-display-value/td-p/571886;

ods excel file="/home/u63327094/analysis_MISSION_01_PS_data_reports/mission_virome_criteria_labeled_2.xlsx";

proc print data = summary_scr_dsa_infxn_virome label;
run;

ods excel close;

ods excel file="/home/u63327094/analysis_MISSION_01_PS_data_reports/mission_virome_scr_date.xlsx";

proc print data = mylib.h1clean3;
where creatpercdiff gt 25;
title "observations with a 25% increase in creatinine level after 3 months";
run;

ods excel close;

*****************************************************************************************************************************;
*****************************************************************************************************************************;
*****************************************************************************************************************************;
*****************************************************************************************************************************;

*Simple proc tabulate code;
*https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/proc/p0nug0r42bnz2cn1k9n16siq2t69.htm;
*chrome-extension://efaidnbmnnnibpcajpcglclefindmkaj/https://www.lexjansen.com/nesug/nesug06/dm/da05.pdf;

data onerectest_toshare_ps;
set onerectest_toshare_ps;
label 
age = "Recipient Age at time of transplant"
predom_race ="Predominant Race, select one"
donor_type ="Type of current kidney donor"
;
run;

*Formating the variables;
proc format;
value predom_racef 1="White" 2="Black or African American" 3="Asian" 4="American Indian or Alaska  Native" 5="Native Hawaiian or other Pacific Islander" 6="Unknown" 7="Not Reported";
value donor_typef 1="Living donor" 2="Deceased donor"; 
run;

data onerectest_toshare_ps;
set onerectest_toshare_ps;
format predom_race_2 predom_racef.;
format donor_type donor_typef.; 
run;

proc tabulate data=onerectest_toshare_ps;
   class donor_type predom_race_2 diabetes_pretx;
   var age_at_pk ;
   table donor_type='Kidney Donor Type'*predom_race_2='Recipient race', age_at_pk='participant age at PK visit'*(N MEAN STD) / 
         rts=20;
 title 'mean age of study participants at time of PK study, stratified by kidney donor type and recipient race';
run;

*****************************************************************************************************************************;
*****************************************************************************************************************************;
*****************************************************************************************************************************;
*****************************************************************************************************************************;

