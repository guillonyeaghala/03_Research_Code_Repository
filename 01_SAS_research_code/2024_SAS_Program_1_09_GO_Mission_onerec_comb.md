*Macro Basics;
*https://support.sas.com/resources/papers/proceedings/proceedings/sugi29/243-29.pdf;

*As you construct macro programs, you will use two basic building blocks: macros and macro variables.
 You can tell them apart because the names of macro variables start with an ampersand (&), while the names of macros start with a percent sign (%).
 1 A macro variable is like a standard data variable except that it does not belong to a data set and has only a single value which is always character. The value of a macro variable could be a variable name, a numeral, or any text you want substituted in your program. 
 A macro, however, is a larger piece of a program that can contain complex logic including complete DATA and PROC steps, and macro statements such as %IF-%THEN/%ELSE and %DO-%END. Macros often —but not always—contain macro variables.;
 
*Macro variables come in two varieties: either local or global. 
A macro variable’s scope is local if it is defined inside a macro.
Its scope is global if it is defined in “open code” which is everything outside a macro. 
You can use a global macro variable anywhere in your program, but you can use a local macro variable only inside its own macro:

*%LET is a straightforward macro statement that simply assigns a value to a macro variable. 
Suppose you have a program that you run once a month. 
Every time you have to edit the program so it will select data for the correct month and print the correct title. This is time-consuming and prone to errors. 
You can use %LET to create a macro variable. Then you can change the value of the macro variable in the %LET statement, and SAS will repeat the new value throughout your program;

*The general form a %LET statement is

%LET macro-variable-name = value;

*where macro-variable-name is a name you make up following the standard rules for SAS names.
Value is the text to be substituted for the macro variable name
The following statement create a macro variable.

%LET winner = Lance Armstrong; 

*Notice that there are no quotation marks around value even when it contains characters. 
Blanks at the beginning and end will be trimmed, and everything else between the equal sign and semicolon will become part of the value for the macro variable;

*To use the macro variable, you simply add the ampersand prefix (&) and stick the macro variable name wherever you want its value to be substituted;

TITLE “First: &winner”;

*After being resolved by the macro processor, this statement would become;

TITLE “First: Lance Armstrong”;

*CREATING MODULAR CODE WITH MACROS
Anytime you find yourself repeating the same program statements over and over, you might want to consider creating a
macro instead. Macros are simply a group of SAS statements that have a name. And, anytime you want that group of
statements in your program, you use the name instead of the re-typing all the statements.
The general form of a macro is;

%MACRO macro-name;
 macro-text
%MEND macro-name;

*The %MACRO statement tells SAS that this is the beginning of the macro.
the %MEND statement signals the end of the macro. 
Macro-name is a name you make up for your macro. 
You don’t need to specify the macro-name in the %MEND statement, but it will make your programs easier to understand if you include it. 
Macro-text represents the SAS statements that you want in your macro;

*After you define your macro, you need to invoke it when you want to use it. 
Do this by adding a percent sign in front of the macro-name like this;

"%macro-name"

/*While you do not need to end this statement with a semicolon, it generally does no harm either*/

/* Example

Looking at the bicycle models data, the sales personnel like to have lists of models sorted both by model name and by price. 
The following program creates a macro named PRINTIT that has the PROC PRINT statements you need for the report. 
Then the program calls the macro twice; first without sorting the data (it is already sorted by model name), and then after executing a PROC SORT by Price.*/

%MACRO printit;

PROC PRINT DATA = models NOOBS;
 TITLE 'Current Models';
 VAR Model Class Frame Price;
 FORMAT Price DOLLAR6.;
RUN;
%MEND printit;

/*The first PROC PRINT is generated by the first call to the PRINTIT macro, the PROC SORT comes from the original program*/

%printit;

/*Here are the standard SAS statements that are generated by the macro processor.*/

PROC PRINT DATA = models NOOBS;
 TITLE 'Current Models';
 VAR Model Class Frame Price;
 FORMAT Price DOLLAR6.;
RUN;

/*The second PROC PRINT is generated by the second call to the PRINTIT macro*/

PROC SORT DATA = models;
 BY Price;

%printit;

/*Here are the standard SAS statements that are generated by the macro processor.*/

PROC SORT DATA = models;
 BY Price;

PROC PRINT DATA = models NOOBS;
 TITLE 'Current Models';
 VAR Model Class Frame Price;
 FORMAT Price DOLLAR6.;
RUN;

/*ADDING PARAMETERS TO MACROS*/

/*Macros allow you to execute a set of SAS statements with just one statement, and while this alone can be helpful, macros
are even more powerful when you add parameters to them. Parameters are macro variables whose values are set when
you invoke the macro. Parameters give your macros flexibility.*/

/*To add parameters to your macro, simply list the macro-variable names followed by an equal sign in parentheses after the macro name:*/

%MACRO macro-name (parameter-1=, parameter-2=, . . . parameter-n=);
 macro-text
%MEND macro-name;

/*For example, if you have a macro named %MONTHLYREPORT that has parameters for the month and region, it might start like this:*/

%MACRO monthlyreport (month=, region=);

/*Then when you invoke the macro, specify the values for the macro variables after the equal signs:*/
/*Because these macro variables are defined in the macro, they are, by default, local to the macro and you cannot use them in any SAS statements outside the macro*/

%monthlyreport (month=May, region=West);

/*Example*/

/*The PRINTIT macro from the previous example prints the desired reports, but you have to sort the data between calls to the
macro and the title does not reflect the sort order of the report. This new macro, SORTANDPRINT includes the PROC SORT
statements and adds parameters so that you can vary both the sort variable and the sort sequence (descending or not).
Then the macro variables are added to a TITLE statement, so the report states how it is sorted. There are two calls to the
macro, producing two reports.*/

/*For sortvar enter the variable for sorting the report. For sortseq use either Descending or do not enter a value for an ascending sequence;*/

%MACRO sortandprint(sortseq=, sortvar=);
PROC SORT DATA = models;
 BY &sortseq &sortvar;
PROC PRINT DATA = models NOOBS;
 TITLE 'Current Models';
 TITLE2 "Sorted by &sortseq &sortvar";
 VAR Model Class Frame Price;
 FORMAT Price DOLLAR6.;
RUN;
%MEND sortandprint;

/*The first call to the macro gives the &SORTSEQ macro variable the value DESCENDING and the &SORTVAR macro
variable the value Price. So the statements generated by this call will sort the data by descending values of the variable
Price.*/ 

%sortandprint(sortseq=Descending, sortvar=Price);

/*Here are the SAS statements that are generated by the macro processor:*/

PROC SORT DATA = models;
BY Descending Price;
PROC PRINT DATA = models NOOBS;
TITLE 'Current Models';
TITLE2 "Sorted by Descending Price";
VAR Model Class Frame Price;
FORMAT Price DOLLAR6.;
RUN;

/*The second call to the macro gives &SORTSEQ no value and &SORTVAR the value Class. So this call will produce
statements that sort the data by ascending (the default) Class.*/

%sortandprint(sortseq=, sortvar=Class);

/*Here are the SAS statements that are generated by the macro processor:*/

PROC SORT DATA = models;
BY Class;
PROC PRINT DATA = models NOOBS;
TITLE 'Current Models';
TITLE2 "Sorted by Class";
VAR Model Class Frame Price;
FORMAT Price DOLLAR6.;
RUN;

/*MPRINT system option*/

/*We have been showing you what SAS sees after the macro processor has resolved your program, but normally you won’t
see these statements. However if you specify the MPRINT sys tem option in your program, then SAS will print the resolved
statements from macros in the SAS log. This can be very useful for debugging purposes. To turn on the MPRINT option,
submit an OPTIONS statement like this:*/

OPTIONS MPRINT;

**********************************************************************************************************************************************;
**********************************************************************************************************************************************;
**********************************************************************************************************************************************;

*Importing the mapping file data for the shotgun data;

libname mylib "/home/u63327094/analysis_MISSION_16S_Shotgun_TAC_Analysis";

*CSV and XLSX file imports;

proc import 
datafile= '/home/u63327094/analysis_MISSION_16S_Shotgun_TAC_Analysis/Shotgun_list_HUMANN_sorting_V4.csv'
out=mylib.shotgunlist
dbms=CSV	
replace;
getnames=yes;
run;

proc import 
datafile= '/home/u63327094/analysis_MISSION_16S_Shotgun_TAC_Analysis/mission_demo_cs_toshare_03012024_noexclusion.xlsx'
out=mylib.missiondemocs
dbms=XLSX	
replace;
getnames=yes;
run;

proc import 
datafile= '/home/u63327094/analysis_MISSION_16S_Shotgun_TAC_Analysis/mission_demo_ps_toshare_03012024_noexclusion.xlsx'
out=mylib.missiondemops
dbms=XLSX	
replace;
getnames=yes;
run;

*checking the variables from the missiondemocs;

data missiondemocs;
set mylib.missiondemocs;
run;

proc contents data = missiondemocs;
run;

proc print data = missiondemocs;
var record_id 
stool_mb_collect_time_baseline_a	
stool_mb_collectdt_baseline_and_
stool_mb_rcvd_lab_date_baseline_
stool_mb_rcvd_lab_time_baseline_;
run;

data missiondemocs;
set missiondemocs;
stool_collect_date = stool_mb_collectdt_baseline_and_;
stool_collect_time = stool_mb_collect_time_baseline_a;
lab_recvd_date = stool_mb_rcvd_lab_date_baseline_;
lab_recvd_time = stool_mb_rcvd_lab_time_baseline_;
run;

data missiondemocs;
set missiondemocs;
format stool_collect_date YYMMDD10.;
format stool_collect_time TIME18.;
format lab_recvd_date YYMMDD10.;
format lab_recvd_time TIME18.;
run;

proc print data = missiondemocs;
var record_id 
stool_mb_collect_time_baseline_a	
stool_mb_collectdt_baseline_and_
stool_mb_rcvd_lab_date_baseline_
stool_mb_rcvd_lab_time_baseline_
stool_collect_date
stool_collect_time
lab_recvd_date
lab_recvd_time;
run;

data missiondemocstomerge;
set missiondemocs;
keep record_id
stool_collect_date
stool_collect_time
lab_recvd_date
lab_recvd_time;
run;

*checking the variables from the missiondemops;

data missiondemops;
set mylib.missiondemops;
run;

proc contents data = missiondemops;
run;

proc print data = missiondemops;
var record_id 
stool_mb_collect_time_baseline_a
stool_mb_collect_time_month_2_du
stool_mb_collect_time_month_4_fo
stool_mb_collect_time_month_6_fo
stool_mb_collect_time_pharmacoki
stool_mb_collectdt_baseline_and_
stool_mb_collectdt_month_2_due_t
stool_mb_collectdt_month_4_follo
stool_mb_collectdt_month_6_follo
stool_mb_collectdt_pharmacokinet
stool_mb_rcvd_lab_date_baseline_
stool_mb_rcvd_lab_date_month_2_d
stool_mb_rcvd_lab_date_month_4_f
stool_mb_rcvd_lab_date_month_6_f
stool_mb_rcvd_lab_date_pharmacok
stool_mb_rcvd_lab_time_baseline_
stool_mb_rcvd_lab_time_month_2_d
stool_mb_rcvd_lab_time_month_4_f
stool_mb_rcvd_lab_time_month_6_f
stool_mb_rcvd_lab_time_pharmacok;
run;

**Doing a quick merge in order to create the new variable timepoints;

data missiondemopstomerge;
set missiondemops;
keep record_id
stool_mb_collect_time_baseline_a
stool_mb_collect_time_month_2_du
stool_mb_collect_time_month_4_fo
stool_mb_collect_time_month_6_fo
stool_mb_collect_time_pharmacoki
stool_mb_collectdt_baseline_and_
stool_mb_collectdt_month_2_due_t
stool_mb_collectdt_month_4_follo
stool_mb_collectdt_month_6_follo
stool_mb_collectdt_pharmacokinet
stool_mb_rcvd_lab_date_baseline_
stool_mb_rcvd_lab_date_month_2_d
stool_mb_rcvd_lab_date_month_4_f
stool_mb_rcvd_lab_date_month_6_f
stool_mb_rcvd_lab_date_pharmacok
stool_mb_rcvd_lab_time_baseline_
stool_mb_rcvd_lab_time_month_2_d
stool_mb_rcvd_lab_time_month_4_f
stool_mb_rcvd_lab_time_month_6_f
stool_mb_rcvd_lab_time_pharmacok;
run;

proc sort data = missiondemopstomerge;
by record_id;
run;

data shotgunlist;
set mylib.shotgunlist;
var_check = 1;
run;

proc sort data = shotgunlist;
by record_id;
run;

data shotgunlistps;
merge shotgunlist missiondemopstomerge;
by record_id;
run;

proc print data = shotgunlistps;
var record_id
month
stool_mb_collect_time_baseline_a
stool_mb_collect_time_month_2_du
stool_mb_collect_time_month_4_fo
stool_mb_collect_time_month_6_fo
stool_mb_collect_time_pharmacoki
stool_mb_collectdt_baseline_and_
stool_mb_collectdt_month_2_due_t
stool_mb_collectdt_month_4_follo
stool_mb_collectdt_month_6_follo
stool_mb_collectdt_pharmacokinet
stool_mb_rcvd_lab_date_baseline_
stool_mb_rcvd_lab_date_month_2_d
stool_mb_rcvd_lab_date_month_4_f
stool_mb_rcvd_lab_date_month_6_f
stool_mb_rcvd_lab_date_pharmacok
stool_mb_rcvd_lab_time_baseline_
stool_mb_rcvd_lab_time_month_2_d
stool_mb_rcvd_lab_time_month_4_f
stool_mb_rcvd_lab_time_month_6_f
stool_mb_rcvd_lab_time_pharmacok;
run;

proc print data = shotgunlistps;
var record_id
month
stool_mb_collect_time_pharmacoki
stool_mb_collectdt_pharmacokinet
stool_mb_rcvd_lab_date_pharmacok
stool_mb_rcvd_lab_time_pharmacok;
where month = "PK" or month = "pk";
run;

data shotgunlistps;
set shotgunlistps;
if month = "PK" then stool_collect_date = stool_mb_collectdt_pharmacokinet;
if month = "pk" then stool_collect_date = stool_mb_collectdt_pharmacokinet;
if month = "PK" then stool_collect_time = stool_mb_collect_time_pharmacoki;
if month = "pk" then stool_collect_time = stool_mb_collect_time_pharmacoki;
if month = "PK" then lab_recvd_date = stool_mb_rcvd_lab_date_pharmacok;
if month = "pk" then lab_recvd_date = stool_mb_rcvd_lab_date_pharmacok;
if month = "PK" then lab_recvd_time = stool_mb_rcvd_lab_time_pharmacok;
if month = "pk" then lab_recvd_time = stool_mb_rcvd_lab_time_pharmacok;
if month = "M1" then stool_collect_date = stool_mb_collectdt_baseline_and_;
if month = "M1" then stool_collect_time = stool_mb_collect_time_baseline_a;
if month = "M1" then lab_recvd_date = stool_mb_rcvd_lab_date_baseline_;
if month = "M1" then lab_recvd_time = stool_mb_rcvd_lab_time_baseline_;
if month = "M2" then stool_collect_date = stool_mb_collectdt_month_2_due_t;
if month = "M2" then stool_collect_time = stool_mb_collect_time_month_2_du;
if month = "M2" then lab_recvd_date = stool_mb_rcvd_lab_date_month_2_d;
if month = "M2" then lab_recvd_time = stool_mb_rcvd_lab_time_month_2_d;
if month = "M4" then stool_collect_date = stool_mb_collectdt_month_4_follo;
if month = "M4" then stool_collect_time = stool_mb_collect_time_month_4_fo;
if month = "M4" then lab_recvd_date = stool_mb_rcvd_lab_date_month_4_f;
if month = "M4" then lab_recvd_time = stool_mb_rcvd_lab_time_month_4_f;
if month = "M6" then stool_collect_date = stool_mb_collectdt_month_6_follo;
if month = "M6" then stool_collect_time = stool_mb_collect_time_month_6_fo;
if month = "M6" then lab_recvd_date = stool_mb_rcvd_lab_date_month_6_f;
if month = "M6" then lab_recvd_time = stool_mb_rcvd_lab_time_month_6_f;
run;

data shotgunlistps;
set shotgunlistps;
format stool_collect_date YYMMDD10.;
format stool_collect_time TIME18.;
format lab_recvd_date YYMMDD10.;
format lab_recvd_time TIME18.;
run;

proc print data = shotgunlistps;
var record_id 
/*stool_mb_collect_time_baseline_a	
stool_mb_collectdt_baseline_and_
stool_mb_rcvd_lab_date_baseline_
stool_mb_rcvd_lab_time_baseline_*/
stool_collect_date
stool_collect_time
lab_recvd_date
lab_recvd_time;
run;

data shotgunlistpstomerge;
set shotgunlistps;
drop 
stool_mb_collect_time_baseline_a
stool_mb_collect_time_month_2_du
stool_mb_collect_time_month_4_fo
stool_mb_collect_time_month_6_fo
stool_mb_collect_time_pharmacoki
stool_mb_collectdt_baseline_and_
stool_mb_collectdt_month_2_due_t
stool_mb_collectdt_month_4_follo
stool_mb_collectdt_month_6_follo
stool_mb_collectdt_pharmacokinet
stool_mb_rcvd_lab_date_baseline_
stool_mb_rcvd_lab_date_month_2_d
stool_mb_rcvd_lab_date_month_4_f
stool_mb_rcvd_lab_date_month_6_f
stool_mb_rcvd_lab_date_pharmacok
stool_mb_rcvd_lab_time_baseline_
stool_mb_rcvd_lab_time_month_2_d
stool_mb_rcvd_lab_time_month_4_f
stool_mb_rcvd_lab_time_month_6_f
stool_mb_rcvd_lab_time_pharmacok;
run;

proc sort data = shotgunlistpstomerge;
by record_id;
run;

proc sort data = missiondemocstomerge;
by record_id;
run;

data shotgun_list_ps_cs;
merge shotgunlistpstomerge missiondemocstomerge;
by record_id;
run;

proc print data = shotgun_list_ps_cs;
run;

*exporting the data as a mapping files for shotgun alpha and beta diversity analysis;

proc export 
  data= shotgun_list_ps_cs
  dbms=csv
  outfile="/home/u63327094/analysis_MISSION_16S_Shotgun_TAC_Analysis/Shotgun_list_HUMANN_sorting_collection_date_time_V5.csv" 
  replace;
run;

*************************************************************************************************************************************
*************************************************************************************************************************************
*************************************************************************************************************************************;

*libname mylib "\\CDRG-FS-P03\Projects\Dr. Israni Projects\DeKAF\MISSION study\Raw_data";
libname mylib "D:\ROOK_03_Professional\HHRI\16_Mission_Redcap_Prospective_Cross-sectional\Datasets\MISSION_Redcap_MAR2023";

*You will need to upload the files to the SAS studio server directly;
*Right click on the folder location and select properties to copy the path name;

libname mylib "/home/u63327094/analysis_MISSION_comb_data_reports";

*This is the CSV file for mapping the samples to timepoint;
proc import 
datafile= '/home/u63327094/analysis_MISSION_comb_data_reports/Shotgun_list_HUMANN_sorting_collection_date_time_V10.csv'
out=mylib.shotgunlist
dbms=csv
replace;
getnames=yes;
guessingrows=9999;
run;

*Here are the files for the mission PS and CS for merging;

data missionps;
set mylib.onerectest_ps_toshare;
run;

proc print data = missionps;
run;

data missioncs;
set mylib.onerectest_cs_toshare;
run;

proc print data = missioncs;
run;

data shotgunlist;
set mylib.shotgunlist;
run;

proc print data = shotgunlist;
run;

*************************************************************************************************************************************
*************************************************************************************************************************************
*************************************************************************************************************************************;

*Merging each mission dataset with the shotgun list so that I can filter by PK date;

proc sort data = shotgunlist;
by record_id;
run;

data missioncs;
set missioncs;
age_at_diabetic_pretx_2 = input(age_at_diabetic_pretx, 8.);
kdpi_2 = input(kdpi, 8.);
initial_dialysis_2 = input(initial_dialysis, 8.);
study_termination_2 = input(study_termination, 8.);
reason_study_terminatn_2 = input(reason_study_terminatn, 8.);
mpd_dt_2 = input(mpd_dt, 8.);
mpd_continue_study_2 = input(mpd_continue_study, 8.);
run;

data missioncs;
set missioncs;
drop 
age_at_diabetic_pretx
kdpi
initial_dialysis
class1_a_value_1
class1_a_value_2
class1_a_value_3
class1_a_value_4
class1_a_value_5
class1_a_value_6
class1_a_value_7
class1_a_value_8
class1_a_value_9
class1_a_value_10
class1_a_value_11
class1_a_value_12
class1_a_value_13
class1_a_value_14
class1_a_value_15
class1_a_value_16
class1_a_value_17
class1_a_value_18
class1_a_value_19
class1_a_value_20
class1_a_value_21
class1_a_value_22
class1_a_value_23
class1_a_value_24
class1_a_value_25
class1_a_value_26
class1_a_value_27
class1_a_value_28
class1_a_value_29
class1_a_value_30
class1_a_value_31
class1_a_value_32
class1_a_value_33
class1_a_value_34
class1_a_value_35
class1_a_value_36
class1_a_value_37
class1_a_value_38
class1_a_value_39
class1_a_value_40
class1_b_specificities_value_1
class1_b_specificities_value_2
class1_b_specificities_value_3
class1_b_specificities_value_4
class1_b_specificities_value_5
class1_b_specificities_value_6
class1_b_specificities_value_7
class1_b_specificities_value_8
class1_b_specificities_value_9
class1_b_specificities_value_10
class1_b_specificities_value_11
class1_b_specificities_value_12
class1_b_specificities_value_13
class1_b_specificities_value_14
class1_b_specificities_value_15
class1_b_specificities_value_16
class1_b_specificities_value_17
class1_b_specificities_value_18
class1_b_specificities_value_19
class1_b_specificities_value_20
class1_b_specificities_value_21
class1_b_specificities_value_22
class1_b_specificities_value_23
class1_b_specificities_value_24
class1_b_specificities_value_25
class1_b_specificities_value_26
class1_b_specificities_value_27
class1_b_specificities_value_28
class1_b_specificities_value_29
class1_b_specificities_value_30
class1_b_specificities_value_31
class1_b_specificities_value_32
class1_b_specificities_value_33
class1_b_specificities_value_34
class1_b_specificities_value_35
class1_b_specificities_value_36
class1_b_specificities_value_37
class1_b_specificities_value_38
class1_b_specificities_value_39
class1_b_specificities_value_40
class1_dp_specificities_value_1
class1_dp_specificities_value_2
class1_dp_specificities_value_3
class1_dp_specificities_value_4
class1_dp_specificities_value_5
class1_dp_specificities_value_6
class1_dp_specificities_value_7
class1_dp_specificities_value_8
class1_dp_specificities_value_9
class1_dp_specificities_value_10
class1_dp_specificities_value_11
class1_dp_specificities_value_12
class1_dp_specificities_value_13
class1_dp_specificities_value_14
class1_dp_specificities_value_15
class1_dp_specificities_value_16
class1_dp_specificities_value_17
class1_dp_specificities_value_18
class1_dp_specificities_value_19
class1_dp_specificities_value_20
class1_dp_specificities_value_21
class1_dp_specificities_value_22
class1_dp_specificities_value_23
class1_dp_specificities_value_24
class1_dp_specificities_value_25
class1_dp_specificities_value_26
class1_dp_specificities_value_27
class1_dp_specificities_value_28
class1_dp_specificities_value_29
class1_dp_specificities_value_30
class1_dp_specificities_value_31
class1_dp_specificities_value_32
class1_dp_specificities_value_33
class1_dp_specificities_value_34
class1_dp_specificities_value_35
class1_dp_specificities_value_36
class1_dp_specificities_value_37
class1_dp_specificities_value_38
class1_dp_specificities_value_39
class1_dp_specificities_value_40
class1_dr_specificities_value_1
class1_dr_specificities_value_2
class1_dr_specificities_value_3
class1_dr_specificities_value_4
class1_dr_specificities_value_5
class1_dr_specificities_value_6
class1_dr_specificities_value_7
class1_dr_specificities_value_8
class1_dr_specificities_value_9
class1_dr_specificities_value_10
class1_dr_specificities_value_11
class1_dr_specificities_value_12
class1_dr_specificities_value_13
class1_dr_specificities_value_14
class1_dr_specificities_value_15
class1_dr_specificities_value_16
class1_dr_specificities_value_17
class1_dr_specificities_value_18
class1_dr_specificities_value_19
class1_dr_specificities_value_20
class1_dr_specificities_value_21
class1_dr_specificities_value_22
class1_dr_specificities_value_23
class1_dr_specificities_value_24
class1_dr_specificities_value_25
class1_dr_specificities_value_26
class1_dr_specificities_value_27
class1_dr_specificities_value_28
class1_dr_specificities_value_29
class1_dr_specificities_value_30
class1_dr_specificities_value_31
class1_dr_specificities_value_32
class1_dr_specificities_value_33
class1_dr_specificities_value_34
class1_dr_specificities_value_35
class1_dr_specificities_value_36
class1_dr_specificities_value_37
class1_dr_specificities_value_38
class1_dr_specificities_value_39
class1_dr_specificities_value_40
study_termination
reason_study_terminatn
mpd_dt
mpd_continue_study;
run;

data missionps;
set missionps;
age_at_diabetic_pretx_2 = input(age_at_diabetic_pretx, 8.);
kdpi_2 = input(kdpi, 8.);
initial_dialysis_2 = input(initial_dialysis, 8.);
study_termination_2 = input(study_termination, 8.);
reason_study_terminatn_2 = input(reason_study_terminatn, 8.);
mpd_dt_2 = input(mpd_dt, 8.);
mpd_continue_study_2 = input(mpd_continue_study, 8.);
run;

data missionps;
set missionps;
drop 
age_at_diabetic_pretx
kdpi
initial_dialysis
class1_a_value_1
class1_a_value_2
class1_a_value_3
class1_a_value_4
class1_a_value_5
class1_a_value_6
class1_a_value_7
class1_a_value_8
class1_a_value_9
class1_a_value_10
class1_a_value_11
class1_a_value_12
class1_a_value_13
class1_a_value_14
class1_a_value_15
class1_a_value_16
class1_a_value_17
class1_a_value_18
class1_a_value_19
class1_a_value_20
class1_a_value_21
class1_a_value_22
class1_a_value_23
class1_a_value_24
class1_a_value_25
class1_a_value_26
class1_a_value_27
class1_a_value_28
class1_a_value_29
class1_a_value_30
class1_a_value_31
class1_a_value_32
class1_a_value_33
class1_a_value_34
class1_a_value_35
class1_a_value_36
class1_a_value_37
class1_a_value_38
class1_a_value_39
class1_a_value_40
class1_b_specificities_value_1
class1_b_specificities_value_2
class1_b_specificities_value_3
class1_b_specificities_value_4
class1_b_specificities_value_5
class1_b_specificities_value_6
class1_b_specificities_value_7
class1_b_specificities_value_8
class1_b_specificities_value_9
class1_b_specificities_value_10
class1_b_specificities_value_11
class1_b_specificities_value_12
class1_b_specificities_value_13
class1_b_specificities_value_14
class1_b_specificities_value_15
class1_b_specificities_value_16
class1_b_specificities_value_17
class1_b_specificities_value_18
class1_b_specificities_value_19
class1_b_specificities_value_20
class1_b_specificities_value_21
class1_b_specificities_value_22
class1_b_specificities_value_23
class1_b_specificities_value_24
class1_b_specificities_value_25
class1_b_specificities_value_26
class1_b_specificities_value_27
class1_b_specificities_value_28
class1_b_specificities_value_29
class1_b_specificities_value_30
class1_b_specificities_value_31
class1_b_specificities_value_32
class1_b_specificities_value_33
class1_b_specificities_value_34
class1_b_specificities_value_35
class1_b_specificities_value_36
class1_b_specificities_value_37
class1_b_specificities_value_38
class1_b_specificities_value_39
class1_b_specificities_value_40
class1_dp_specificities_value_1
class1_dp_specificities_value_2
class1_dp_specificities_value_3
class1_dp_specificities_value_4
class1_dp_specificities_value_5
class1_dp_specificities_value_6
class1_dp_specificities_value_7
class1_dp_specificities_value_8
class1_dp_specificities_value_9
class1_dp_specificities_value_10
class1_dp_specificities_value_11
class1_dp_specificities_value_12
class1_dp_specificities_value_13
class1_dp_specificities_value_14
class1_dp_specificities_value_15
class1_dp_specificities_value_16
class1_dp_specificities_value_17
class1_dp_specificities_value_18
class1_dp_specificities_value_19
class1_dp_specificities_value_20
class1_dp_specificities_value_21
class1_dp_specificities_value_22
class1_dp_specificities_value_23
class1_dp_specificities_value_24
class1_dp_specificities_value_25
class1_dp_specificities_value_26
class1_dp_specificities_value_27
class1_dp_specificities_value_28
class1_dp_specificities_value_29
class1_dp_specificities_value_30
class1_dp_specificities_value_31
class1_dp_specificities_value_32
class1_dp_specificities_value_33
class1_dp_specificities_value_34
class1_dp_specificities_value_35
class1_dp_specificities_value_36
class1_dp_specificities_value_37
class1_dp_specificities_value_38
class1_dp_specificities_value_39
class1_dp_specificities_value_40
class1_dr_specificities_value_1
class1_dr_specificities_value_2
class1_dr_specificities_value_3
class1_dr_specificities_value_4
class1_dr_specificities_value_5
class1_dr_specificities_value_6
class1_dr_specificities_value_7
class1_dr_specificities_value_8
class1_dr_specificities_value_9
class1_dr_specificities_value_10
class1_dr_specificities_value_11
class1_dr_specificities_value_12
class1_dr_specificities_value_13
class1_dr_specificities_value_14
class1_dr_specificities_value_15
class1_dr_specificities_value_16
class1_dr_specificities_value_17
class1_dr_specificities_value_18
class1_dr_specificities_value_19
class1_dr_specificities_value_20
class1_dr_specificities_value_21
class1_dr_specificities_value_22
class1_dr_specificities_value_23
class1_dr_specificities_value_24
class1_dr_specificities_value_25
class1_dr_specificities_value_26
class1_dr_specificities_value_27
class1_dr_specificities_value_28
class1_dr_specificities_value_29
class1_dr_specificities_value_30
class1_dr_specificities_value_31
class1_dr_specificities_value_32
class1_dr_specificities_value_33
class1_dr_specificities_value_34
class1_dr_specificities_value_35
class1_dr_specificities_value_36
class1_dr_specificities_value_37
class1_dr_specificities_value_38
class1_dr_specificities_value_39
class1_dr_specificities_value_40
study_termination
reason_study_terminatn
mpd_dt
mpd_continue_study;
run;

proc sort data = missionps;
by record_id;
run;

*************************************************************************************************************************************
*************************************************************************************************************************************
*************************************************************************************************************************************;

*Merging each mission dataset with the shotgun list so that I can filter by PK date;

proc sort data = shotgunlist;
by record_id;
run;

proc print data = shotgunlist;
run;

data shotgunlistcs;
merge shotgunlist missioncs;
by record_id;
run;

proc print data = shotgunlistcs;
var record_id tx_dt Month;
run;

data shotgunlistcs;
set shotgunlistcs;
if tx_dt = " " then delete;
run;

proc print data = shotgunlistcs;
var record_id tx_dt Month;
run;

*Seems I need to run a one to many merge here;
data shotgunlistps;
merge missionps shotgunlist;
by record_id;
run;

proc print data = missionps;
var record_id tx_dt;
run;

proc print data = shotgunlistps;
var record_id tx_dt Month;
run;

data shotgunlistps;
set shotgunlistps;
if tx_dt = " " then delete;
run;

proc print data = shotgunlistps;
var record_id tx_dt Month;
run;

*Merging each mission dataset with the shotgun list so that I can filter by PK date;

proc sort data = shotgunlistcs;
by record_id;
run;

proc sort data = shotgunlistps;
by record_id;
run;

proc print data = shotgunlistcs;
var record_id bilirubin_total;
run;

data shotgunlistcs;
set shotgunlistcs;
txn_dt_pk2 = input(txn_dt_pk, 8.);
bun2 = input(bun, 8.);
bilirubin_total2 = input(bilirubin_total, 8.);
run;

proc print data = shotgunlistcs;
var record_id bilirubin_total bilirubin_total2;
run;

data shotgunlistcs;
set shotgunlistcs;
if bilirubin_total2 = . then bilirubin_total2 = 0.2;
run;

proc print data = shotgunlistcs;
var record_id bilirubin_total bilirubin_total2;
run;

data shotgunlistcs;
set shotgunlistcs;
drop 
txn_dt_pk
bun
bilirubin_total;
run;

data shotgunlistps;
set shotgunlistps;
txn_dt_pk2 = input(txn_dt_pk, 8.);
bun2 = input(bun, 8.);
bilirubin_total2 = input(bilirubin_total, 8.);
run;

data shotgunlistps;
set shotgunlistps;
if bilirubin_total2 = . then bilirubin_total2 = bilirubin_total;
run;

proc print data = shotgunlistps;
var record_id bilirubin_total bilirubin_total2;
run;

data shotgunlistcs;
set shotgunlistcs;
drop 
txn_dt_pk
bun
bilirubin_total;
run;

data shotgunlistcsps;
merge shotgunlistps shotgunlistcs;
by record_id;
run;

proc print data = shotgunlistcsps;
var record_id tx_dt Month;
run;

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

*Generating the descriptive statistics for the Table 1 Dr. jacobson requested for comparison with the LSS paper;

data shotgunlistcsps2;
set shotgunlistcsps;
*if record_id = 4016 and Month = "M4" then check =1;
*if record_id = 4022 and Month = "M4" then check =1;
if Month = "PK" then check = 1;
if Month = "pk" then check = 1;
run;

proc print data = shotgunlistcsps2;
var record_id check;
where check = 1;
run;

data shotgunlistcsps2;
set shotgunlistcsps2;
where check = 1;
run;

proc contents data = shotgunlistcsps2;
run;

data shotgunlistcsps2;
set shotgunlistcsps2;
if PID = 3001 then delete; *3001 was on myfortic;
if PID = 3003 then delete; *3003 was on myfortic;
if record_id = 3005 then delete; *3005 was on myfortic;
if record_id = 3534 then delete; *3534 was on myfortic;
if record_id = 4509 then delete; *4509 did not have all the measurements for the LSS paper;
run;

proc export 
  data= shotgunlistcsps2
  dbms=csv
  outfile="/home/u63327094/analysis_MISSION_comb_data_reports/Shotgun_list_LSS.csv" 
  replace;
run;

/*
data missionps;
set missionps;
if birth_yr_ld ne . then yr_ld = YEAR(tx_dt);
if birth_yr_ld ne . then age_ld = yr_ld-birth_yr_ld;
if birth_yr_dd ne . then yr_dd = YEAR(tx_dt);
if birth_yr_dd ne . then age_dd = yr_dd-birth_yr_dd;
run;

proc print data = missionps;
var record_id tx_dt birth_yr_ld yr_ld age_ld birth_yr_dd yr_dd age_dd;
run;
*/

data shotgunlistcsps2;
set shotgunlistcsps2;
if birth_yr_ld ne . then yr_ld = YEAR(tx_dt);
if birth_yr_ld ne . then age_ld = yr_ld-birth_yr_ld;
if birth_yr_dd ne . then yr_dd = YEAR(tx_dt);
if birth_yr_dd ne . then age_dd = yr_dd-birth_yr_dd;
run;

proc print data = shotgunlistcsps2;
var record_id tx_dt birth_yr_ld yr_ld age_ld birth_yr_dd yr_dd age_dd;
run;

proc print data = shotgunlistcsps2;
var record_id tx_dt age days_after_posttx_pk;
run;

data shotgunlistcsps2;
set shotgunlistcsps2;
age_to_add = days_after_posttx_pk/365.2;
run;

data shotgunlistcsps2;
set shotgunlistcsps2;
age_at_PK = age + age_to_add;
run;

ods excel file="/home/u63327094/analysis_MISSION_comb_data_reports/age_at_transplant_calculation.csv";

proc print data = shotgunlistcsps2;
var record_id tx_dt age days_after_posttx_pk age_to_add age_at_pk;
run;

ods excel close;

proc means data = shotgunlistcsps2 mean std;
var age_at_pk;
run;

proc freq data = shotgunlistcsps2;
table sex / nocol norow;
run;

proc freq data = shotgunlistcsps2;
table predom_race;
run;

proc means data = shotgunlistcsps2 mean std missing;
var bilirubin_total2;
run;

ods excel file="/home/u63327094/analysis_MISSION_comb_data_reports/bilirubin_total_calculation.csv";

proc print data = shotgunlistcsps2;
var record_id bilirubin_total2;
run;

proc means data = shotgunlistcsps2 mean std missing;
var bilirubin_total2;
run;

ods excel close;

proc means data = shotgunlistcsps2 mean std missing;
var alb_value;
run;

proc print data = shotgunlistcsps2;
var record_id mmf_daily_dose_pk;
run;

data shotgunlistcsps2;
set shotgunlistcsps2;
if mmf_daily_dose_pk = 1 then daily_dose_num = 500;
if mmf_daily_dose_pk = 2 then daily_dose_num = 1000;
if mmf_daily_dose_pk = 3 then daily_dose_num = 1500;
if mmf_daily_dose_pk = 4 then daily_dose_num = 2000;
if mmf_daily_dose_pk = 5 then daily_dose_num = 2500;
if mmf_daily_dose_pk = 6 then daily_dose_num = 3000;
if mmf_daily_dose_pk = 7 then daily_dose_num = 750;
run;

data shotgunlistcsps2;
set shotgunlistcsps2;
total_daily_dose_num =2*daily_dose_num;
run;

ods excel file="/home/u63327094/analysis_MISSION_comb_data_reports/mmf_total_daily_dose_calculation_v2.csv";

proc print data = shotgunlistcsps2;
var record_id  mmf_daily_dose_pk mmf_dosefreq_pk daily_dose_num total_daily_dose_num;
run;

proc means data = shotgunlistcsps2 median p25 p75;
var daily_dose_num;
run;

ods excel close;

proc means data = shotgunlistcsps2 median p25 p75;
var daily_dose_num total_daily_dose_num;
run;

ods excel file="/home/u63327094/analysis_MISSION_comb_data_reports/redcap_MPA_AUC.csv";

proc print data = shotgunlistcsps2;
var record_id  mpaauc mpaauc_dt mpaauc_value;
run;

ods excel close;

/*
proc freq data = shotgunlistcsps2;
table ethnicity;
run;

proc freq data = shotgunlistcsps2;
table sex;
run;

proc means data = shotgunlistcsps2 mean std;
var age;
run;

proc freq data = shotgunlistcsps2;
table esrd_cause;
run;

proc freq data = shotgunlistcsps2;
table diabetes_pretx;
run;

proc freq data = shotgunlistcsps2;
table donor_type;
run;
 
proc means data = shotgunlistcsps2 mean std;
var age_ld age_dd;
run;

proc freq data = shotgunlistcsps2;
table sex_ld sex_dd;
run;

proc means data = shotgunlistcsps2 mean std;
var cold_ischem_time;
run;

proc freq data = shotgunlistcsps2;
table prev_tx;
run;

proc freq data = shotgunlistcsps2;
table dialysis_post_tx/missing;
run;

proc freq data = shotgunlistcsps2;
table pra_test /missing;
run;

proc freq data = shotgunlistcsps2;
table t_cell_x_match_result /missing;
run;

proc freq data = shotgunlistcsps2;
table b_cell_x_match_result /missing;
run;

proc freq data = shotgunlistcsps2;
table plasmapheresis /missing;
run;

proc freq data = shotgunlistcsps2;
table nummismatch /missing;
run;

proc freq data = shotgunlistcsps2;
table smoking /missing;
run;

proc freq data = shotgunlistcsps2;
table preemptive_tx /missing;
run;

proc freq data = shotgunlistcsps2;
table spk /missing;
run;

proc freq data = shotgunlistcsps2;
table cmv_donor_igg
eb_donor
hepb_donor
hepc_donor /missing;
run;

*/

***********************************************************************************************************************************************;
***********************************************************************************************************************************************;
***********************************************************************************************************************************************;

/*

data g3;
set mylib.g3clean;
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

proc contents data = g3;
run;

proc print data = g3 label;
run;

data g3demo;
set g3;
where redcap_repeat_instance = 1;
run;

proc freq data = g3demo;
tables induct_meds___1 induct_meds___5;
run;

data g3demo;
set g3demo;
if induct_meds___1 = 1 then induct_meds = "Thymoglobulin (anti-thymocyte globulin [rabbit], ATG rabbit)";
else if induct_meds___2 = 1 then induct_meds = "Simulect (basiliximab)";
else if induct_meds___3 = 1 then induct_meds = "Campath (alemtuzumab)";
else if induct_meds___4 = 1 then induct_meds = "Rituxan (rituximab)";
else induct_meds = "Drug not received";
run;

proc freq data = g3demo;
table induct_meds /missing;
run;

data g4;
set mylib.g4clean;
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

proc contents data = g4;
run;

proc print data = g4 label;
run;

data g4demo;
set g4;
where ind_steroid_dose_change = 1;
run;

proc print data = g4demo label;
run;

*remove duplicate PIDs;
*chrome-extension://efaidnbmnnnibpcajpcglclefindmkaj/https://support.sas.com/resources/papers/proceedings/proceedings/forum2007/069-2007.pdf;

PROC SORT data=g4demo NODUPkey;  BY record_id; RUN; 


data g10;
set mylib.g10clean;
if record_id = 3501 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3519 then delete; *excluding 3519 for form b2 pets + being withdrawn;
if record_id = 3522 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3523 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3525 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3526 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3529 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3533 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 3540 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4003 then delete; *excluding 4003 for missing age + being withdrawn;
if record_id = 4007 then delete; *excluding 4007 for form b2 + being withdrawn;
if record_id = 4008 then delete; *excluding 4008 for form b2 + being withdrawn;
if record_id = 4009 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4010 then delete; *excluding 4009 for form b2 + being withdrawn;
if record_id = 4023 then delete; *excluding 4023 for form b2 + being withdrawn;
if record_id = 4024 then delete; *excluding 4024 for form b2 + being withdrawn;
if record_id = 4028 then delete; *excluding 3523 for form b2 + being withdrawn;
if record_id = 4030 then delete; *excluding 3523 for form b2 + being withdrawn;
run;

proc contents data = g10;
run;

proc print data = g10 label;
run;

*/